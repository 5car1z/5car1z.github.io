<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="Linux System Administration"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="atom.xml" title="Tricks of the Trades" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Docker - Building Images and Docker Hub (5) - Tricks of the Trades</title><link rel="stylesheet" href="/css/main.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">Tricks of the Trades</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/trades" class="head-nav__link">Trades</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="/work" class="head-nav__link">Work</a></li><li class="head-nav__item"><a href="/about" class="head-nav__link">About</a></li><li class="head-nav__item"><a href="/contact" class="head-nav__link">Contact</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2016-05-17T23:00:00.000Z" class="post__time">May 18, 2016</time><h1 class="post__title"><a href="/2016/05/18/docker-images-hub/">Docker - Building Images and Docker Hub (5)</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/poo8Rai.png" alt="Docker Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>Docker images can be thought of as blueprints and house the software or files required to run your application inside of a container. So far in these Docker posts all container images have been pulled from an online source and no real interaction with the images themselves has been explored. </p>
<p>However in this post we’re taking a very simple Python Flask application and going through the process of <em>dockerising</em> it. Which in non-jargon terms means we are configuring and creating our own custom Docker image, to then run it in a container like any other image. This usually also involves uploading it to Docker Hub for others to pull down and use, so is covered in the guide. </p>
<p>The <a href="http://www.tricksofthetrades.net/2016/03/14/docker-data-volumes/">Docker - Data Volumes and Data Containers (4)</a> post that comes before this one is mostly unrelated so not really a requirement for this post, but still worth checking out overall. </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Clone-the-Repository"><a href="#1-–-Clone-the-Repository" class="headerlink" title="1 –  Clone the Repository"></a>1 –  Clone the Repository</h1><p>The example application used in this post is named “Flaskr” and serves as a very simple messaging board. It allows a user to sign in/out, add new written entries to the message board displayed, and does all this using SQLite as the database backend. </p>
<p>Clone this example application and its code locally. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/5car1z/docker-flaskr.git ~/docker-flaskr</span><br></pre></td></tr></table></figure>
<p>Change your working directory to the new repository.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/docker-flaskr</span><br></pre></td></tr></table></figure>
<p>Take a quick glance at the files using:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ls</span><br></pre></td></tr></table></figure>
<p>Which returns: </p>
<figure class="highlight bash"><figcaption><span>Output </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flaskr.py  flaskr_settings  README  requirements.txt  schema.sql  static  templates  test_flaskr.py</span><br></pre></td></tr></table></figure>
<p>Then move onto the next step. </p>
<hr>
<h1 id="2-–-Configure-the-Application"><a href="#2-–-Configure-the-Application" class="headerlink" title="2 –  Configure the Application"></a>2 –  Configure the Application</h1><p>Most Flask or Python projects contain a file that holds circumstantial configuration values. These settings differ from user to user and when running the application in development/production environments. To run our Flaskr application and build a successful Docker image later on, we must set the values in this file beforehand.  </p>
<p>Open the <code>flaskr_settings</code> file with your preferred text editor.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim flaskr_settings</span><br></pre></td></tr></table></figure>
<p>The first two lines containing the database file location and debug status should remain as they are. There is no need to change these for this scenario. </p>
<figure class="highlight bash"><figcaption><span>flaskr_settings</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># configuration</span></span><br><span class="line">DATABASE = <span class="string">'flaskr.db'</span></span><br><span class="line">DEBUG = False</span><br></pre></td></tr></table></figure>
<p>Generating a secret key for the third line here is easiest using a Python console.</p>
<figure class="highlight bash"><figcaption><span>flaskr_settings</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SECRET_KEY = <span class="string">''</span></span><br></pre></td></tr></table></figure>
<p>Back on the command line outside of the editor run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python</span><br></pre></td></tr></table></figure>
<p>Import the OS module. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> os</span><br></pre></td></tr></table></figure>
<p>Run the associated OS function for generating a string of random bytes (urandom). </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>os.urandom(<span class="number">24</span>)</span><br></pre></td></tr></table></figure>
<p>A 24 byte value is returned as output for use as the secret key in the <code>flaskr_settings</code> file. The key value shown here is for demonstration purposes only. </p>
<figure class="highlight python"><figcaption><span>Example Key Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'\xebqD\x0f\xf3\xcf\xaa\x9e]%\x86\xd7\x11h\x8f\xa3\xa6\xbb=\xf7m\xf2&#123;\xfd'</span></span><br></pre></td></tr></table></figure>
<p>Copy your own secret key value into the third line of the <code>flaskr_settings</code> file - you can exit the Python console by pressing <code>CTRL</code> + <code>D</code> once the key has been retained. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim flaskr_settings</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><figcaption><span>flaskr_settings</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SECRET_KEY = <span class="string">'\xebqD\x0f\xf3\xcf\xaa\x9e]%\x86\xd7\x11h\x8f\xa3\xa6\xbb=\xf7m\xf2&#123;\xfd'</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Only one set of enclosing apostrophes are required: <code>&#39;&#39;</code> </p>
</blockquote>
<p>On the last two lines of the configuration file provide a username and password. These details are used for authentication when logging into the app after it is up and running. </p>
<p>Add in your own values. </p>
<figure class="highlight python"><figcaption><span>flaskr_settings</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">USERNAME = <span class="string">'username'</span></span><br><span class="line">PASSWORD = <span class="string">'password'</span></span><br></pre></td></tr></table></figure>
<p>Save your changes to the <code>flaskr_settings</code> file before continuing, and exit the file. </p>
<p>My example entries and file look like this when completed:</p>
<figure class="highlight python"><figcaption><span>flaskr_settings</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># configuration</span></span><br><span class="line">DATABASE = <span class="string">'flaskr.db'</span></span><br><span class="line">DEBUG = <span class="keyword">False</span></span><br><span class="line">SECRET_KEY = <span class="string">'\xebqD\x0f\xf3\xcf\xaa\x9e]%\x86\xd7\x11h\x8f\xa3\xa6\xbb=\xf7m\xf2&#123;\xfd'</span></span><br><span class="line">USERNAME = <span class="string">'scarlz'</span></span><br><span class="line">PASSWORD = <span class="string">'password'</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="3-–-Create-the-Dockerfile"><a href="#3-–-Create-the-Dockerfile" class="headerlink" title="3 –  Create the Dockerfile"></a>3 –  Create the Dockerfile</h1><p>The build process and configuration parameters for our eventual Docker image get defined in a new file named the “Dockerfile”. </p>
<p>Create the new Dockerfile using your text editor again, and place each of the upcoming actions on its own separate line. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim Dockerfile</span><br></pre></td></tr></table></figure>
<p>Tell Docker to use the official Python 2.7 image as a base for our own custom image, on the first line.</p>
<figure class="highlight bash"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FROM python:2.7</span><br></pre></td></tr></table></figure>
<p>Define an environment variable that tells Flaskr the name of the configuration file we completed earlier.</p>
<figure class="highlight bash"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ENV FLASKR_SETTINGS flaskr_settings</span><br></pre></td></tr></table></figure>
<p>Add the <code>requirements.txt</code> file to the file-system of the image we are creating. </p>
<figure class="highlight bash"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ADD requirements.txt /tmp/requirements.txt</span><br></pre></td></tr></table></figure>
<p>Install the Flaskr application dependencies onto this image - sourced in from the “requirements” file. </p>
<figure class="highlight bash"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RUN pip install -r /tmp/requirements.txt</span><br></pre></td></tr></table></figure>
<p>Add the current working directory <code>.</code> of the project and its contents to a new directory on the image’s file-system. </p>
<figure class="highlight bash"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ADD . /flask-application</span><br></pre></td></tr></table></figure>
<p>Set the image’s file-system current working directory to the one we are creating. </p>
<figure class="highlight bash"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WORKDIR /flask-application</span><br></pre></td></tr></table></figure>
<p>Open port <code>5000</code> on the container so we can map it to a host port later. </p>
<figure class="highlight bash"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPOSE 5000</span><br></pre></td></tr></table></figure>
<p>Run the Flaskr app on this image, once the container is launched by the user.  </p>
<figure class="highlight bash"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CMD [<span class="string">"python"</span>, <span class="string">"flaskr.py"</span>, <span class="string">"--host"</span>, <span class="string">"0.0.0.0"</span>, <span class="string">"--port"</span>, <span class="string">"5000"</span>]</span><br></pre></td></tr></table></figure>
<p>The Dockerfile in full:</p>
<figure class="highlight bash"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FROM python:2.7</span><br><span class="line">ENV FLASKR_SETTINGS flaskr_settings</span><br><span class="line">ADD requirements.txt /tmp/requirements.txt</span><br><span class="line">RUN pip install -r /tmp/requirements.txt</span><br><span class="line">ADD . /flaskr-application</span><br><span class="line">WORKDIR /flaskr-application</span><br><span class="line">EXPOSE 5000</span><br><span class="line">CMD [<span class="string">"python"</span>, <span class="string">"flaskr.py"</span>, <span class="string">"--host"</span>, <span class="string">"0.0.0.0"</span>, <span class="string">"--port"</span>, <span class="string">"5000"</span>]</span><br></pre></td></tr></table></figure>
<p>Make sure your own file’s contents matches the above, and then save the changes. </p>
<hr>
<h1 id="4-–-Build-and-Run-the-Image"><a href="#4-–-Build-and-Run-the-Image" class="headerlink" title="4 – Build and Run the Image"></a>4 – Build and Run the Image</h1><p>Using Docker (which you should already <a href="http://www.tricksofthetrades.net/2015/12/23/installing-running-docker/">have installed</a>) we’re going to build the custom Flaskr image configured in the previous step. </p>
<p>When entering this next command be aware that ideally the parameters of <code>-t</code> need to be replaced with your own username and preferred image name. The details are used later on when registering the image externally. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build --no-cache -t scarlz/flaskr-application .</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> The <code>-t</code> option assigns a <em>tag</em> to the image used by Docker Hub or an image registry service. </p>
</blockquote>
<p>Give the build process a few minutes to download and carry out the necessary operations, noting its progress via the output. </p>
<p>If the Dockerfile was configured properly in the previous step you’ll get a final output similar to:</p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Successfully built c4e546ed282d</span><br></pre></td></tr></table></figure>
<p>Run the newly built Docker image in a daemonised container, mapping the internal container port <code>5000</code> to the host port <code>32775</code> so we can view the app locally. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --name flaskr-container -p 32775:5000 <span class="_">-d</span> scarlz/flaskr-application</span><br></pre></td></tr></table></figure>
<p>Confirm the container has run and is running. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps</span><br></pre></td></tr></table></figure>
<p>Running container details are returned:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS              PORTS                     NAMES</span><br><span class="line">c3937994e66b        scarlz/flaskr-application   <span class="string">"python flaskr.py --h"</span>   3 seconds ago       Up 3 seconds        0.0.0.0:5000-&gt;32775/tcp   flaskr-container</span><br></pre></td></tr></table></figure>
<p>Preview the Flaskr app in your web browser by visiting:</p>
<p><code>http://0.0.0.0:32775</code></p>
<p><img src="http://i.imgur.com/sLe4eCC.png" alt="Flaskr Homepage Image"></p>
<p>Log in to the application with the authentication details from step 2 if you wish to test it out. </p>
<p><img src="http://i.imgur.com/wtTvZkZ.png" alt="Flaskr Internal Form Image"></p>
<hr>
<h2 id="5-–-Push-the-Image-to-Docker-Hub"><a href="#5-–-Push-the-Image-to-Docker-Hub" class="headerlink" title="5 – Push the Image to Docker Hub"></a>5 – Push the Image to Docker Hub</h2><p>Once images have been built and tested successfully you may want to make them accessible to others through a public or private Docker registry service. The official registry service open to all provided by Docker is known as <a href="https://hub.docker.com/" target="_blank" rel="external">“Docker Hub”</a>. </p>
<p>Create a free account by registering with the service at the previous link and then go back to the command line and login using:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker login</span><br></pre></td></tr></table></figure>
<p>Enter the authentication details you used to sign up to the service as prompted. </p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Username: </span><br><span class="line">Password: </span><br><span class="line">Email: </span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure>
<p>Now once successfully authenticated push the image you created earlier to Docker Hub by providing the “tag” name assigned to it. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker push scarlz/flaskr-application:latest</span><br></pre></td></tr></table></figure>
<p>The <code>:latest</code> suffix ensures the most recently built version of the image is sent. </p>
<p>Successfully pushing the image will return an output akin to:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">77e39ee82117: Image successfully pushed</span><br></pre></td></tr></table></figure>
<p>You can see the example image I pushed to Docker Hub at: </p>
<p><a href="https://hub.docker.com/r/5car1z/flaskr-application" target="_blank" rel="external">https://hub.docker.com/r/5car1z/flaskr-application</a></p>
<p><img src="http://i.imgur.com/roVLQ0J.png" alt="Docker Hub - Flaskr"></p>
<hr>
<p>There are many more practices and nuances not covered here when it comes to building, tagging, and pushing to Docker registries. But hopefully this serves as a simple example of how the process can be carried out. Something to bear in mind perhaps is that Docker Hub has in the past been given bad press in terms of performance (most notably speed) although the service continues to improve as time goes on. it is also for these reasons or similar many use third party private registry platforms in its place e.g. <a href="">Portus</a></p>
<p>The next and final post in this series takes a glance briefly at some of the extra platforms/toolsets that form up more of the Docker eco-system.</p>
<p><a href="http://www.tricksofthetrades.net/trades/">Links to subsequent Docker posts can be found on the Trades page.</a></p>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://github.com/5car1z/docker-flaskr" target="_blank" rel="external">GitHub - Docker-Flaskr Repository</a> – Repository for this post cloned at the start.</li>
<li><a href="http://tiborsimko.org/docker-for-python-applications.html" target="_blank" rel="external">Tibor’s Musings - Using Docker for Developing Python Applications</a> – Basis of what goes on this blog post with adaption for Flaskr.</li>
<li><a href="">Official Docker Documentation - Build Your Own Images</a> – Probably best source for everything covered here. </li>
<li><a href="http://prakhar.me/docker-curriculum/" target="_blank" rel="external">Prakhar - Docker for Beginners</a> – Detailed guide on fundamentals of Docker, referred to partly for this post.</li>
<li><a href="https://community.nitrous.io/docs/creating-custom-docker-images" target="_blank" rel="external">Nitrous.io Documentation - Creating Custom Docker Images</a> – Specific to Nitrous development in parts but relevant overall. </li>
<li><a href="http://flask.readthedocs.io/en/latest/cli/#command-line-interface" target="_blank" rel="external">Flask Documentation - Command Line Interface</a> – Flask application CLI documentation page. </li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Docker/" class="post__tag__link">Docker</a></li><li class="post__tag__item"><a href="/tags/Virtualisation/" class="post__tag__link">Virtualisation</a></li><li class="post__tag__item"><a href="/tags/Containers/" class="post__tag__link">Containers</a></li></ul><a href="/2016/05/18/docker-images-hub/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><div class="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript></div></div></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2018 Scarlz</div><menu class="page-menu u-fr"><li class="page-menu__item"><a title="Previous" href="/2016/06/13/debian8-vps-checklist/" class="page-menu__link icon-arrow-left"></a></li><li class="page-menu__item"><a title="Next" href="/2016/04/26/github-flow/" class="page-menu__link icon-arrow-right"></a></li></menu></footer><script>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src="//"+l+".disqus.com/"+k+".js",i.parentNode.insertBefore(j,i)})
(document,"script","totts","embed");
</script></body></html>