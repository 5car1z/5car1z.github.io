<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="Linux System Administration"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="atom.xml" title="Tricks of the Trades" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Ansible - Ad Hoc Commands and Modules (3) - Tricks of the Trades</title><link rel="stylesheet" href="/css/main.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">Tricks of the Trades</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/trades" class="head-nav__link">Trades</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="/work" class="head-nav__link">Work</a></li><li class="head-nav__item"><a href="/about" class="head-nav__link">About</a></li><li class="head-nav__item"><a href="/contact" class="head-nav__link">Contact</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2017-03-20T00:00:00.000Z" class="post__time">March 20, 2017</time><h1 class="post__title"><a href="/2017/03/20/ansible-adhoc-modules/">Ansible - Ad Hoc Commands and Modules (3)</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/9HBs9cy.png" alt="Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>Several ad hoc commands were shown in the previous post but no real detail was given as to what they can fully offer. These <em>ad hoc</em> commands are often cited as being a good starter point for learning what’s possible with Ansible; without having to dive straight into writing a playbook. Most of them incorporate the use of a <em>module</em> into their structure, so this post introduces modules too. Both from the point of view of an ad hoc command, and within the context of a task. Towards the end, the “special” Ansible module types are shown. </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Ad-Hoc-Commands"><a href="#1-–-Ad-Hoc-Commands" class="headerlink" title="1 – Ad Hoc Commands"></a>1 – Ad Hoc Commands</h1><p>Sometimes you may not need nor want to write a fully fledged playbook for simple operations. Either way the concepts here for these commands port directly over to the playbook language for when you do begin writing them later on. These due to their impromptu nature and use,. </p>
<p>In their simplest form these commands are shell commands performed in parallel to each host by Ansible. </p>
<p>Here <code>coreservers</code> is the group name that contains several hosts and the ad hoc command <code>-a</code> we are running on them is <code>/sbin/reboot</code> using <code>10</code> Ansible forks. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers <span class="_">-a</span> <span class="string">"/sbin/reboot"</span> <span class="_">-f</span> 10 -b -K</span><br></pre></td></tr></table></figure>
<p>The <code>-f 10</code> in the above specifies the usage of 10 simultaneous processes to use (10 hosts at a time). You can also set this as an assumed default in the configuration file to avoid setting it here. The default is set to 5, which is lacking and conservative, so feel free to increase this value to a more optimal number. </p>
<p>Ansible defaults to running from your current user account (or from any hosts variables). To change this pass in the <code>-u</code> option. Where <code>scarlz</code> is the username you want to run the command as. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers <span class="_">-a</span> <span class="string">"/usr/bin/foo"</span> -u scarlz</span><br></pre></td></tr></table></figure>
<p>When not calling raw programs on the node through Ansible, modules are the main choice for carrying out operations. </p>
<p>In general the <code>-m</code> option denotes a named module. Here is an example of the <code>shell</code> module that is used to issue precise commands on the Ansible node. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -u scarlz -m shell <span class="_">-a</span> <span class="string">'echo $TERM'</span></span><br></pre></td></tr></table></figure>
<p>There are a whole back-catalogue of these inbuilt modules for you to make use of. </p>
<hr>
<h1 id="2-–-Modules"><a href="#2-–-Modules" class="headerlink" title="2 – Modules"></a>2 – Modules</h1><p>Modules contain the actions or functionality we want to implement and run. Some commonly used modules are apt/yum, copy, ec2, file, service, template, and user. Like shown in the previous section, modules can be used in ad-hoc commands as well as “tasks”.  </p>
<h2 id="Copy"><a href="#Copy" class="headerlink" title="Copy"></a>Copy</h2><p>This command transfers a “hosts” file directly to all servers in the “coreservers” group, using SCP and the <code>copy</code> module:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -m copy <span class="_">-a</span> <span class="string">"src=/etc/hosts dest=/tmp/hosts"</span> -b -K</span><br></pre></td></tr></table></figure>
<h2 id="File"><a href="#File" class="headerlink" title="File"></a>File</h2><p>The <code>file</code> module provides the ability to change system ownership and permissions on remote files. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -m file <span class="_">-a</span> <span class="string">"dest=/var/www/index.html mode=755 owner=scarlz group=www"</span> -b -K</span><br></pre></td></tr></table></figure>
<p>To create directories with <code>file</code>, like when using the <code>mkdir -p</code> command in Linux, add the “directory” <code>state-directory</code> option.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -m file <span class="_">-a</span> <span class="string">"dest=/var/www/new-vhost-dir mode=755 owner=scarlz group=www state=directory"</span> -b -K</span><br></pre></td></tr></table></figure>
<p>Delete directories recursively, and delete files through <code>file</code> with the <code>state=absent</code> option.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -m file <span class="_">-a</span> <span class="string">"dest=/path/to/delete state=absent"</span></span><br></pre></td></tr></table></figure>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>This module is referred to when you need to interact with the OS system services. Inclusive of  BSD init, OpenRC, SysV, Solaris SMF, systemd, and upstart.</p>
<p>As an example of how this could work, this starts Nginx via systemd:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -m service <span class="_">-a</span> <span class="string">"name=nginx.service state=started"</span> -b -K</span><br></pre></td></tr></table></figure>
<p>Changing the state option changes the result - this is to restart:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -m service <span class="_">-a</span> <span class="string">"name=nginx.service state=restarted"</span> -b -K</span><br></pre></td></tr></table></figure>
<p>The value of “state” must be one of either: running, started, stopped, restarted, or reloaded.</p>
<h2 id="Users-and-Groups"><a href="#Users-and-Groups" class="headerlink" title="Users and Groups"></a>Users and Groups</h2><p>A module named the “user” module serves as an interface to creating, removing, and manipulating system user accounts. </p>
<p>Altering a user’s password only requires the username, in this next example this is <code>scarlz</code>, then the new password for the user which is substituted in to the <code>&lt;user-password&gt;</code> field.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -m user <span class="_">-a</span> <span class="string">"name=scarlz password=&lt;user-password&gt;"</span></span><br></pre></td></tr></table></figure>
<p>Removing the user account completely, once again needs the username (<code>scarlz</code> in my case) as well as the value <code>absent</code> for the <code>state</code> option. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -m user <span class="_">-a</span> <span class="string">"name=scarlz state=absent"</span> -b -K</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Practical-Ad-Hoc-Module-Example"><a href="#Practical-Ad-Hoc-Module-Example" class="headerlink" title="Practical Ad Hoc Module Example"></a>Practical Ad Hoc Module Example</h2><p>The first command updates the Apt package index - similar to running the usual <code>apt-get update</code> command. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -b -K -m apt <span class="_">-a</span> update_cache=yes</span><br></pre></td></tr></table></figure>
<p>Continuing on from before, upgrading the system packages (like with <code>apt-get upgrade</code>) uses: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -b -K -m apt <span class="_">-a</span> upgrade=yes</span><br></pre></td></tr></table></figure>
<p>Performing a <code>dist-upgrade</code> uses the <code>full</code> switch instead of just “yes”.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -b -K -m apt <span class="_">-a</span> upgrade=full</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Module-Index"><a href="#Module-Index" class="headerlink" title="Module Index"></a>Module Index</h2><p><a href="http://docs.ansible.com/ansible/modules_by_category.html" target="_blank" rel="external">Here’s a page from the official Ansible documentation</a> that acts as a catalogue for all the registered inbuilt modules available. There are many many modules, to cater for all specific needs. </p>
<hr>
<h1 id="3-–-Modules-in-Tasks"><a href="#3-–-Modules-in-Tasks" class="headerlink" title="3 – Modules in Tasks"></a>3 – Modules in Tasks</h1><p>Here are some examples of using the modules in a task (like you’d find in an Ansible playbook). </p>
<p>The file module (most shown before) creates a new directory to be used for caching purposes. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: add cache directory</span><br><span class="line">  file: path=/opt/cache state=directory</span><br></pre></td></tr></table></figure>
<p>In more detail this time, the <code>apt</code> module handles packages for Ubuntu/Debian OS. The state option here designates that the install of Nginx should be implemented via apt-get, but the state value could also be replaced with <code>latest</code> (to update the package) or <code>absent</code> (to remove the package) instead. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: install nginx</span><br><span class="line">  yum name=nginx state=present</span><br></pre></td></tr></table></figure>
<p>This one’s pretty straight forward, and is the “task” equivalent of the ad hoc command from earlier. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: start nginx</span><br><span class="line">  service: name=nginx enabled=yes state=started</span><br></pre></td></tr></table></figure>
<p>One thing to notice here is with the <code>name:</code>  field. Tasks can be defined as anything you want here but should be descriptive. Tasks are simple and declarative, they aim to pass the correct arguments to the module calls, to achieve what is needed. </p>
<hr>
<h1 id="4-–-Special-Modules"><a href="#4-–-Special-Modules" class="headerlink" title="4 – Special Modules"></a>4 – Special Modules</h1><p>There are several modules that fall into their own category, that exist to provide special core use cases. The code examples here are in the form of a task you’d find within a playbook. </p>
<ul>
<li><code>command</code> module – Used for executing simple commands on remote nodes. (first example shown in step one). </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: Run the <span class="built_in">command</span> <span class="keyword">if</span> the specified file does not exist.</span><br><span class="line">  <span class="built_in">command</span>: /usr/bin/make_database.sh arg1 arg2 creates=/path/to/database</span><br></pre></td></tr></table></figure>
<ul>
<li><code>shell</code> module – Similar to the command module but allows the use of redirection, variables, and further operators. The <code>shell</code> module was also used in the first step. </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: Execute the <span class="built_in">command</span> <span class="keyword">in</span> remote shell; stdout goes to the specified file on the remote.</span><br><span class="line">  shell: somescript.sh &gt;&gt; somelog.txt</span><br></pre></td></tr></table></figure>
<ul>
<li><code>script</code> – Let’s you run a local script on a remote node - <strong>after transferring it.</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- script: /some/<span class="built_in">local</span>/script.sh --some-arguments 1234</span><br></pre></td></tr></table></figure>
<ul>
<li><code>raw</code> – Executes a low-down and dirty SSH command. Mainly used for installing Python versions onto hosts that do not already have it. </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: Bootstrap a legacy python 2.4 host</span><br><span class="line">  raw: yum -y install python-simplejson</span><br></pre></td></tr></table></figure>
<p>The examples uses Yum package manager, so is in the context of an enterprise Linux OS. </p>
<hr>
<p>With a basic understanding of how modules work within both ad hoc commands and tasks. It’s easy to now see how the bulk of an Ansible playbooks actions are laid out. </p>
<p><a href="http://www.tricksofthetrades.net/trades/">Links to subsequent Ansible posts can be found on the Trades page.</a> </p>
<p><strong>More Information</strong></p>
<ul>
<li><a href="http://docs.ansible.com/ansible/intro_adhoc.html" target="_blank" rel="external">Official Ansible Documentation - Introduction To Ad-Hoc Commands</a> – Has the bulk of the information contained in this post. </li>
<li><a href="https://serversforhackers.com/an-ansible-tutorial" target="_blank" rel="external">“Servers for Hackers” - An Ansible Tutorial</a> – Some context for some of the commands and the use of the options. </li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Python/" class="post__tag__link">Python</a></li></ul><a href="/2017/03/20/ansible-adhoc-modules/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><div class="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript></div></div></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2018 Scarlz</div><menu class="page-menu u-fr"><li class="page-menu__item"><a title="Previous" href="/2017/04/10/ansible-playbooks/" class="page-menu__link icon-arrow-left"></a></li><li class="page-menu__item"><a title="Next" href="/2017/02/14/installing-using-ufw/" class="page-menu__link icon-arrow-right"></a></li></menu></footer><script>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src="//"+l+".disqus.com/"+k+".js",i.parentNode.insertBefore(j,i)})
(document,"script","totts","embed");
</script></body></html>