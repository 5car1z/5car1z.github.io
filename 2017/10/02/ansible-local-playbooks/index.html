<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="Linux System Administration"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="atom.xml" title="Tricks of the Trades" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Ansible - Local Playbook Execution - Tricks of the Trades</title><link rel="stylesheet" href="/css/main.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">Tricks of the Trades</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/trades" class="head-nav__link">Trades</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="/work" class="head-nav__link">Work</a></li><li class="head-nav__item"><a href="/about" class="head-nav__link">About</a></li><li class="head-nav__item"><a href="/contact" class="head-nav__link">Contact</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2017-10-01T23:00:00.000Z" class="post__time">October 2, 2017</time><h1 class="post__title"><a href="/2017/10/02/ansible-local-playbooks/">Ansible - Local Playbook Execution</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/9HBs9cy.png" alt="Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>There are a several ways to run Ansible on a local system that I could find whilst searching the net. In this I’m covering three of the ones that were the most popular or the most prevalent. The first two seem great for their different contexts, and the third is not as necessary but worth considering perhaps.  </p>
<p>Being able to do this can be very useful for setting up your own machines or workstations (dotfiles anyone?) at least in the event that you don’t want to use traditional scripting. Also when creating playbooks that involve interacting with developer API’s this is an important component - see the “more information” section at the end, for a link to an example of this. </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Local-Play-Directives"><a href="#1-–-Local-Play-Directives" class="headerlink" title="1 – Local Play Directives"></a>1 – Local Play Directives</h1><p>This is the easiest way I found and probably most suited for when writing one or two individual playbooks. </p>
<p>Simply put, using both <code>127.0.0.1</code> for the <code>hosts:</code> directive and setting <code>connection:</code> to <code>local</code>  in a playbook ensures any tasks carried out are executed on your local machine. </p>
<p>This is an example playbook that prints “localhost” during execution to show local playback, then updates and upgrades Apt system packages; so it’s intended for Debian and or Ubuntu. </p>
<figure class="highlight bash"><figcaption><span>playbook.yml </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"></span><br><span class="line">- name: run the playbook tasks on the localhost</span><br><span class="line">  hosts: 127.0.0.1</span><br><span class="line">  connection: <span class="built_in">local</span></span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">  - name: <span class="built_in">print</span> out the hostname of target</span><br><span class="line">    <span class="built_in">command</span>: hostname</span><br><span class="line">  </span><br><span class="line">  - name: ensure aptitude is installed</span><br><span class="line">    <span class="built_in">command</span>: apt-get -y install aptitude</span><br><span class="line">  </span><br><span class="line">  - name: update the apt package index i.e. apt-get update</span><br><span class="line">    apt: update_cache=yes</span><br><span class="line"></span><br><span class="line">  - name: upgrade system packages i.e. apt-get upgrade</span><br><span class="line">    apt: upgrade=yes</span><br></pre></td></tr></table></figure>
<p>Run it as usual like any standard playbook - inclusive of  <code>-K</code> as it’ll need <code>sudo</code> privileges to complete. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -K playbook.yml</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="2-–-Repository-Config-and-Hosts-File"><a href="#2-–-Repository-Config-and-Hosts-File" class="headerlink" title="2 – Repository Config and Hosts File"></a>2 – Repository Config and Hosts File</h1><p>This second method works best in the context of a version control repository, which features multiple local playbook files and is intended to be passed around from person to person or host to host. It works by forcing Ansible to use a custom config file and in turn local hosts file.  </p>
<p>Here are the step you’d need to carry out in order to set this up in a Git repository, after setting up the repo itself. There’s also no commands for checking in, writing, and pushing files to the remote.</p>
<p>In the Git repository, create the custom <code>ansible.cfg</code> file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim ansible.cfg</span><br></pre></td></tr></table></figure>
<p>Add these contents to the file as they’re shown:</p>
<figure class="highlight bash"><figcaption><span>ansible.cfg</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">hostfile = hosts</span><br></pre></td></tr></table></figure>
<p>Save and exit the new file. </p>
<p>Then create another file, this time the custom <code>hosts</code> one.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim hosts</span><br></pre></td></tr></table></figure>
<p>The contents here consist of a group named <code>[local]</code> and a host entry listed as <code>localhost</code>. The host variable for local host <code>ansible_connection=local</code> as expected forces a local connection whenever it is targeted in a playbook. </p>
<figure class="highlight bash"><figcaption><span>hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">local</span>]</span><br><span class="line">localhost ansible_connection=<span class="built_in">local</span></span><br></pre></td></tr></table></figure>
<p>Again on a Debian/Ubuntu host you could use an adapted version of the earlier playbook as a test example, to ensure everything is working as intended. The difference here is the <code>localhost</code> value for <code>hosts:</code> and no requirement to mention the <code>connection: local</code> directive. </p>
<figure class="highlight bash"><figcaption><span>playbook.yml </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"></span><br><span class="line">- name: run the playbook tasks on the localhost</span><br><span class="line">  hosts: localhost</span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">  - name: <span class="built_in">print</span> out the hostname of target</span><br><span class="line">    <span class="built_in">command</span>: hostname</span><br><span class="line">  </span><br><span class="line">  - name: ensure aptitude is installed</span><br><span class="line">    <span class="built_in">command</span>: apt-get -y install aptitude</span><br><span class="line">  </span><br><span class="line">  - name: update the apt package index i.e. apt-get update</span><br><span class="line">    apt: update_cache=yes</span><br><span class="line"></span><br><span class="line">  - name: upgrade system packages i.e. apt-get upgrade</span><br><span class="line">    apt: upgrade=yes</span><br></pre></td></tr></table></figure>
<p>You’ll need to provide your <code>sudo</code> password with this again, to run the playbook.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -K playbook.yml</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="3-–-Global-Inventory-Hosts-Group"><a href="#3-–-Global-Inventory-Hosts-Group" class="headerlink" title="3 – Global Inventory Hosts Group"></a>3 – Global Inventory Hosts Group</h1><p>One further alternative solution (in a non version control scenario where there’s no need for portability) is to instead add the <code>[local]</code> host group to your global <code>/etc/ansible/hosts</code> file. </p>
<p>These would be the commands:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/ansible/hosts</span><br></pre></td></tr></table></figure>
<p>Append this new host group to the file. </p>
<figure class="highlight bash"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">local</span>]</span><br><span class="line">localhost ansible_connection=<span class="built_in">local</span></span><br></pre></td></tr></table></figure>
<p>Write your opening lines of playbooks with the <code>hosts: all</code> definition. Here’s the example from before, adapted to this:</p>
<figure class="highlight bash"><figcaption><span>playbook.yml </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"></span><br><span class="line">- name: run the playbook tasks on the localhost</span><br><span class="line">  hosts: all</span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">  - name: <span class="built_in">print</span> out the hostname of target</span><br><span class="line">    <span class="built_in">command</span>: hostname</span><br><span class="line">  </span><br><span class="line">  - name: ensure aptitude is installed</span><br><span class="line">    <span class="built_in">command</span>: apt-get -y install aptitude</span><br><span class="line">  </span><br><span class="line">  - name: update the apt package index i.e. apt-get update</span><br><span class="line">    apt: update_cache=yes</span><br><span class="line"></span><br><span class="line">  - name: upgrade system packages i.e. apt-get upgrade</span><br><span class="line">    apt: upgrade=yes</span><br></pre></td></tr></table></figure>
<p>Then afterwards when you want to run a playbook locally, use the <code>-l</code> switch and provide the <code>local</code> group or  <code>localhost</code> as the target host. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -K <span class="_">-l</span> localhost playbook.yml</span><br></pre></td></tr></table></figure>
<p>It’s still wise and maybe more convenient to keep local playbook execution isolated to one directory or Git repository however (using the method in the former step). I would probably not recommend this method over the other two, but whatever works best for your particular needs I guess. </p>
<p>Thanks for reading, and I hope this has helped you out with local playbook execution in some way or another.  </p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://docs.ansible.com/ansible/latest/playbooks_delegation.html#local-playbooks" target="_blank" rel="external">Ansible Official Documentation - Local Playbooks</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-use-the-digitalocean-api-v2-with-ansible-2-0-on-ubuntu-14-04" target="_blank" rel="external">How To Use the DigitalOcean API v2 with Ansible 2.0 on Ubuntu 14.04</a></li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Python/" class="post__tag__link">Python</a></li><li class="post__tag__item"><a href="/tags/Debian/" class="post__tag__link">Debian</a></li><li class="post__tag__item"><a href="/tags/Ubuntu/" class="post__tag__link">Ubuntu</a></li></ul><a href="/2017/10/02/ansible-local-playbooks/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><div class="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript></div></div></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2018 Scarlz</div><menu class="page-menu u-fr"><li class="page-menu__item"><a title="Previous" href="/2018/01/11/kernel-update-for-meltdown-spectre/" class="page-menu__link icon-arrow-left"></a></li><li class="page-menu__item"><a title="Next" href="/2017/08/21/ansible-playbook-server-provisioning/" class="page-menu__link icon-arrow-right"></a></li></menu></footer><script>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src="//"+l+".disqus.com/"+k+".js",i.parentNode.insertBefore(j,i)})
(document,"script","totts","embed");
</script></body></html>