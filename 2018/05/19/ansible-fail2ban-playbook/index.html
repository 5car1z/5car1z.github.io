<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="Linux System Administration"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="C.J. Scarlett" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Installing Fail2ban with Ansible on Ubuntu 18.04 (Bionic Beaver) - C.J. Scarlett</title><link rel="stylesheet" href="/css/main.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">C.J. Scarlett</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/topics" class="head-nav__link">Topics</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="/misc" class="head-nav__link">Misc</a></li><li class="head-nav__item"><a href="/about" class="head-nav__link">About</a></li><li class="head-nav__item"><a href="/contact" class="head-nav__link">Contact</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2018-05-18T23:00:00.000Z" class="post__time">May 19, 2018</time><h1 class="post__title"><a href="/2018/05/19/ansible-fail2ban-playbook/">Installing Fail2ban with Ansible on Ubuntu 18.04 (Bionic Beaver)</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/klPwJ5E.png" alt="Fail2ban Logo with Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>This is a very short post covering a rudimentary Ansible playbook (if you can even call it one) that contains tasks for installing Fail2ban in a straightforward manner. It’s intended as a follow on from the manual set of instructions/commands most people are familiar with, which I covered in this other post: </p>
<blockquote>
<p><a href="https://www.tricksofthetrades.net/2018/05/18/fail2ban-installing-bionic/">Installing Fail2ban on Ubuntu 18.04 (Bionic Beaver)</a></p>
</blockquote>
<p>At the end I’m linking to a third and final post which goes into detail on a more extensive solution to installing Fail2ban, as part of an Ansible <em>provisioning</em> project. It uses an Ansible role rather than a standalone playbook. </p>
<a id="more"></a>
<hr>
<h1 id="Installing-Fail2ban-with-Ansible"><a href="#Installing-Fail2ban-with-Ansible" class="headerlink" title="Installing Fail2ban with Ansible"></a>Installing Fail2ban with Ansible</h1><p>This is probably the most simple and obvious solution outside of manually installing. It exists in the form of a single playbook and template file. </p>
<p>Somewhere suitable (e.g. in version control) create the main playbook file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim fail2ban-playbook.yml</span><br></pre></td></tr></table></figure>
<p>Enter in the following playbook contents:</p>
<figure class="highlight yml"><figcaption><span>fail2ban-playbook.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span><span class="bullet">--</span> </span><br><span class="line"><span class="attr">- name:</span> <span class="string">installs</span> <span class="string">fail2ban</span> <span class="string">on</span> <span class="string">ansible</span> <span class="string">hosts</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">fail2ban-hosts</span></span><br><span class="line"><span class="attr">  become:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">install</span> <span class="string">apt</span> <span class="string">fail2ban</span> <span class="string">packages</span></span><br><span class="line"><span class="attr">    apt:</span> </span><br><span class="line"><span class="attr">      name:</span> <span class="string">"<span class="template-variable">&#123;&#123; item &#125;&#125;</span>"</span>   </span><br><span class="line"><span class="attr">      state:</span> <span class="string">latest</span></span><br><span class="line"><span class="attr">      update_cache:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      cache_valid_time:</span> <span class="number">3600</span></span><br><span class="line"><span class="attr">    with_items:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">sendmail</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">override</span> <span class="string">the</span> <span class="string">basic</span> <span class="string">fail2ban</span> <span class="string">configuration</span> <span class="string">with</span> <span class="string">.local</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    copy:</span></span><br><span class="line"><span class="attr">      src:</span> <span class="string">jail.local.j2</span></span><br><span class="line"><span class="attr">      dest:</span> <span class="string">/etc/fail2ban/jail.local</span></span><br><span class="line"><span class="attr">      owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">      group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">      mode:</span> <span class="number">0644</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> <a href="https://gist.github.com/5car1z/76dd1e48f9b16dbd2fb370bba1e2d393" target="_blank" rel="external">Here’s the same contents as a Gist.</a></p>
</blockquote>
<p>The first task updates the package manager cache (if it has not been updated within a set time period) and then installs the <code>fail2ban</code> plus <code>sendmail</code> packages. </p>
<p>The second copies across a local configuration file for Fail2ban, whilst giving it the necessary permissions and ownership’s. </p>
<p>Next create the previously mentioned template file (locally still of course).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim jail.local</span><br></pre></td></tr></table></figure>
<p>Add in your own Fail2ban configuration settings; these are mine for example purposes, but can be used:</p>
<figure class="highlight bash"><figcaption><span>jail.local</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line"></span><br><span class="line"><span class="comment"># email address to receive notifications.</span></span><br><span class="line">destemail = root@localhost    </span><br><span class="line"><span class="comment"># the email address from which to send emails.</span></span><br><span class="line">sender = root@&lt;fq-hostname&gt;    </span><br><span class="line"><span class="comment"># name on the notification emails.</span></span><br><span class="line">sendername = Fail2Ban    </span><br><span class="line"><span class="comment"># email transfer agent to use. </span></span><br><span class="line">mta = sendmail   </span><br><span class="line"></span><br><span class="line"><span class="comment"># see action.d/ufw.conf</span></span><br><span class="line">actionban = ufw.conf</span><br><span class="line"><span class="comment"># see action.d/ufw.conf </span></span><br><span class="line">actionunban = ufw.conf   </span><br><span class="line"></span><br><span class="line">[sshd]</span><br><span class="line">enabled = <span class="literal">true</span></span><br><span class="line">port = ssh</span><br><span class="line">filter = sshd</span><br><span class="line"><span class="comment"># the length of time between login attempts for maxretry. </span></span><br><span class="line">findtime = 600</span><br><span class="line"><span class="comment"># attempts from a single ip before a ban is imposed.</span></span><br><span class="line">maxretry = 5</span><br><span class="line"><span class="comment"># the number of seconds that a host is banned for.</span></span><br><span class="line">bantime = 3600</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> <a href="https://gist.github.com/5car1z/9c143fd17e61d074ec95207380ba9969" target="_blank" rel="external">Here’s the same contents as a Gist.</a></p>
</blockquote>
<p>These settings assume accompanied <a href="https://www.tricksofthetrades.net/2017/02/14/installing-using-ufw/">use of UFW as a firewall on the host</a> - hence the <code>actionban</code> lines. </p>
<p>It would make sense to create a local Ansible config and local hosts file to keep everything contained to the current repo/directory. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim ansible.cfg</span><br></pre></td></tr></table></figure>
<p>Point Ansible commands to use a local <code>hostfile</code> named <code>hosts</code>. </p>
<figure class="highlight yml"><figcaption><span>ansible.cfg </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[defaults]</span></span><br><span class="line"><span class="string">hostfile</span> <span class="string">=</span> <span class="string">hosts</span></span><br></pre></td></tr></table></figure>
<p>Create the local “hosts” file in turn. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim hosts</span><br></pre></td></tr></table></figure>
<p>The <code>hosts</code> file needs to then contain your target host’s details, using Ansible YAML syntax such as:</p>
<figure class="highlight yml"><figcaption><span>hosts </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[fail2ban-hosts]</span></span><br><span class="line"><span class="string">host-one</span> <span class="string">ansible_host=your.vps.ip.address</span> <span class="string">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class="line"><span class="string">host-two</span> <span class="string">ansible_host=your.vps.ip.address</span> <span class="string">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class="line"><span class="string">host-three</span> <span class="string">ansible_host=your.vps.ip.address</span> <span class="string">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class="line"><span class="comment"># Add more hosts here as needed.</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Currently Ansible uses Python 2.7 system libraries, and most Ubuntu images have Python 3.0+ installed. So this “interpreter” variable is usually necessary to access the correct libraries with Ansible.  </p>
</blockquote>
<p>Running the playbook on the remote host (or set of remote hosts) is then rather easy. </p>
<p>Make sure to include <code>-K</code> for the playbook’s <code>become:</code> password. Substitution for your own username (<code>scarlz</code> in my case) is also necessary - the user must have <em>sudo</em> privileges. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -u scarlz -K fail2ban-playbook.yml</span><br></pre></td></tr></table></figure>
<p>These few steps are for all intents and purposes everything that’s needed in a basic working install. For a less simplistic approach to installing Fail2ban, take a look at it again through the perspective of a more complex Ansible role instead:</p>
<blockquote>
</blockquote>
<p>This was very short and terse due to its simplicity, but thanks for reading. </p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://stackoverflow.com/questions/26469896/how-to-install-fail2ban-using-ansible" target="_blank" rel="external">Stack Overflow – How to Install Fail2ban using Ansible</a></li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/Security/" class="post__tag__link">Security</a></li><li class="post__tag__item"><a href="/tags/Ubuntu/" class="post__tag__link">Ubuntu</a></li><li class="post__tag__item"><a href="/tags/Bionic/" class="post__tag__link">Bionic</a></li></ul><a href="/2018/05/19/ansible-fail2ban-playbook/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><div class="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript></div></div></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2018 Scarlz</div><menu class="page-menu u-fr"><li class="page-menu__item"><a title="Previous" href="/2018/05/23/ansible-fail2ban-role/" class="page-menu__link icon-arrow-left"></a></li><li class="page-menu__item"><a title="Next" href="/2018/05/18/fail2ban-installing-bionic/" class="page-menu__link icon-arrow-right"></a></li></menu></footer><script>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src="//"+l+".disqus.com/"+k+".js",i.parentNode.insertBefore(j,i)})
(document,"script","totts","embed");
</script></body></html>