<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="Linux System Administration"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="C.J. Scarlett" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Installing Fail2ban with an Ansible Role on Ubuntu 18.04 (Bionic Beaver) - C.J. Scarlett</title><link rel="stylesheet" href="/css/main.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">C.J. Scarlett</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/topics" class="head-nav__link">Topics</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="/misc" class="head-nav__link">Misc</a></li><li class="head-nav__item"><a href="/about" class="head-nav__link">About</a></li><li class="head-nav__item"><a href="/contact" class="head-nav__link">Contact</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2018-05-22T23:00:00.000Z" class="post__time">May 23, 2018</time><h1 class="post__title"><a href="/2018/05/23/ansible-fail2ban-role/">Installing Fail2ban with an Ansible Role on Ubuntu 18.04 (Bionic Beaver)</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/klPwJ5E.png" alt="Fail2ban Logo with Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>The Ansible role in question comes from Ansible Galaxy. It’s linked here below, where you can read about it more if needs be:</p>
<blockquote>
<p><a href="https://galaxy.ansible.com/tersmitten/fail2ban/" target="_blank" rel="external">https://galaxy.ansible.com/tersmitten/fail2ban/</a></p>
</blockquote>
<p>Here’s my method for making use of the role, which is within the context of an Ansible project that already automates the other aspects of setting up a server. It’s necessary to have a provisioning playbook already in place, so you can incorporate the role shown in this post into the main project.  </p>
<blockquote>
<p><a href="https://www.tricksofthetrades.net/2017/08/21/ansible-playbook-server-provisioning/">If this idea of “context” doesn’t make much sense then check out this other post I have on provisioning a server with Ansible for Debian 8 (Jessie).</a></p>
</blockquote>
<a id="more"></a>
<hr>
<h2 id="1-–-Acquiring-the-Files"><a href="#1-–-Acquiring-the-Files" class="headerlink" title="1 – Acquiring the Files"></a>1 – Acquiring the Files</h2><p>Starting from within the <em>root</em> directory of your own Ansible server <em>“provisioning”</em> project (most likely a version controlled project). </p>
<p>Clone the <code>ansible-fail2ban</code> repo from GitHub into your project:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/Oefenweb/ansible-fail2ban.git roles/fail2ban</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Alternatively you can use <code>ansible-galaxy install --roles-path roles/ tersmitten.fail2ban</code> if you don’t mind the directory name for the role being <code>tersmitten.fail2ban</code> </p>
</blockquote>
<p>Include the new role in your <strong>main</strong> playbook file’s list of roles to be performed on the host(s).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim playbook.yml</span><br></pre></td></tr></table></figure>
<p>Such as in this generic bare bones example here:</p>
<figure class="highlight yml"><figcaption><span>playbook.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">provision</span> <span class="string">ubuntu</span> <span class="number">18.04</span> <span class="string">(bionic</span> <span class="string">beaver)</span> <span class="string">servers</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">base</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">users</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ufw</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ntp</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> It does need to match the actual role directory name, so change this entry here to <code>tersmitten.fail2ban</code> if you instead used the Ansible galaxy install command earlier.</p>
</blockquote>
<hr>
<h2 id="2-–-Editing-the-Default-Ansible-Variables"><a href="#2-–-Editing-the-Default-Ansible-Variables" class="headerlink" title="2 – Editing the Default Ansible Variables"></a>2 – Editing the Default Ansible Variables</h2><p>Several default values for many Fail2ban configuration directives are already set in the role’s <code>defaults</code> directory. </p>
<p>Edit them as normal with your preferred fail2ban configuration values.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim roles/fail2ban/defaults/main.yml</span><br></pre></td></tr></table></figure>
<p>These are the general contents including one or two additions, removals, and changes of my own:</p>
<figure class="highlight yml"><figcaption><span>defaults/main.yml </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># defaults file for fail2ban</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">fail2ban_loglevel:</span> <span class="string">'INFO'</span> </span><br><span class="line"><span class="attr">fail2ban_logtarget:</span> <span class="string">/var/log/fail2ban.log</span></span><br><span class="line"><span class="attr">fail2ban_syslog_target:</span> <span class="string">/var/log/fail2ban.log</span></span><br><span class="line"><span class="attr">fail2ban_syslog_facility:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">fail2ban_socket:</span> <span class="string">/var/run/fail2ban/fail2ban.sock</span></span><br><span class="line"><span class="attr">fail2ban_pidfile:</span> <span class="string">/var/run/fail2ban/fail2ban.pid</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fail2ban_sendername:</span> <span class="string">'Fail2ban'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fail2ban_ignoreips:</span></span><br><span class="line"><span class="bullet"> -</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">/8</span></span><br><span class="line"><span class="attr">fail2ban_bantime:</span> <span class="number">3600</span></span><br><span class="line"><span class="attr">fail2ban_maxretry:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">fail2ban_findtime:</span> <span class="number">600</span></span><br><span class="line"><span class="attr">fail2ban_backend:</span> <span class="string">auto</span></span><br><span class="line"><span class="attr">fail2ban_destemail:</span> <span class="string">root@localhost</span></span><br><span class="line"><span class="attr">fail2ban_banaction:</span> <span class="string">ufw.conf</span></span><br><span class="line"><span class="attr">fail2ban_mta:</span> <span class="string">sendmail</span></span><br><span class="line"><span class="attr">fail2ban_protocol:</span> <span class="string">tcp</span></span><br><span class="line"><span class="attr">fail2ban_chain:</span> <span class="string">INPUT</span></span><br><span class="line"><span class="attr">fail2ban_action:</span> <span class="string">'%(action_)s'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fail2ban_services:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">sshd</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">ssh</span></span><br><span class="line"><span class="attr">    maxretry:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    bantime:</span> <span class="bullet">-1</span></span><br></pre></td></tr></table></figure>
<p>These Ansible variables are applied onto the target host through two Jinja templates. Variables here are split into one of these two files (see the template files themselves for specifics). New variables you wish to incorporate have to be added to <code>defaults/main.yml</code> <strong>and</strong> the relevant Jinja template file if not present.  </p>
<blockquote>
<p><a href="https://github.com/Oefenweb/ansible-fail2ban#variables" target="_blank" rel="external">Here’s the reference for the Ansible variables on offer, used by this role.</a> </p>
</blockquote>
<p>You could also override them in the <code>vars/main.yml</code> file too, if that seems more appealing, but do not define duplicate variables.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim roles/fail2ban/vars/main.yml</span><br></pre></td></tr></table></figure>
<p>This is the same common SSH daemon jail I added earlier, but in the alternative file:</p>
<figure class="highlight yml"><figcaption><span>roles/fail2ban/vars/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vars file for fail2ban</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">fail2ban_dependencies:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">fail2ban</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fail2ban_services:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">sshd</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">ssh</span></span><br><span class="line"><span class="attr">    maxretry:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    bantime:</span> <span class="bullet">-1</span></span><br></pre></td></tr></table></figure>
<p>Remember not to duplicate variables between these two files!</p>
<p>So regardless of the file you choose, new jails must be included as part of the one <code>fail2ban_services:</code> variable.</p>
<p>For example, adding a second Nginx jail:</p>
<figure class="highlight yml"><figcaption><span>example.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">fail2ban_services:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">sshd</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">ssh</span></span><br><span class="line"><span class="attr">    maxretry:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    bantime:</span> <span class="bullet">-1</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">nginx-http-auth</span></span><br><span class="line"><span class="attr">    filter:</span> <span class="string">nginx-http-auth</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">http,https</span></span><br><span class="line"><span class="attr">    logpath:</span> <span class="string">/var/log/nginx/access.log</span></span><br></pre></td></tr></table></figure>
<p>The next section glosses over how the tasks of the role actually work. </p>
<hr>
<h2 id="3-–-Examining-the-Role’s-Tasks"><a href="#3-–-Examining-the-Role’s-Tasks" class="headerlink" title="3 – Examining the Role’s Tasks"></a>3 – Examining the Role’s Tasks</h2><p>Taking a glance at the <code>tasks/main.yml</code> is worthwhile. It explains how the variables from the previous section are implemented, alongside the Jinja file templates, that are to be processed and copied across. </p>
<p>The first block of YAML is a task that creates/copies the local version of <strong>the main Fail2ban configuration file,</strong> onto the target. </p>
<figure class="highlight yml"><figcaption><span>tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">update</span> <span class="string">configuration</span> <span class="string">file</span> <span class="bullet">-</span> <span class="string">/etc/fail2ban/fail2ban.local</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">etc/fail2ban/fail2ban.local.j2</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/fail2ban/fail2ban.local</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="number">0644</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">configuration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban-configuration</span></span><br></pre></td></tr></table></figure>
<p>The second block of YAML is a task that creates/copies the local version of <strong>the Fail2ban jail configuration file,</strong> again onto the target. </p>
<figure class="highlight yml"><figcaption><span>tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">update</span> <span class="string">configuration</span> <span class="string">file</span> <span class="bullet">-</span> <span class="string">/etc/fail2ban/jail.local</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">etc/fail2ban/jail.local.j2</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/fail2ban/jail.local</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="number">0644</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">configuration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban-configuration</span></span><br></pre></td></tr></table></figure>
<p>The third task block only runs when the <code>fail2ban_filterd_path</code> variable is set. Which assigns the path to the directory containing custom “filter” files, that you need copying across. </p>
<figure class="highlight yml"><figcaption><span>tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">copy</span> <span class="string">filters</span></span><br><span class="line"><span class="attr">  copy:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">"<span class="template-variable">&#123;&#123; fail2ban_filterd_path &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/fail2ban/filter.d/</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="number">0644</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">fail2ban_filterd_path</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">configuration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban-filters</span></span><br></pre></td></tr></table></figure>
<p>The next task block only runs when the <code>fail2ban_actiond_path</code> variable is set. Which assigns the local path to the directory containing custom “actions” files, that you need copying across. </p>
<figure class="highlight yml"><figcaption><span>tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">copy</span> <span class="string">actions</span></span><br><span class="line"><span class="attr">  copy:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">"<span class="template-variable">&#123;&#123; fail2ban_actiond_path &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/fail2ban/action.d/</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="number">0644</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">fail2ban_actiond_path</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">configuration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban-actions</span></span><br></pre></td></tr></table></figure>
<p>And the final task displayed here runs when the <code>fail2ban_actiond_jail</code> variable is set. Similarily this defines the local path to the directory containing custom “jail” configs. </p>
<figure class="highlight yml"><figcaption><span>tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">copy</span> <span class="string">jails</span></span><br><span class="line"><span class="attr">  copy:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">"<span class="template-variable">&#123;&#123; fail2ban_jaild_path &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/fail2ban/jail.d/</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="number">0644</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">fail2ban_jaild_path</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">configuration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban-jails</span></span><br></pre></td></tr></table></figure>
<p>Hopefully this all makes sense, explaining how the role is written and used.</p>
<hr>
<h2 id="4-–-Testing-and-Running-the-Playbook-Role"><a href="#4-–-Testing-and-Running-the-Playbook-Role" class="headerlink" title="4 – Testing and Running the Playbook Role"></a>4 – Testing and Running the Playbook Role</h2><p>After all of this is in place, test the new role by running your playbook. </p>
<p>This could be either as part of a Vagrant VM, Docker container, or on a live host. </p>
<p>From a live host’s perspective, on a blank Ubuntu 18.04 Bionic server, and using the global <code>hosts</code> file with all the hosts defined beforehand, un a syntax check on the playbook to ensure it’s all legit.  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook playbook.yml --syntax-check</span><br></pre></td></tr></table></figure>
<p>No errors in terms of the written contents means you’re good to actually run the playbook. </p>
<p>But wait, in order to examine how the role’s tasks play out (yay puns), without actually implementing anything remotely, there’s the <code>--check</code> option. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook <span class="_">-l</span> <span class="built_in">test</span>-host -u root playbook.yml --check</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Some modules cannot properly complete their operations in “–check” mode so may  fail (e.g. the user module when attempting to create encrypted system passwords for users).</p>
</blockquote>
<p>This is optional but a convenient way of seeing the results before actually committing, so to speak.</p>
<p>Now we’re certain everything’s as it should be, here’s the command to directly run the playbook, and in turn the Fail2ban installation role. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook <span class="_">-l</span> <span class="built_in">test</span>-host -u root playbook.yml</span><br></pre></td></tr></table></figure>
<p>A bonus idea is to <em>“tag”</em> your roles in the main playbook using this form of syntax on line 10:</p>
<figure class="highlight yml"><figcaption><span>playbook.yml </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">provision</span> <span class="string">ubuntu</span> <span class="number">18.04</span> <span class="string">(bionic</span> <span class="string">beaver)</span> <span class="string">droplets</span> </span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fixes</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">base</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">users</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ufw</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;role:</span> <span class="string">'fail2ban'</span><span class="string">,</span> <span class="attr">tags:</span> <span class="string">'fail2ban'</span><span class="string">&#125;</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ntp</span></span><br></pre></td></tr></table></figure>
<p>Which allows you to run <strong>only</strong> this role at playbook runtime, excluding the other listed roles. </p>
<p>So once tagged (in regards to the above), execute the playbook and specify the “fail2ban” tagging:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook <span class="_">-l</span> <span class="built_in">test</span>-host -u root playbook.yml --tags <span class="string">"fail2ban"</span> --check</span><br></pre></td></tr></table></figure>
<p>This is once again useful for selective testing purposes.  </p>
<blockquote>
<p><strong>Note:</strong> From what I can tell there’s no inbuilt function in Ansible to run select individual roles in a playbook, other than this <code>tags:</code> directive, unfortunately.</p>
</blockquote>
<p>Check the two files in the remote server’s <code>/etc/fail2ban</code> to see the applied directives from our <code>defaults/main.yml</code> file. This is the best way of confirming the changes we wanted are now in effect; Ansible does confirm and show changes during it’s task execution though!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo less /etc/fail2ban/jail.local</span><br><span class="line">$ sudo less /etc/fail2ban/fail2ban.local</span><br></pre></td></tr></table></figure>
<p>Another brief post I may publish in the future, will go into detail on some further examples of jail configs, for various services. </p>
<p>Thanks!</p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://blog.ssdnodes.com/blog/tutorial-a-more-secure-ansible-playbook-part-2/" target="_blank" rel="external">ServerWise – Tutorial: A More Secure Ansible Playbook, Part 2</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_checkmode.html" target="_blank" rel="external">Official Ansible Documentation – Check Mode (“Dry Run”)</a></li>
<li><a href="https://stackoverflow.com/questions/38350674/ansible-can-i-execute-role-from-command-line#38384205" target="_blank" rel="external">Stack Overflow – Ansible: Can I execute a role from the command line?</a></li>
</ul>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/Security/" class="post__tag__link">Security</a></li><li class="post__tag__item"><a href="/tags/Ubuntu/" class="post__tag__link">Ubuntu</a></li><li class="post__tag__item"><a href="/tags/Bionic/" class="post__tag__link">Bionic</a></li></ul><a href="/2018/05/23/ansible-fail2ban-role/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><div class="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript></div></div></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2018 Scarlz</div><menu class="page-menu u-fr"><li class="page-menu__item"><a title="Previous" href="/2018/08/30/exa-getting-started/" class="page-menu__link icon-arrow-left"></a></li><li class="page-menu__item"><a title="Next" href="/2018/05/19/ansible-fail2ban-playbook/" class="page-menu__link icon-arrow-right"></a></li></menu></footer><script>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src="//"+l+".disqus.com/"+k+".js",i.parentNode.insertBefore(j,i)})
(document,"script","totts","embed");
</script></body></html>