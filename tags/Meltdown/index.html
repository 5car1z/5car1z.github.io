<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="Linux System Administration"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="atom.xml" title="C.J. Scarlett" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Meltdown - C.J. Scarlett</title><link rel="stylesheet" href="/css/main.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">C.J. Scarlett</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/topics" class="head-nav__link">Topics</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="/misc" class="head-nav__link">Misc</a></li><li class="head-nav__item"><a href="/about" class="head-nav__link">About</a></li><li class="head-nav__item"><a href="/contact" class="head-nav__link">Contact</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2018-02-03T00:00:00.000Z" class="post__time">February 3, 2018</time><h1 class="post__title"><a href="/2018/02/03/spectre-meltdown-ansible/">Deploying Meltdown and Spectre Fixes with Ansible on Linux Hosts</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/TEnht2h.jpg" alt="Spectre &amp; Meltdown Logos"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>As it stands the current “fixes” for <a href="https://meltdownattack.com/" target="_blank" rel="external">Meltdown and Spectre</a> mainly involve updating and upgrading hosts to include their patched kernel upgrades. When it comes to applying the updates to multiple Linux servers, one approach is to use the playbook/plays in this “lockdown” repo from Ansible. </p>
<blockquote>
<p><a href="https://github.com/ansible/ansible-lockdown/blob/master/meltdown-spectre-linux.yml" target="_blank" rel="external">https://github.com/ansible/ansible-lockdown/blob/master/meltdown-spectre-linux.yml</a></p>
</blockquote>
<p>This is how the YAML works to patch the aforementioned exploits. </p>
<a id="more"></a>
<hr>
<p>First off for the hosts directive, either the default <code>all</code> hosts is used or any hosts provided <code>-i</code> when running <code>ansible-playbook</code> take precedence. The tasks are to be carried out with <code>become:</code> and thereby super user privileges. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://meltdownattack.com</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Patch</span> <span class="string">Linux</span> <span class="string">systems</span> <span class="string">against</span> <span class="string">Meltdown</span> <span class="string">and</span> <span class="string">Spectre</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">"<span class="template-variable">&#123;&#123; target_hosts | default('all') &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">  become:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>
<p>Variables are defined ready for use later on in the tasks section. </p>
<p><code>reboot_after_update:</code> is set to <code>no</code> but should be set to “yes” where possible by yourself. The reason for this is covered properly towards the end of these explanations. </p>
<p><code>packages:</code> contains the required kernel package versions for each respective Linux distro. Most of the Debian/Ubuntu entries are empty with the exception of Debian 9 (the latest stable version) which contains the specific kernel package.  </p>
<p>The empty values may be updated by the maintainers at some point, but you can add in the kernel packages yourself for the empty ones. I’ve done this in the next code snippet, from the information given at these two links:</p>
<blockquote>
<p><a href="https://www.debian.org/security/2018/dsa-4078" target="_blank" rel="external">https://www.debian.org/security/2018/dsa-4078</a><br><a href="https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/SpectreAndMeltdown" target="_blank" rel="external">https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/SpectreAndMeltdown</a></p>
</blockquote>
<p>These kernel packages are in essence the only Meltdown and or Spectre <em>“fixes”</em> currently available. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">vars:</span></span><br><span class="line"><span class="attr">  reboot_after_update:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">  packages:</span></span><br><span class="line">    <span class="comment"># https://access.redhat.com/security/vulnerabilities/speculativeexecution</span></span><br><span class="line"><span class="attr">    RedHat7:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kernel-3.10.0-693.11.6.el7</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">microcode_ctl-2.1-22.2.el7</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">perf-3.10.0-693.11.6.el7</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">python-perf-3.10.0-693.11.6.el7</span></span><br><span class="line"><span class="attr">    RedHat6:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kernel-2.6.32-696.18.7.el6</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kernel-firmware-2.6.32-696.18.7.el6</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">perf-2.6.32-696.18.7.el6</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">python-perf-2.6.32-696.18.7.el6</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># https://www.debian.org/security/2018/dsa-4078</span></span><br><span class="line"><span class="attr">    Debian7:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-3.2.0-5-amd64</span></span><br><span class="line"><span class="attr">    Debian8:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-3.16.0-5-amd64</span></span><br><span class="line"><span class="attr">    Debian9:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-4.9.0-5-amd64</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/SpectreAndMeltdown</span></span><br><span class="line"><span class="attr">    Ubuntu14:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-3.13.0-141-generic</span></span><br><span class="line"><span class="attr">    Ubuntu16:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-4.4.0-112-generic</span> </span><br><span class="line"><span class="attr">    Ubuntu17:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-4.13.0-31-generic</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Please remember that this is as things stand right now with the kernel patching in late January, so these version numbers are always subject to change as new fixes are released. </p>
</blockquote>
<p>There are two tasks in total. One for each type of package manager in use on the various distros. </p>
<p>When Yum is detected on the host by Ansible, the first task is executed and the distro packages defined previously are referenced for installation. This is done using the <code>ansible_os_family</code> and <code>ansible_distribution_major_version</code> system fact variables - the distro name and version number respectively.  </p>
<p>A handler is then called to reboot the host (explained later on).</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">RHEL</span> <span class="string">| Install kernel updates</span><br><span class="line"></span><span class="attr">    yum:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">"<span class="template-variable">&#123;&#123; packages[ansible_os_family ~ ansible_distribution_major_version] &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">      state:</span> <span class="string">present</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">ansible_pkg_mgr</span> <span class="string">==</span> <span class="string">'yum'</span></span><br><span class="line"><span class="attr">    notify:</span> <span class="string">reboot</span> <span class="string">system</span></span><br></pre></td></tr></table></figure>
<p>If Aptitude (<code>apt</code>) is detected on the host in place of Yum, the second task is run instead. Which uses a similar process. The distro type and version number are sourced from the start in order to install the correct packages (like in the other task), whilst the package index is updated via <code>update_cache:</code>.  </p>
<p>As before the host is then rebooted via the handler (more on that now, as promised). </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">DEBIAN</span> <span class="string">| Install kernel updates</span><br><span class="line"></span><span class="attr">  apt:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">"<span class="template-variable">&#123;&#123; item &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">    state:</span> <span class="string">present</span></span><br><span class="line"><span class="attr">    update_cache:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">    cache_valid_time:</span> <span class="number">3600</span></span><br><span class="line"><span class="attr">  with_items:</span> <span class="string">"<span class="template-variable">&#123;&#123; packages[ansible_distribution ~ ansible_distribution_major_version] &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">ansible_pkg_mgr</span> <span class="string">==</span> <span class="string">'apt'</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">reboot</span> <span class="string">system</span></span><br></pre></td></tr></table></figure>
<p>If the variable <code>reboot_after_update</code> from the start is set to <code>yes</code> or true. The host(s) will reboot at the end of each task run, as the handler is called. </p>
<p>This is here as it’s necessary to reboot the system to begin using the new kernel changes brought in for the Spectre/Meltdown exploits. So you should set <code>reboot_after_update</code> to “yes” at the start of the file, as long as it’s safe to do so in terms of node availability and uptime. </p>
<p>Lastly <code>async:</code> allows the shutdown command to run for a maximum of <code>15</code> seconds, but also <code>poll:</code> tells Ansible to check constantly for its completion. This is all so Ansible moves on and doesn’t idle from the node’s system shutdown.  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">handlers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">reboot</span> <span class="string">system</span></span><br><span class="line"><span class="attr">    shell:</span> <span class="string">sleep</span> <span class="number">3</span><span class="string">;</span> <span class="string">reboot</span></span><br><span class="line"><span class="attr">    async:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">    poll:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">reboot_after_update</span></span><br></pre></td></tr></table></figure>
<p>It might be better to download the repository itself but if you want the <code>meltdown-spectre-linux.yml</code> file I showed here (with all the kernel package versions added in) use this Gist instead:</p>
<script src="https://gist.github.com/5car1z/ddbb17cb763d5aedf129732213febac4.js"></script>

<blockquote>
<p><strong>Warning:</strong> Be aware that the “reboot” variable is set to yes in this Gist. </p>
</blockquote>
<p>Run the file against your desired host groups or host patterns as normal, adding a <code>-K</code> sudo password or <code>-u</code> user switch if relevant e.g. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook <span class="_">-l</span> webservers meltdown-spectre-linux.yml -K</span><br></pre></td></tr></table></figure>
<p>Then watch Ansible check and update the kernel packages on each host. Oh and <code>uname -r</code> reveals the kernel package in use by your current node. </p>
<p>Thanks to <a href="https://www.ansible.com/blog/author/sam-doran" target="_blank" rel="external">Sam Doran</a> for the plays and the Ansible repository this is taken from. </p>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Meltdown/" class="post__tag__link">Meltdown</a></li><li class="post__tag__item"><a href="/tags/Spectre/" class="post__tag__link">Spectre</a></li></ul><a href="/2018/02/03/spectre-meltdown-ansible/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2018-01-11T00:00:00.000Z" class="post__time">January 11, 2018</time><h1 class="post__title"><a href="/2018/01/11/kernel-update-for-meltdown-spectre/">Kernal Updates for Meltdown and Spectre CPU Exploits</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/TEnht2h.jpg" alt="Meltdown and Spectre Logos"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>As updating the target hosts system packages to their latest versions includes the kernel updates, this is in general the easiest way to bring in any <a href="https://meltdownattack.com/" target="_blank" rel="external">Meltdown and Spectre</a> fixes. A reboot is required after the updates for kernel changes to take effect. </p>
<p>Without configuration management or any automation tools it’s pretty simple.</p>
<a id="more"></a>
<hr>
<p>On Debian and Ubuntu:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get dist-upgrade</span><br><span class="line">$ sudo reboot</span><br></pre></td></tr></table></figure>
<p>On RPM based distros like Redhat and CentOS this would be:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum update</span><br><span class="line">$ sudo reboot</span><br></pre></td></tr></table></figure>
<p>On Fedora it’s <code>dnf</code> instead:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo dnf update</span><br><span class="line">$ sudo reboot</span><br></pre></td></tr></table></figure>
<hr>
<p>Further updates, more information, and perhaps even a targeted approach to circumventing these exploits could be available in the future. So keep up to date with both of the two issues as best as possible.</p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-protect-your-server-against-the-meltdown-and-spectre-vulnerabilities" target="_blank" rel="external">DigitalOcean - How To Protect Your Server Against the Meltdown and Spectre Vulnerabilities</a></li>
<li><a href="https://www.cyberciti.biz/faq/patch-meltdown-cpu-vulnerability-cve-2017-5754-linux/" target="_blank" rel="external">Nixcraft: How to patch Meltdown CPU Vulnerability CVE-2017-5754 on Linux</a></li>
<li><a href="https://www.cyberciti.biz/faq/patch-spectre-vulnerability-cve-2017-5753-cve-2017-5715-linux/" target="_blank" rel="external">Nixcraft: How to patch Spectre Vulnerability CVE-2017-5753/CVE-2017-5715 on Linux</a></li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Security/" class="post__tag__link">Security</a></li><li class="post__tag__item"><a href="/tags/Meltdown/" class="post__tag__link">Meltdown</a></li><li class="post__tag__item"><a href="/tags/Spectre/" class="post__tag__link">Spectre</a></li></ul><a href="/2018/01/11/kernel-update-for-meltdown-spectre/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2018 Scarlz</div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"></span></li><li class="page-menu__item"><span title="Next" class="page-menu__link icon-arrow-right page-menu__link--disabled"></span></li></menu></footer><script>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src="//"+l+".disqus.com/"+k+".js",i.parentNode.insertBefore(j,i)})
(document,"script","totts","count");
</script></body></html>