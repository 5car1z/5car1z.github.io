<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="ToTT"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="atom.xml" title="Tricks of the Trades" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Python - Tricks of the Trades</title><link rel="stylesheet" href="/css/main.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">Tricks of the Trades</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="/trades" class="head-nav__link">Trades</a></li><li class="head-nav__item"><a href="/work" class="head-nav__link">Work</a></li><li class="head-nav__item"><a href="/about" class="head-nav__link">About</a></li><li class="head-nav__item"><a href="/contact" class="head-nav__link">Contact</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2017-04-09T23:00:00.000Z" class="post__time">April 10, 2017</time><h1 class="post__title"><a href="/2017/04/10/ansible-playbooks/">Ansible - Playbook Concepts (4)</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/9HBs9cy.png" alt="Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>Playbooks are written in YAML like the configuration files and are the basis for Ansible’s configuration management and en-masse multi-machine deployment. </p>
<p>These are very powerful not only for declaring server configurations but also to orchestrate steps of any manual ordered process, even when the different steps must bounce back and forth between sets of machines in any order, as playbooks can launch tasks synchronously or asynchronously as required.</p>
<p>While it’s suitable to use the <code>/usr/bin/ansible</code> program for ad-hoc commands and tasks. Playbooks are better kept in source control and used to push out larger configurations, or assure the configurations of your remote systems are still in check. </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Playbook-Examples"><a href="#1-–-Playbook-Examples" class="headerlink" title="1 – Playbook Examples"></a>1 – Playbook Examples</h1><p>Here are some initial examples of Ansible playbooks. A playbook by definition is composed of one or more <em>plays</em> in a list.</p>
<p>The goal of each play is to map a group of hosts to some well defined role, through actions within the play Ansible calls tasks. Put simply though, a task is nothing more than a call to a preset Ansible <a href="http://www.tricksofthetrades.net/2017/03/20/ansible-adhoc-modules/">module</a>. </p>
<p>By composing a playbook of multiple ‘plays’, it is possible to orchestrate multi-machine deployments. Running certain steps on all machines in the “webservers” group, then certain steps on the “databases” server group, and then more commands back on the “webservers” group, etc. </p>
<p>The first snippet and playbook sets up Apache web server on hosts in the <code>webservers</code> group. Notice the variables declared, remote user in use, and handlers towards the end. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    http_port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    max_clients:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=httpd</span> <span class="string">state=latest</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">write</span> <span class="string">the</span> <span class="string">apache</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=/srv/httpd.j2</span> <span class="string">dest=/etc/httpd.conf</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span> <span class="string">(and</span> <span class="string">enable</span> <span class="string">it</span> <span class="string">at</span> <span class="string">boot)</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>
<p>This second example uses tasks that have really long parameters, and modules that take many parameters. When this is the case you can break tasks items over multiple lines to improve the playbook readability and structure. Breaking up tasks is achieved by using YAML dictionaries to supply the modules with their <em>key=value</em> arguments.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    http_port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    max_clients:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line"><span class="attr">    yum:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">      state:</span> <span class="string">latest</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">write</span> <span class="string">the</span> <span class="string">apache</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    template:</span></span><br><span class="line"><span class="attr">      src:</span> <span class="string">/srv/httpd.j2</span></span><br><span class="line"><span class="attr">      dest:</span> <span class="string">/etc/httpd.conf</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">      state:</span> <span class="string">started</span></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">      service:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">        state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>
<p>This final example contains not just one but two plays. The first targets the <code>webservers</code> host group and the second targets the <code>databases</code> host group. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=httpd</span> <span class="string">state=latest</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">write</span> <span class="string">the</span> <span class="string">apache</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=/srv/httpd.j2</span> <span class="string">dest=/etc/httpd.conf</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">databases</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">postgresql</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=postgresql</span> <span class="string">state=latest</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">that</span> <span class="string">postgresql</span> <span class="string">is</span> <span class="string">started</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=postgresql</span> <span class="string">state=started</span></span><br></pre></td></tr></table></figure>
<p>See the <a href="https://github.com/ansible/ansible-examples" target="_blank" rel="external">ansible/ansible-examples</a> GitHub repository for some fully fledged and properly structured Playbook configuration examples. </p>
<hr>
<h1 id="2-–-Playbook-Hosts-and-Users"><a href="#2-–-Playbook-Hosts-and-Users" class="headerlink" title="2 – Playbook Hosts and Users"></a>2 – Playbook Hosts and Users</h1><p>For each “play” in a playbook, you get to choose the servers/hosts in your infrastructure you want to target, and which remote Linux user to complete the steps in the play as (remember the steps are called tasks).</p>
<p>The <code>hosts</code> line at the start of a play is a list of one or more groups, or if needed a <a href="http://docs.ansible.com/ansible/intro_patterns.html" target="_blank" rel="external">host pattern</a>. The <code>remote_user</code> holds the name of the target Linux/Unix user account.</p>
<p>For example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure>
<p>Remote users can also be set per task instead of just for the entire play. Such as in this example where the task <code>test connection</code> uses a different user to the overall play. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">test</span> <span class="string">connection</span></span><br><span class="line"><span class="attr">      ping:</span></span><br><span class="line"><span class="attr">      remote_user:</span> <span class="string">scarlz</span></span><br></pre></td></tr></table></figure>
<p>The <code>become</code> and <code>become_method</code> items allow a change of privileges from within the SSH user’s session. This is useful for using shell programs like <code>sudo</code> for tasks that need <a href="http://docs.ansible.com/ansible/become.html" target="_blank" rel="external">higher privileges</a>.</p>
<p>Like here: </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">scarlz</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span></span><br><span class="line"><span class="attr">      become:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      become_method:</span> <span class="string">sudo</span></span><br></pre></td></tr></table></figure>
<p>In these cases you must provide the necessary password using <code>--ask-become-pass</code> when running the playbook itself with <code>ansible-playbook</code> from the command line - covered later on. </p>
<p>Using <code>become_user</code> similarly allows a change of user from within the play’s SSH user shell session. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">scarlz</span></span><br><span class="line"><span class="attr">  become:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  become_user:</span> <span class="string">postgres</span></span><br></pre></td></tr></table></figure>
<p>Let’s look more at the tasks themselves and what they can do. </p>
<hr>
<h1 id="3-–-Playbook-Tasks"><a href="#3-–-Playbook-Tasks" class="headerlink" title="3 – Playbook Tasks"></a>3 – Playbook Tasks</h1><p>As seen each play contains its own list of tasks. Tasks are executed in order, one at a time, against all machines matched by the host group or pattern. So keep in mind that all hosts are going to receive and process the same task directives issued. </p>
<p>Also when running a playbook, any hosts that end up with failed tasks are taken out of the rotation for the entire playbook run. If things fail, simply correct the playbook file (or host connectivity issue) and rerun it.</p>
<p>As seen in the first section of this post, the goal of each task is to execute a module, with set variables passed to that module if needed. </p>
<p>Here is an omitted example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    http_port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    max_clients:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">make</span> <span class="string">sure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span></span><br></pre></td></tr></table></figure>
<p>Importantly though module use should also be “idempotent”. That is to say, when running a module multiple times in a sequence, it should have the same end result as if you had run it only once. One way to achieve this state of idem-potency in playbooks is to have a module check whether its desired final state has already been achieved, and if that state has been achieved, to instead exit without performing any actions. </p>
<p>So if all the modules a playbook uses are idempotent, then the playbook itself is likely to be idempotent too (overall), so re-running the playbook multiple times should be safe and not create any issues.</p>
<blockquote>
<p><strong>Note:</strong> The <code>command</code> and <code>shell</code> modules will typically rerun the same command issued again, which is fine if the command is something that does not change the outcome of its initial execution, when run multiple times. There is also a “creates” flag available here which can be used to make these two modules idempotent. </p>
</blockquote>
<p>Furthermore every task should have a <code>name</code>, which is included in the output from running the playbook, and serves as more of a description than a moniker. Due to this It is useful to provide good descriptions for each task step. </p>
<blockquote>
<p><strong>Note:</strong> If a <code>name</code> is not provided, the string fed to ‘action’ will be used for output.</p>
</blockquote>
<p>As with most modules, the <code>service</code> module takes arguments in the key=value format.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">make</span> <span class="string">sure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span></span><br></pre></td></tr></table></figure>
<p>The <code>command</code> and <code>shell</code> modules are the only modules that take a list of arguments and don’t use the key=value form as normal. </p>
<p>This makes them work in the same way as you would expect them to on the command line e.g. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">disable</span> <span class="string">selinux</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">/sbin/setenforce</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>The <code>command</code> and <code>shell</code> module care about return codes, so if you have a command where the successful exit code is not zero, you can alter it to this:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line"><span class="attr">    shell:</span> <span class="string">/usr/bin/somecommand</span> <span class="string">||</span> <span class="string">/bin/true</span></span><br></pre></td></tr></table></figure>
<p>If the action line of the module is getting too long, you can break it on a space character and indent any continued lines to improve readability. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Copy</span> <span class="string">ansible</span> <span class="string">inventory</span> <span class="string">file</span> <span class="string">to</span> <span class="string">client</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=/etc/ansible/hosts</span> <span class="string">dest=/etc/ansible/hosts</span></span><br><span class="line">            <span class="string">owner=root</span> <span class="string">group=root</span> <span class="string">mode=0644</span></span><br></pre></td></tr></table></figure>
<p>Variables declared can be explicitly used in task action lines, not just in <em>templates</em> (templates not covered yet). </p>
<p>The variable is called using the word <code>vhost</code> inside of the curly braces, in the example below:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    vhost:</span> <span class="string">blog-site.conf</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">create</span> <span class="string">a</span> <span class="string">virtual</span> <span class="string">host</span> <span class="string">file</span> <span class="string">for</span> <span class="string">&#123;&#123;</span> <span class="string">vhost</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=somefile.j2</span> <span class="string">dest=/etc/httpd/conf.d/&#123;&#123;</span> <span class="string">vhost</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>To carry on the concept and practice introduced here of idem-potency in Ansible. The next section talks about <em>handlers</em>.</p>
<hr>
<h1 id="4-–-Playbook-Handlers"><a href="#4-–-Playbook-Handlers" class="headerlink" title="4 – Playbook Handlers"></a>4 – Playbook Handlers</h1><p>Modules should be idempotent as described in the last section, so they can relay back whether they have made a change on the remote system or not. Playbooks have the ability to recognise these changes and also have a basic event system that can be used to respond to change. </p>
<p><code>notify</code> actions are triggered at the end of each block of tasks in a play, and will only be triggered once. Even if notified and triggered by multiple different tasks. For instance, multiple resources may indicate that Apache needs to be restarted because they have changed a config file, but Apache will only be restarted once to avoid multiple unnecessary restarts.</p>
<p>Here’s an example of restarting two services in a task when the contents of a file change, but only if the file changes. The items listed in the notify section of the task are called handlers.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">template</span> <span class="string">configuration</span> <span class="string">file</span></span><br><span class="line"><span class="attr">  template:</span> <span class="string">src=template.j2</span> <span class="string">dest=/etc/foo.conf</span></span><br><span class="line"><span class="attr">  notify:</span></span><br><span class="line"><span class="bullet">     -</span> <span class="string">restart</span> <span class="string">memcached</span></span><br><span class="line"><span class="bullet">     -</span> <span class="string">restart</span> <span class="string">apache</span></span><br></pre></td></tr></table></figure>
<p>Handlers are lists of tasks (not really any different from regular tasks) that are referenced by a globally unique name, and are notified by notifiers. If a handler is never referenced/notified it will not run. As inferred earlier, regardless of how many tasks notify a handler, it will run only once, and after all of the tasks complete in a particular play.</p>
<p>Here’s an example of a <code>handlers</code> section with some defined tasks:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">memcached</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=memcached</span> <span class="string">state=restarted</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=apache</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="5-–-Running-Playbooks"><a href="#5-–-Running-Playbooks" class="headerlink" title="5 – Running Playbooks"></a>5 – Running Playbooks</h1><p>Now that you’ve learned much of the groundwork for playbook syntax, we should look at how to run a completed playbook. </p>
<p>To run a playbook use the <code>anisble-playbook</code> command followed by the path to the playbook file. In this scenario it’s in the current working directory and named <code>playbook.yml</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook playbook.yml <span class="_">-f</span> 10</span><br></pre></td></tr></table></figure>
<p>The <code>-f 10</code> specifies the usage of 10 simultaneous Ansible processes at once. </p>
<p>When executing a playbook there will always be a summary of the nodes/hosts that were targeted and how they fared with the instructions. General failures and fatal unreachable attempts by the playbook execution are kept separate in the “counts”.</p>
<p>The <code>--verbose</code> flag tagged onto the <code>ansible-playbook</code> command results in a more detailed account of the results of a playbook run. Furthermore the <code>--list-hosts</code> flag shows which hosts are to be affected by a playbook before you run it. </p>
<p>It’s possible to invert the architecture of Ansible, forcing nodes/hosts check in to a central location instead of pushing configuration out externally, by using the <code>ansible-pull</code> script. </p>
<p>Run the help option to see details on this if interested.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-pull --help</span><br></pre></td></tr></table></figure>
<p>As an aside, some say that Ansible playbook output is vastly upgraded if the <code>cowsay</code> package is installed on your system. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Debian / Ubuntu</span></span><br><span class="line">$ sudo apt-get install cowsay </span><br><span class="line"><span class="comment"># Arch Linux</span></span><br><span class="line">$ sudo pacman -S cowsay</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="7-–-Ansible-Templating"><a href="#7-–-Ansible-Templating" class="headerlink" title="7 – Ansible Templating"></a>7 – Ansible Templating</h1><p>Templates in Ansible are constructed using the Jinja2 Python templating language, and reside in their own files. They are capable of referencing variables from outside sources, such as from within the playbook using the template and the outer Ansible file inventory e.g. a <code>main.yml</code> file within an upper <code>/vars</code> directory.</p>
<p>Templates are typically useful for setting up configuration files, to make them and other files more versatile or reusable among playbooks. They can have any file name but the <code>.tpl</code> or <code>.j2</code> extensions are common. </p>
<p>Below is a template example for setting up an Apache virtual host. It uses a variable for setting up the document root on each Ansible host:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;VirtualHost *:80&gt;</span></span><br><span class="line">    <span class="attribute">ServerAdmin</span> webmaster@localhost</span><br><span class="line">    <span class="attribute"><span class="nomarkup">DocumentRoot</span></span> &#123;&#123; doc_root &#125;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">&lt;Directory &#123;&#123; doc_root &#125;&#125;&gt;</span></span><br><span class="line">        <span class="attribute">AllowOverride</span> <span class="literal">All</span></span><br><span class="line">        <span class="attribute">Require</span> <span class="literal">all</span> granted</span><br><span class="line">    <span class="section">&lt;/Directory&gt;</span></span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br></pre></td></tr></table></figure>
<p>The inbuilt module <code>template:</code> is used to apply a template file in a task. For example, if you named a template file <code>vhost.tpl</code> and you placed it inside the same directory as your playbook, this is how you would make use of the template to replace the default Apache virtual host, on your Ansible hosts:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Alter</span> <span class="string">the</span> <span class="string">default</span> <span class="string">Apache</span> <span class="string">virtual</span> <span class="string">host</span></span><br><span class="line"><span class="attr">  template:</span> <span class="string">src=vhost.tpl</span> <span class="string">dest=/etc/apache2/sites-available/000-default.conf</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="8-–-Roles-in-Playbooks"><a href="#8-–-Roles-in-Playbooks" class="headerlink" title="8 – Roles in Playbooks"></a>8 – Roles in Playbooks</h1><p>Roles work best for more complex playbooks that have many multiple but related tasks. Each role contains only the relevant data and information needed to carry out said tasks. As there are usually multiple stages to a task or set of tasks, playbooks can get very lengthy and congested with all their operations. So confining tasks to roles helps alleviate this problem. </p>
<p>As an example, a playbook that installs Nginx, likely involves adding the stable package repository, then installing the package itself, as well as setting up all the configuration for the web server. The final configuration step no doubt requires extra data such as variables, files, dynamic templates, and more. These are bet kept in their own role’s area.</p>
<p>The file-system for a role looks like the below, where <code>rolename</code> is the root directory, and the options are the subsequent directory areas for each piece of information. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">rolename</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">files</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">handlers</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">meta</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">templates</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">tasks</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">vars</span></span><br></pre></td></tr></table></figure>
<p>Within each of the individual directory areas above, Ansible will search for a <code>main.yml</code> file automatically. Any every piece of configuration for the role in question is contained within these locations. </p>
<hr>
<p>After understanding how each of these different concepts work together to create a playbook. You can go on to make your own from scratch, from other examples, or by converting your older setup scripts. </p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="http://docs.ansible.com/ansible/playbooks_intro.html" target="_blank" rel="external">Official Ansible Documentation - Intro to Playbooks</a> – Most of the base content for this post was garnered from here.</li>
<li><a href="https://www.digitalocean.com/community/tutorials/configuration-management-101-writing-ansible-playbooks" target="_blank" rel="external">Digital Ocean - Configuration Management 101: Writing Ansible Playbooks</a> – Some of the basic playbook examples and ideas are taken from this.</li>
<li><a href="https://serversforhackers.com/an-ansible-tutorial" target="_blank" rel="external">Servers for Hackers - An Ansible Tutorial</a> – Shows a great real world example for creating an Nginx playbook; among other things.</li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Python/" class="post__tag__link">Python</a></li></ul><a href="/2017/04/10/ansible-playbooks/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2017-03-20T00:00:00.000Z" class="post__time">March 20, 2017</time><h1 class="post__title"><a href="/2017/03/20/ansible-adhoc-modules/">Ansible - Ad Hoc Commands and Modules (3)</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/9HBs9cy.png" alt="Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>Several ad hoc commands were shown in the previous post but no real detail was given as to what they can fully offer. These <em>ad hoc</em> commands are often cited as being a good starter point for learning what’s possible with Ansible; without having to dive straight into writing a playbook. Most of them incorporate the use of a <em>module</em> into their structure, so this post introduces modules too. Both from the point of view of an ad hoc command, and within the context of a task. Towards the end, the “special” Ansible module types are shown. </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Ad-Hoc-Commands"><a href="#1-–-Ad-Hoc-Commands" class="headerlink" title="1 – Ad Hoc Commands"></a>1 – Ad Hoc Commands</h1><p>Sometimes you may not need nor want to write a fully fledged playbook for simple operations. Either way the concepts here for these commands port directly over to the playbook language for when you do begin writing them later on. These due to their impromptu nature and use,. </p>
<p>In their simplest form these commands are shell commands performed in parallel to each host by Ansible. </p>
<p>Here <code>coreservers</code> is the group name that contains several hosts and the ad hoc command <code>-a</code> we are running on them is <code>/sbin/reboot</code> using <code>10</code> Ansible forks. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers <span class="_">-a</span> <span class="string">"/sbin/reboot"</span> <span class="_">-f</span> 10 <span class="_">-s</span> -K</span><br></pre></td></tr></table></figure>
<p>The <code>-f 10</code> in the above specifies the usage of 10 simultaneous processes to use (10 hosts at a time). You can also set this as an assumed default in the configuration file to avoid setting it here. The default is set to 5, which is lacking and conservative, so feel free to increase this value to a more optimal number. </p>
<p>Ansible defaults to running from your current user account (or from any hosts variables). To change this pass in the <code>-u</code> option. Where <code>scarlz</code> is the username you want to run the command as. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers <span class="_">-a</span> <span class="string">"/usr/bin/foo"</span> -u scarlz</span><br></pre></td></tr></table></figure>
<p>When not calling raw programs on the node through Ansible, modules are the main choice for carrying out operations. </p>
<p>In general the <code>-m</code> option denotes a named module. Here is an example of the <code>shell</code> module that is used to issue precise commands on the Ansible node. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -u scarlz -m shell <span class="_">-a</span> <span class="string">'echo $TERM'</span></span><br></pre></td></tr></table></figure>
<p>There are a whole back-catalogue of these inbuilt modules for you to make use of. </p>
<hr>
<h1 id="2-–-Modules"><a href="#2-–-Modules" class="headerlink" title="2 – Modules"></a>2 – Modules</h1><p>Modules contain the actions or functionality we want to implement and run. Some commonly used modules are apt/yum, copy, ec2, file, service, template, and user. Like shown in the previous section, modules can be used in ad-hoc commands as well as “tasks”.  </p>
<h2 id="Copy"><a href="#Copy" class="headerlink" title="Copy"></a>Copy</h2><p>This command transfers a “hosts” file directly to all servers in the “coreservers” group, using SCP and the <code>copy</code> module:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -m copy <span class="_">-a</span> <span class="string">"src=/etc/hosts dest=/tmp/hosts"</span> <span class="_">-s</span> -K</span><br></pre></td></tr></table></figure>
<h2 id="File"><a href="#File" class="headerlink" title="File"></a>File</h2><p>The <code>file</code> module provides the ability to change system ownership and permissions on remote files. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -m file <span class="_">-a</span> <span class="string">"dest=/var/www/index.html mode=755 owner=scarlz group=www"</span> <span class="_">-s</span> -K</span><br></pre></td></tr></table></figure>
<p>To create directories with <code>file</code>, like when using the <code>mkdir -p</code> command in Linux, add the “directory” <code>state-directory</code> option.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -m file <span class="_">-a</span> <span class="string">"dest=/var/www/new-vhost-dir mode=755 owner=scarlz group=www state=directory"</span> <span class="_">-s</span> -K</span><br></pre></td></tr></table></figure>
<p>Delete directories recursively, and delete files through <code>file</code> with the <code>state=absent</code> option.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -m file <span class="_">-a</span> <span class="string">"dest=/path/to/delete state=absent"</span></span><br></pre></td></tr></table></figure>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>This module is referred to when you need to interact with the OS system services. Inclusive of  BSD init, OpenRC, SysV, Solaris SMF, systemd, and upstart.</p>
<p>As an example of how this could work, this starts Nginx via systemd:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -m service <span class="_">-a</span> <span class="string">"name=nginx.service state=started"</span> <span class="_">-s</span> -K</span><br></pre></td></tr></table></figure>
<p>Changing the state option changes the result - this is to restart:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -m service <span class="_">-a</span> <span class="string">"name=nginx.service state=restarted"</span> <span class="_">-s</span> -K</span><br></pre></td></tr></table></figure>
<p>The value of “state” must be one of either: running, started, stopped, restarted, or reloaded.</p>
<h2 id="Users-and-Groups"><a href="#Users-and-Groups" class="headerlink" title="Users and Groups"></a>Users and Groups</h2><p>A module named the “user” module serves as an interface to creating, removing, and manipulating system user accounts. </p>
<p>Altering a user’s password only requires the username, in this next example this is <code>scarlz</code>, then the new password for the user which is substituted in to the <code>&lt;user-password&gt;</code> field.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -m user <span class="_">-a</span> <span class="string">"name=scarlz password=&lt;user-password&gt;"</span></span><br></pre></td></tr></table></figure>
<p>Removing the user account completely, once again needs the username (<code>scarlz</code> in my case) as well as the value <code>absent</code> for the <code>state</code> option. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -m user <span class="_">-a</span> <span class="string">"name=scarlz state=absent"</span> <span class="_">-s</span> -K</span><br></pre></td></tr></table></figure>
<h2 id="Module-Index"><a href="#Module-Index" class="headerlink" title="Module Index"></a>Module Index</h2><p><a href="http://docs.ansible.com/ansible/modules_by_category.html" target="_blank" rel="external">Here’s a page from the official Ansible documentation</a> that acts as a catalogue for all the registered inbuilt modules available. There are many many modules, to cater for all specific needs. </p>
<hr>
<h1 id="3-–-Modules-in-Tasks"><a href="#3-–-Modules-in-Tasks" class="headerlink" title="3 – Modules in Tasks"></a>3 – Modules in Tasks</h1><p>Here are some examples of using the modules in a task (like you’d find in an Ansible playbook). </p>
<p>The file module (most shown before) creates a new directory to be used for caching purposes. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: add cache directory</span><br><span class="line">  file: path=/opt/cache state=directory</span><br></pre></td></tr></table></figure>
<p>The <code>apt</code> module handles packages for Ubuntu/Debian OS. The state option here designates that the install of Nginx should be implemented via apt-get, but the state value could also be replaced with <code>latest</code> (to update the package) or <code>absent</code> (to remove the package) instead. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: install nginx</span><br><span class="line">  yum name =nginx state=present</span><br></pre></td></tr></table></figure>
<p>This one’s pretty straight forward, and is the “task” equivalent of the ad hoc command from earlier. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: start nginx</span><br><span class="line">  service: name=nginx enabled=yes state=started</span><br></pre></td></tr></table></figure>
<p>One thing to notice here is with the <code>name:</code>  field. Tasks can be defined as anything you want here but should be descriptive. Tasks are simple and declarative, they aim to pass the correct arguments to the module calls, to achieve what is needed. </p>
<hr>
<h1 id="4-–-Special-Modules"><a href="#4-–-Special-Modules" class="headerlink" title="4 – Special Modules"></a>4 – Special Modules</h1><p>There are several modules that fall into their own category, that exist to provide special core use cases. The code examples here are in the form of a task you’d find within a playbook. </p>
<ul>
<li><code>command</code> module – Used for executing simple commands on remote nodes. (first example shown in step one). </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: Run the <span class="built_in">command</span> <span class="keyword">if</span> the specified file does not exist.</span><br><span class="line">  <span class="built_in">command</span>: /usr/bin/make_database.sh arg1 arg2 creates=/path/to/database</span><br></pre></td></tr></table></figure>
<ul>
<li><code>shell</code> module – Similar to the command module but allows the use of redirection, variables, and further operators. The <code>shell</code> module was also used in the first step. </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: Execute the <span class="built_in">command</span> <span class="keyword">in</span> remote shell; stdout goes to the specified file on the remote.</span><br><span class="line">  shell: somescript.sh &gt;&gt; somelog.txt</span><br></pre></td></tr></table></figure>
<ul>
<li><code>script</code> – Let’s you run a local script on a remote node - <strong>after transferring it.</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- script: /some/<span class="built_in">local</span>/script.sh --some-arguments 1234</span><br></pre></td></tr></table></figure>
<ul>
<li><code>raw</code> – Executes a low-down and dirty SSH command. Mainly used for installing Python versions onto hosts that do not already have it. </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: Bootstrap a legacy python 2.4 host</span><br><span class="line">  raw: yum -y install python-simplejson</span><br></pre></td></tr></table></figure>
<p>The examples uses Yum package manager, so is in the context of an enterprise Linux OS. </p>
<hr>
<p>With a basic understanding of how modules work within both ad hoc commands and tasks. It’s easy to now see how the bulk of an Ansible playbooks actions are laid out. </p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="http://docs.ansible.com/ansible/intro_adhoc.html" target="_blank" rel="external">Official Ansible Documentation - Introduction To Ad-Hoc Commands</a> – Has the bulk of the information contained in this post. </li>
<li><a href="https://serversforhackers.com/an-ansible-tutorial" target="_blank" rel="external">“Servers for Hackers” - An Ansible Tutorial</a> – Some context for some of the commands and the use of the options. </li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
<p><a href="https://serversforhackers.com/an-ansible-tutorial" target="_blank" rel="external">https://serversforhackers.com/an-ansible-tutorial</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Python/" class="post__tag__link">Python</a></li></ul><a href="/2017/03/20/ansible-adhoc-modules/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2016-06-26T23:00:00.000Z" class="post__time">June 27, 2016</time><h1 class="post__title"><a href="/2016/06/27/ansible-inventory-concepts/">Ansible - Inventory Concepts (2)</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/9HBs9cy.png" alt="Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>After outlining the initial installation and setup process in <a href="http://www.tricksofthetrades.net/2016/02/10/ansible-installing-running/">Ansible - Installing and Running (1)</a> I’m continuing in this post with a more precise look at how to handle the main hosts file. Specifically how to lay it out and add host variables or group variables to the mix. Dynamic inventory assets and development/production inventory layouts are not covered here and only alluded to or linked to. </p>
<p>Lastly splitting up the variable types and their definitions into their own YAML files is briefly introduced in the final step, and works best for more complex network hierarchies. </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Hosts-Inventory-File"><a href="#1-–-Hosts-Inventory-File" class="headerlink" title="1 –  Hosts Inventory File"></a>1 –  Hosts Inventory File</h1><p>As shown in “Ansible - Installing and Running (1)” Ansible operates by working simultaneously with multiple hosts in your infrastructure. It’s preferred way of doing this is to allocate hosts into different groups inside of the inventory file - <code>/etc/ansible/hosts</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ls /etc/ansible/</span><br><span class="line"></span><br><span class="line">ansible.cfg  hosts  hosts.orig  roles</span><br></pre></td></tr></table></figure>
<p>This file is completely configurable and can be expanded or broken up into multiple inventory files.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/ansible/hosts</span><br></pre></td></tr></table></figure>
<p>There’s a special form of inventory in Ansible known as <em>dynamic inventory</em> that refers to inventory files or asserts that get pulled down from the cloud, or other server side sources. This is not covered in this post however. </p>
<hr>
<h1 id="2-–-Hosts-and-Groups"><a href="#2-–-Hosts-and-Groups" class="headerlink" title="2 – Hosts and Groups"></a>2 – Hosts and Groups</h1><p>As seen in the first post, the INI style formatting for an Ansible hosts file looks similar to this:</p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[webservers]</span></span><br><span class="line"><span class="string">webremote.one.ip.address</span></span><br><span class="line"><span class="string">webremote.two.ip.address</span></span><br><span class="line"><span class="string">webremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[dbservers]</span></span><br><span class="line"><span class="string">dbremote.one.ip.address</span></span><br><span class="line"><span class="string">dbremote.two.ip.address</span></span><br><span class="line"><span class="string">dbremote.three.ip.address</span></span><br></pre></td></tr></table></figure>
<p>Square brackets <code>[ ]</code> contain a group name which is used to decide what systems you are controlling at what times and for what purpose. This makes it possible to apply actions to specific nodes/hosts as and when necessary. </p>
<p>Also systems (nodes/hosts) can be attributed under more than one group if needed, so in the snippet above one of the example nodes could be both a web server <strong>and</strong> a database server, added to both group entries in the file.</p>
<p>The hostnames can also be domain names instead of raw IP addresses if preferred, and when adding a large numbers of hosts if the domain names follow a similar numerical pattern, you can use ranges of numbers instead of adding them all individually. </p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[webservers]</span></span><br><span class="line"><span class="string">www[01:50].example.com</span></span><br></pre></td></tr></table></figure>
<p>Lastly hosts that run on non-standard SSH ports i.e. not <code>22</code> must have the their custom SSH port numbers inserted after the hostname separated by a colon.</p>
<p>For example:</p>
<p><code>webremote.one.ip.address:3675</code></p>
<p>Or instead defined through host/group variables (see next step). </p>
<hr>
<h1 id="3-–-Host-and-Group-Variables"><a href="#3-–-Host-and-Group-Variables" class="headerlink" title="3 – Host and Group Variables"></a>3 – Host and Group Variables</h1><p>Variables in the inventory file(s) are set on a host basis or group basis. There are many of these inbuilt variables on offer to the user when constructing the file. </p>
<p>Here is an example of two host variables, that explicitly tell Ansible to use SSH as the connection type, with a set username:</p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[webservers]</span></span><br><span class="line"><span class="string">webremote.one.ip.address</span> <span class="string">ansible_connection=ssh</span> <span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">webremote.two.ip.address</span> <span class="string">ansible_connection=ssh</span> <span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">webremote.three.ip.address</span> <span class="string">ansible_connection=ssh</span> <span class="string">ansible_user=username</span> </span><br><span class="line"></span><br><span class="line"><span class="string">[dbservers]</span></span><br><span class="line"><span class="string">dbremote.one.ip.address</span> <span class="string">ansible_connection=ssh</span> <span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">dbremote.two.ip.address</span> <span class="string">ansible_connection=ssh</span> <span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">dbremote.three.ip.address</span> <span class="string">ansible_connection=ssh</span> <span class="string">ansible_user=username</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> <code>username</code> would be replaced by the actual Ansible user on these hosts in the above.</p>
</blockquote>
<p>In the first post on Ansible I laid out these host variables and the file formatting differently, by using:</p>
<ul>
<li>An “empty” name for the hosts - <code>server-name-1</code></li>
<li>A host variable that then gives this name an IP address to refer to - <code>ansible_host=remote.one.ip.address</code></li>
<li>Another host variable with the specific username like in the previous example - <code>ansible_user=username</code></li>
<li>Then a final host variable that holds the custom SSH port to use when connecting to this host - <code>ansible_port=3980</code></li>
</ul>
<p>Here is what the layout looked like for this file:</p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[servers]</span></span><br><span class="line"><span class="string">server-name-1</span> <span class="string">ansible_host=remote.one.ip.address</span> <span class="string">ansible_user=username</span> <span class="string">ansible_port=3980</span> </span><br><span class="line"><span class="string">server-name-2</span> <span class="string">ansible_host=remote.one.ip.address</span> <span class="string">ansible_user=username</span> <span class="string">ansible_port=3980</span> </span><br><span class="line"><span class="string">server-name-3</span> <span class="string">ansible_host=remote.one.ip.address</span> <span class="string">ansible_user=username</span> <span class="string">ansible_port=3980</span></span><br></pre></td></tr></table></figure>
<p>Group variables allow extra options and settings like in the above to be applied to an entire group at once. Instead of having to set the same variables for each host when the value of the variables is the same. </p>
<p>These are defined by creating a new set of square brackets <code>[ ]</code> that contain the group name you wish to apply the variables to, followed by a <em>tag</em> that consists of a <code>:</code> and the term <code>vars</code> .</p>
<p>When put together using a group named “webservers” this makes - <code>[webservers:vars]</code> </p>
<p>The variables you want to apply to the group are then listed on separate lines - an example of all of this is shown in the below code snippet:</p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[webservers]</span></span><br><span class="line"><span class="string">webremote.one.ip.address</span></span><br><span class="line"><span class="string">webremote.two.ip.address</span></span><br><span class="line"><span class="string">webremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[webservers:vars]</span></span><br><span class="line"><span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">ansible_port=3980</span> </span><br><span class="line"><span class="string">ntp_server=ntp.example.com</span></span><br><span class="line"><span class="string">proxy=proxy.example.com</span></span><br><span class="line"></span><br><span class="line"><span class="string">[dbservers]</span></span><br><span class="line"><span class="string">dbremote.one.ip.address</span></span><br><span class="line"><span class="string">dbremote.two.ip.address</span></span><br><span class="line"><span class="string">dbremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[dbservers:vars]</span></span><br><span class="line"><span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">ansible_port=3980</span> </span><br><span class="line"><span class="string">ntp_server=ntp.example.com</span></span><br><span class="line"><span class="string">proxy=proxy.example.com</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="4-–-Groups-of-Groups"><a href="#4-–-Groups-of-Groups" class="headerlink" title="4 – Groups of Groups"></a>4 – Groups of Groups</h1><p>There’s a further way of making “groups out of groups” by using the <code>:children</code> tag. These can have group variables applied to them too by using the same method in the last step. To do this extra grouping, a new group name is created then suffixed with the <code>:children</code> tag which will contain the original groups defined.</p>
<p>Such as here:</p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[webservers-one]</span></span><br><span class="line"><span class="string">webremote.one.ip.address</span></span><br><span class="line"><span class="string">webremote.two.ip.address</span></span><br><span class="line"><span class="string">webremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[dbservers-one]</span></span><br><span class="line"><span class="string">dbremote.one.ip.address</span></span><br><span class="line"><span class="string">dbremote.two.ip.address</span></span><br><span class="line"><span class="string">dbremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[cluster-one:children]</span></span><br><span class="line"><span class="string">webservers-one</span></span><br><span class="line"><span class="string">dbservers-two</span></span><br></pre></td></tr></table></figure>
<p>To add group variables to this new group of a group, the new name is added to yet another group with the standard <code>:vars</code> tag.</p>
<p>Like at the bottom of this code snippet:</p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[webservers-one]</span></span><br><span class="line"><span class="string">webremote.one.ip.address</span></span><br><span class="line"><span class="string">webremote.two.ip.address</span></span><br><span class="line"><span class="string">webremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[dbservers-one]</span></span><br><span class="line"><span class="string">dbremote.one.ip.address</span></span><br><span class="line"><span class="string">dbremote.two.ip.address</span></span><br><span class="line"><span class="string">dbremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[cluster-one:children]</span></span><br><span class="line"><span class="string">webservers-one</span></span><br><span class="line"><span class="string">dbservers-two</span></span><br><span class="line"></span><br><span class="line"><span class="string">[cluster-one:vars]</span></span><br><span class="line"><span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">ansible_port=3980</span> </span><br><span class="line"><span class="string">ntp_server=ntp.example.com</span></span><br><span class="line"><span class="string">proxy=proxy.example.com</span></span><br></pre></td></tr></table></figure>
<p>The concept of grouping groups into more groups can theoretically go on indefinitely. Another level of grouping is added below to demonstrate:</p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[webservers-one]</span></span><br><span class="line"><span class="string">webremote.one.ip.address</span></span><br><span class="line"><span class="string">webremote.two.ip.address</span></span><br><span class="line"><span class="string">webremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[dbservers-one]</span></span><br><span class="line"><span class="string">dbremote.one.ip.address</span></span><br><span class="line"><span class="string">dbremote.two.ip.address</span></span><br><span class="line"><span class="string">dbremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[cluster-one:children]</span></span><br><span class="line"><span class="string">webservers-one</span></span><br><span class="line"><span class="string">dbservers-two</span></span><br><span class="line"></span><br><span class="line"><span class="string">[cluster-one:vars]</span></span><br><span class="line"><span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">ansible_port=3980</span> </span><br><span class="line"><span class="string">ntp_server=ntp.example.com</span></span><br><span class="line"><span class="string">proxy=proxy.example.com</span></span><br><span class="line"><span class="string">[webservers-two]</span></span><br><span class="line"></span><br><span class="line"><span class="string">webremote.one.ip.address</span></span><br><span class="line"><span class="string">webremote.two.ip.address</span></span><br><span class="line"><span class="string">webremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[dbservers-two]</span></span><br><span class="line"><span class="string">dbremote.one.ip.address</span></span><br><span class="line"><span class="string">dbremote.two.ip.address</span></span><br><span class="line"><span class="string">dbremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[cluster-two:children]</span></span><br><span class="line"><span class="string">webservers-two</span></span><br><span class="line"><span class="string">dbservers-two</span></span><br><span class="line"></span><br><span class="line"><span class="string">[cluster-two:vars]</span></span><br><span class="line"><span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">ansible_port=3980</span> </span><br><span class="line"><span class="string">ntp_server=ntp.example.com</span></span><br><span class="line"><span class="string">proxy=proxy.example.com</span></span><br><span class="line"></span><br><span class="line"><span class="string">[all-clusters:children]</span></span><br><span class="line"><span class="string">cluster-one</span></span><br><span class="line"><span class="string">cluster-two</span></span><br></pre></td></tr></table></figure>
<p>More realistically this could be seen in terms of grouping local data-centre hosts into regions and then into a country wide group. </p>
<hr>
<h1 id="5-–-Multiple-Inventory-Files"><a href="#5-–-Multiple-Inventory-Files" class="headerlink" title="5 – Multiple Inventory Files"></a>5 – Multiple Inventory Files</h1><p>The singular <code>/etc/ansible/hosts</code> file is fine for smaller more contained network setups, but the preferred practice in Ansible is not to store variables in the main <code>hosts</code> inventory file. At least when dealing with larger more complex layouts of hosts, or bigger networks. </p>
<p>Host and group variables ideally when handling large scale setups should be stored in individual files. Files that are relative to the main inventory file.</p>
<p>As an example any group variables defined in the below file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/ansible/group_vars/webservers.yml</span><br></pre></td></tr></table></figure>
<p>Will apply to any hosts located in the <code>webservers</code> group. These variable files are written in YAML.</p>
<p>Similarly any host variables defined in:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/ansible/host_vars/server-name-1.yml</span><br></pre></td></tr></table></figure>
<p>Are applied to the host named <code>server-name-1</code> from the original <code>hosts</code> file. </p>
<p>Further segmentation and organisation of the host/inventory files is followed but not covered in this post, see <a href="http://rosstuck.com/multistage-environments-with-ansible/" target="_blank" rel="external">Multistage Environments with Ansible</a> for more information on how this is done. </p>
<hr>
<p>A future third post on Ansible will describe the <em>modules</em> in place that can be run as part of a playbook, or as ad-hoc based commands. </p>
<p><strong>More Information</strong></p>
<ul>
<li><a href="http://docs.ansible.com/ansible/intro_inventory.html" target="_blank" rel="external">Official Ansible Documentation - Inventory</a> – The concepts on this page are what I based most of this blosg post on. </li>
<li><a href="http://docs.ansible.com/ansible/playbooks_best_practices.html" target="_blank" rel="external">Official Ansible Documentation - Best Practices: Content Organisation</a> – Not as relevant but </li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Python/" class="post__tag__link">Python</a></li></ul><a href="/2016/06/27/ansible-inventory-concepts/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2016-02-10T00:00:00.000Z" class="post__time">February 10, 2016</time><h1 class="post__title"><a href="/2016/02/10/ansible-installing-running/">Ansible - Installing and Running (1)</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/9HBs9cy.png" alt="Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>Ansible is one of many configuration management tools but has its own unique set of differences. The platform aims to provide solutions for the entirety of a setup. With consideration for infrastructure provisioning, application deployment, and overall orchestration taken into account.  </p>
<p>Some of its features it uses to achieve this are agentless management, multi-node deployment, ad hoc task execution, module libraries, and use of higher level install scripts referred to as <em>playbooks</em>. Security and reliability is maintained throughout this with SSH as the transport protocol.  </p>
<p>Compared to to other CM tools the learning curve is also seen as much lower with Ansible, making it easier to understand and use from the outset. Only Python and a designated control machine are required for the actual installation. With all configuration for the “inventory” assets written in YAML to keep things simple and clean. </p>
<blockquote>
<p><a href="http://www.ansible.com/" target="_blank" rel="external">http://www.ansible.com/</a></p>
</blockquote>
<a id="more"></a>
<hr>
<h1 id="1-–-Control-Machine-Installation"><a href="#1-–-Control-Machine-Installation" class="headerlink" title="1 – Control Machine Installation"></a>1 – Control Machine Installation</h1><p>The host you want to use as the <em>control machine</em> for Ansible requires Python 2.6 or 2.7 installed. This control machine can be a desktop, laptop, or workstation etc as long it’s running a Linux based OS such as Debian/Ubuntu, Arch, CentOS, RHEL, OS X, or any version of BSD. </p>
<p>Windows as a platform is not currently supported for the control machine. </p>
<p>In this post the commands are shown for installing Ansible onto the control machine using system package managers, and for only a few of the many Linux distributions on offer.</p>
<h2 id="Arch-Linux"><a href="#Arch-Linux" class="headerlink" title="Arch Linux"></a>Arch Linux</h2><p><a href="https://wiki.archlinux.org/index.php/Ansible" target="_blank" rel="external">Ansible</a> has a Pacman package in the community repository.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pacman -S ansible</span><br></pre></td></tr></table></figure>
<p>The AUR also has a package build that pulls directly from GitHub called <code>ansible-git</code> . Any Aurum helper can be used to automatically build and install this</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yaourt -S ansible-git</span><br></pre></td></tr></table></figure>
<h2 id="Debian"><a href="#Debian" class="headerlink" title="Debian"></a>Debian</h2><p>Open up the Debian software sources file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/apt/sources.list</span><br></pre></td></tr></table></figure>
<p>Add the following line to /etc/apt/sources.list:</p>
<p><code>deb http://ppa.launchpad.net/ansible/ansible/ubuntu trusty main</code></p>
<p>Add the Ansible software repository key to the system; it’s the same source as the Ubuntu PPA. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 93C4A3FD7BB9C367</span><br></pre></td></tr></table></figure>
<p>Update the package manager to verify the changes and then install Ansible itself:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install ansible</span><br></pre></td></tr></table></figure>
<h2 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h2><p>Install the common software properties package if you don’t already have it. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install software-properties-common</span><br></pre></td></tr></table></figure>
<p>Add the official Ansible package repository to the system and update the package manager database. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-add-repository ppa:ansible/ansible</span><br><span class="line">$ sudo apt-get update</span><br></pre></td></tr></table></figure>
<p>Install Ansible from the newly added package repository.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install ansible</span><br></pre></td></tr></table></figure>
<h2 id="Fedora"><a href="#Fedora" class="headerlink" title="Fedora"></a>Fedora</h2><p>Fedora users can install Ansible directly:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum -y update</span><br><span class="line">$ sudo yum -y install ansible</span><br></pre></td></tr></table></figure>
<h2 id="RHEL-CentOS"><a href="#RHEL-CentOS" class="headerlink" title="RHEL / CentOS"></a>RHEL / CentOS</h2><p><a href="http://fedoraproject.org/wiki/EPEL" target="_blank" rel="external">EPEL must be configured before trying to install Ansible on these systems.</a> </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum -y update</span><br><span class="line">$ sudo yum -y install ansible</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="2-–-Remote-Nodes-SSH-Setup"><a href="#2-–-Remote-Nodes-SSH-Setup" class="headerlink" title="2 – Remote Nodes SSH Setup"></a>2 – Remote Nodes SSH Setup</h1><p>On the remote nodes you want Ansible to interact with you need to register the control machine’s public SSH key. This is as Ansible uses SSH to communicate and operate by default. </p>
<p>To generate a new SSH key for the control machine use the next command on the control machine host:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> .ssh/ </span><br><span class="line">$ ssh-keygen -t rsa -b 4096 -C <span class="string">"ansible-control-host"</span></span><br></pre></td></tr></table></figure>
<p>Then copy the new key across to the remote client nodes; changing the <code>-p</code> value for your own relevant SSH port number. Along with the usernames plus remote host IP addresses. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-copy-id -i ansible-control-host -p 3980 username@remote.one.ip.address</span><br><span class="line">$ ssh-copy-id -i ansible-control-host -p 3980 username@remote.two.ip.address</span><br><span class="line">$ ssh-copy-id -i ansible-control-host -p 3980 username@remote.three.ip.address</span><br></pre></td></tr></table></figure>
<p>Next open the main Ansible configuration file; which is explained more in a latter section. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/ansible/ansible.cfg</span><br></pre></td></tr></table></figure>
<p>Locate the lines that describe private key authentication (shown below) and remove the <code>#</code> symbol whilst adding in the path to the new private key we created.</p>
<figure class="highlight bash"><figcaption><span>/etc/ansible/ansible.cfg</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># if set, always use this private key file for authentication, same as</span></span><br><span class="line"><span class="comment"># if passing --private-key to ansible or ansible-playbook</span></span><br><span class="line">private_key_file = ~/.ssh/ansible-control-host</span><br></pre></td></tr></table></figure>
<p>Save and exit the file. </p>
<p>This forces Ansible to use this private key for all operations by default. An alternative to this would be to use the <code>ansible_ssh_private_key_file</code> variable in the <code>hosts</code> file explained later on. </p>
<p>Like with the control machine the remote nodes must have Python installed (2.4 or later) as a prerequisite to using Ansible with them. So any remote nodes that do not have Python already installed must be attended to before continuing. </p>
<hr>
<h1 id="3-–-Ansible-Hosts-File-Setup"><a href="#3-–-Ansible-Hosts-File-Setup" class="headerlink" title="3 – Ansible Hosts File Setup"></a>3 – Ansible Hosts File Setup</h1><iframe width="1080" height="500" src="https://www.youtube.com/embed/xew7CMkL7jY" frameborder="1" allowfullscreen><br></iframe>

<p>Continuing on with the control machine - backup the template Ansible hosts file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mv /etc/ansible/hosts /etc/ansible/hosts.orig</span><br></pre></td></tr></table></figure>
<p>Begin writing to a new buffer to create a new “hosts” file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/ansible/hosts</span><br></pre></td></tr></table></figure>
<p>Add the contents of the next code snippet into the hosts file, substituting in the IP addresses of your remotes in the process.</p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[servers]</span></span><br><span class="line"><span class="string">remote.one.ip.address</span></span><br><span class="line"><span class="string">remote.two.ip.address</span></span><br><span class="line"><span class="string">remote.three.ip.address</span></span><br></pre></td></tr></table></figure>
<p>This configuration file is very flexible and can be expanded to use variables, aliases, and port numbers. Which is what we need to add to ensure the SSH connectivity. </p>
<blockquote>
<p><strong>Note:</strong> If your SSH port is the default port 22 on these remote nodes then you do not have to set this upcoming port variable.</p>
</blockquote>
<p>Expand the file by adding a hostname alias, host variable, user variable, and port number variable:</p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[servers]</span></span><br><span class="line"><span class="string">server-name-1</span> <span class="string">ansible_host=remote.one.ip.address</span> <span class="string">ansible_user=username</span> <span class="string">ansible_port=3980</span> </span><br><span class="line"><span class="string">server-name-2</span> <span class="string">ansible_host=remote.two.ip.address</span> <span class="string">ansible_user=username</span> <span class="string">ansible_port=3980</span> </span><br><span class="line"><span class="string">server-name-3</span> <span class="string">ansible_host=remote.three.ip.address</span> <span class="string">ansible_user=username</span> <span class="string">ansible_port=3980</span></span><br></pre></td></tr></table></figure>
<p>Save the changes and exit the text editor. </p>
<p>As an extra option here, adding an <code>ansible_ssh_private_key_file=~/.ssh/ansible-control-host</code> variable to each host line is another possibility. Instead of what we set in the last step i.e. the default private key directive in Ansible’s main configuration file (<code>ansible.cfg</code>). </p>
<hr>
<h1 id="4-–-Test-Ansible-Connectivity"><a href="#4-–-Test-Ansible-Connectivity" class="headerlink" title="4 – Test Ansible Connectivity"></a>4 – Test Ansible Connectivity</h1><p>An Ansible module named “ping” is useful for testing the previous host file configuration we added.</p>
<p>Note that <code>all</code> can be replaced for a group name like <code>server</code> - which is taken from the example earlier to only select those hosts in that group. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible all -m ping</span><br></pre></td></tr></table></figure>
<p>A successful hosts and SSH key configuration returns an output similar to:</p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">hostname1 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"invocation"</span>: &#123;</span><br><span class="line">        <span class="string">"module_args"</span>: &#123;</span><br><span class="line">            <span class="string">"data"</span>: null</span><br><span class="line">        &#125;, </span><br><span class="line">        <span class="string">"module_name"</span>: <span class="string">"ping"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hostname2 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"invocation"</span>: &#123;</span><br><span class="line">        <span class="string">"module_args"</span>: &#123;</span><br><span class="line">            <span class="string">"data"</span>: null</span><br><span class="line">        &#125;, </span><br><span class="line">        <span class="string">"module_name"</span>: <span class="string">"ping"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hostname3 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"invocation"</span>: &#123;</span><br><span class="line">        <span class="string">"module_args"</span>: &#123;</span><br><span class="line">            <span class="string">"data"</span>: null</span><br><span class="line">        &#125;, </span><br><span class="line">        <span class="string">"module_name"</span>: <span class="string">"ping"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Manual options are also sometimes added to these <em>ad hoc</em> Ansible commands. </p>
<p>Here <code>-u</code> selects a Linux user to issue the command as: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible all -m ping -u &lt;username&gt;</span><br></pre></td></tr></table></figure>
<p>Furthermore the  <code>-b</code> option triggers the command to be run with <code>sudo</code> privileges: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible all -m ping -u &lt;username&gt; -b</span><br></pre></td></tr></table></figure>
<p>This is all with the “ping” module example, but live commands are just as easy.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible all <span class="_">-a</span> <span class="string">"/bin/echo hello world!"</span></span><br></pre></td></tr></table></figure>
<p>You can do this without invoking the program directly and use the <code>command</code> module with Ansible instead.</p>
<p>Return the “servers” group drive partitions using the <code>df</code> program: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible -m <span class="built_in">command</span> <span class="_">-a</span> <span class="string">"df -h"</span> servers</span><br></pre></td></tr></table></figure>
<p>Example output from one host:</p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hostname1 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">Filesystem                 Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/disk/by-label/DOROOT   30G  6.1G   22G  22% /</span><br><span class="line">udev                        10M     0   10M   0% /dev</span><br><span class="line">tmpfs                      202M   25M  178M  13% /run</span><br><span class="line">tmpfs                      505M     0  505M   0% /dev/shm</span><br><span class="line">tmpfs                      5.0M     0  5.0M   0% /run/lock</span><br><span class="line">tmpfs                      505M     0  505M   0% /sys/fs/cgroup</span><br><span class="line">tmpfs                      101M     0  101M   0% /run/user/1001</span><br></pre></td></tr></table></figure>
<p>Checking disk space on multiple nodes has never been easier!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible -m <span class="built_in">command</span> <span class="_">-a</span> <span class="string">"free -h"</span> servers</span><br></pre></td></tr></table></figure>
<p>Example output from one host:</p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hostname2 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">             total       used       free     shared    buffers     cached</span><br><span class="line">Mem:          1.0G       875M       134M        25M       187M       570M</span><br><span class="line">-/+ buffers/cache:       117M       892M</span><br><span class="line">Swap:         2.0G        32K       2.0G</span><br></pre></td></tr></table></figure>
<p>Query the system’s uptime of only one requested host using the assigned alias from the hosts file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible -m <span class="built_in">command</span> <span class="_">-a</span> <span class="string">"uptime -p"</span> hostname3</span><br></pre></td></tr></table></figure>
<p>Example output:</p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hostname3 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">up 7 weeks, 1 day, 7 minutes</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="5-–-Ansible-Configuration-File"><a href="#5-–-Ansible-Configuration-File" class="headerlink" title="5 – Ansible Configuration File"></a>5 – Ansible Configuration File</h1><p>Custom changes to the Ansible install and how it behaves are made through the configuration files. </p>
<p>Changes in relation to configuration are processed and picked up in the the following order:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* ANSIBLE_CONFIG (an environment variable)</span><br><span class="line">* ansible.cfg (<span class="keyword">in</span> the current directory)</span><br><span class="line">* .ansible.cfg (<span class="keyword">in</span> the home directory)</span><br><span class="line">* .ansible.cdg (<span class="keyword">in</span> /etc/ansible/ansible.cfg)</span><br></pre></td></tr></table></figure>
<p>In this section we’re taking a quick look at the <code>ansible.cfg</code> file we modified slightly earlier. </p>
<p>There’s not much wrong with the default contents of the main <code>/etc/ansible.cfg</code> file, but you may need to delve into it at some point in the future. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/ansible/ansible.cfg</span><br></pre></td></tr></table></figure>
<p>Here are some cherry picked lines and directives from the file that may be of interest. Remember if/when setting these to remove the <code>#</code> symbol to uncomment. </p>
<p>To assign a different directory for a custom hosts file location. </p>
<figure class="highlight bash"><figcaption><span>/etc/ansible/ansible.cfg</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#inventory = /etc/ansible/hosts</span></span><br></pre></td></tr></table></figure>
<p>This next line designates the number of parallel processes to generate when talking with remote hosts. The value will always depend upon your hardware capabilities and amount of remote nodes in play. </p>
<p>Higher fork values will help to complete actions across the nodes faster. Assuming you have the hardware needed. A common value is 50, rather than the default of 5. </p>
<figure class="highlight bash"><figcaption><span>/etc/ansible/ansible.cfg</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#forks = 5</span></span><br></pre></td></tr></table></figure>
<p>To control whether an Ansible playbook prompts for a sudo password when sudoing - set this next directive to true. </p>
<figure class="highlight bash"><figcaption><span>/etc/ansible/ansible.cfg</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ask_sudo_pass = True</span></span><br></pre></td></tr></table></figure>
<p>Similarly to set whether an Ansible playbook prompts for a password when run - set this next line to true.</p>
<figure class="highlight bash"><figcaption><span>/etc/ansible/ansible.cfg</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ask_pass = True</span></span><br></pre></td></tr></table></figure>
<p>This sets the default SSH port for all system connections, be aware that any settings in the inventory (e.g. hosts file) will override this. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#remote_port = 22</span><br></pre></td></tr></table></figure>
<p>Set the time out value for SSH queries here on this line:</p>
<figure class="highlight bash"><figcaption><span>/etc/ansible/ansible.cfg</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SSH timeout</span></span><br><span class="line"><span class="comment">#timeout = 10</span></span><br></pre></td></tr></table></figure>
<p>Enable playbook logging capability in the specified directory on these lines here: </p>
<figure class="highlight bash"><figcaption><span>/etc/ansible/ansible.cfg</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># logging is off by default unless this path is defined</span></span><br><span class="line"><span class="comment"># if so defined, consider logrotate</span></span><br><span class="line"><span class="comment">#log_path = /var/log/ansible.log</span></span><br></pre></td></tr></table></figure>
<p>Who doesn’t like <code>cowsay</code> ?</p>
<figure class="highlight bash"><figcaption><span>/etc/ansible/ansible.cfg</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># don't like cows?  that's unfortunate.</span></span><br><span class="line"><span class="comment"># set to 1 if you don't want cowsay support or export ANSIBLE_NOCOWS=1 </span></span><br><span class="line"><span class="comment">#nocows = 1</span></span><br></pre></td></tr></table></figure>
<p>The lines following these let you tweak and customise components of cowsay even further!</p>
<p>After which the remaining sections that have been omitted here contain more background areas of Ansible, should you need to examine or change them in the future.</p>
<figure class="highlight bash"><figcaption><span>/etc/ansible/ansible.cfg</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[privilege_escalation]</span><br><span class="line">&lt;...&gt;</span><br><span class="line">[paramiko_connection]</span><br><span class="line">&lt;...&gt;</span><br><span class="line">[ssh_connection]</span><br><span class="line">&lt;...&gt;</span><br><span class="line">[accelerate]</span><br><span class="line">&lt;...&gt;</span><br><span class="line">[selinux]</span><br><span class="line">&lt;...&gt;</span><br></pre></td></tr></table></figure>
<p>Any major changes or crucial updates to the configuration file syntax and formatting will likely be pushed to the GitHub development configuration file at:</p>
<blockquote>
<p><a href="https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg" target="_blank" rel="external">https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg</a></p>
</blockquote>
<p>Or shown in the official documentation. </p>
<hr>
<iframe width="1080" height="500" src="https://www.youtube.com/embed/ZNB1at8mJWY" frameborder="1" allowfullscreen><br></iframe>

<p>What’s been covered in this post is the very basics of Ansible and only goes a short way towards demonstrating its ability as a configuration management tool. There are still a variety of pieces to fit into the puzzle such as modules, inventory items, and most importantly the playbooks. Which all make up and achieve the aims of the software described in the premable. </p>
<p>A future post on Ansible will look at more at the concept of “inventory”. </p>
<p><strong>More Information</strong></p>
<ul>
<li><a href="http://docs.ansible.com/ansible/intro_installation.html" target="_blank" rel="external">Official Ansible Documentation - Installation</a> – Extensive instructions for installing and building Ansible from source are located here. </li>
<li><a href="http://docs.ansible.com/ansible/intro_getting_started.html" target="_blank" rel="external">Official Ansible Documentation - Getting Started</a> – A few initial ad hoc commands and examples of them are described in brief here. </li>
<li><a href="http://docs.ansible.com/ansible/intro_configuration.html" target="_blank" rel="external">Official Ansible Documentation - Configuration File</a> – Anything and everything to do with the configuration file, good for referring back to.  </li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Python/" class="post__tag__link">Python</a></li></ul><a href="/2016/02/10/ansible-installing-running/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2015-11-30T00:00:00.000Z" class="post__time">November 30, 2015</time><h1 class="post__title"><a href="/2015/11/30/django-modwsgi-apache/">Hosting Django Web Applications with Apache (mod_wsgi) on Debian 8</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/qzPEFWB.png" alt="Django Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>This post covers one of many ways to setup and run a Django project, website, or web application. It’s probably one of the most routine methods on offer and is certainly not the “best” choice out of them all, but still a good place to start in understanding the framework and how it operates. </p>
<p>More popular methods of running and hosting Django are mentioned at the end of the post. </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Update-amp-Install-Packages"><a href="#1-–-Update-amp-Install-Packages" class="headerlink" title="1 – Update &amp; Install Packages"></a>1 – Update &amp; Install Packages</h1><p>Update and upgrade the server’s system packages:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update &amp;&amp; sudo apt-get upgrade</span><br></pre></td></tr></table></figure>
<p>Install Apache, mod-wsgi, and Python’s pip package manager.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install apache2 libapache2-mod-wsgi python-pip</span><br></pre></td></tr></table></figure>
<p>Also the <code>virtualenv</code> package is required for the next step. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pip install virtualenv</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="2-–-Setup-Virtual-Environment"><a href="#2-–-Setup-Virtual-Environment" class="headerlink" title="2 – Setup Virtual Environment"></a>2 – Setup Virtual Environment</h1><p>Decide where you want to keep your Django project. </p>
<p>There are several places form which you could run the project. One that is very common is the user’s <code>home</code> directory. Another suitable place is the <code>/srv/</code> system directory. A final place could be directly inside the system’s web server directories i.e. <code>/var/www</code> and down. </p>
<p>In my example I’ll be using a Linux user’s home directory. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir ~/django-project &amp;&amp; <span class="built_in">cd</span> ~/django-project</span><br></pre></td></tr></table></figure>
<p>Inside the new project folder create a dedicated Python virtual environment:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ virtualenv django-virt-env</span><br></pre></td></tr></table></figure>
<p>Activate the environment and enter into it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> django-virt-env/bin/activate</span><br></pre></td></tr></table></figure>
<p>Now you’re within the environment (prompt will change) install Django with pip into it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install django</span><br></pre></td></tr></table></figure>
<p>Once Django is installed, use the <code>deactivate</code> command to exit the environment prompt.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ deactivate</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="3-–-Create-or-Import-Django-Project"><a href="#3-–-Create-or-Import-Django-Project" class="headerlink" title="3 – Create or Import Django Project"></a>3 – Create or Import Django Project</h1><p>To start from scratch you can use the Django installation in the virtual environment and make a brand new Django project. Or instead import your Django project files from something like version control. </p>
<p>For this tutorial we’ll go down the path of importing a a pre-existing Django project from Git. </p>
<p>Before this though, here are the initial steps for starting a brand new Django project. </p>
<h2 id="Create-Project"><a href="#Create-Project" class="headerlink" title="Create Project"></a>Create Project</h2><p>Skip past this section to instead import an existing Django project.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> django-virt-env/bin/activate</span><br></pre></td></tr></table></figure>
<p>Create the new project and give it a name, where <code>project_name</code> is replaced with your name you want to give it.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ django-admin.py startproject project-name .</span><br></pre></td></tr></table></figure>
<p>Run initial migration: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./manage.py migrate</span><br></pre></td></tr></table></figure>
<p>Create a superuser for the project:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./manage.py createsuperuser</span><br></pre></td></tr></table></figure>
<p>Open up the <code>settings.py</code> file for editing:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim project-name/settings.py</span><br></pre></td></tr></table></figure>
<p>Add this new line to the bottom section of the file:</p>
<figure class="highlight python"><figcaption><span>~/django-project/project_name/settings.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STATIC_ROOT = os.path.join(BASE_DIR, <span class="string">"static/"</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> The <code>settings.py</code> file is often replaced with a template file in version control, as it contains user specific data, environment specific data, and sensitive credentials. More on this later. </p>
</blockquote>
<p>Copy static content into the directory set in the previous <code>STATIC_ROOT</code> directive:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./manage.py collectstatic</span><br></pre></td></tr></table></figure>
<p>Test the server runs correctly:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python manage.py runserver 0.0.0.0:8000</span><br></pre></td></tr></table></figure>
<p>You can test the project works in a web browser at: <code>your.vps.ip.address:8000</code></p>
<p><img src="https://i.gyazo.com/a0ca362f8a25159e68f4df71b43b6a0b.png" alt="It Worked Django Image"></p>
<p><code>CTRL</code> + <code>C</code> once checked to exit the server process. </p>
<p>Then <code>deactivate</code> once again to leave the Python virtual env prompt. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ deactivate</span><br></pre></td></tr></table></figure>
<h2 id="Import"><a href="#Import" class="headerlink" title="Import"></a>Import</h2><p>This is the assumption I’m following for the rest of the post, that you already have a Django project created and want to host it. You could still however carry on with the new blank project from before. </p>
<p>Import the Django project into our local project’s root folder:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/username/repository-name.git ~/django-project</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> The <code>settings.py</code> file is often replaced with a template file in version control, as it contains user specific data, environment specific data, and sensitive credentials. More on this later. </p>
</blockquote>
<p>Then move on to setting up the virtual host.</p>
<hr>
<h1 id="4-–-Setup-Apache-Virtual-Host"><a href="#4-–-Setup-Apache-Virtual-Host" class="headerlink" title="4 – Setup Apache Virtual Host"></a>4 – Setup Apache Virtual Host</h1><p>Using your preferred text editor open the default Apache <em>vhost</em> for writing, or a <em>dedicated vhost</em> instead. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/apache2/sites-available/000-default.conf</span><br></pre></td></tr></table></figure>
<p>The complete main block of the virtual host should contain the following:</p>
<figure class="highlight apache"><figcaption><span>/etc/apache2/sites-available/000-default.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute"><span class="nomarkup">ServerName</span></span> exampledomain.com</span><br><span class="line"><span class="attribute">ServerAlias</span> www.exampledomain.com</span><br><span class="line"><span class="attribute">ServerAdmin</span> server-administrator@emaildomain.com</span><br><span class="line">    </span><br><span class="line"><span class="attribute">Alias</span> /static /home/username/django-project/static</span><br><span class="line"></span><br><span class="line"><span class="section">&lt;Directory /home/username/django-project/static&gt;</span></span><br><span class="line">    <span class="attribute">Require</span> <span class="literal">all</span> granted </span><br><span class="line"><span class="section">&lt;/Directory&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="section">&lt;Directory /home/username/django-project&gt;</span></span><br><span class="line">    <span class="section">&lt;Files wsgi.py&gt;</span></span><br><span class="line">        <span class="attribute">Require</span> <span class="literal">all</span> granted </span><br><span class="line">    <span class="section">&lt;/Files&gt;</span></span><br><span class="line"><span class="section">&lt;/Directory&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="attribute">WSGIDaemonProcess</span> project-name python-path=/home/username/django-project:home/username/django-project/django-virt-env/lib/python2.7/site-packages</span><br><span class="line"><span class="attribute">WSGIProcessGroup</span> project-name</span><br><span class="line"><span class="attribute">WSGIScriptAlias</span> / /home/username/django-project/project-name/wsgi.py</span><br></pre></td></tr></table></figure>
<p>What follows are the broken down areas of the above virtual host, and how to set them.</p>
<p><strong>Static Alias</strong></p>
<p>The first option to set is an alias, and needs to point to the <code>static</code> directory we generated when either creating or importing the Django project files. </p>
<p>So username needs to be your Linux username, and <code>django-project</code> needs to be substituted for whatever you named the very first folder we created. Back at the start of <strong>Step 3</strong>. </p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Alias</span> /static /home/username/django-project/static</span><br></pre></td></tr></table></figure>
<p><strong>Static Directory Access</strong></p>
<p>The web server must also allow access to the directory we aliased for <code>static</code>. Do this with a directory block that looks like this. Except again with the same values as before substituted in.</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;Directory /home/username/django-project/static&gt;</span></span><br><span class="line">  <span class="attribute">Require</span> <span class="literal">all</span> granted </span><br><span class="line"><span class="section">&lt;/Directory&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>wsgi.py Access</strong></p>
<p>The <code>wsgi.py</code> file inside your <code>project-name</code> directory should also be open for access. Add this second directory block to ensure it’s accessible.</p>
<p>Again <code>project_name</code> and the previous values need altering to your own.</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;Directory /home/username/django-project/project-name&gt;</span></span><br><span class="line">  <span class="section">&lt;Files wsgi.py&gt;</span></span><br><span class="line">    <span class="attribute">Require</span> <span class="literal">all</span> granted </span><br><span class="line">  <span class="section">&lt;/Files&gt;</span></span><br><span class="line"><span class="section">&lt;/Directory&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>WSGI Settings</strong><br>The gateway interface mod for Apache uses <code>wsgi.py</code> to handle passing clients to the Django web app. Set it up with a daemon process path, process group name, and alias to the <code>wsgi.py</code> file location. </p>
<p>Some things to note are that the latter half of the <code>python-path</code> setting should point to your virtual environment’s Python site packages, and not your system wide ones. The <code>:</code> character delimits separate paths. </p>
<p>For the <code>WSGIDaemonProcess</code> and <code>WSGIProcessGroup</code> name (<code>project-name</code> in my example) you can set it to any suitable name. </p>
<p>All relevant values here once again should be replaced with your own. </p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">WSGIDaemonProcess</span> project-name python-path=/home/username/django-project:home/username/django-project/django-virt-env/lib/python2.7/site-packages</span><br><span class="line"><span class="attribute">WSGIProcessGroup</span> django-project</span><br><span class="line"><span class="attribute">WSGIScriptAlias</span> / /home/username/django-project/project-name/wsgi.py</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="5-–-Apache-Permissions"><a href="#5-–-Apache-Permissions" class="headerlink" title="5 – Apache Permissions"></a>5 – Apache Permissions</h1><p>Change the system permissions so that the Linux group owner of the database file can read and write. </p>
<p>The database file is named  <code>db.sqlite3</code> by default and is in the root project directory if not moved previously. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ chmod 664 ~/django-project/db.sqlite3</span><br></pre></td></tr></table></figure>
<p>Apache runs under the <code>www-data</code> system group, give said group ownership of the database file:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chown :www-data ~/django-project/db.sqlite3</span><br></pre></td></tr></table></figure>
<p>In order for the <code>www-data</code> Apache group to properly write to the database file, we also need to give it ownership of the database file’s parent directory:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chown :www-data ~/myproject</span><br></pre></td></tr></table></figure>
<p>Restart Apache to implement the changes we just made:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service apache2 restart</span><br></pre></td></tr></table></figure>
<p>Assuming your firewall is setup correctly you should now be able to access your Django site by going to your server’s domain name or IP address in a browser. </p>
<hr>
<h1 id="Live-Deployment-Considerations"><a href="#Live-Deployment-Considerations" class="headerlink" title="Live Deployment Considerations"></a>Live Deployment Considerations</h1><h1 id="1-–-Django-Project-Settings"><a href="#1-–-Django-Project-Settings" class="headerlink" title="1 – Django Project Settings"></a>1 – Django Project Settings</h1><p>The <code>settings.py</code> file usually contains sensitive data values such as passwords, <em>secret keys</em>, and user credentials. Which are at risk of being exposed when stored in the Project’s version control (at least if public version control is used). </p>
<p>The exact details set in <code>settings.py</code> are also likely to differ from user to user. As different directives and values may be required depending upon the installation context and user in question. For example <code>DEBUG</code> being set to <code>TRUE</code> on a local environment versus a live environment. </p>
<p>It’s for these reasons it’s advisable to instead import these values into <code>settings.py</code> from another local <em>credentials</em> file. One that the user fills out manually upon setting up the project locally for the first time. </p>
<p>The same “credentials” file must then be permanently ignored by the version control system, so the user specific details and passwords are kept private, but still imported into <code>settings.py</code> . </p>
<p>Here is what an example template for this credentials file might look like:</p>
<script src="https://gist.github.com/5car1z/6b014dd95f216780b1ce.js"></script>

<p>Once created the <code>credentials.py</code> file and it’s stored directives can all then be imported inside the main Django settings file. </p>
<p>Via this line of code: </p>
<figure class="highlight python"><figcaption><span>~/django-project/project-name/settings.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Imports sensitive/user config variable values.</span></span><br><span class="line"><span class="keyword">from</span> credentials <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>
<p>It’s a good idea to use a template file like the one above to replace the <code>credentials.py</code> in version control. So new users and installs can make a copy of it, and fill in the details required. </p>
<hr>
<h1 id="2-–-Live-Specific-Directives"><a href="#2-–-Live-Specific-Directives" class="headerlink" title="2 – Live Specific Directives"></a>2 – Live Specific Directives</h1><p>As mentioned in the previous section, some directives will need to be set differently for different situations. </p>
<p>Here are some of the directives defined in <code>credentials.py</code> (or an equivalent user specific settings file) that are suitable for a live setup.</p>
<figure class="highlight python"><figcaption><span>~/django-project/project-name/credentials.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEBUG = <span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<p>Setting this next directive is optional more than anything but provides a means of helping with debugging errors and exceptions raised while rendering the apps templates.</p>
<figure class="highlight python"><figcaption><span>~/django-project/project-name/credentials.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TEMPLATE_DEBUG = <span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<p>This line and directive can be kept directly in <code>settings.py</code> unlike the other directives, although it doesn’t hurt to place in <code>credentials.py</code> anyway. Once <code>DEBUG</code> is set to <code>false</code> , this allows only the specified FQDN’s access to your Django site. </p>
<p>It’s wise to ensure you <a href="https://github.com/DigitalOcean-User-Projects/Articles-and-Tutorials/blob/master/set_hostname_fqdn_on_ubuntu_centos.md" target="_blank" rel="external">have a valid FQDN hostname set on your server</a> if experiencing any problems with this directive.</p>
<figure class="highlight python"><figcaption><span>~/django-project/project-name/credentials.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALLOWED_HOSTS = [<span class="string">'127.0.0.1'</span>, <span class="string">'localhost'</span>, <span class="string">'.leagueofyorkshire.co.uk'</span>]</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> it is unwise to add a <code>*</code> symbol to the <code>ALLOWED_HOSTS</code> directive, as this would give access to any and all potential requests. </p>
</blockquote>
<p>Django uses the <code>STATIC_ROOT</code> directive to tell Apache where the generated <em>static</em> files are located. If the <code>./manage.py collectstatic</code> is run with live settings then the <code>STATIC_ROOT</code> directive must be set to something other than the previous <code>static</code> directory. In this case in the below code it’s set to generate it in a directory named <code>assets</code>. The other commented directives also need enabling in here for this to work:  </p>
<figure class="highlight python"><figcaption><span>~/django-project/project-name/credentials.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span></span><br><span class="line"><span class="comment"># STATIC_URL = '/static/'</span></span><br><span class="line"><span class="comment"># STATIC_ROOT = os.path.join(BASE_DIR, "assets/")</span></span><br><span class="line"><span class="comment"># STATICFILES_DIRS = (os.path.join('static'),)</span></span><br></pre></td></tr></table></figure>
<p>These previous directives are not <strong>all</strong> the ones you will find or define in the credentials file, but are mostly the ones to consider when working with a live deployment install of the project. </p>
<p>See here for detailed information about more of these:</p>
<blockquote>
<p><a href="https://docs.djangoproject.com/en/1.8/ref/settings/#std:setting-ADMINS" target="_blank" rel="external">Django Official Documentation - Settings</a></p>
</blockquote>
<hr>
<h1 id="3-–-Web-Server-Permissions"><a href="#3-–-Web-Server-Permissions" class="headerlink" title="3 – Web Server Permissions"></a>3 – Web Server Permissions</h1><p>We set some permissions on the database file and parent directory in an earlier step, however the other Django files hosted by your web server have their own permissions to consider. </p>
<p>The main file to take into account when setting permission is the file that holds your live environment specific directives, and user sensitive data. In our example this was the <code>credentials.py</code> file, created from a template that takes it’s place in version control. </p>
<p>Consider taking away read and write privileges to <em>everyone else</em> / <em>other</em> for this file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chmod o-rw ~/django-project/project-name/credentials.py</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="4-–-Error-Reporting-amp-Logging"><a href="#4-–-Error-Reporting-amp-Logging" class="headerlink" title="4 – Error Reporting &amp; Logging"></a>4 – Error Reporting &amp; Logging</h1><blockquote>
<p><strong>Section To Be Added</strong></p>
</blockquote>
<hr>
<h1 id="5-–-gitignore"><a href="#5-–-gitignore" class="headerlink" title="5 – .gitignore"></a>5 – .gitignore</h1><p>Here is a .gitignore containing lots of potential file types and directories you likely don’t want to track for live or in general. Some are Django specific, others are Python project related. </p>
<script src="https://gist.github.com/5car1z/2bd1ade7177fbccca339.js"></script>

<hr>
<h1 id="Further-Considerations"><a href="#Further-Considerations" class="headerlink" title="Further Considerations"></a>Further Considerations</h1><p>There are other alternatives to this entire procedure that have their own advantages and merits. These should be considered as an alternative or more specialised way of running Django. </p>
<p><strong>Gunicorn</strong> </p>
<p>“Gunicorn ‘Green Unicorn’ is a Python WSGI HTTP Server for UNIX. It’s a pre-fork worker model ported from Ruby’s Unicorn project. The Gunicorn server is broadly compatible with various web frameworks, simply implemented, light on server resources, and fairly speedy.”</p>
<blockquote>
<p><a href="http://gunicorn.org/" target="_blank" rel="external">http://gunicorn.org/</a></p>
</blockquote>
<p><strong>uWSGI</strong></p>
<p>“The uWSGI project aims at developing a full stack for building hosting services. Versatility, performance, low-resource usage and reliability are the strengths of the project “</p>
<blockquote>
<p><a href="https://uwsgi-docs.readthedocs.org/en/latest/WSGIquickstart.html" target="_blank" rel="external">Quickstart for Python/WSGI applications</a></p>
</blockquote>
<p><strong>Tornado</strong></p>
<p>“Tornado is a Python web framework and asynchronous networking library, originally developed at FriendFeed. By using non-blocking network I/O, Tornado can scale to tens of thousands of open connections, making it ideal for long polling, WebSockets, and other applications that require a long-lived connection to each user.”</p>
<blockquote>
<p><a href="http://www.tornadoweb.org/en/stable/wsgi.html" target="_blank" rel="external">tornado.wsgi — Interoperability with other Python frameworks and servers</a></p>
</blockquote>
<p><strong>Other Python Web Frameworks/Servers</strong></p>
<ul>
<li><a href="http://www.cherrypy.org/" target="_blank" rel="external">CherryPy</a></li>
<li><a href="http://twistedmatrix.com/trac/wiki/TwistedWeb" target="_blank" rel="external">Twisted Web</a></li>
<li><a href="http://waitress.readthedocs.org/en/latest/" target="_blank" rel="external">Waitress WSGI Server</a></li>
</ul>
<hr>
<p><strong>More Information</strong> </p>
<ul>
<li><p><a href="https://www.digitalocean.com/community/tutorials/how-to-serve-django-applications-with-apache-and-mod_wsgi-on-ubuntu-14-04" target="_blank" rel="external">Digital Ocean - How To Serve Django Applications with Apache and mod_wsgi on Ubuntu 14.04</a> – Main source of inspiration and workflow for this blog post. </p>
</li>
<li><p><a href="https://www.digitalocean.com/community/tutorials/how-to-run-django-with-mod_wsgi-and-apache-with-a-virtualenv-python-environment-on-a-debian-vps" target="_blank" rel="external">Digital Ocean – How to Run Django with mod_wsgi and Apache with a virtualenv Python environment on a Debian VPS</a> – Similar to the first link here but with different approaches and older. </p>
</li>
<li><p><a href="https://docs.djangoproject.com/en/1.8/howto/deployment/wsgi/modwsgi/" target="_blank" rel="external">Official Django Documentation - How to use Django with Apache and mod_wsgi</a> – Good general purpose information. </p>
</li>
<li><p><a href="http://www.slideshare.net/GrahamDumpleton/getting-started-with-modwsgi" target="_blank" rel="external">Graham Dumpleton - PyCon AU 2010 - Getting Started With Apache/mod_wsgi</a> – Slides that are useful for troubleshooting Django errors, is a bit outdated now ion parts however. </p>
</li>
<li><p><a href="http://modwsgi.readthedocs.org/en/develop/index.html" target="_blank" rel="external">Official Documentation for mod_wsgi</a> – Anything and everything for mod_wsgi. </p>
</li>
<li><p><a href="http://www.djangobook.com/en/2.0/chapter12.html" target="_blank" rel="external">“Django Book” - Chapter 12: Deploying Django</a> – Overall good deployment practices. </p>
</li>
<li><p><a href="https://www.digitalocean.com/community/tutorials/a-comparison-of-web-servers-for-python-based-web-applications" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/a-comparison-of-web-servers-for-python-based-web-applications</a> – The python web frameworks/servers from the last step. </p>
</li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Apache/" class="post__tag__link">Apache</a></li><li class="post__tag__item"><a href="/tags/Python/" class="post__tag__link">Python</a></li><li class="post__tag__item"><a href="/tags/Django/" class="post__tag__link">Django</a></li><li class="post__tag__item"><a href="/tags/Debian/" class="post__tag__link">Debian</a></li></ul><a href="/2015/11/30/django-modwsgi-apache/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2017 Scarlz</div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"></span></li><li class="page-menu__item"><span title="Next" class="page-menu__link icon-arrow-right page-menu__link--disabled"></span></li></menu></footer><script>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src="//"+l+".disqus.com/"+k+".js",i.parentNode.insertBefore(j,i)})
(document,"script","totts","count");
</script></body></html>