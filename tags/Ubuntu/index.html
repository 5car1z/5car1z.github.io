<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="Linux System Administration"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="C.J. Scarlett" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Ubuntu - C.J. Scarlett</title><link rel="stylesheet" href="/css/main.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">C.J. Scarlett</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/topics" class="head-nav__link">Topics</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="/misc" class="head-nav__link">Misc</a></li><li class="head-nav__item"><a href="/about" class="head-nav__link">About</a></li><li class="head-nav__item"><a href="/contact" class="head-nav__link">Contact</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2018-05-22T23:00:00.000Z" class="post__time">May 23, 2018</time><h1 class="post__title"><a href="/2018/05/23/ansible-fail2ban-role/">Installing Fail2ban with an Ansible Role on Ubuntu 18.04 (Bionic Beaver)</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/klPwJ5E.png" alt="Fail2ban Logo with Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>The Ansible role in question comes from Ansible Galaxy. It’s linked here below, where you can read about it more if needs be:</p>
<blockquote>
<p><a href="https://galaxy.ansible.com/tersmitten/fail2ban/" target="_blank" rel="external">https://galaxy.ansible.com/tersmitten/fail2ban/</a></p>
</blockquote>
<p>Here’s my method for making use of the role, which is within the context of an Ansible project that already automates the other aspects of setting up a server. It’s necessary to have a provisioning playbook already in place, so you can incorporate the role shown in this post into the main project.  </p>
<blockquote>
<p><a href="https://www.tricksofthetrades.net/2017/08/21/ansible-playbook-server-provisioning/">If this idea of “context” doesn’t make much sense then check out this other post I have on provisioning a server with Ansible for Debian 8 (Jessie).</a></p>
</blockquote>
<a id="more"></a>
<hr>
<h2 id="1-–-Acquiring-the-Files"><a href="#1-–-Acquiring-the-Files" class="headerlink" title="1 – Acquiring the Files"></a>1 – Acquiring the Files</h2><p>Starting from within the <em>root</em> directory of your own Ansible server <em>“provisioning”</em> project (most likely a version controlled project). </p>
<p>Clone the <code>ansible-fail2ban</code> repo from GitHub into your project:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/Oefenweb/ansible-fail2ban.git roles/fail2ban</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Alternatively you can use <code>ansible-galaxy install --roles-path roles/ tersmitten.fail2ban</code> if you don’t mind the directory name for the role being <code>tersmitten.fail2ban</code> </p>
</blockquote>
<p>Include the new role in your <strong>main</strong> playbook file’s list of roles to be performed on the host(s).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim playbook.yml</span><br></pre></td></tr></table></figure>
<p>Such as in this generic bare bones example here:</p>
<figure class="highlight yml"><figcaption><span>playbook.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">provision</span> <span class="string">ubuntu</span> <span class="number">18.04</span> <span class="string">(bionic</span> <span class="string">beaver)</span> <span class="string">servers</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">base</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">users</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ufw</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ntp</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> It does need to match the actual role directory name, so change this entry here to <code>tersmitten.fail2ban</code> if you instead used the Ansible galaxy install command earlier.</p>
</blockquote>
<hr>
<h2 id="2-–-Editing-the-Default-Ansible-Variables"><a href="#2-–-Editing-the-Default-Ansible-Variables" class="headerlink" title="2 – Editing the Default Ansible Variables"></a>2 – Editing the Default Ansible Variables</h2><p>Several default values for many Fail2ban configuration directives are already set in the role’s <code>defaults</code> directory. </p>
<p>Edit them as normal with your preferred fail2ban configuration values.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim roles/fail2ban/defaults/main.yml</span><br></pre></td></tr></table></figure>
<p>These are the general contents including one or two additions, removals, and changes of my own:</p>
<figure class="highlight yml"><figcaption><span>defaults/main.yml </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># defaults file for fail2ban</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">fail2ban_loglevel:</span> <span class="string">'INFO'</span> </span><br><span class="line"><span class="attr">fail2ban_logtarget:</span> <span class="string">/var/log/fail2ban.log</span></span><br><span class="line"><span class="attr">fail2ban_syslog_target:</span> <span class="string">/var/log/fail2ban.log</span></span><br><span class="line"><span class="attr">fail2ban_syslog_facility:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">fail2ban_socket:</span> <span class="string">/var/run/fail2ban/fail2ban.sock</span></span><br><span class="line"><span class="attr">fail2ban_pidfile:</span> <span class="string">/var/run/fail2ban/fail2ban.pid</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fail2ban_sendername:</span> <span class="string">'Fail2ban'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fail2ban_ignoreips:</span></span><br><span class="line"><span class="bullet"> -</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">/8</span></span><br><span class="line"><span class="attr">fail2ban_bantime:</span> <span class="number">3600</span></span><br><span class="line"><span class="attr">fail2ban_maxretry:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">fail2ban_findtime:</span> <span class="number">600</span></span><br><span class="line"><span class="attr">fail2ban_backend:</span> <span class="string">auto</span></span><br><span class="line"><span class="attr">fail2ban_destemail:</span> <span class="string">root@localhost</span></span><br><span class="line"><span class="attr">fail2ban_banaction:</span> <span class="string">ufw.conf</span></span><br><span class="line"><span class="attr">fail2ban_mta:</span> <span class="string">sendmail</span></span><br><span class="line"><span class="attr">fail2ban_protocol:</span> <span class="string">tcp</span></span><br><span class="line"><span class="attr">fail2ban_chain:</span> <span class="string">INPUT</span></span><br><span class="line"><span class="attr">fail2ban_action:</span> <span class="string">'%(action_)s'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fail2ban_services:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">sshd</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">ssh</span></span><br><span class="line"><span class="attr">    maxretry:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    bantime:</span> <span class="bullet">-1</span></span><br></pre></td></tr></table></figure>
<p>These Ansible variables are applied onto the target host through two Jinja templates. Variables here are split into one of these two files (see the template files themselves for specifics). New variables you wish to incorporate have to be added to <code>defaults/main.yml</code> <strong>and</strong> the relevant Jinja template file if not present.  </p>
<blockquote>
<p><a href="https://github.com/Oefenweb/ansible-fail2ban#variables" target="_blank" rel="external">Here’s the reference for the Ansible variables on offer, used by this role.</a> </p>
</blockquote>
<p>You could also override them in the <code>vars/main.yml</code> file too, if that seems more appealing, but do not define duplicate variables.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim roles/fail2ban/vars/main.yml</span><br></pre></td></tr></table></figure>
<p>This is the same common SSH daemon jail I added earlier, but in the alternative file:</p>
<figure class="highlight yml"><figcaption><span>roles/fail2ban/vars/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vars file for fail2ban</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">fail2ban_dependencies:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">fail2ban</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fail2ban_services:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">sshd</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">ssh</span></span><br><span class="line"><span class="attr">    maxretry:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    bantime:</span> <span class="bullet">-1</span></span><br></pre></td></tr></table></figure>
<p>Remember not to duplicate variables between these two files!</p>
<p>So regardless of the file you choose, new jails must be included as part of the one <code>fail2ban_services:</code> variable.</p>
<p>For example, adding a second Nginx jail:</p>
<figure class="highlight yml"><figcaption><span>example.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">fail2ban_services:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">sshd</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">ssh</span></span><br><span class="line"><span class="attr">    maxretry:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    bantime:</span> <span class="bullet">-1</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">nginx-http-auth</span></span><br><span class="line"><span class="attr">    filter:</span> <span class="string">nginx-http-auth</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">http,https</span></span><br><span class="line"><span class="attr">    logpath:</span> <span class="string">/var/log/nginx/access.log</span></span><br></pre></td></tr></table></figure>
<p>The next section glosses over how the tasks of the role actually work. </p>
<hr>
<h2 id="3-–-Examining-the-Role’s-Tasks"><a href="#3-–-Examining-the-Role’s-Tasks" class="headerlink" title="3 – Examining the Role’s Tasks"></a>3 – Examining the Role’s Tasks</h2><p>Taking a glance at the <code>tasks/main.yml</code> is worthwhile. It explains how the variables from the previous section are implemented, alongside the Jinja file templates, that are to be processed and copied across. </p>
<p>The first block of YAML is a task that creates/copies the local version of <strong>the main Fail2ban configuration file,</strong> onto the target. </p>
<figure class="highlight yml"><figcaption><span>tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">update</span> <span class="string">configuration</span> <span class="string">file</span> <span class="bullet">-</span> <span class="string">/etc/fail2ban/fail2ban.local</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">etc/fail2ban/fail2ban.local.j2</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/fail2ban/fail2ban.local</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="number">0644</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">configuration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban-configuration</span></span><br></pre></td></tr></table></figure>
<p>The second block of YAML is a task that creates/copies the local version of <strong>the Fail2ban jail configuration file,</strong> again onto the target. </p>
<figure class="highlight yml"><figcaption><span>tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">update</span> <span class="string">configuration</span> <span class="string">file</span> <span class="bullet">-</span> <span class="string">/etc/fail2ban/jail.local</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">etc/fail2ban/jail.local.j2</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/fail2ban/jail.local</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="number">0644</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">configuration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban-configuration</span></span><br></pre></td></tr></table></figure>
<p>The third task block only runs when the <code>fail2ban_filterd_path</code> variable is set. Which assigns the path to the directory containing custom “filter” files, that you need copying across. </p>
<figure class="highlight yml"><figcaption><span>tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">copy</span> <span class="string">filters</span></span><br><span class="line"><span class="attr">  copy:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">"<span class="template-variable">&#123;&#123; fail2ban_filterd_path &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/fail2ban/filter.d/</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="number">0644</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">fail2ban_filterd_path</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">configuration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban-filters</span></span><br></pre></td></tr></table></figure>
<p>The next task block only runs when the <code>fail2ban_actiond_path</code> variable is set. Which assigns the local path to the directory containing custom “actions” files, that you need copying across. </p>
<figure class="highlight yml"><figcaption><span>tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">copy</span> <span class="string">actions</span></span><br><span class="line"><span class="attr">  copy:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">"<span class="template-variable">&#123;&#123; fail2ban_actiond_path &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/fail2ban/action.d/</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="number">0644</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">fail2ban_actiond_path</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">configuration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban-actions</span></span><br></pre></td></tr></table></figure>
<p>And the final task displayed here runs when the <code>fail2ban_actiond_jail</code> variable is set. Similarily this defines the local path to the directory containing custom “jail” configs. </p>
<figure class="highlight yml"><figcaption><span>tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">copy</span> <span class="string">jails</span></span><br><span class="line"><span class="attr">  copy:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">"<span class="template-variable">&#123;&#123; fail2ban_jaild_path &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/fail2ban/jail.d/</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="number">0644</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">fail2ban_jaild_path</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">configuration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban-jails</span></span><br></pre></td></tr></table></figure>
<p>Hopefully this all makes sense, explaining how the role is written and used.</p>
<hr>
<h2 id="4-–-Testing-and-Running-the-Playbook-Role"><a href="#4-–-Testing-and-Running-the-Playbook-Role" class="headerlink" title="4 – Testing and Running the Playbook Role"></a>4 – Testing and Running the Playbook Role</h2><p>After all of this is in place, test the new role by running your playbook. </p>
<p>This could be either as part of a Vagrant VM, Docker container, or on a live host. </p>
<p>From a live host’s perspective, on a blank Ubuntu 18.04 Bionic server, and using the global <code>hosts</code> file with all the hosts defined beforehand, un a syntax check on the playbook to ensure it’s all legit.  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook playbook.yml --syntax-check</span><br></pre></td></tr></table></figure>
<p>No errors in terms of the written contents means you’re good to actually run the playbook. </p>
<p>But wait, in order to examine how the role’s tasks play out (yay puns), without actually implementing anything remotely, there’s the <code>--check</code> option. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook <span class="_">-l</span> <span class="built_in">test</span>-host -u root playbook.yml --check</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Some modules cannot properly complete their operations in “–check” mode so may  fail (e.g. the user module when attempting to create encrypted system passwords for users).</p>
</blockquote>
<p>This is optional but a convenient way of seeing the results before actually committing, so to speak.</p>
<p>Now we’re certain everything’s as it should be, here’s the command to directly run the playbook, and in turn the Fail2ban installation role. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook <span class="_">-l</span> <span class="built_in">test</span>-host -u root playbook.yml</span><br></pre></td></tr></table></figure>
<p>A bonus idea is to <em>“tag”</em> your roles in the main playbook using this form of syntax on line 10:</p>
<figure class="highlight yml"><figcaption><span>playbook.yml </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">provision</span> <span class="string">ubuntu</span> <span class="number">18.04</span> <span class="string">(bionic</span> <span class="string">beaver)</span> <span class="string">droplets</span> </span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fixes</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">base</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">users</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ufw</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;role:</span> <span class="string">'fail2ban'</span><span class="string">,</span> <span class="attr">tags:</span> <span class="string">'fail2ban'</span><span class="string">&#125;</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ntp</span></span><br></pre></td></tr></table></figure>
<p>Which allows you to run <strong>only</strong> this role at playbook runtime, excluding the other listed roles. </p>
<p>So once tagged (in regards to the above), execute the playbook and specify the “fail2ban” tagging:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook <span class="_">-l</span> <span class="built_in">test</span>-host -u root playbook.yml --tags <span class="string">"fail2ban"</span> --check</span><br></pre></td></tr></table></figure>
<p>This is once again useful for selective testing purposes.  </p>
<blockquote>
<p><strong>Note:</strong> From what I can tell there’s no inbuilt function in Ansible to run select individual roles in a playbook, other than this <code>tags:</code> directive, unfortunately.</p>
</blockquote>
<p>Check the two files in the remote server’s <code>/etc/fail2ban</code> to see the applied directives from our <code>defaults/main.yml</code> file. This is the best way of confirming the changes we wanted are now in effect; Ansible does confirm and show changes during it’s task execution though!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo less /etc/fail2ban/jail.local</span><br><span class="line">$ sudo less /etc/fail2ban/fail2ban.local</span><br></pre></td></tr></table></figure>
<p>Another brief post I may publish in the future, will go into detail on some further examples of jail configs, for various services. </p>
<p>Thanks!</p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://blog.ssdnodes.com/blog/tutorial-a-more-secure-ansible-playbook-part-2/" target="_blank" rel="external">ServerWise – Tutorial: A More Secure Ansible Playbook, Part 2</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_checkmode.html" target="_blank" rel="external">Official Ansible Documentation – Check Mode (“Dry Run”)</a></li>
<li><a href="https://stackoverflow.com/questions/38350674/ansible-can-i-execute-role-from-command-line#38384205" target="_blank" rel="external">Stack Overflow – Ansible: Can I execute a role from the command line?</a></li>
</ul>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/Security/" class="post__tag__link">Security</a></li><li class="post__tag__item"><a href="/tags/Ubuntu/" class="post__tag__link">Ubuntu</a></li><li class="post__tag__item"><a href="/tags/Bionic/" class="post__tag__link">Bionic</a></li></ul><a href="/2018/05/23/ansible-fail2ban-role/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2018-05-18T23:00:00.000Z" class="post__time">May 19, 2018</time><h1 class="post__title"><a href="/2018/05/19/ansible-fail2ban-playbook/">Installing Fail2ban with Ansible on Ubuntu 18.04 (Bionic Beaver)</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/klPwJ5E.png" alt="Fail2ban Logo with Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>This is a very short post covering a rudimentary Ansible playbook (if you can even call it one) that contains tasks for installing Fail2ban in a straightforward manner. It’s intended as a follow on from the manual set of instructions/commands most people are familiar with, which I covered in this other post: </p>
<blockquote>
<p><a href="https://www.tricksofthetrades.net/2018/05/18/fail2ban-installing-bionic/">Installing Fail2ban on Ubuntu 18.04 (Bionic Beaver)</a></p>
</blockquote>
<p>At the end I’m linking to a third and final post which goes into detail on a more extensive solution to installing Fail2ban, as part of an Ansible <em>provisioning</em> project. It uses an Ansible role rather than a standalone playbook. </p>
<a id="more"></a>
<hr>
<h1 id="Installing-Fail2ban-with-Ansible"><a href="#Installing-Fail2ban-with-Ansible" class="headerlink" title="Installing Fail2ban with Ansible"></a>Installing Fail2ban with Ansible</h1><p>This is probably the most simple and obvious solution outside of manually installing. It exists in the form of a single playbook and template file. </p>
<p>Somewhere suitable (e.g. in version control) create the main playbook file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim fail2ban-playbook.yml</span><br></pre></td></tr></table></figure>
<p>Enter in the following playbook contents:</p>
<figure class="highlight yml"><figcaption><span>fail2ban-playbook.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span><span class="bullet">--</span> </span><br><span class="line"><span class="attr">- name:</span> <span class="string">installs</span> <span class="string">fail2ban</span> <span class="string">on</span> <span class="string">ansible</span> <span class="string">hosts</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">fail2ban-hosts</span></span><br><span class="line"><span class="attr">  become:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">install</span> <span class="string">apt</span> <span class="string">fail2ban</span> <span class="string">packages</span></span><br><span class="line"><span class="attr">    apt:</span> </span><br><span class="line"><span class="attr">      name:</span> <span class="string">"<span class="template-variable">&#123;&#123; item &#125;&#125;</span>"</span>   </span><br><span class="line"><span class="attr">      state:</span> <span class="string">latest</span></span><br><span class="line"><span class="attr">      update_cache:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      cache_valid_time:</span> <span class="number">3600</span></span><br><span class="line"><span class="attr">    with_items:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">sendmail</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">override</span> <span class="string">the</span> <span class="string">basic</span> <span class="string">fail2ban</span> <span class="string">configuration</span> <span class="string">with</span> <span class="string">.local</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    copy:</span></span><br><span class="line"><span class="attr">      src:</span> <span class="string">jail.local.j2</span></span><br><span class="line"><span class="attr">      dest:</span> <span class="string">/etc/fail2ban/jail.local</span></span><br><span class="line"><span class="attr">      owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">      group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">      mode:</span> <span class="number">0644</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> <a href="https://gist.github.com/5car1z/76dd1e48f9b16dbd2fb370bba1e2d393" target="_blank" rel="external">Here’s the same contents as a Gist.</a></p>
</blockquote>
<p>The first task updates the package manager cache (if it has not been updated within a set time period) and then installs the <code>fail2ban</code> plus <code>sendmail</code> packages. </p>
<p>The second copies across a local configuration file for Fail2ban, whilst giving it the necessary permissions and ownership’s. </p>
<p>Next create the previously mentioned template file (locally still of course).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim jail.local</span><br></pre></td></tr></table></figure>
<p>Add in your own Fail2ban configuration settings; these are mine for example purposes, but can be used:</p>
<figure class="highlight bash"><figcaption><span>jail.local</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line"></span><br><span class="line"><span class="comment"># email address to receive notifications.</span></span><br><span class="line">destemail = root@localhost    </span><br><span class="line"><span class="comment"># the email address from which to send emails.</span></span><br><span class="line">sender = root@&lt;fq-hostname&gt;    </span><br><span class="line"><span class="comment"># name on the notification emails.</span></span><br><span class="line">sendername = Fail2Ban    </span><br><span class="line"><span class="comment"># email transfer agent to use. </span></span><br><span class="line">mta = sendmail   </span><br><span class="line"></span><br><span class="line"><span class="comment"># see action.d/ufw.conf</span></span><br><span class="line">actionban = ufw.conf</span><br><span class="line"><span class="comment"># see action.d/ufw.conf </span></span><br><span class="line">actionunban = ufw.conf   </span><br><span class="line"></span><br><span class="line">[sshd]</span><br><span class="line">enabled = <span class="literal">true</span></span><br><span class="line">port = ssh</span><br><span class="line">filter = sshd</span><br><span class="line"><span class="comment"># the length of time between login attempts for maxretry. </span></span><br><span class="line">findtime = 600</span><br><span class="line"><span class="comment"># attempts from a single ip before a ban is imposed.</span></span><br><span class="line">maxretry = 5</span><br><span class="line"><span class="comment"># the number of seconds that a host is banned for.</span></span><br><span class="line">bantime = 3600</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> <a href="https://gist.github.com/5car1z/9c143fd17e61d074ec95207380ba9969" target="_blank" rel="external">Here’s the same contents as a Gist.</a></p>
</blockquote>
<p>These settings assume accompanied <a href="https://www.tricksofthetrades.net/2017/02/14/installing-using-ufw/">use of UFW as a firewall on the host</a> - hence the <code>actionban</code> lines. </p>
<p>It would make sense to create a local Ansible config and local hosts file to keep everything contained to the current repo/directory. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim ansible.cfg</span><br></pre></td></tr></table></figure>
<p>Point Ansible commands to use a local <code>hostfile</code> named <code>hosts</code>. </p>
<figure class="highlight yml"><figcaption><span>ansible.cfg </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[defaults]</span></span><br><span class="line"><span class="string">hostfile</span> <span class="string">=</span> <span class="string">hosts</span></span><br></pre></td></tr></table></figure>
<p>Create the local “hosts” file in turn. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim hosts</span><br></pre></td></tr></table></figure>
<p>The <code>hosts</code> file needs to then contain your target host’s details, using Ansible YAML syntax such as:</p>
<figure class="highlight yml"><figcaption><span>hosts </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[fail2ban-hosts]</span></span><br><span class="line"><span class="string">host-one</span> <span class="string">ansible_host=your.vps.ip.address</span> <span class="string">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class="line"><span class="string">host-two</span> <span class="string">ansible_host=your.vps.ip.address</span> <span class="string">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class="line"><span class="string">host-three</span> <span class="string">ansible_host=your.vps.ip.address</span> <span class="string">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class="line"><span class="comment"># Add more hosts here as needed.</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Currently Ansible uses Python 2.7 system libraries, and most Ubuntu images have Python 3.0+ installed. So this “interpreter” variable is usually necessary to access the correct libraries with Ansible.  </p>
</blockquote>
<p>Running the playbook on the remote host (or set of remote hosts) is then rather easy. </p>
<p>Make sure to include <code>-K</code> for the playbook’s <code>become:</code> password. Substitution for your own username (<code>scarlz</code> in my case) is also necessary - the user must have <em>sudo</em> privileges. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -u scarlz -K fail2ban-playbook.yml</span><br></pre></td></tr></table></figure>
<p>These few steps are for all intents and purposes everything that’s needed in a basic working install. For a less simplistic approach to installing Fail2ban, take a look at it again through the perspective of a more complex Ansible role instead:</p>
<blockquote>
<p><a href="https://www.tricksofthetrades.net/2018/05/23/ansible-fail2ban-role/">Installing Fail2ban with an Ansible Role on Ubuntu 18.04 (Bionic Beaver)</a> </p>
</blockquote>
<p>This was very short and terse due to its simplicity, but thanks for reading. </p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://stackoverflow.com/questions/26469896/how-to-install-fail2ban-using-ansible" target="_blank" rel="external">Stack Overflow – How to Install Fail2ban using Ansible</a></li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/Security/" class="post__tag__link">Security</a></li><li class="post__tag__item"><a href="/tags/Ubuntu/" class="post__tag__link">Ubuntu</a></li><li class="post__tag__item"><a href="/tags/Bionic/" class="post__tag__link">Bionic</a></li></ul><a href="/2018/05/19/ansible-fail2ban-playbook/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2018-05-17T23:00:00.000Z" class="post__time">May 18, 2018</time><h1 class="post__title"><a href="/2018/05/18/fail2ban-installing-bionic/">Installing Fail2ban on Ubuntu 18.04 (Bionic Beaver)</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/RdP4s4d.jpg" alt="Fail2ban Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>A highly condensed set of basic commands to install Fail2ban the traditional way. These can be executed on any remote server/VPS running recent versions of Ubuntu; although the process was carried out by myself on 18.04. If you’re not familiar with Fail2ban, the start of this brief guide refers to two good resources you can read up on. One more up to date than the other.  </p>
<p>The purpose of this post is to serve as background for a follow up post which uses Ansible to install the Fail2ban package and configuration more efficiently (linked at the end). </p>
<a id="more"></a>
<hr>
<h2 id="Installing-Fail2ban"><a href="#Installing-Fail2ban" class="headerlink" title="Installing Fail2ban"></a>Installing Fail2ban</h2><p>Several of the instructions for this process are taken and adapted from an older article on DigitalOcean. They’re intended for Ubuntu 14.04 but are still overall suitable on Bionic: </p>
<blockquote>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-protect-ssh-with-fail2ban-on-ubuntu-14-04" target="_blank" rel="external">DigitalOcean – “How To Protect SSH with Fail2Ban on Ubuntu 14.04”</a></p>
</blockquote>
<p>It might be better to read through this more up to date Linode article instead however to understand what Fail2ban is, how it works, and most importantly what different values to place into the configuration files. Otherwise this may not make complete sense before doing so. </p>
<p>It may even be more preferable to follow the Linode guide in its entirety, but that’s up to you! </p>
<p>See below: </p>
<blockquote>
<p><a href="https://www.linode.com/docs/security/using-fail2ban-for-security/" target="_blank" rel="external">Linode – “Use Fail2ban to Secure Your Server”</a></p>
</blockquote>
<p>On the remote Ubuntu server in question, update the system package index. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update -y</span><br></pre></td></tr></table></figure>
<p>Download and acquire the <code>fail2ban</code> plus <code>sendmail</code> packages. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install fail2ban sendmail</span><br></pre></td></tr></table></figure>
<p>Sendmail (if not present by default) is required for Fail2ban to generate notification emails. </p>
<p>Copy the base Fail2ban config into a new <code>jail.local</code> file, in order to begin adding in the config options we want overridden and applied:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> “Fail2ban reads <code>.conf</code> configuration files first, then <code>.local</code> files overriding any settings. Because of this, all changes to the configuration are generally done in <code>.local</code> files, leaving the <code>.conf</code> files untouched.”</p>
</blockquote>
<p>Here’s where an understanding of the configuration is very much necessary. </p>
<p>Having <a href="https://www.tricksofthetrades.net/2017/02/14/installing-using-ufw/">a working firewall such as UFW on Ubuntu</a> is also a background assumption I’m working with here, as the two can work together, and a firewall’s kinda mandatory anyway of course.</p>
<p>Open the newly copied <code>jail.local</code> file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/fail2ban/jail.local</span><br></pre></td></tr></table></figure>
<p>Add in your sensible Fail2ban configuration blocks and values now; this is my example file contents, should you want to make use of them:</p>
<figure class="highlight bash"><figcaption><span>/etc/fail2ban/jail.local</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line"></span><br><span class="line"><span class="comment"># email address to receive notifications.</span></span><br><span class="line">destemail = root@localhost    </span><br><span class="line"><span class="comment"># the email address from which to send emails.</span></span><br><span class="line">sender = root@&lt;fq-hostname&gt;    </span><br><span class="line"><span class="comment"># name on the notification emails.</span></span><br><span class="line">sendername = Fail2Ban    </span><br><span class="line"><span class="comment"># email transfer agent to use. </span></span><br><span class="line">mta = sendmail   </span><br><span class="line"></span><br><span class="line"><span class="comment"># see action.d/ufw.conf</span></span><br><span class="line">actionban = ufw.conf</span><br><span class="line"><span class="comment"># see action.d/ufw.conf </span></span><br><span class="line">actionunban = ufw.conf   </span><br><span class="line"></span><br><span class="line">[sshd]</span><br><span class="line">enabled = <span class="literal">true</span></span><br><span class="line">port = ssh</span><br><span class="line">filter = sshd</span><br><span class="line"><span class="comment"># the length of time between login attempts for maxretry. </span></span><br><span class="line">findtime = 600</span><br><span class="line"><span class="comment"># attempts from a single ip before a ban is imposed.</span></span><br><span class="line">maxretry = 5</span><br><span class="line"><span class="comment"># the number of seconds that a host is banned for.</span></span><br><span class="line">bantime = 3600</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> “A host is banned if it has generated “maxretry” during the last “findtime”.”</p>
</blockquote>
<p>Lastly here <code>enable</code> the Fail2ban service on system startup.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl service <span class="built_in">enable</span> fail2ban</span><br></pre></td></tr></table></figure>
<p>Then <code>start</code> the service so it’s currently active.   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl service start fail2ban</span><br></pre></td></tr></table></figure>
<p>Fail2ban is now up and running - assuming you entered proper configuration options and have no syntax errors.  </p>
<p>As an alternate to using Systemd, restarting the entire Fail2ban server reports any runtime errors, should there be any issue, so…</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ fail2ban-client restart</span><br></pre></td></tr></table></figure>
<p>Fix any reported problems in the output, and then restart again. </p>
<p>There’s also a command to confirm the status of the server/jails. </p>
<p>Try it out: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ fail2ban-client status</span><br></pre></td></tr></table></figure>
<p>More specific information about the <code>sshd</code> jail we created in the config file is retrievable with:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ fail2ban-client status sshd</span><br></pre></td></tr></table></figure>
<p>Many more useful commands for you to explore are available, indexed at the following wiki:</p>
<blockquote>
<p><a href="https://www.fail2ban.org/wiki/index.php/Commands" target="_blank" rel="external">Fail2ban Client CLI Commands</a></p>
</blockquote>
<p>Fail2ban is now installed, running, and working! </p>
<p>Add more jails and actions for other services to expand upon it.  </p>
<p>The post leading on from this one achieves the same end result but using Ansible configuration management to do the job:</p>
<blockquote>
<p><a href="https://www.tricksofthetrades.net/2018/05/19/ansible-fail2ban-playbook/">“Installing Fail2ban with Ansible on Ubuntu 18.04 (Bionic Beaver)”</a> </p>
</blockquote>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://www.fail2ban.org/wiki/index.php/Main_Page" target="_blank" rel="external">Fail2ban Wiki</a></li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Security/" class="post__tag__link">Security</a></li><li class="post__tag__item"><a href="/tags/Ubuntu/" class="post__tag__link">Ubuntu</a></li><li class="post__tag__item"><a href="/tags/Bionic/" class="post__tag__link">Bionic</a></li></ul><a href="/2018/05/18/fail2ban-installing-bionic/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2017-10-01T23:00:00.000Z" class="post__time">October 2, 2017</time><h1 class="post__title"><a href="/2017/10/02/ansible-local-playbooks/">Ansible - Local Playbook Execution</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/0YogZaW.png" alt="Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>There are a several ways to run Ansible on a local system that I could find whilst searching the net. In this I’m covering three of the ones that were the most popular or the most prevalent. The first two seem great for their different contexts, and the third is not as necessary but worth considering perhaps.  </p>
<p>Being able to do this can be very useful for setting up your own machines or workstations (dotfiles anyone?) at least in the event that you don’t want to use traditional scripting. Also when creating playbooks that involve interacting with developer API’s this is an important component - see the “more information” section at the end, for a link to an example of this. </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Local-Play-Directives"><a href="#1-–-Local-Play-Directives" class="headerlink" title="1 – Local Play Directives"></a>1 – Local Play Directives</h1><p>This is the easiest way I found and probably most suited for when writing one or two individual playbooks. </p>
<p>Simply put, using both <code>127.0.0.1</code> for the <code>hosts:</code> directive and setting <code>connection:</code> to <code>local</code>  in a playbook ensures any tasks carried out are executed on your local machine. </p>
<p>This is an example playbook that prints “localhost” during execution to show local playback, then updates and upgrades Apt system packages; so it’s intended for Debian and or Ubuntu. </p>
<figure class="highlight bash"><figcaption><span>playbook.yml </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"></span><br><span class="line">- name: run the playbook tasks on the localhost</span><br><span class="line">  hosts: 127.0.0.1</span><br><span class="line">  connection: <span class="built_in">local</span></span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">  - name: <span class="built_in">print</span> out the hostname of target</span><br><span class="line">    <span class="built_in">command</span>: hostname</span><br><span class="line">  </span><br><span class="line">  - name: ensure aptitude is installed</span><br><span class="line">    <span class="built_in">command</span>: apt-get -y install aptitude</span><br><span class="line">  </span><br><span class="line">  - name: update the apt package index i.e. apt-get update</span><br><span class="line">    apt: update_cache=yes</span><br><span class="line"></span><br><span class="line">  - name: upgrade system packages i.e. apt-get upgrade</span><br><span class="line">    apt: upgrade=yes</span><br></pre></td></tr></table></figure>
<p>Run it as usual like any standard playbook - inclusive of  <code>-K</code> as it’ll need <code>sudo</code> privileges to complete. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -K playbook.yml</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="2-–-Repository-Config-and-Hosts-File"><a href="#2-–-Repository-Config-and-Hosts-File" class="headerlink" title="2 – Repository Config and Hosts File"></a>2 – Repository Config and Hosts File</h1><p>This second method works best in the context of a version control repository, which features multiple local playbook files and is intended to be passed around from person to person or host to host. It works by forcing Ansible to use a custom config file and in turn local hosts file.  </p>
<p>Here are the step you’d need to carry out in order to set this up in a Git repository, after setting up the repo itself. There’s also no commands for checking in, writing, and pushing files to the remote.</p>
<p>In the Git repository, create the custom <code>ansible.cfg</code> file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim ansible.cfg</span><br></pre></td></tr></table></figure>
<p>Add these contents to the file as they’re shown:</p>
<figure class="highlight bash"><figcaption><span>ansible.cfg</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">hostfile = hosts</span><br></pre></td></tr></table></figure>
<p>Save and exit the new file. </p>
<p>Then create another file, this time the custom <code>hosts</code> one.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim hosts</span><br></pre></td></tr></table></figure>
<p>The contents here consist of a group named <code>[local]</code> and a host entry listed as <code>localhost</code>. The host variable for local host <code>ansible_connection=local</code> as expected forces a local connection whenever it is targeted in a playbook. </p>
<figure class="highlight bash"><figcaption><span>hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">local</span>]</span><br><span class="line">localhost ansible_connection=<span class="built_in">local</span></span><br></pre></td></tr></table></figure>
<p>Again on a Debian/Ubuntu host you could use an adapted version of the earlier playbook as a test example, to ensure everything is working as intended. The difference here is the <code>localhost</code> value for <code>hosts:</code> and no requirement to mention the <code>connection: local</code> directive. </p>
<figure class="highlight bash"><figcaption><span>playbook.yml </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"></span><br><span class="line">- name: run the playbook tasks on the localhost</span><br><span class="line">  hosts: localhost</span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">  - name: <span class="built_in">print</span> out the hostname of target</span><br><span class="line">    <span class="built_in">command</span>: hostname</span><br><span class="line">  </span><br><span class="line">  - name: ensure aptitude is installed</span><br><span class="line">    <span class="built_in">command</span>: apt-get -y install aptitude</span><br><span class="line">  </span><br><span class="line">  - name: update the apt package index i.e. apt-get update</span><br><span class="line">    apt: update_cache=yes</span><br><span class="line"></span><br><span class="line">  - name: upgrade system packages i.e. apt-get upgrade</span><br><span class="line">    apt: upgrade=yes</span><br></pre></td></tr></table></figure>
<p>You’ll need to provide your <code>sudo</code> password with this again, to run the playbook.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -K playbook.yml</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="3-–-Global-Inventory-Hosts-Group"><a href="#3-–-Global-Inventory-Hosts-Group" class="headerlink" title="3 – Global Inventory Hosts Group"></a>3 – Global Inventory Hosts Group</h1><p>One further alternative solution (in a non version control scenario where there’s no need for portability) is to instead add the <code>[local]</code> host group to your global <code>/etc/ansible/hosts</code> file. </p>
<p>These would be the commands:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/ansible/hosts</span><br></pre></td></tr></table></figure>
<p>Append this new host group to the file. </p>
<figure class="highlight bash"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">local</span>]</span><br><span class="line">localhost ansible_connection=<span class="built_in">local</span></span><br></pre></td></tr></table></figure>
<p>Write your opening lines of playbooks with the <code>hosts: all</code> definition. Here’s the example from before, adapted to this:</p>
<figure class="highlight bash"><figcaption><span>playbook.yml </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"></span><br><span class="line">- name: run the playbook tasks on the localhost</span><br><span class="line">  hosts: all</span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">  - name: <span class="built_in">print</span> out the hostname of target</span><br><span class="line">    <span class="built_in">command</span>: hostname</span><br><span class="line">  </span><br><span class="line">  - name: ensure aptitude is installed</span><br><span class="line">    <span class="built_in">command</span>: apt-get -y install aptitude</span><br><span class="line">  </span><br><span class="line">  - name: update the apt package index i.e. apt-get update</span><br><span class="line">    apt: update_cache=yes</span><br><span class="line"></span><br><span class="line">  - name: upgrade system packages i.e. apt-get upgrade</span><br><span class="line">    apt: upgrade=yes</span><br></pre></td></tr></table></figure>
<p>Then afterwards when you want to run a playbook locally, use the <code>-l</code> switch and provide the <code>local</code> group or  <code>localhost</code> as the target host. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -K <span class="_">-l</span> localhost playbook.yml</span><br></pre></td></tr></table></figure>
<p>It’s still wise and maybe more convenient to keep local playbook execution isolated to one directory or Git repository however (using the method in the former step). I would probably not recommend this method over the other two, but whatever works best for your particular needs I guess. </p>
<p>Thanks for reading, and I hope this has helped you out with local playbook execution in some way or another.  </p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://docs.ansible.com/ansible/latest/playbooks_delegation.html#local-playbooks" target="_blank" rel="external">Ansible Official Documentation - Local Playbooks</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-use-the-digitalocean-api-v2-with-ansible-2-0-on-ubuntu-14-04" target="_blank" rel="external">How To Use the DigitalOcean API v2 with Ansible 2.0 on Ubuntu 14.04</a></li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/Ubuntu/" class="post__tag__link">Ubuntu</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Python/" class="post__tag__link">Python</a></li><li class="post__tag__item"><a href="/tags/Debian/" class="post__tag__link">Debian</a></li></ul><a href="/2017/10/02/ansible-local-playbooks/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2017-05-16T23:00:00.000Z" class="post__time">May 17, 2017</time><h1 class="post__title"><a href="/2017/05/17/vagrant-started/">How to Install and Get Started with Vagrant in 2017</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/mw4s7ic.png" alt="Vagrant Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>Despite its age and familiarity to most nowadays I couldn’t find a straight forward post on how to install and get started using Vagrant. So here’s my notes on doing so in blog post format. Be aware that this is well trodden ground and the Vagrant documentation on their website has a similar set of steps and content. The official site, if not this will get you where you need to be when it comes to getting started with Vagrant. </p>
<blockquote>
<p><a href="https://www.vagrantup.com/intro/getting-started/index.html" target="_blank" rel="external">Official Vagrant Website - Getting Started</a></p>
</blockquote>
<a id="more"></a>
<hr>
<h1 id="1-–-Install-VirtualBox"><a href="#1-–-Install-VirtualBox" class="headerlink" title="1 – Install VirtualBox"></a>1 – Install VirtualBox</h1><p>Our provider choice will be VirtualBox. The <em>provider</em> describes the software in charge of creating then managing the virtual machines comissioned by Vagrant. The two major providers are VirtualBox and VMware, VirtualBox is free and open source, whereas VMware is not. </p>
<p><a href="https://www.virtualbox.org/wiki/Linux_Downloads" target="_blank" rel="external">Find the correct installation procedure for your flavour of Linux here.</a></p>
<p>On Ubuntu you would add this line to the bottom of your <code>sources.list</code> file:</p>
<p><code>deb http://download.virtualbox.org/virtualbox/debian xenial contrib</code></p>
<p>Replacing <code>xenial</code> for your own distributions release codename. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/apt/sources.list</span><br></pre></td></tr></table></figure>
<p>You can find this codename if you don’t already know it by running this command; back on the prompt. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsb_release <span class="_">-a</span></span><br></pre></td></tr></table></figure>
<p>For Debian 8 (“Jessie”) and Ubuntu 16.04 (“Xenial”) or later distributions. Download and add the repositories PGP key. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-key add -</span><br></pre></td></tr></table></figure>
<p>Update the apt-get package database and install the <code>virtualbox</code> packages. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install virtualbox</span><br></pre></td></tr></table></figure>
<p>VirtualBox is now installed and ready to use. </p>
<hr>
<h1 id="2-–-Install-Vagrant"><a href="#2-–-Install-Vagrant" class="headerlink" title="2 – Install Vagrant"></a>2 – Install Vagrant</h1><p><a href="https://www.vagrantup.com/downloads.html" target="_blank" rel="external">Find the correct binary for your version of Linux, then download it with the URL and Wget.</a></p>
<p>Here’s the <code>wget</code> command and correct URL for downloading the latest version of Vagrant on Debian (at the time of writing this) - yours may differ.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://releases.hashicorp.com/vagrant/2.1.1/vagrant_2.1.1_x86_64.deb ~</span><br></pre></td></tr></table></figure>
<p>To then install the binary as a package on the system, use:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo dpkg -i vagrant_2.1.1_x86_64.deb</span><br></pre></td></tr></table></figure>
<p>You can remove the Vagrant <code>.deb</code> build file from your user’s home directory now, after it’s been installed. </p>
<hr>
<h2 id="3-–-Download-and-Use-a-Vagrant-Box"><a href="#3-–-Download-and-Use-a-Vagrant-Box" class="headerlink" title="3 – Download and Use a Vagrant Box"></a>3 – Download and Use a Vagrant Box</h2><p>Make a temporary test directory, and change into it, before continuing. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir ~/vagrant-test &amp;&amp; <span class="built_in">cd</span> vagrant-test</span><br></pre></td></tr></table></figure>
<p>To test the install, you can download and run a basic Vagrant box as a VM by running the next set of commands.</p>
<p>So we’re clear, here’s a good definition of a what a Vagrant “box” actually is: </p>
<blockquote>
<p>“A package containing a representation of a virtual machine running a specific operating system. To be more simple, it is a base image of any Operating System or Kernel. It may be for a specific Provider.”</p>
</blockquote>
<p>The box is the image, and from this image a virtual machine (VM) is created on the localhost. </p>
<p>The basic Vagrant configuration for this VM will be based in one file, the <code>Vagrantfile</code>. </p>
<p>This file is placed in the <code>~/vagrant-test</code> directory via:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant init ubuntu/xenial64</span><br></pre></td></tr></table></figure>
<p>There are a wide variety of different box types (various OS images) listed on <a href="https://atlas.hashicorp.com/boxes/search" target="_blank" rel="external">Hashi corp’s  Atlas index.</a></p>
<p>After issuing the next command Vagrant will start to download the box and attempt to create and run a VM through VirtualBox.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant up</span><br></pre></td></tr></table></figure>
<p>Here’s an example of what the progress output looks like for this:</p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">==&gt; default: Box <span class="string">'ubuntu/xenial64'</span> could not be found. Attempting to find and install...</span><br><span class="line">    default: Box Provider: virtualbox</span><br><span class="line">    default: Box Version: &gt;= 0</span><br><span class="line">==&gt; default: Loading metadata <span class="keyword">for</span> box <span class="string">'ubuntu/xenial64'</span></span><br><span class="line">    default: URL: https://atlas.hashicorp.com/ubuntu/xenial64</span><br><span class="line">==&gt; default: Adding box <span class="string">'ubuntu/xenial64'</span> (v2017.05.01) <span class="keyword">for</span> provider: virtualbox</span><br><span class="line">    default: Downloading: https://vagrantcloud.com/ogarcia/boxes/archlinux-x32/versions/2017.05.01/providers/virtualbox.box</span><br><span class="line">==&gt; default: Successfully added box <span class="string">'ubuntu/xenial64'</span> (v2017.05.01) <span class="keyword">for</span> <span class="string">'virtualbox'</span>!</span><br><span class="line">==&gt; default: Importing base box <span class="string">'ubuntu/xenial64'</span>...</span><br><span class="line">==&gt; default: Matching MAC address <span class="keyword">for</span> NAT networking...</span><br><span class="line">==&gt; default: Checking <span class="keyword">if</span> box <span class="string">'ubuntu/xenial64'</span> is up to date...</span><br><span class="line">==&gt; default: Setting the name of the VM: vagrant-testing_default_1494195673719_66642</span><br><span class="line">==&gt; default: Clearing any previously <span class="built_in">set</span> network interfaces...</span><br><span class="line">==&gt; default: Preparing network interfaces based on configuration...</span><br><span class="line">    default: Adapter 1: nat</span><br><span class="line">==&gt; default: Forwarding ports...</span><br><span class="line">    default: 22 (guest) =&gt; 2222 (host) (adapter 1)</span><br><span class="line">==&gt; default: Booting VM...</span><br><span class="line">==&gt; default: Waiting <span class="keyword">for</span> machine to boot. This may take a few minutes...</span><br><span class="line">    default: SSH address: 127.0.0.1:2222</span><br><span class="line">    default: SSH username: vagrant</span><br><span class="line">    default: SSH auth method: private key</span><br><span class="line">    default: </span><br><span class="line">    default: Vagrant insecure key detected. Vagrant will automatically replace</span><br><span class="line">    default: this with a newly generated keypair <span class="keyword">for</span> better security.</span><br><span class="line">    default: </span><br><span class="line">    default: Inserting generated public key within guest...</span><br><span class="line">    default: Removing insecure key from the guest <span class="keyword">if</span> it<span class="string">'s present...</span><br><span class="line">    default: Key inserted! Disconnecting and reconnecting using new SSH key...</span><br><span class="line">==&gt; default: Machine booted and ready!</span><br><span class="line">==&gt; default: Checking for guest additions in VM...</span><br><span class="line">    default: The guest additions on this VM do not match the installed version of</span><br><span class="line">    default: VirtualBox! In most cases this is fine, but in rare cases it can</span><br><span class="line">    default: prevent things such as shared folders from working properly. If you see</span><br><span class="line">    default: shared folder errors, please make sure the guest additions within the</span><br><span class="line">    default: virtual machine match the version of VirtualBox you have installed on</span><br><span class="line">    default: your host and reload your VM.</span><br><span class="line">    default: </span><br><span class="line">    default: Guest Additions Version: 5.1.22 r115126</span><br><span class="line">    default: VirtualBox Version: 5.0</span><br><span class="line">==&gt; default: Mounting shared folders...</span><br><span class="line">    default: /vagrant =&gt; /home/scarlz/vagrant-testing</span></span><br></pre></td></tr></table></figure>
<p>You can get an error message here relating to CPU architecture if you use a box that isn’t intended for your host’s operating system.</p>
<p>For example, the first image here requires a 64-bit host operating system, and then the second is for a 32-bit version. The “host” here refers to the machine you installed Vagrant on.</p>
<ul>
<li><a href="https://atlas.hashicorp.com/ubuntu/boxes/xenial64" target="_blank" rel="external">https://atlas.hashicorp.com/ubuntu/boxes/xenial64</a></li>
<li><a href="https://atlas.hashicorp.com/ubuntu/boxes/trusty32" target="_blank" rel="external">https://atlas.hashicorp.com/ubuntu/boxes/trusty32</a></li>
</ul>
<p>In my example we used the first box, a 64-bit system. </p>
<p>Also if you are running Vagrant itself in a virtual machine (using a hypervisor). Then you’ll need to ensure your hypervisor has “VT-x/AMD-V enabled”.</p>
<p>To enable this you’ll have to do something along the lines of:</p>
<ol>
<li>Power off the host virtual machine.</li>
<li>Edit the individual virtual machine’s settings.</li>
<li>Go to the CPU/processors section.</li>
<li>Enable “VT-x/AMD-V” /  “Virtualise Intel VR-x/EPT and AMD-V/RVI”</li>
<li>Then power on the virtual machine again.</li>
<li>Re-run <code>vagrant up</code> in your Vagrant testing directory.</li>
</ol>
<p>Here is what the setting looks like when using VMware Workstation as your hypervisor.</p>
<p><img src="https://i.gyazo.com/2f12d720498b753e09eb79f6f31117c9.png" alt="Vmware CPU Section Image"></p>
<hr>
<h1 id="4-–-Connect-to-a-Running-VM"><a href="#4-–-Connect-to-a-Running-VM" class="headerlink" title="4 – Connect to a Running VM"></a>4 – Connect to a Running VM</h1><p>Once a box is installed and configured to run in a VM (like in step 2), you connect to the VM through an SSH tunnel created by Vagrant. </p>
<p>To connect to the newly running VM with Vagrant use:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant ssh</span><br></pre></td></tr></table></figure>
<p>The prompt now shows you are connected to your new VM!</p>
<figure class="highlight bash"><figcaption><span>prompt example</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-xenial:~$</span><br></pre></td></tr></table></figure>
<p>Type <code>exit</code> or use <code>CTRL + D</code> to leave the VM’s command line and return to your host. </p>
<hr>
<h1 id="5-–-Vagrant-Sub-commands"><a href="#5-–-Vagrant-Sub-commands" class="headerlink" title="5 – Vagrant Sub-commands"></a>5 – Vagrant Sub-commands</h1><p>These are the commands you’ll find yourself using when working with Vagrant. They use subsets of subcommands - which may seem confusing at first glance. The first is <code>box</code> and has several susbets. Not all however have them.</p>
<h2 id="box"><a href="#box" class="headerlink" title="box"></a><a href="https://www.vagrantup.com/docs/cli/box.html" target="_blank" rel="external">box</a></h2><p>List all the boxes you currently have installed on the host. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant box list</span><br></pre></td></tr></table></figure>
<p>Remove an already existing box from Vagrant. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant box remove ubuntu/xenial64</span><br></pre></td></tr></table></figure>
<p>Check updates for all box images on your system. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant box update</span><br></pre></td></tr></table></figure>
<p>Many of these commands can have the box named appended to them. In order to single them out. </p>
<h2 id="destroy"><a href="#destroy" class="headerlink" title="destroy"></a><a href="https://www.vagrantup.com/docs/cli/destroy.html" target="_blank" rel="external">destroy</a></h2><p>The Vagrant documentation sums this command up pretty well:</p>
<blockquote>
<p>“This command stops the running machine Vagrant is managing and destroys all resources that were created during the machine creation process. After running this command, your computer should be left at a clean state, as if you never created the guest machine in the first place.”</p>
</blockquote>
<p>Use it to destroy your created virual machines e.g.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant destroy ubuntu/xenial64</span><br></pre></td></tr></table></figure>
<h2 id="halt"><a href="#halt" class="headerlink" title="halt"></a><a href="https://www.vagrantup.com/docs/cli/halt.html" target="_blank" rel="external">halt</a></h2><p>This command shuts down the running virtual machine Vagrant is currently managing; you can add a machine name/ID to target specific VM’s</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant halt</span><br></pre></td></tr></table></figure>
<h2 id="reload"><a href="#reload" class="headerlink" title="reload"></a><a href="https://www.vagrantup.com/docs/cli/reload.html" target="_blank" rel="external">reload</a></h2><p>This is the same as a <code>vagrant halt</code> but restarts the VM after halting - like with <code>vagrant up</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant reload</span><br></pre></td></tr></table></figure>
<h2 id="port"><a href="#port" class="headerlink" title="port"></a><a href="https://www.vagrantup.com/docs/cli/port.html" target="_blank" rel="external">port</a></h2><p>This allows you to list all the Vagrant guest ports that are mapped to the host ports. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant port</span><br></pre></td></tr></table></figure>
<h2 id="ssh-config"><a href="#ssh-config" class="headerlink" title="ssh_config"></a><a href="https://www.vagrantup.com/docs/cli/ssh_config.html" target="_blank" rel="external">ssh_config</a></h2><p>Useful for displaying the output of the Vagrant host side SSH configuration file. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant ssh-config</span><br></pre></td></tr></table></figure>
<p>Returns:</p>
<figure class="highlight bash"><figcaption><span>Example Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Host default</span><br><span class="line">  HostName 127.0.0.1</span><br><span class="line">  User ubuntu</span><br><span class="line">  Port 2222</span><br><span class="line">  UserKnownHostsFile /dev/null</span><br><span class="line">  StrictHostKeyChecking no</span><br><span class="line">  PasswordAuthentication no</span><br><span class="line">  IdentityFile /home/scarlz/vagrant-ubuntu-test/.vagrant/machines/default/virtualbox/private_key</span><br><span class="line">  IdentitiesOnly yes</span><br><span class="line">  LogLevel FATAL</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="6-–-Miscellaneous"><a href="#6-–-Miscellaneous" class="headerlink" title="6 – Miscellaneous"></a>6 – Miscellaneous</h2><p>Should there ever be any SSH connection issues to a VM. The connection log can be seen by appending <code>--debug</code> to the command. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant ssh --debug</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> This <code>--debug</code> flag can be added onto most Vagrant commands to see the internal operations being carried out. </p>
</blockquote>
<p>Checking the status of the current Vagrant virtual machine is possible by entering:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant status</span><br></pre></td></tr></table></figure>
<p>A global version also exists.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant global-status</span><br></pre></td></tr></table></figure>
<p>Adding the <code>--prune</code> flag updates the cache for this - thereby removing any old, dead entries from the output. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant global-status --prune</span><br></pre></td></tr></table></figure>
<p>Looking back to the <code>Vagrantfile</code> configuration. We can see that there are different options on offer to configure the resultant VM(s). </p>
<p>One to highlight is the VM name that is assigned to both the provider (VirtualBox) and internal Vagrant machine “name”. </p>
<p>This is the code to explicitly define it in both instances, if you ever want to:</p>
<figure class="highlight bash"><figcaption><span>Vagrantfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Vagrant.configure(VAGRANTFILE_API_VERSION) <span class="keyword">do</span> |config|</span><br><span class="line"></span><br><span class="line"> config.vm.define <span class="string">"ubuntu_test_vm"</span> <span class="keyword">do</span> |vmname|</span><br><span class="line"> end</span><br><span class="line">  </span><br><span class="line"> config.vm.provider :virtualbox <span class="keyword">do</span> |vb|</span><br><span class="line">     vb.name = <span class="string">"ubuntu_test_vm"</span></span><br><span class="line"> end</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>Line 3 determines the <code>&quot;name&quot;</code> listed when issuing: <code>vagrant global-status</code></p>
<p>Whilst line 5/6 ensures VirtualBox names and displays the VM properly in its GUI. </p>
<p><img src="https://i.imgur.com/CrSEOo4.png" alt="VirtualBox Ubuntu VM Image"></p>
<p><a href="https://www.vagrantup.com/docs/vagrantfile/" target="_blank" rel="external">How the Vagrantfile works in terms of configuration is described in detail here.</a></p>
<hr>
<h2 id="7-–-Autocompletion"><a href="#7-–-Autocompletion" class="headerlink" title="7 – Autocompletion"></a>7 – Autocompletion</h2><p>A nice addition to Vagrant is shell auto completion (Bash shell) for when typing in the above commands.  An up to date (at the time of writing this) repo which provides this is located here: </p>
<blockquote>
<p><a href="https://github.com/brbsix/vagrant-bash-completion" target="_blank" rel="external">https://github.com/brbsix/vagrant-bash-completion</a></p>
</blockquote>
<p>This is a fork of <a href="https://github.com/kura/vagrant-bash-completion" target="_blank" rel="external">Kura’s old repo</a>; thanks go to him for maintaining this up until now. Here’s the provided “easiest” method of downloading this functionality to your Linux/Unix host system. </p>
<p><code>wget</code> the script file in the above repo. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget -q https://raw.github.com/brbsix/vagrant-bash-completion/master/vagrant-bash-completion/etc/bash_completion.d/vagrant</span><br></pre></td></tr></table></figure>
<p>Add the newly downloaded file to the system Bash completion directory - whilst modifying the file’s permissions. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo install -m 0644 vagrant /etc/bash_completion.d/</span><br></pre></td></tr></table></figure>
<p>Now either close and re-open your terminal, or <code>source</code> in the new <code>/etc/bash_completion.d/vagrant</code> bash completion file. To get the new auto-completion working. </p>
<hr>
<h1 id="8-–-Further-Reading"><a href="#8-–-Further-Reading" class="headerlink" title="8 – Further Reading"></a>8 – Further Reading</h1><p>Erika Heidi has recently revisited and updated her great in-depth book dedicated to Vagrant. For a full run down of Vagrant and how to add configuration management tools into the mix. I’d highly recommend this book. </p>
<p><img src="https://i.imgur.com/0kT5WIB.png" alt="Cookbook - Frontcover"></p>
<blockquote>
<p><a href="https://leanpub.com/vagrantcookbook" target="_blank" rel="external">https://leanpub.com/vagrantcookbook</a></p>
</blockquote>
<p>There’s an accompanying blog post from February 2017 that she’s put together on recent Vagrant usage and trends. It’s quite short and worth reading if you’re interested.</p>
<blockquote>
<p><a href="http://www.erikaheidi.com/blog/vagrant-usage-research-2017/" target="_blank" rel="external">http://www.erikaheidi.com/blog/vagrant-usage-research-2017/</a></p>
</blockquote>
<p>The infographic (which I’ll leave here) is the main takeaway from the post:</p>
<p><img src="http://www.erikaheidi.com/files/2017-02/vagrant-research-2017.png" alt="The State of Vagrant Infographic"></p>
<hr>
<p>Vagrant is a slightly ageing software in the sense that many prefer more recent tools like Docker. It does however still have its uses and is quite well adopted these days, so it’s more than worth understanding at least the basics.</p>
<p>Enjoy your time with Vagrant.  </p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://stackoverflow.com/questions/17175696/running-vagrant-inside-vmware-vm" target="_blank" rel="external">Stack Overflow - Running Vagrant Inside VMWare VM</a> – As mentioned in step 2. </li>
<li><a href="https://stackoverflow.com/questions/22922891/vagrant-ssh-authentication-failure" target="_blank" rel="external">Stack Overflow - Vagrant ssh authentication failure</a> – An issue that seems to occur with the official Vagrant Ubuntu images. </li>
<li><a href="https://stackoverflow.com/questions/17845637/how-to-change-vagrant-default-machine-name" target="_blank" rel="external">Stack Overflow - How to change Vagrant ‘default’ machine name?</a> – Complex but comprehensive thread for this. </li>
<li><a href="https://stackoverflow.com/questions/24440142/removing-list-of-vms-in-vagrant-cache" target="_blank" rel="external">Stack Overflow - Removing list of vms in vagrant cache</a> – For when the status output is not accurate/updating. </li>
<li><a href="https://github.com/mitchellh/vagrant/issues/5186" target="_blank" rel="external">“Warning: Authentication failure. Retrying…”</a> – A very detailed long-term GitHub thread detailing the aforementioned issue. </li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ubuntu/" class="post__tag__link">Ubuntu</a></li><li class="post__tag__item"><a href="/tags/Virtualisation/" class="post__tag__link">Virtualisation</a></li><li class="post__tag__item"><a href="/tags/Vagrant/" class="post__tag__link">Vagrant</a></li></ul><a href="/2017/05/17/vagrant-started/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2018 Scarlz</div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"></span></li><li class="page-menu__item"><a title="Next" href="/tags/Ubuntu/page/2/" class="page-menu__link icon-arrow-right"></a></li></menu></footer><script>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src="//"+l+".disqus.com/"+k+".js",i.parentNode.insertBefore(j,i)})
(document,"script","totts","count");
</script></body></html>