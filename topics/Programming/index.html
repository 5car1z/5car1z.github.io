<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="Linux System Administration"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="/atom.xml" title="C.J. Scarlett" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Programming - C.J. Scarlett</title><link rel="stylesheet" href="/css/main.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">C.J. Scarlett</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/topics" class="head-nav__link">Topics</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="/misc" class="head-nav__link">Misc</a></li><li class="head-nav__item"><a href="/about" class="head-nav__link">About</a></li><li class="head-nav__item"><a href="/contact" class="head-nav__link">Contact</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2018-05-22T23:00:00.000Z" class="post__time">May 23, 2018</time><h1 class="post__title"><a href="/2018/05/23/ansible-fail2ban-role/">Installing Fail2ban with an Ansible Role on Ubuntu 18.04 (Bionic Beaver)</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/klPwJ5E.png" alt="Fail2ban Logo with Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>The Ansible role in question comes from Ansible Galaxy. It’s linked here below, where you can read about it more if needs be:</p>
<blockquote>
<p><a href="https://galaxy.ansible.com/tersmitten/fail2ban/" target="_blank" rel="external">https://galaxy.ansible.com/tersmitten/fail2ban/</a></p>
</blockquote>
<p>Here’s my method for making use of the role, which is within the context of an Ansible project that already automates the other aspects of setting up a server. It’s necessary to have a provisioning playbook already in place, so you can incorporate the role shown in this post into the main project.  </p>
<blockquote>
<p><a href="https://www.tricksofthetrades.net/2017/08/21/ansible-playbook-server-provisioning/">If this idea of “context” doesn’t make much sense then check out this other post I have on provisioning a server with Ansible for Debian 8 (Jessie).</a></p>
</blockquote>
<a id="more"></a>
<hr>
<h2 id="1-–-Acquiring-the-Files"><a href="#1-–-Acquiring-the-Files" class="headerlink" title="1 – Acquiring the Files"></a>1 – Acquiring the Files</h2><p>Starting from within the <em>root</em> directory of your own Ansible server <em>“provisioning”</em> project (most likely a version controlled project). </p>
<p>Clone the <code>ansible-fail2ban</code> repo from GitHub into your project:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/Oefenweb/ansible-fail2ban.git roles/fail2ban</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Alternatively you can use <code>ansible-galaxy install --roles-path roles/ tersmitten.fail2ban</code> if you don’t mind the directory name for the role being <code>tersmitten.fail2ban</code> </p>
</blockquote>
<p>Include the new role in your <strong>main</strong> playbook file’s list of roles to be performed on the host(s).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim playbook.yml</span><br></pre></td></tr></table></figure>
<p>Such as in this generic bare bones example here:</p>
<figure class="highlight yml"><figcaption><span>playbook.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">provision</span> <span class="string">ubuntu</span> <span class="number">18.04</span> <span class="string">(bionic</span> <span class="string">beaver)</span> <span class="string">servers</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">base</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">users</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ufw</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ntp</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> It does need to match the actual role directory name, so change this entry here to <code>tersmitten.fail2ban</code> if you instead used the Ansible galaxy install command earlier.</p>
</blockquote>
<hr>
<h2 id="2-–-Editing-the-Default-Ansible-Variables"><a href="#2-–-Editing-the-Default-Ansible-Variables" class="headerlink" title="2 – Editing the Default Ansible Variables"></a>2 – Editing the Default Ansible Variables</h2><p>Several default values for many Fail2ban configuration directives are already set in the role’s <code>defaults</code> directory. </p>
<p>Edit them as normal with your preferred fail2ban configuration values.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim roles/fail2ban/defaults/main.yml</span><br></pre></td></tr></table></figure>
<p>These are the general contents including one or two additions, removals, and changes of my own:</p>
<figure class="highlight yml"><figcaption><span>defaults/main.yml </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># defaults file for fail2ban</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">fail2ban_loglevel:</span> <span class="string">'INFO'</span> </span><br><span class="line"><span class="attr">fail2ban_logtarget:</span> <span class="string">/var/log/fail2ban.log</span></span><br><span class="line"><span class="attr">fail2ban_syslog_target:</span> <span class="string">/var/log/fail2ban.log</span></span><br><span class="line"><span class="attr">fail2ban_syslog_facility:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">fail2ban_socket:</span> <span class="string">/var/run/fail2ban/fail2ban.sock</span></span><br><span class="line"><span class="attr">fail2ban_pidfile:</span> <span class="string">/var/run/fail2ban/fail2ban.pid</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fail2ban_sendername:</span> <span class="string">'Fail2ban'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fail2ban_ignoreips:</span></span><br><span class="line"><span class="bullet"> -</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">/8</span></span><br><span class="line"><span class="attr">fail2ban_bantime:</span> <span class="number">3600</span></span><br><span class="line"><span class="attr">fail2ban_maxretry:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">fail2ban_findtime:</span> <span class="number">600</span></span><br><span class="line"><span class="attr">fail2ban_backend:</span> <span class="string">auto</span></span><br><span class="line"><span class="attr">fail2ban_destemail:</span> <span class="string">root@localhost</span></span><br><span class="line"><span class="attr">fail2ban_banaction:</span> <span class="string">ufw.conf</span></span><br><span class="line"><span class="attr">fail2ban_mta:</span> <span class="string">sendmail</span></span><br><span class="line"><span class="attr">fail2ban_protocol:</span> <span class="string">tcp</span></span><br><span class="line"><span class="attr">fail2ban_chain:</span> <span class="string">INPUT</span></span><br><span class="line"><span class="attr">fail2ban_action:</span> <span class="string">'%(action_)s'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fail2ban_services:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">sshd</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">ssh</span></span><br><span class="line"><span class="attr">    maxretry:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    bantime:</span> <span class="bullet">-1</span></span><br></pre></td></tr></table></figure>
<p>These Ansible variables are applied onto the target host through two Jinja templates. Variables here are split into one of these two files (see the template files themselves for specifics). New variables you wish to incorporate have to be added to <code>defaults/main.yml</code> <strong>and</strong> the relevant Jinja template file if not present.  </p>
<blockquote>
<p><a href="https://github.com/Oefenweb/ansible-fail2ban#variables" target="_blank" rel="external">Here’s the reference for the Ansible variables on offer, used by this role.</a> </p>
</blockquote>
<p>You could also override them in the <code>vars/main.yml</code> file too, if that seems more appealing, but do not define duplicate variables.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim roles/fail2ban/vars/main.yml</span><br></pre></td></tr></table></figure>
<p>This is the same common SSH daemon jail I added earlier, but in the alternative file:</p>
<figure class="highlight yml"><figcaption><span>roles/fail2ban/vars/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vars file for fail2ban</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">fail2ban_dependencies:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">fail2ban</span></span><br><span class="line"></span><br><span class="line"><span class="attr">fail2ban_services:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">sshd</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">ssh</span></span><br><span class="line"><span class="attr">    maxretry:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    bantime:</span> <span class="bullet">-1</span></span><br></pre></td></tr></table></figure>
<p>Remember not to duplicate variables between these two files!</p>
<p>So regardless of the file you choose, new jails must be included as part of the one <code>fail2ban_services:</code> variable.</p>
<p>For example, adding a second Nginx jail:</p>
<figure class="highlight yml"><figcaption><span>example.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">fail2ban_services:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">sshd</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">ssh</span></span><br><span class="line"><span class="attr">    maxretry:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">    bantime:</span> <span class="bullet">-1</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">nginx-http-auth</span></span><br><span class="line"><span class="attr">    filter:</span> <span class="string">nginx-http-auth</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">http,https</span></span><br><span class="line"><span class="attr">    logpath:</span> <span class="string">/var/log/nginx/access.log</span></span><br></pre></td></tr></table></figure>
<p>The next section glosses over how the tasks of the role actually work. </p>
<hr>
<h2 id="3-–-Examining-the-Role’s-Tasks"><a href="#3-–-Examining-the-Role’s-Tasks" class="headerlink" title="3 – Examining the Role’s Tasks"></a>3 – Examining the Role’s Tasks</h2><p>Taking a glance at the <code>tasks/main.yml</code> is worthwhile. It explains how the variables from the previous section are implemented, alongside the Jinja file templates, that are to be processed and copied across. </p>
<p>The first block of YAML is a task that creates/copies the local version of <strong>the main Fail2ban configuration file,</strong> onto the target. </p>
<figure class="highlight yml"><figcaption><span>tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">update</span> <span class="string">configuration</span> <span class="string">file</span> <span class="bullet">-</span> <span class="string">/etc/fail2ban/fail2ban.local</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">etc/fail2ban/fail2ban.local.j2</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/fail2ban/fail2ban.local</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="number">0644</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">configuration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban-configuration</span></span><br></pre></td></tr></table></figure>
<p>The second block of YAML is a task that creates/copies the local version of <strong>the Fail2ban jail configuration file,</strong> again onto the target. </p>
<figure class="highlight yml"><figcaption><span>tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">update</span> <span class="string">configuration</span> <span class="string">file</span> <span class="bullet">-</span> <span class="string">/etc/fail2ban/jail.local</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">etc/fail2ban/jail.local.j2</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/fail2ban/jail.local</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="number">0644</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">configuration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban-configuration</span></span><br></pre></td></tr></table></figure>
<p>The third task block only runs when the <code>fail2ban_filterd_path</code> variable is set. Which assigns the path to the directory containing custom “filter” files, that you need copying across. </p>
<figure class="highlight yml"><figcaption><span>tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">copy</span> <span class="string">filters</span></span><br><span class="line"><span class="attr">  copy:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">"<span class="template-variable">&#123;&#123; fail2ban_filterd_path &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/fail2ban/filter.d/</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="number">0644</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">fail2ban_filterd_path</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">configuration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban-filters</span></span><br></pre></td></tr></table></figure>
<p>The next task block only runs when the <code>fail2ban_actiond_path</code> variable is set. Which assigns the local path to the directory containing custom “actions” files, that you need copying across. </p>
<figure class="highlight yml"><figcaption><span>tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">copy</span> <span class="string">actions</span></span><br><span class="line"><span class="attr">  copy:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">"<span class="template-variable">&#123;&#123; fail2ban_actiond_path &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/fail2ban/action.d/</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="number">0644</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">fail2ban_actiond_path</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">configuration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban-actions</span></span><br></pre></td></tr></table></figure>
<p>And the final task displayed here runs when the <code>fail2ban_actiond_jail</code> variable is set. Similarily this defines the local path to the directory containing custom “jail” configs. </p>
<figure class="highlight yml"><figcaption><span>tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">copy</span> <span class="string">jails</span></span><br><span class="line"><span class="attr">  copy:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">"<span class="template-variable">&#123;&#123; fail2ban_jaild_path &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/fail2ban/jail.d/</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    mode:</span> <span class="number">0644</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">fail2ban_jaild_path</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">configuration</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban-jails</span></span><br></pre></td></tr></table></figure>
<p>Hopefully this all makes sense, explaining how the role is written and used.</p>
<hr>
<h2 id="4-–-Testing-and-Running-the-Playbook-Role"><a href="#4-–-Testing-and-Running-the-Playbook-Role" class="headerlink" title="4 – Testing and Running the Playbook Role"></a>4 – Testing and Running the Playbook Role</h2><p>After all of this is in place, test the new role by running your playbook. </p>
<p>This could be either as part of a Vagrant VM, Docker container, or on a live host. </p>
<p>From a live host’s perspective, on a blank Ubuntu 18.04 Bionic server, and using the global <code>hosts</code> file with all the hosts defined beforehand, un a syntax check on the playbook to ensure it’s all legit.  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook playbook.yml --syntax-check</span><br></pre></td></tr></table></figure>
<p>No errors in terms of the written contents means you’re good to actually run the playbook. </p>
<p>But wait, in order to examine how the role’s tasks play out (yay puns), without actually implementing anything remotely, there’s the <code>--check</code> option. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook <span class="_">-l</span> <span class="built_in">test</span>-host -u root playbook.yml --check</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Some modules cannot properly complete their operations in “–check” mode so may  fail (e.g. the user module when attempting to create encrypted system passwords for users).</p>
</blockquote>
<p>This is optional but a convenient way of seeing the results before actually committing, so to speak.</p>
<p>Now we’re certain everything’s as it should be, here’s the command to directly run the playbook, and in turn the Fail2ban installation role. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook <span class="_">-l</span> <span class="built_in">test</span>-host -u root playbook.yml</span><br></pre></td></tr></table></figure>
<p>A bonus idea is to <em>“tag”</em> your roles in the main playbook using this form of syntax on line 10:</p>
<figure class="highlight yml"><figcaption><span>playbook.yml </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">provision</span> <span class="string">ubuntu</span> <span class="number">18.04</span> <span class="string">(bionic</span> <span class="string">beaver)</span> <span class="string">droplets</span> </span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fixes</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">base</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">users</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ufw</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;role:</span> <span class="string">'fail2ban'</span><span class="string">,</span> <span class="attr">tags:</span> <span class="string">'fail2ban'</span><span class="string">&#125;</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ntp</span></span><br></pre></td></tr></table></figure>
<p>Which allows you to run <strong>only</strong> this role at playbook runtime, excluding the other listed roles. </p>
<p>So once tagged (in regards to the above), execute the playbook and specify the “fail2ban” tagging:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook <span class="_">-l</span> <span class="built_in">test</span>-host -u root playbook.yml --tags <span class="string">"fail2ban"</span> --check</span><br></pre></td></tr></table></figure>
<p>This is once again useful for selective testing purposes.  </p>
<blockquote>
<p><strong>Note:</strong> From what I can tell there’s no inbuilt function in Ansible to run select individual roles in a playbook, other than this <code>tags:</code> directive, unfortunately.</p>
</blockquote>
<p>Check the two files in the remote server’s <code>/etc/fail2ban</code> to see the applied directives from our <code>defaults/main.yml</code> file. This is the best way of confirming the changes we wanted are now in effect; Ansible does confirm and show changes during it’s task execution though!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo less /etc/fail2ban/jail.local</span><br><span class="line">$ sudo less /etc/fail2ban/fail2ban.local</span><br></pre></td></tr></table></figure>
<p>Another brief post I may publish in the future, will go into detail on some further examples of jail configs, for various services. </p>
<p>Thanks!</p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://blog.ssdnodes.com/blog/tutorial-a-more-secure-ansible-playbook-part-2/" target="_blank" rel="external">ServerWise – Tutorial: A More Secure Ansible Playbook, Part 2</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_checkmode.html" target="_blank" rel="external">Official Ansible Documentation – Check Mode (“Dry Run”)</a></li>
<li><a href="https://stackoverflow.com/questions/38350674/ansible-can-i-execute-role-from-command-line#38384205" target="_blank" rel="external">Stack Overflow – Ansible: Can I execute a role from the command line?</a></li>
</ul>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/Security/" class="post__tag__link">Security</a></li><li class="post__tag__item"><a href="/tags/Ubuntu/" class="post__tag__link">Ubuntu</a></li><li class="post__tag__item"><a href="/tags/Bionic/" class="post__tag__link">Bionic</a></li></ul><a href="/2018/05/23/ansible-fail2ban-role/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2018-05-18T23:00:00.000Z" class="post__time">May 19, 2018</time><h1 class="post__title"><a href="/2018/05/19/ansible-fail2ban-playbook/">Installing Fail2ban with Ansible on Ubuntu 18.04 (Bionic Beaver)</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/klPwJ5E.png" alt="Fail2ban Logo with Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>This is a very short post covering a rudimentary Ansible playbook (if you can even call it one) that contains tasks for installing Fail2ban in a straightforward manner. It’s intended as a follow on from the manual set of instructions/commands most people are familiar with, which I covered in this other post: </p>
<blockquote>
<p><a href="https://www.tricksofthetrades.net/2018/05/18/fail2ban-installing-bionic/">Installing Fail2ban on Ubuntu 18.04 (Bionic Beaver)</a></p>
</blockquote>
<p>At the end I’m linking to a third and final post which goes into detail on a more extensive solution to installing Fail2ban, as part of an Ansible <em>provisioning</em> project. It uses an Ansible role rather than a standalone playbook. </p>
<a id="more"></a>
<hr>
<h1 id="Installing-Fail2ban-with-Ansible"><a href="#Installing-Fail2ban-with-Ansible" class="headerlink" title="Installing Fail2ban with Ansible"></a>Installing Fail2ban with Ansible</h1><p>This is probably the most simple and obvious solution outside of manually installing. It exists in the form of a single playbook and template file. </p>
<p>Somewhere suitable (e.g. in version control) create the main playbook file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim fail2ban-playbook.yml</span><br></pre></td></tr></table></figure>
<p>Enter in the following playbook contents:</p>
<figure class="highlight yml"><figcaption><span>fail2ban-playbook.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span><span class="bullet">--</span> </span><br><span class="line"><span class="attr">- name:</span> <span class="string">installs</span> <span class="string">fail2ban</span> <span class="string">on</span> <span class="string">ansible</span> <span class="string">hosts</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">fail2ban-hosts</span></span><br><span class="line"><span class="attr">  become:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">install</span> <span class="string">apt</span> <span class="string">fail2ban</span> <span class="string">packages</span></span><br><span class="line"><span class="attr">    apt:</span> </span><br><span class="line"><span class="attr">      name:</span> <span class="string">"<span class="template-variable">&#123;&#123; item &#125;&#125;</span>"</span>   </span><br><span class="line"><span class="attr">      state:</span> <span class="string">latest</span></span><br><span class="line"><span class="attr">      update_cache:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      cache_valid_time:</span> <span class="number">3600</span></span><br><span class="line"><span class="attr">    with_items:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">sendmail</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">override</span> <span class="string">the</span> <span class="string">basic</span> <span class="string">fail2ban</span> <span class="string">configuration</span> <span class="string">with</span> <span class="string">.local</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    copy:</span></span><br><span class="line"><span class="attr">      src:</span> <span class="string">jail.local.j2</span></span><br><span class="line"><span class="attr">      dest:</span> <span class="string">/etc/fail2ban/jail.local</span></span><br><span class="line"><span class="attr">      owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">      group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">      mode:</span> <span class="number">0644</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> <a href="https://gist.github.com/5car1z/76dd1e48f9b16dbd2fb370bba1e2d393" target="_blank" rel="external">Here’s the same contents as a Gist.</a></p>
</blockquote>
<p>The first task updates the package manager cache (if it has not been updated within a set time period) and then installs the <code>fail2ban</code> plus <code>sendmail</code> packages. </p>
<p>The second copies across a local configuration file for Fail2ban, whilst giving it the necessary permissions and ownership’s. </p>
<p>Next create the previously mentioned template file (locally still of course).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim jail.local</span><br></pre></td></tr></table></figure>
<p>Add in your own Fail2ban configuration settings; these are mine for example purposes, but can be used:</p>
<figure class="highlight bash"><figcaption><span>jail.local</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line"></span><br><span class="line"><span class="comment"># email address to receive notifications.</span></span><br><span class="line">destemail = root@localhost    </span><br><span class="line"><span class="comment"># the email address from which to send emails.</span></span><br><span class="line">sender = root@&lt;fq-hostname&gt;    </span><br><span class="line"><span class="comment"># name on the notification emails.</span></span><br><span class="line">sendername = Fail2Ban    </span><br><span class="line"><span class="comment"># email transfer agent to use. </span></span><br><span class="line">mta = sendmail   </span><br><span class="line"></span><br><span class="line"><span class="comment"># see action.d/ufw.conf</span></span><br><span class="line">actionban = ufw.conf</span><br><span class="line"><span class="comment"># see action.d/ufw.conf </span></span><br><span class="line">actionunban = ufw.conf   </span><br><span class="line"></span><br><span class="line">[sshd]</span><br><span class="line">enabled = <span class="literal">true</span></span><br><span class="line">port = ssh</span><br><span class="line">filter = sshd</span><br><span class="line"><span class="comment"># the length of time between login attempts for maxretry. </span></span><br><span class="line">findtime = 600</span><br><span class="line"><span class="comment"># attempts from a single ip before a ban is imposed.</span></span><br><span class="line">maxretry = 5</span><br><span class="line"><span class="comment"># the number of seconds that a host is banned for.</span></span><br><span class="line">bantime = 3600</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> <a href="https://gist.github.com/5car1z/9c143fd17e61d074ec95207380ba9969" target="_blank" rel="external">Here’s the same contents as a Gist.</a></p>
</blockquote>
<p>These settings assume accompanied <a href="https://www.tricksofthetrades.net/2017/02/14/installing-using-ufw/">use of UFW as a firewall on the host</a> - hence the <code>actionban</code> lines. </p>
<p>It would make sense to create a local Ansible config and local hosts file to keep everything contained to the current repo/directory. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim ansible.cfg</span><br></pre></td></tr></table></figure>
<p>Point Ansible commands to use a local <code>hostfile</code> named <code>hosts</code>. </p>
<figure class="highlight yml"><figcaption><span>ansible.cfg </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[defaults]</span></span><br><span class="line"><span class="string">hostfile</span> <span class="string">=</span> <span class="string">hosts</span></span><br></pre></td></tr></table></figure>
<p>Create the local “hosts” file in turn. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim hosts</span><br></pre></td></tr></table></figure>
<p>The <code>hosts</code> file needs to then contain your target host’s details, using Ansible YAML syntax such as:</p>
<figure class="highlight yml"><figcaption><span>hosts </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[fail2ban-hosts]</span></span><br><span class="line"><span class="string">host-one</span> <span class="string">ansible_host=your.vps.ip.address</span> <span class="string">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class="line"><span class="string">host-two</span> <span class="string">ansible_host=your.vps.ip.address</span> <span class="string">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class="line"><span class="string">host-three</span> <span class="string">ansible_host=your.vps.ip.address</span> <span class="string">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class="line"><span class="comment"># Add more hosts here as needed.</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Currently Ansible uses Python 2.7 system libraries, and most Ubuntu images have Python 3.0+ installed. So this “interpreter” variable is usually necessary to access the correct libraries with Ansible.  </p>
</blockquote>
<p>Running the playbook on the remote host (or set of remote hosts) is then rather easy. </p>
<p>Make sure to include <code>-K</code> for the playbook’s <code>become:</code> password. Substitution for your own username (<code>scarlz</code> in my case) is also necessary - the user must have <em>sudo</em> privileges. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -u scarlz -K fail2ban-playbook.yml</span><br></pre></td></tr></table></figure>
<p>These few steps are for all intents and purposes everything that’s needed in a basic working install. For a less simplistic approach to installing Fail2ban, take a look at it again through the perspective of a more complex Ansible role instead:</p>
<blockquote>
<p><a href="https://www.tricksofthetrades.net/2018/05/23/ansible-fail2ban-role/">Installing Fail2ban with an Ansible Role on Ubuntu 18.04 (Bionic Beaver)</a> </p>
</blockquote>
<p>This was very short and terse due to its simplicity, but thanks for reading. </p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://stackoverflow.com/questions/26469896/how-to-install-fail2ban-using-ansible" target="_blank" rel="external">Stack Overflow – How to Install Fail2ban using Ansible</a></li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/Security/" class="post__tag__link">Security</a></li><li class="post__tag__item"><a href="/tags/Ubuntu/" class="post__tag__link">Ubuntu</a></li><li class="post__tag__item"><a href="/tags/Bionic/" class="post__tag__link">Bionic</a></li></ul><a href="/2018/05/19/ansible-fail2ban-playbook/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2018-05-17T23:00:00.000Z" class="post__time">May 18, 2018</time><h1 class="post__title"><a href="/2018/05/18/fail2ban-installing-bionic/">Installing Fail2ban on Ubuntu 18.04 (Bionic Beaver)</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/RdP4s4d.jpg" alt="Fail2ban Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>A highly condensed set of basic commands to install Fail2ban the traditional way. These can be executed on any remote server/VPS running recent versions of Ubuntu; although the process was carried out by myself on 18.04. If you’re not familiar with Fail2ban, the start of this brief guide refers to two good resources you can read up on. One more up to date than the other.  </p>
<p>The purpose of this post is to serve as background for a follow up post which uses Ansible to install the Fail2ban package and configuration more efficiently (linked at the end). </p>
<a id="more"></a>
<hr>
<h2 id="Installing-Fail2ban"><a href="#Installing-Fail2ban" class="headerlink" title="Installing Fail2ban"></a>Installing Fail2ban</h2><p>Several of the instructions for this process are taken and adapted from an older article on DigitalOcean. They’re intended for Ubuntu 14.04 but are still overall suitable on Bionic: </p>
<blockquote>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-protect-ssh-with-fail2ban-on-ubuntu-14-04" target="_blank" rel="external">DigitalOcean – “How To Protect SSH with Fail2Ban on Ubuntu 14.04”</a></p>
</blockquote>
<p>It might be better to read through this more up to date Linode article instead however to understand what Fail2ban is, how it works, and most importantly what different values to place into the configuration files. Otherwise this may not make complete sense before doing so. </p>
<p>It may even be more preferable to follow the Linode guide in its entirety, but that’s up to you! </p>
<p>See below: </p>
<blockquote>
<p><a href="https://www.linode.com/docs/security/using-fail2ban-for-security/" target="_blank" rel="external">Linode – “Use Fail2ban to Secure Your Server”</a></p>
</blockquote>
<p>On the remote Ubuntu server in question, update the system package index. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update -y</span><br></pre></td></tr></table></figure>
<p>Download and acquire the <code>fail2ban</code> plus <code>sendmail</code> packages. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install fail2ban sendmail</span><br></pre></td></tr></table></figure>
<p>Sendmail (if not present by default) is required for Fail2ban to generate notification emails. </p>
<p>Copy the base Fail2ban config into a new <code>jail.local</code> file, in order to begin adding in the config options we want overridden and applied:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> “Fail2ban reads <code>.conf</code> configuration files first, then <code>.local</code> files overriding any settings. Because of this, all changes to the configuration are generally done in <code>.local</code> files, leaving the <code>.conf</code> files untouched.”</p>
</blockquote>
<p>Here’s where an understanding of the configuration is very much necessary. </p>
<p>Having <a href="https://www.tricksofthetrades.net/2017/02/14/installing-using-ufw/">a working firewall such as UFW on Ubuntu</a> is also a background assumption I’m working with here, as the two can work together, and a firewall’s kinda mandatory anyway of course.</p>
<p>Open the newly copied <code>jail.local</code> file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/fail2ban/jail.local</span><br></pre></td></tr></table></figure>
<p>Add in your sensible Fail2ban configuration blocks and values now; this is my example file contents, should you want to make use of them:</p>
<figure class="highlight bash"><figcaption><span>/etc/fail2ban/jail.local</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line"></span><br><span class="line"><span class="comment"># email address to receive notifications.</span></span><br><span class="line">destemail = root@localhost    </span><br><span class="line"><span class="comment"># the email address from which to send emails.</span></span><br><span class="line">sender = root@&lt;fq-hostname&gt;    </span><br><span class="line"><span class="comment"># name on the notification emails.</span></span><br><span class="line">sendername = Fail2Ban    </span><br><span class="line"><span class="comment"># email transfer agent to use. </span></span><br><span class="line">mta = sendmail   </span><br><span class="line"></span><br><span class="line"><span class="comment"># see action.d/ufw.conf</span></span><br><span class="line">actionban = ufw.conf</span><br><span class="line"><span class="comment"># see action.d/ufw.conf </span></span><br><span class="line">actionunban = ufw.conf   </span><br><span class="line"></span><br><span class="line">[sshd]</span><br><span class="line">enabled = <span class="literal">true</span></span><br><span class="line">port = ssh</span><br><span class="line">filter = sshd</span><br><span class="line"><span class="comment"># the length of time between login attempts for maxretry. </span></span><br><span class="line">findtime = 600</span><br><span class="line"><span class="comment"># attempts from a single ip before a ban is imposed.</span></span><br><span class="line">maxretry = 5</span><br><span class="line"><span class="comment"># the number of seconds that a host is banned for.</span></span><br><span class="line">bantime = 3600</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> “A host is banned if it has generated “maxretry” during the last “findtime”.”</p>
</blockquote>
<p>Lastly here <code>enable</code> the Fail2ban service on system startup.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl service <span class="built_in">enable</span> fail2ban</span><br></pre></td></tr></table></figure>
<p>Then <code>start</code> the service so it’s currently active.   </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl service start fail2ban</span><br></pre></td></tr></table></figure>
<p>Fail2ban is now up and running - assuming you entered proper configuration options and have no syntax errors.  </p>
<p>As an alternate to using Systemd, restarting the entire Fail2ban server reports any runtime errors, should there be any issue, so…</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ fail2ban-client restart</span><br></pre></td></tr></table></figure>
<p>Fix any reported problems in the output, and then restart again. </p>
<p>There’s also a command to confirm the status of the server/jails. </p>
<p>Try it out: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ fail2ban-client status</span><br></pre></td></tr></table></figure>
<p>More specific information about the <code>sshd</code> jail we created in the config file is retrievable with:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ fail2ban-client status sshd</span><br></pre></td></tr></table></figure>
<p>Many more useful commands for you to explore are available, indexed at the following wiki:</p>
<blockquote>
<p><a href="https://www.fail2ban.org/wiki/index.php/Commands" target="_blank" rel="external">Fail2ban Client CLI Commands</a></p>
</blockquote>
<p>Fail2ban is now installed, running, and working! </p>
<p>Add more jails and actions for other services to expand upon it.  </p>
<p>The post leading on from this one achieves the same end result but using Ansible configuration management to do the job:</p>
<blockquote>
<p><a href="https://www.tricksofthetrades.net/2018/05/19/ansible-fail2ban-playbook/">“Installing Fail2ban with Ansible on Ubuntu 18.04 (Bionic Beaver)”</a> </p>
</blockquote>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://www.fail2ban.org/wiki/index.php/Main_Page" target="_blank" rel="external">Fail2ban Wiki</a></li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Security/" class="post__tag__link">Security</a></li><li class="post__tag__item"><a href="/tags/Ubuntu/" class="post__tag__link">Ubuntu</a></li><li class="post__tag__item"><a href="/tags/Bionic/" class="post__tag__link">Bionic</a></li></ul><a href="/2018/05/18/fail2ban-installing-bionic/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2018-02-03T00:00:00.000Z" class="post__time">February 3, 2018</time><h1 class="post__title"><a href="/2018/02/03/spectre-meltdown-ansible/">Deploying Meltdown and Spectre Fixes with Ansible on Linux Hosts</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/TEnht2h.jpg" alt="Spectre &amp; Meltdown Logos"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>As it stands the current “fixes” for <a href="https://meltdownattack.com/" target="_blank" rel="external">Meltdown and Spectre</a> mainly involve updating and upgrading hosts to include their patched kernel upgrades. When it comes to applying the updates to multiple Linux servers, one approach is to use the playbook/plays in this “lockdown” repo from Ansible. </p>
<blockquote>
<p><a href="https://github.com/ansible/ansible-lockdown/blob/master/meltdown-spectre-linux.yml" target="_blank" rel="external">https://github.com/ansible/ansible-lockdown/blob/master/meltdown-spectre-linux.yml</a></p>
</blockquote>
<p>This is how the YAML works to patch the aforementioned exploits. </p>
<a id="more"></a>
<hr>
<p>First off for the hosts directive, either the default <code>all</code> hosts is used or any hosts provided <code>-i</code> when running <code>ansible-playbook</code> take precedence. The tasks are to be carried out with <code>become:</code> and thereby super user privileges. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://meltdownattack.com</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Patch</span> <span class="string">Linux</span> <span class="string">systems</span> <span class="string">against</span> <span class="string">Meltdown</span> <span class="string">and</span> <span class="string">Spectre</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">"<span class="template-variable">&#123;&#123; target_hosts | default('all') &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">  become:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>
<p>Variables are defined ready for use later on in the tasks section. </p>
<p><code>reboot_after_update:</code> is set to <code>no</code> but should be set to “yes” where possible by yourself. The reason for this is covered properly towards the end of these explanations. </p>
<p><code>packages:</code> contains the required kernel package versions for each respective Linux distro. Most of the Debian/Ubuntu entries are empty with the exception of Debian 9 (the latest stable version) which contains the specific kernel package.  </p>
<p>The empty values may be updated by the maintainers at some point, but you can add in the kernel packages yourself for the empty ones. I’ve done this in the next code snippet, from the information given at these two links:</p>
<blockquote>
<p><a href="https://www.debian.org/security/2018/dsa-4078" target="_blank" rel="external">https://www.debian.org/security/2018/dsa-4078</a><br><a href="https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/SpectreAndMeltdown" target="_blank" rel="external">https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/SpectreAndMeltdown</a></p>
</blockquote>
<p>These kernel packages are in essence the only Meltdown and or Spectre <em>“fixes”</em> currently available. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">vars:</span></span><br><span class="line"><span class="attr">  reboot_after_update:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">  packages:</span></span><br><span class="line">    <span class="comment"># https://access.redhat.com/security/vulnerabilities/speculativeexecution</span></span><br><span class="line"><span class="attr">    RedHat7:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kernel-3.10.0-693.11.6.el7</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">microcode_ctl-2.1-22.2.el7</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">perf-3.10.0-693.11.6.el7</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">python-perf-3.10.0-693.11.6.el7</span></span><br><span class="line"><span class="attr">    RedHat6:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kernel-2.6.32-696.18.7.el6</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kernel-firmware-2.6.32-696.18.7.el6</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">perf-2.6.32-696.18.7.el6</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">python-perf-2.6.32-696.18.7.el6</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># https://www.debian.org/security/2018/dsa-4078</span></span><br><span class="line"><span class="attr">    Debian7:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-3.2.0-5-amd64</span></span><br><span class="line"><span class="attr">    Debian8:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-3.16.0-5-amd64</span></span><br><span class="line"><span class="attr">    Debian9:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-4.9.0-5-amd64</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/SpectreAndMeltdown</span></span><br><span class="line"><span class="attr">    Ubuntu14:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-3.13.0-141-generic</span></span><br><span class="line"><span class="attr">    Ubuntu16:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-4.4.0-112-generic</span> </span><br><span class="line"><span class="attr">    Ubuntu17:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-4.13.0-31-generic</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Please remember that this is as things stand right now with the kernel patching in late January, so these version numbers are always subject to change as new fixes are released. </p>
</blockquote>
<p>There are two tasks in total. One for each type of package manager in use on the various distros. </p>
<p>When Yum is detected on the host by Ansible, the first task is executed and the distro packages defined previously are referenced for installation. This is done using the <code>ansible_os_family</code> and <code>ansible_distribution_major_version</code> system fact variables - the distro name and version number respectively.  </p>
<p>A handler is then called to reboot the host (explained later on).</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">RHEL</span> <span class="string">| Install kernel updates</span><br><span class="line"></span><span class="attr">    yum:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">"<span class="template-variable">&#123;&#123; packages[ansible_os_family ~ ansible_distribution_major_version] &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">      state:</span> <span class="string">present</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">ansible_pkg_mgr</span> <span class="string">==</span> <span class="string">'yum'</span></span><br><span class="line"><span class="attr">    notify:</span> <span class="string">reboot</span> <span class="string">system</span></span><br></pre></td></tr></table></figure>
<p>If Aptitude (<code>apt</code>) is detected on the host in place of Yum, the second task is run instead. Which uses a similar process. The distro type and version number are sourced from the start in order to install the correct packages (like in the other task), whilst the package index is updated via <code>update_cache:</code>.  </p>
<p>As before the host is then rebooted via the handler (more on that now, as promised). </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">DEBIAN</span> <span class="string">| Install kernel updates</span><br><span class="line"></span><span class="attr">  apt:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">"<span class="template-variable">&#123;&#123; item &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">    state:</span> <span class="string">present</span></span><br><span class="line"><span class="attr">    update_cache:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">    cache_valid_time:</span> <span class="number">3600</span></span><br><span class="line"><span class="attr">  with_items:</span> <span class="string">"<span class="template-variable">&#123;&#123; packages[ansible_distribution ~ ansible_distribution_major_version] &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">ansible_pkg_mgr</span> <span class="string">==</span> <span class="string">'apt'</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">reboot</span> <span class="string">system</span></span><br></pre></td></tr></table></figure>
<p>If the variable <code>reboot_after_update</code> from the start is set to <code>yes</code> or true. The host(s) will reboot at the end of each task run, as the handler is called. </p>
<p>This is here as it’s necessary to reboot the system to begin using the new kernel changes brought in for the Spectre/Meltdown exploits. So you should set <code>reboot_after_update</code> to “yes” at the start of the file, as long as it’s safe to do so in terms of node availability and uptime. </p>
<p>Lastly <code>async:</code> allows the shutdown command to run for a maximum of <code>15</code> seconds, but also <code>poll:</code> tells Ansible to check constantly for its completion. This is all so Ansible moves on and doesn’t idle from the node’s system shutdown.  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">handlers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">reboot</span> <span class="string">system</span></span><br><span class="line"><span class="attr">    shell:</span> <span class="string">sleep</span> <span class="number">3</span><span class="string">;</span> <span class="string">reboot</span></span><br><span class="line"><span class="attr">    async:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">    poll:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">reboot_after_update</span></span><br></pre></td></tr></table></figure>
<p>It might be better to download the repository itself but if you want the <code>meltdown-spectre-linux.yml</code> file I showed here (with all the kernel package versions added in) use this Gist instead:</p>
<script src="https://gist.github.com/5car1z/ddbb17cb763d5aedf129732213febac4.js"></script>

<blockquote>
<p><strong>Warning:</strong> Be aware that the “reboot” variable is set to yes in this Gist. </p>
</blockquote>
<p>Run the file against your desired host groups or host patterns as normal, adding a <code>-K</code> sudo password or <code>-u</code> user switch if relevant e.g. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook <span class="_">-l</span> webservers meltdown-spectre-linux.yml -K</span><br></pre></td></tr></table></figure>
<p>Then watch Ansible check and update the kernel packages on each host. Oh and <code>uname -r</code> reveals the kernel package in use by your current node. </p>
<p>Thanks to <a href="https://www.ansible.com/blog/author/sam-doran" target="_blank" rel="external">Sam Doran</a> for the plays and the Ansible repository this is taken from. </p>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Meltdown/" class="post__tag__link">Meltdown</a></li><li class="post__tag__item"><a href="/tags/Spectre/" class="post__tag__link">Spectre</a></li></ul><a href="/2018/02/03/spectre-meltdown-ansible/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2018-01-11T00:00:00.000Z" class="post__time">January 11, 2018</time><h1 class="post__title"><a href="/2018/01/11/kernel-update-for-meltdown-spectre/">Kernel Updates for Meltdown and Spectre CPU Exploits</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/TEnht2h.jpg" alt="Meltdown and Spectre Logos"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>As updating the target hosts system packages to their latest versions includes the kernel updates, this is in general the easiest way to bring in any <a href="https://meltdownattack.com/" target="_blank" rel="external">Meltdown and Spectre</a> fixes. A reboot is required after the updates for kernel changes to take effect. </p>
<p>Without configuration management or any automation tools it’s pretty simple.</p>
<a id="more"></a>
<hr>
<p>On Debian and Ubuntu:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get dist-upgrade</span><br><span class="line">$ sudo reboot</span><br></pre></td></tr></table></figure>
<p>On RPM based distros like Redhat and CentOS this would be:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum update</span><br><span class="line">$ sudo reboot</span><br></pre></td></tr></table></figure>
<p>On Fedora it’s <code>dnf</code> instead:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo dnf update</span><br><span class="line">$ sudo reboot</span><br></pre></td></tr></table></figure>
<hr>
<p>Further updates, more information, and perhaps even a targeted approach to circumventing these exploits could be available in the future. So keep up to date with both of the two issues as best as possible.</p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-protect-your-server-against-the-meltdown-and-spectre-vulnerabilities" target="_blank" rel="external">DigitalOcean - How To Protect Your Server Against the Meltdown and Spectre Vulnerabilities</a></li>
<li><a href="https://www.cyberciti.biz/faq/patch-meltdown-cpu-vulnerability-cve-2017-5754-linux/" target="_blank" rel="external">Nixcraft: How to patch Meltdown CPU Vulnerability CVE-2017-5754 on Linux</a></li>
<li><a href="https://www.cyberciti.biz/faq/patch-spectre-vulnerability-cve-2017-5753-cve-2017-5715-linux/" target="_blank" rel="external">Nixcraft: How to patch Spectre Vulnerability CVE-2017-5753/CVE-2017-5715 on Linux</a></li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Security/" class="post__tag__link">Security</a></li><li class="post__tag__item"><a href="/tags/Meltdown/" class="post__tag__link">Meltdown</a></li><li class="post__tag__item"><a href="/tags/Spectre/" class="post__tag__link">Spectre</a></li></ul><a href="/2018/01/11/kernel-update-for-meltdown-spectre/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2018 Scarlz</div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"></span></li><li class="page-menu__item"><a title="Next" href="/topics/Programming/page/2/" class="page-menu__link icon-arrow-right"></a></li></menu></footer><script>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src="//"+l+".disqus.com/"+k+".js",i.parentNode.insertBefore(j,i)})
(document,"script","totts","count");
</script></body></html>