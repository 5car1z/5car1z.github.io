<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="Linux System Administration"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="atom.xml" title="C.J. Scarlett" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Programming - C.J. Scarlett</title><link rel="stylesheet" href="/css/main.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">C.J. Scarlett</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/topics" class="head-nav__link">Topics</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="/misc" class="head-nav__link">Misc</a></li><li class="head-nav__item"><a href="/about" class="head-nav__link">About</a></li><li class="head-nav__item"><a href="/contact" class="head-nav__link">Contact</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2017-04-09T23:00:00.000Z" class="post__time">April 10, 2017</time><h1 class="post__title"><a href="/2017/04/10/ansible-playbooks/">Ansible - Playbook Concepts (4)</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/9HBs9cy.png" alt="Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>Playbooks are written in YAML like the configuration files and are the basis for Ansible’s configuration management and en-masse multi-machine deployment. </p>
<p>These are very powerful not only for declaring server configurations but also to orchestrate steps of any manual ordered process, even when the different steps must bounce back and forth between sets of machines in any order, as playbooks can launch tasks synchronously or asynchronously as required.</p>
<p>While it’s suitable to use the <code>/usr/bin/ansible</code> program for ad-hoc commands and tasks. Playbooks are better kept in source control and used to push out larger configurations, or assure the configurations of your remote systems are still in check. </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Playbook-Examples"><a href="#1-–-Playbook-Examples" class="headerlink" title="1 – Playbook Examples"></a>1 – Playbook Examples</h1><p>Here are some initial examples of Ansible playbooks. A playbook by definition is composed of one or more <em>plays</em> in a list.</p>
<p>The goal of each play is to map a group of hosts to some well defined role, through actions within the play Ansible calls tasks. Put simply though, a task is nothing more than a call to a preset Ansible <a href="http://www.tricksofthetrades.net/2017/03/20/ansible-adhoc-modules/">module</a>. </p>
<p>By composing a playbook of multiple ‘plays’, it is possible to orchestrate multi-machine deployments. Running certain steps on all machines in the “webservers” group, then certain steps on the “databases” server group, and then more commands back on the “webservers” group, etc. </p>
<p>The first snippet and playbook sets up Apache web server on hosts in the <code>webservers</code> group. Notice the variables declared, remote user in use, and handlers towards the end. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    http_port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    max_clients:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=httpd</span> <span class="string">state=latest</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">write</span> <span class="string">the</span> <span class="string">apache</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=/srv/httpd.j2</span> <span class="string">dest=/etc/httpd.conf</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span> <span class="string">(and</span> <span class="string">enable</span> <span class="string">it</span> <span class="string">at</span> <span class="string">boot)</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>
<p>This second example uses tasks that have really long parameters, and modules that take many parameters. When this is the case you can break tasks items over multiple lines to improve the playbook readability and structure. Breaking up tasks is achieved by using YAML dictionaries to supply the modules with their <em>key=value</em> arguments.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    http_port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    max_clients:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line"><span class="attr">    yum:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">      state:</span> <span class="string">latest</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">write</span> <span class="string">the</span> <span class="string">apache</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    template:</span></span><br><span class="line"><span class="attr">      src:</span> <span class="string">/srv/httpd.j2</span></span><br><span class="line"><span class="attr">      dest:</span> <span class="string">/etc/httpd.conf</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">      state:</span> <span class="string">started</span></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">      service:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">        state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>
<p>This final example contains not just one but two plays. The first targets the <code>webservers</code> host group and the second targets the <code>databases</code> host group. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=httpd</span> <span class="string">state=latest</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">write</span> <span class="string">the</span> <span class="string">apache</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=/srv/httpd.j2</span> <span class="string">dest=/etc/httpd.conf</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">databases</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">postgresql</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=postgresql</span> <span class="string">state=latest</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">that</span> <span class="string">postgresql</span> <span class="string">is</span> <span class="string">started</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=postgresql</span> <span class="string">state=started</span></span><br></pre></td></tr></table></figure>
<p>See the <a href="https://github.com/ansible/ansible-examples" target="_blank" rel="external">ansible/ansible-examples</a> GitHub repository for some fully fledged and properly structured Playbook configuration examples. </p>
<hr>
<h1 id="2-–-Playbook-Hosts-and-Users"><a href="#2-–-Playbook-Hosts-and-Users" class="headerlink" title="2 – Playbook Hosts and Users"></a>2 – Playbook Hosts and Users</h1><p>For each “play” in a playbook, you get to choose the servers/hosts in your infrastructure you want to target, and which remote Linux user to complete the steps in the play as (remember the steps are called tasks).</p>
<p>The <code>hosts</code> line at the start of a play is a list of one or more groups, or if needed a <a href="http://docs.ansible.com/ansible/intro_patterns.html" target="_blank" rel="external">host pattern</a>. The <code>remote_user</code> holds the name of the target Linux/Unix user account.</p>
<p>For example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure>
<p>Remote users can also be set per task instead of just for the entire play. Such as in this example where the task <code>test connection</code> uses a different user to the overall play. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">test</span> <span class="string">connection</span></span><br><span class="line"><span class="attr">      ping:</span></span><br><span class="line"><span class="attr">      remote_user:</span> <span class="string">scarlz</span></span><br></pre></td></tr></table></figure>
<p>The <code>become</code> and <code>become_method</code> items allow a change of privileges from within the SSH user’s session. This is useful for using shell programs like <code>sudo</code> for tasks that need <a href="http://docs.ansible.com/ansible/become.html" target="_blank" rel="external">higher privileges</a>.</p>
<p>Like here: </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">scarlz</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span></span><br><span class="line"><span class="attr">      become:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      become_method:</span> <span class="string">sudo</span></span><br></pre></td></tr></table></figure>
<p>In these cases you must provide the necessary password using <code>--ask-become-pass</code> when running the playbook itself with <code>ansible-playbook</code> from the command line - covered later on. </p>
<p>Using <code>become_user</code> similarly allows a change of user from within the play’s SSH user shell session. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">scarlz</span></span><br><span class="line"><span class="attr">  become:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  become_user:</span> <span class="string">postgres</span></span><br></pre></td></tr></table></figure>
<p>Let’s look more at the tasks themselves and what they can do. </p>
<hr>
<h1 id="3-–-Playbook-Tasks"><a href="#3-–-Playbook-Tasks" class="headerlink" title="3 – Playbook Tasks"></a>3 – Playbook Tasks</h1><p>As seen each play contains its own list of tasks. Tasks are executed in order, one at a time, against all machines matched by the host group or pattern. So keep in mind that all hosts are going to receive and process the same task directives issued. </p>
<p>Also when running a playbook, any hosts that end up with failed tasks are taken out of the rotation for the entire playbook run. If things fail, simply correct the playbook file (or host connectivity issue) and rerun it.</p>
<p>As seen in the first section of this post, the goal of each task is to execute a module, with set variables passed to that module if needed. </p>
<p>Here is an omitted example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    http_port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    max_clients:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">make</span> <span class="string">sure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span></span><br></pre></td></tr></table></figure>
<p>Importantly though module use should also be “idempotent”. That is to say, when running a module multiple times in a sequence, it should have the same end result as if you had run it only once. One way to achieve this state of idem-potency in playbooks is to have a module check whether its desired final state has already been achieved, and if that state has been achieved, to instead exit without performing any actions. </p>
<p>So if all the modules a playbook uses are idempotent, then the playbook itself is likely to be idempotent too (overall), so re-running the playbook multiple times should be safe and not create any issues.</p>
<blockquote>
<p><strong>Note:</strong> The <code>command</code> and <code>shell</code> modules will typically rerun the same command issued again, which is fine if the command is something that does not change the outcome of its initial execution, when run multiple times. There is also a “creates” flag available here which can be used to make these two modules idempotent. </p>
</blockquote>
<p>Furthermore every task should have a <code>name</code>, which is included in the output from running the playbook, and serves as more of a description than a moniker. Due to this It is useful to provide good descriptions for each task step. </p>
<blockquote>
<p><strong>Note:</strong> If a <code>name</code> is not provided, the string fed to ‘action’ will be used for output.</p>
</blockquote>
<p>As with most modules, the <code>service</code> module takes arguments in the key=value format.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">make</span> <span class="string">sure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span></span><br></pre></td></tr></table></figure>
<p>The <code>command</code> and <code>shell</code> modules are the only modules that take a list of arguments and don’t use the key=value form as normal. </p>
<p>This makes them work in the same way as you would expect them to on the command line e.g. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">disable</span> <span class="string">selinux</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">/sbin/setenforce</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>The <code>command</code> and <code>shell</code> module care about return codes, so if you have a command where the successful exit code is not zero, you can alter it to this:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line"><span class="attr">    shell:</span> <span class="string">/usr/bin/somecommand</span> <span class="string">||</span> <span class="string">/bin/true</span></span><br></pre></td></tr></table></figure>
<p>If the action line of the module is getting too long, you can break it on a space character and indent any continued lines to improve readability. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Copy</span> <span class="string">ansible</span> <span class="string">inventory</span> <span class="string">file</span> <span class="string">to</span> <span class="string">client</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=/etc/ansible/hosts</span> <span class="string">dest=/etc/ansible/hosts</span></span><br><span class="line">            <span class="string">owner=root</span> <span class="string">group=root</span> <span class="string">mode=0644</span></span><br></pre></td></tr></table></figure>
<p>Variables declared can be explicitly used in task action lines, not just in <em>templates</em> (templates not covered yet). </p>
<p>The variable is called using the word <code>vhost</code> inside of the curly braces, in the example below:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    vhost:</span> <span class="string">blog-site.conf</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">create</span> <span class="string">a</span> <span class="string">virtual</span> <span class="string">host</span> <span class="string">file</span> <span class="string">for</span> <span class="string">&#123;&#123;</span> <span class="string">vhost</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=somefile.j2</span> <span class="string">dest=/etc/httpd/conf.d/&#123;&#123;</span> <span class="string">vhost</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>To carry on the concept and practice introduced here of idem-potency in Ansible. The next section talks about <em>handlers</em>.</p>
<hr>
<h1 id="4-–-Playbook-Handlers"><a href="#4-–-Playbook-Handlers" class="headerlink" title="4 – Playbook Handlers"></a>4 – Playbook Handlers</h1><p>Modules should be idempotent as described in the last section, so they can relay back whether they have made a change on the remote system or not. Playbooks have the ability to recognise these changes and also have a basic event system that can be used to respond to change. </p>
<p><code>notify</code> actions are triggered at the end of each block of tasks in a play, and will only be triggered once. Even if notified and triggered by multiple different tasks. For instance, multiple resources may indicate that Apache needs to be restarted because they have changed a config file, but Apache will only be restarted once to avoid multiple unnecessary restarts.</p>
<p>Here’s an example of restarting two services in a task when the contents of a file change, but only if the file changes. The items listed in the notify section of the task are called handlers.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">template</span> <span class="string">configuration</span> <span class="string">file</span></span><br><span class="line"><span class="attr">  template:</span> <span class="string">src=template.j2</span> <span class="string">dest=/etc/foo.conf</span></span><br><span class="line"><span class="attr">  notify:</span></span><br><span class="line"><span class="bullet">     -</span> <span class="string">restart</span> <span class="string">memcached</span></span><br><span class="line"><span class="bullet">     -</span> <span class="string">restart</span> <span class="string">apache</span></span><br></pre></td></tr></table></figure>
<p>Handlers are lists of tasks (not really any different from regular tasks) that are referenced by a globally unique name, and are notified by notifiers. If a handler is never referenced/notified it will not run. As inferred earlier, regardless of how many tasks notify a handler, it will run only once, and after all of the tasks complete in a particular play.</p>
<p>Here’s an example of a <code>handlers</code> section with some defined tasks:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">memcached</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=memcached</span> <span class="string">state=restarted</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=apache</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="5-–-Running-Playbooks"><a href="#5-–-Running-Playbooks" class="headerlink" title="5 – Running Playbooks"></a>5 – Running Playbooks</h1><p>Now that you’ve learned much of the groundwork for playbook syntax, we should look at how to run a completed playbook. </p>
<p>To run a playbook use the <code>anisble-playbook</code> command followed by the path to the playbook file. In this scenario it’s in the current working directory and named <code>playbook.yml</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook playbook.yml <span class="_">-f</span> 10</span><br></pre></td></tr></table></figure>
<p>The <code>-f 10</code> specifies the usage of 10 simultaneous Ansible processes at once. </p>
<p>When executing a playbook there will always be a summary of the nodes/hosts that were targeted and how they fared with the instructions. General failures and fatal unreachable attempts by the playbook execution are kept separate in the “counts”.</p>
<p>The <code>--verbose</code> flag tagged onto the <code>ansible-playbook</code> command results in a more detailed account of the results of a playbook run. Furthermore the <code>--list-hosts</code> flag shows which hosts are to be affected by a playbook before you run it. </p>
<p>It’s possible to invert the architecture of Ansible, forcing nodes/hosts check in to a central location instead of pushing configuration out externally, by using the <code>ansible-pull</code> script. </p>
<p>Run the help option to see details on this if interested.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-pull --help</span><br></pre></td></tr></table></figure>
<p>As an aside, some say that Ansible playbook output is vastly upgraded if the <code>cowsay</code> package is installed on your system. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Debian / Ubuntu</span></span><br><span class="line">$ sudo apt-get install cowsay </span><br><span class="line"><span class="comment"># Arch Linux</span></span><br><span class="line">$ sudo pacman -S cowsay</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="7-–-Ansible-Templating"><a href="#7-–-Ansible-Templating" class="headerlink" title="7 – Ansible Templating"></a>7 – Ansible Templating</h1><p>Templates in Ansible are constructed using the Jinja2 Python templating language, and reside in their own files. They are capable of referencing variables from outside sources, such as from within the playbook using the template and the outer Ansible file inventory e.g. a <code>main.yml</code> file within an upper <code>/vars</code> directory.</p>
<p>Templates are typically useful for setting up configuration files, to make them and other files more versatile or reusable among playbooks. They can have any file name but the <code>.tpl</code> or <code>.j2</code> extensions are common. </p>
<p>Below is a template example for setting up an Apache virtual host. It uses a variable for setting up the document root on each Ansible host:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;VirtualHost *:80&gt;</span></span><br><span class="line">    <span class="attribute">ServerAdmin</span> webmaster@localhost</span><br><span class="line">    <span class="attribute"><span class="nomarkup">DocumentRoot</span></span> &#123;&#123; doc_root &#125;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">&lt;Directory &#123;&#123; doc_root &#125;&#125;&gt;</span></span><br><span class="line">        <span class="attribute">AllowOverride</span> <span class="literal">All</span></span><br><span class="line">        <span class="attribute">Require</span> <span class="literal">all</span> granted</span><br><span class="line">    <span class="section">&lt;/Directory&gt;</span></span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br></pre></td></tr></table></figure>
<p>The inbuilt module <code>template:</code> is used to apply a template file in a task. For example, if you named a template file <code>vhost.tpl</code> and you placed it inside the same directory as your playbook, this is how you would make use of the template to replace the default Apache virtual host, on your Ansible hosts:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Alter</span> <span class="string">the</span> <span class="string">default</span> <span class="string">Apache</span> <span class="string">virtual</span> <span class="string">host</span></span><br><span class="line"><span class="attr">  template:</span> <span class="string">src=vhost.tpl</span> <span class="string">dest=/etc/apache2/sites-available/000-default.conf</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="8-–-Roles-in-Playbooks"><a href="#8-–-Roles-in-Playbooks" class="headerlink" title="8 – Roles in Playbooks"></a>8 – Roles in Playbooks</h1><p>Roles work best for more complex playbooks that have many multiple but related tasks. Each role contains only the relevant data and information needed to carry out said tasks. As there are usually multiple stages to a task or set of tasks, playbooks can get very lengthy and congested with all their operations. So confining tasks to roles helps alleviate this problem. </p>
<p>As an example, a playbook that installs Nginx, likely involves adding the stable package repository, then installing the package itself, as well as setting up all the configuration for the web server. The final configuration step no doubt requires extra data such as variables, files, dynamic templates, and more. These are bet kept in their own role’s area.</p>
<p>The file-system for a role looks like the below, where <code>rolename</code> is the root directory, and the options are the subsequent directory areas for each piece of information. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">rolename</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">files</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">handlers</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">meta</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">templates</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">tasks</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">vars</span></span><br></pre></td></tr></table></figure>
<p>Within each of the individual directory areas above, Ansible will search for a <code>main.yml</code> file automatically. Any every piece of configuration for the role in question is contained within these locations. </p>
<hr>
<p>After understanding how each of these different concepts work together to create a playbook. You can go on to make your own from scratch, from other examples, or by converting your older setup scripts. </p>
<p><a href="http://www.tricksofthetrades.net/trades/">Links to subsequent Ansible posts can be found on the Trades page.</a></p>
<p><strong>More Information</strong></p>
<ul>
<li><a href="http://docs.ansible.com/ansible/playbooks_intro.html" target="_blank" rel="external">Official Ansible Documentation - Intro to Playbooks</a> – Most of the base content for this post was garnered from here.</li>
<li><a href="https://www.digitalocean.com/community/tutorials/configuration-management-101-writing-ansible-playbooks" target="_blank" rel="external">Digital Ocean - Configuration Management 101: Writing Ansible Playbooks</a> – Some of the basic playbook examples and ideas are taken from this.</li>
<li><a href="https://serversforhackers.com/an-ansible-tutorial" target="_blank" rel="external">Servers for Hackers - An Ansible Tutorial</a> – Shows a great real world example for creating an Nginx playbook; among other things.</li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Python/" class="post__tag__link">Python</a></li></ul><a href="/2017/04/10/ansible-playbooks/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2017-03-20T00:00:00.000Z" class="post__time">March 20, 2017</time><h1 class="post__title"><a href="/2017/03/20/ansible-adhoc-modules/">Ansible - Ad Hoc Commands and Modules (3)</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/9HBs9cy.png" alt="Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>Several ad hoc commands were shown in the previous post but no real detail was given as to what they can fully offer. These <em>ad hoc</em> commands are often cited as being a good starter point for learning what’s possible with Ansible; without having to dive straight into writing a playbook. Most of them incorporate the use of a <em>module</em> into their structure, so this post introduces modules too. Both from the point of view of an ad hoc command, and within the context of a task. Towards the end, the “special” Ansible module types are shown. </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Ad-Hoc-Commands"><a href="#1-–-Ad-Hoc-Commands" class="headerlink" title="1 – Ad Hoc Commands"></a>1 – Ad Hoc Commands</h1><p>Sometimes you may not need nor want to write a fully fledged playbook for simple operations. Either way the concepts here for these commands port directly over to the playbook language for when you do begin writing them later on. These due to their impromptu nature and use,. </p>
<p>In their simplest form these commands are shell commands performed in parallel to each host by Ansible. </p>
<p>Here <code>coreservers</code> is the group name that contains several hosts and the ad hoc command <code>-a</code> we are running on them is <code>/sbin/reboot</code> using <code>10</code> Ansible forks. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers <span class="_">-a</span> <span class="string">"/sbin/reboot"</span> <span class="_">-f</span> 10 -b -K</span><br></pre></td></tr></table></figure>
<p>The <code>-f 10</code> in the above specifies the usage of 10 simultaneous processes to use (10 hosts at a time). You can also set this as an assumed default in the configuration file to avoid setting it here. The default is set to 5, which is lacking and conservative, so feel free to increase this value to a more optimal number. </p>
<p>Ansible defaults to running from your current user account (or from any hosts variables). To change this pass in the <code>-u</code> option. Where <code>scarlz</code> is the username you want to run the command as. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers <span class="_">-a</span> <span class="string">"/usr/bin/foo"</span> -u scarlz</span><br></pre></td></tr></table></figure>
<p>When not calling raw programs on the node through Ansible, modules are the main choice for carrying out operations. </p>
<p>In general the <code>-m</code> option denotes a named module. Here is an example of the <code>shell</code> module that is used to issue precise commands on the Ansible node. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -u scarlz -m shell <span class="_">-a</span> <span class="string">'echo $TERM'</span></span><br></pre></td></tr></table></figure>
<p>There are a whole back-catalogue of these inbuilt modules for you to make use of. </p>
<hr>
<h1 id="2-–-Modules"><a href="#2-–-Modules" class="headerlink" title="2 – Modules"></a>2 – Modules</h1><p>Modules contain the actions or functionality we want to implement and run. Some commonly used modules are apt/yum, copy, ec2, file, service, template, and user. Like shown in the previous section, modules can be used in ad-hoc commands as well as “tasks”.  </p>
<h2 id="Copy"><a href="#Copy" class="headerlink" title="Copy"></a>Copy</h2><p>This command transfers a “hosts” file directly to all servers in the “coreservers” group, using SCP and the <code>copy</code> module:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -m copy <span class="_">-a</span> <span class="string">"src=/etc/hosts dest=/tmp/hosts"</span> -b -K</span><br></pre></td></tr></table></figure>
<h2 id="File"><a href="#File" class="headerlink" title="File"></a>File</h2><p>The <code>file</code> module provides the ability to change system ownership and permissions on remote files. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -m file <span class="_">-a</span> <span class="string">"dest=/var/www/index.html mode=755 owner=scarlz group=www"</span> -b -K</span><br></pre></td></tr></table></figure>
<p>To create directories with <code>file</code>, like when using the <code>mkdir -p</code> command in Linux, add the “directory” <code>state-directory</code> option.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -m file <span class="_">-a</span> <span class="string">"dest=/var/www/new-vhost-dir mode=755 owner=scarlz group=www state=directory"</span> -b -K</span><br></pre></td></tr></table></figure>
<p>Delete directories recursively, and delete files through <code>file</code> with the <code>state=absent</code> option.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -m file <span class="_">-a</span> <span class="string">"dest=/path/to/delete state=absent"</span></span><br></pre></td></tr></table></figure>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>This module is referred to when you need to interact with the OS system services. Inclusive of  BSD init, OpenRC, SysV, Solaris SMF, systemd, and upstart.</p>
<p>As an example of how this could work, this starts Nginx via systemd:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -m service <span class="_">-a</span> <span class="string">"name=nginx.service state=started"</span> -b -K</span><br></pre></td></tr></table></figure>
<p>Changing the state option changes the result - this is to restart:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -m service <span class="_">-a</span> <span class="string">"name=nginx.service state=restarted"</span> -b -K</span><br></pre></td></tr></table></figure>
<p>The value of “state” must be one of either: running, started, stopped, restarted, or reloaded.</p>
<h2 id="Users-and-Groups"><a href="#Users-and-Groups" class="headerlink" title="Users and Groups"></a>Users and Groups</h2><p>A module named the “user” module serves as an interface to creating, removing, and manipulating system user accounts. </p>
<p>Altering a user’s password only requires the username, in this next example this is <code>scarlz</code>, then the new password for the user which is substituted in to the <code>&lt;user-password&gt;</code> field.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -m user <span class="_">-a</span> <span class="string">"name=scarlz password=&lt;user-password&gt;"</span></span><br></pre></td></tr></table></figure>
<p>Removing the user account completely, once again needs the username (<code>scarlz</code> in my case) as well as the value <code>absent</code> for the <code>state</code> option. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -m user <span class="_">-a</span> <span class="string">"name=scarlz state=absent"</span> -b -K</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Practical-Ad-Hoc-Module-Example"><a href="#Practical-Ad-Hoc-Module-Example" class="headerlink" title="Practical Ad Hoc Module Example"></a>Practical Ad Hoc Module Example</h2><p>The first command updates the Apt package index - similar to running the usual <code>apt-get update</code> command. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -b -K -m apt <span class="_">-a</span> update_cache=yes</span><br></pre></td></tr></table></figure>
<p>Continuing on from before, upgrading the system packages (like with <code>apt-get upgrade</code>) uses: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -b -K -m apt <span class="_">-a</span> upgrade=yes</span><br></pre></td></tr></table></figure>
<p>Performing a <code>dist-upgrade</code> uses the <code>full</code> switch instead of just “yes”.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible coreservers -b -K -m apt <span class="_">-a</span> upgrade=full</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Module-Index"><a href="#Module-Index" class="headerlink" title="Module Index"></a>Module Index</h2><p><a href="http://docs.ansible.com/ansible/modules_by_category.html" target="_blank" rel="external">Here’s a page from the official Ansible documentation</a> that acts as a catalogue for all the registered inbuilt modules available. There are many many modules, to cater for all specific needs. </p>
<hr>
<h1 id="3-–-Modules-in-Tasks"><a href="#3-–-Modules-in-Tasks" class="headerlink" title="3 – Modules in Tasks"></a>3 – Modules in Tasks</h1><p>Here are some examples of using the modules in a task (like you’d find in an Ansible playbook). </p>
<p>The file module (most shown before) creates a new directory to be used for caching purposes. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: add cache directory</span><br><span class="line">  file: path=/opt/cache state=directory</span><br></pre></td></tr></table></figure>
<p>In more detail this time, the <code>apt</code> module handles packages for Ubuntu/Debian OS. The state option here designates that the install of Nginx should be implemented via apt-get, but the state value could also be replaced with <code>latest</code> (to update the package) or <code>absent</code> (to remove the package) instead. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: install nginx</span><br><span class="line">  yum name=nginx state=present</span><br></pre></td></tr></table></figure>
<p>This one’s pretty straight forward, and is the “task” equivalent of the ad hoc command from earlier. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: start nginx</span><br><span class="line">  service: name=nginx enabled=yes state=started</span><br></pre></td></tr></table></figure>
<p>One thing to notice here is with the <code>name:</code>  field. Tasks can be defined as anything you want here but should be descriptive. Tasks are simple and declarative, they aim to pass the correct arguments to the module calls, to achieve what is needed. </p>
<hr>
<h1 id="4-–-Special-Modules"><a href="#4-–-Special-Modules" class="headerlink" title="4 – Special Modules"></a>4 – Special Modules</h1><p>There are several modules that fall into their own category, that exist to provide special core use cases. The code examples here are in the form of a task you’d find within a playbook. </p>
<ul>
<li><code>command</code> module – Used for executing simple commands on remote nodes. (first example shown in step one). </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: Run the <span class="built_in">command</span> <span class="keyword">if</span> the specified file does not exist.</span><br><span class="line">  <span class="built_in">command</span>: /usr/bin/make_database.sh arg1 arg2 creates=/path/to/database</span><br></pre></td></tr></table></figure>
<ul>
<li><code>shell</code> module – Similar to the command module but allows the use of redirection, variables, and further operators. The <code>shell</code> module was also used in the first step. </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: Execute the <span class="built_in">command</span> <span class="keyword">in</span> remote shell; stdout goes to the specified file on the remote.</span><br><span class="line">  shell: somescript.sh &gt;&gt; somelog.txt</span><br></pre></td></tr></table></figure>
<ul>
<li><code>script</code> – Let’s you run a local script on a remote node - <strong>after transferring it.</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- script: /some/<span class="built_in">local</span>/script.sh --some-arguments 1234</span><br></pre></td></tr></table></figure>
<ul>
<li><code>raw</code> – Executes a low-down and dirty SSH command. Mainly used for installing Python versions onto hosts that do not already have it. </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: Bootstrap a legacy python 2.4 host</span><br><span class="line">  raw: yum -y install python-simplejson</span><br></pre></td></tr></table></figure>
<p>The examples uses Yum package manager, so is in the context of an enterprise Linux OS. </p>
<hr>
<p>With a basic understanding of how modules work within both ad hoc commands and tasks. It’s easy to now see how the bulk of an Ansible playbooks actions are laid out. </p>
<p><a href="http://www.tricksofthetrades.net/trades/">Links to subsequent Ansible posts can be found on the Trades page.</a> </p>
<p><strong>More Information</strong></p>
<ul>
<li><a href="http://docs.ansible.com/ansible/intro_adhoc.html" target="_blank" rel="external">Official Ansible Documentation - Introduction To Ad-Hoc Commands</a> – Has the bulk of the information contained in this post. </li>
<li><a href="https://serversforhackers.com/an-ansible-tutorial" target="_blank" rel="external">“Servers for Hackers” - An Ansible Tutorial</a> – Some context for some of the commands and the use of the options. </li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Python/" class="post__tag__link">Python</a></li></ul><a href="/2017/03/20/ansible-adhoc-modules/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2017-02-14T00:00:00.000Z" class="post__time">February 14, 2017</time><h1 class="post__title"><a href="/2017/02/14/installing-using-ufw/">Installing and Using UFW (Uncomplicated Firewall)</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/000yMhS.png" alt="Firewall Image"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>UFW is a popular and convenient firewall configuration tool originating from Ubuntu distributions. It’s a more accessible way of using the <code>iptables</code> program. Which with some of its complexities can be more cumbersome or confusing for newcomers to learn. In reality UFW works as a wrapper for iptables, so is not a firewall in its own right but the iptables firewall in a simpler form. It serves both IPv4 and IPv6 host-based traffic.</p>
<p>In this post are commands containing options/arguments that contain two words and look like this: <code>comment ssh</code>. These extra parts add a comment to the firewall rules generated. If you are using a version of UFW priot to <code>0.35</code> you may have to remove these two extra pieces to avoid errors. Please bear this in mind when you come to using these types of commands later on should you receive errors.  </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Install-UFW"><a href="#1-–-Install-UFW" class="headerlink" title="1 – Install UFW"></a>1 – Install UFW</h1><p>Using your systems package manager is a straight forward and easy way of obtaining UFW. Here are two examples for Arch Linux and Debian/Ubuntu. </p>
<h2 id="Arch-Linux"><a href="#Arch-Linux" class="headerlink" title="Arch Linux"></a>Arch Linux</h2><p>On Arch with Pacman it’s simply:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pacman -S ufw</span><br></pre></td></tr></table></figure>
<p>Then enable it on boot through systemd using:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl <span class="built_in">enable</span> ufw</span><br><span class="line">$ sudo systemctl start ufw</span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="https://wiki.archlinux.org/index.php/Uncomplicated_Firewall" target="_blank" rel="external">Arch Wiki - Uncomplicated Firewall</a></p>
</blockquote>
<h2 id="Debian-Ubuntu"><a href="#Debian-Ubuntu" class="headerlink" title="Debian / Ubuntu"></a>Debian / Ubuntu</h2><p>UFW comes as part of most Ubuntu based distributions so you might already have it on your system, but to download the package on either Debian or Ubuntu use:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install ufw</span><br></pre></td></tr></table></figure>
<p>To check the status of the program and confirm installation.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw status verbose</span><br></pre></td></tr></table></figure>
<p>The output returned if installed successfully should be:</p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Status: inactive</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="2-–-Enable-Default-Rules"><a href="#2-–-Enable-Default-Rules" class="headerlink" title="2 – Enable Default Rules"></a>2 – Enable Default Rules</h1><p>As with several other firewall solutions, the standard practice is to block every possible incoming connection and allow any possible outgoing connections. Then open/block individual services and ports where necessary afterwards. </p>
<p>So deny all incoming connections. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw default deny incoming</span><br></pre></td></tr></table></figure>
<p>And allow all outgoing connections. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw default allow outgoing</span><br></pre></td></tr></table></figure>
<p>Remember that the firewall itself is still not active yet. All we have done so far is add these two overall base rules.  </p>
<hr>
<h1 id="3-–-Adding-Rules"><a href="#3-–-Adding-Rules" class="headerlink" title="3 – Adding Rules"></a>3 – Adding Rules</h1><p>There are two primary styles available for adding rules - standard rule inputs and alias style inputs. </p>
<p>Here’s how to enable SSH connections to the server, using one of the built-in alias style inputs UFW provides.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow ssh comment ssh</span><br></pre></td></tr></table></figure>
<p>This opens the default SSH TCP port - port number <code>22</code>.  Without this port open, SSH connections to your server would be blocked. Potentially making it inaccessible remotely.  </p>
<p>Here’s the same rule again that opens the default SSH port, but using the standard rule input syntax.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow 22/tcp comment ssh</span><br></pre></td></tr></table></figure>
<p>Anyone who does not use the default port number <code>22</code> for SSH and has altered it manually on their server, must use this standard rule syntax, and change the number in the command <code>22</code> to their chosen custom SSH port number. </p>
<p>Usually there is no need to restart UFW for newly added/removed rules to take effect. The effect of an action is applied immediately. </p>
<h2 id="Further-Methods"><a href="#Further-Methods" class="headerlink" title="Further Methods"></a>Further Methods</h2><p>Specific IP addresses may be utilised in rules too. The next example (as suggested by the syntax) allows all traffic incoming access from the provided address. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow from 192.168.255.255</span><br></pre></td></tr></table></figure>
<p>Port ranges are opened using a colon <code>:</code> and the number ranges you wish to use. The port type is given as <code>/tcp</code> or <code>/udp</code> appearing in the same manner as before. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow 3452:3478/tcp</span><br><span class="line">$ sudo ufw allow 3452:3478/udp</span><br></pre></td></tr></table></figure>
<p>Although the default rules we applied in step two automatically block every network connection, you can still block individual items with the firewall if you wish. Such as with a different blanket rule setup. </p>
<p>The <code>deny</code> command is what blocks specific port numbers, IP addresses, or port ranges when passed. </p>
<p>This would block the default SSH port if in some scenario it was required. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw deny ssh comment ssh</span><br></pre></td></tr></table></figure>
<p>To deny FTP traffic using the standard rule input syntax you can use:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw deny 21/tcp comment ssh</span><br></pre></td></tr></table></figure>
<p>Blocking a target IP address(s) is the same as allowing but again uses the <code>deny</code> option instead. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw deny from 192.168.254.254</span><br></pre></td></tr></table></figure>
<p>Lastly blocking entire ranges with <code>deny</code> is just as possible:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw deny 3278:3282/tcp</span><br><span class="line">$ sudo ufw deny 3278:3282/udp</span><br></pre></td></tr></table></figure>
<p>Blocking/denying entire subnets is also possible by using the IP address and mask (CIDR notation).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw deny 15.15.15.0/26</span><br></pre></td></tr></table></figure>
<p>Lastly here, blocking via the host machines network interface/hardware is possible e.g. <code>eth0</code> or whatever it is registered as. No examples for this will be shown here however. Simply note that it is possible. </p>
<hr>
<h1 id="4-–-Commonly-Applied-Rules"><a href="#4-–-Commonly-Applied-Rules" class="headerlink" title="4 – Commonly Applied Rules"></a>4 – Commonly Applied Rules</h1><p>Continuing on with the primary styles available for adding rules, the standard rule inputs and alias style inputs. Here are some common rules you might want to add to the firewall either now, or at some point in the future. </p>
<p>These two allow traffic on port <code>80</code> - the standard web server port. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow http comment http</span><br><span class="line">$ sudo ufw allow 80/tcp comment http</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Remember only one of the commands is required from these code blocks. Either the alias version (first line) or the standard input version (second line).</p>
</blockquote>
<p>The same goes for the port assigned to encrypted traffic on web servers, port <code>443</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow https comment https</span><br><span class="line">$ sudo ufw allow 443/tcp comment https</span><br></pre></td></tr></table></figure>
<p>Always use <code>sftp</code> instead of <code>ftp</code> when transferring files on the command line. The choice of commands to allow traffic on the default <code>sftp</code> port is:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow sftp comment sftp</span><br><span class="line">$ sudo ufw allow 115/tcp comment sftp</span><br></pre></td></tr></table></figure>
<p>When working with LDAP (Lightweight Directory Access Protocol) the alias command is best suited as it saves you having to open up both the TCP <strong>and</strong> UDP ports with two commands, so open up port <code>389</code> on both using:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow ldap comment ldap</span><br></pre></td></tr></table></figure>
<p>For SMTP traffic there’s:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow smtp comment smtp</span><br><span class="line">$ sudo ufw allow 25 comment smtp</span><br></pre></td></tr></table></figure>
<p>And for IMAP you’d enter:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow imap comment imap</span><br><span class="line">$ sudo ufw allow 143 comment imap</span><br></pre></td></tr></table></figure>
<p>Since UFW reads from the <code>/etc/services</code> file you can add any of the service names listed in there.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo less /etc/services</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Ping or ICMP reply should be enabled already by UFW. Meaning the server can be pinged even when the firewall is active. See <a href="http://askubuntu.com/a/10314" target="_blank" rel="external">http://askubuntu.com/a/10314</a></p>
</blockquote>
<p>Check this <a href="https://www.digitalocean.com/community/tutorials/ufw-essentials-common-firewall-rules-and-commands" target="_blank" rel="external">Digital Ocean article</a> for even more specific rules to add to your servers UFW config. </p>
<hr>
<h1 id="5-–-Enabling-and-Disabling-UFW"><a href="#5-–-Enabling-and-Disabling-UFW" class="headerlink" title="5 – Enabling and Disabling UFW"></a>5 – Enabling and Disabling UFW</h1><p>Once the rules are all added and ready for use, the final step is to activate the firewall. </p>
<p>This is easily done by issuing the command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw <span class="built_in">enable</span></span><br></pre></td></tr></table></figure>
<p>After entering the <code>sudo</code> password and confirming any prompts, you receive the message:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Firewall is active and enabled on system startup</span><br></pre></td></tr></table></figure>
<p>From here onward the rules are applied and working as entered. </p>
<p>To see the entire rules and status of the firewall now it’s running enter the command from the start again.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw status verbose</span><br></pre></td></tr></table></figure>
<p>Should you ever need to reload the firewall, use the <code>reload</code> option. Although this will probably be a rare occasion as remember rules are applied instantly upon entering.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw reload</span><br></pre></td></tr></table></figure>
<p>More commonly the entire firewall can be <code>disabled</code> with one command.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw <span class="built_in">disable</span></span><br></pre></td></tr></table></figure>
<p>Your rules and configuration is not list when the firewall is disabled, only inactive until you <code>enable</code> them again. To delete and remove rules see the next section. </p>
<hr>
<h1 id="6-–-Deleting-Rules"><a href="#6-–-Deleting-Rules" class="headerlink" title="6 – Deleting Rules"></a>6 – Deleting Rules</h1><p>Removing rules using the syntax you’re now likely familiar with. All you need to do is use the <code>delete</code> option as part of your command structure. </p>
<p>For example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw delete allow ssh</span><br><span class="line">$ sudo ufw delete allow 22/tcp</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Once again remember only one of the commands is required from the above code block. Either the alias version (first line) or the standard input version (second line).</p>
</blockquote>
<p>A smart way to remove rules uses the <code>numbered</code> output command.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw status numbered</span><br></pre></td></tr></table></figure>
<p>Here’s some example output:</p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Status: active</span><br><span class="line"></span><br><span class="line">     To                         Action      From</span><br><span class="line">     --                         ------      ----</span><br><span class="line">[ 1] 22                         ALLOW IN    Anywhere                  </span><br><span class="line">[ 2] 21/tcp                     ALLOW IN    Anywhere                  </span><br><span class="line">[ 3] 80                         ALLOW IN    Anywhere                  </span><br><span class="line">[ 4] 443                        ALLOW IN    Anywhere                  </span><br><span class="line">[ 5] 22 (v6)                    ALLOW IN    Anywhere (v6)             </span><br><span class="line">[ 6] 21/tcp (v6)                ALLOW IN    Anywhere (v6)             </span><br><span class="line">[ 7] 80 (v6)                    ALLOW IN    Anywhere (v6)             </span><br><span class="line">[ 8] 443 (v6)                   ALLOW IN    Anywhere (v6)</span><br></pre></td></tr></table></figure>
<p>The number featured in the resultant output (on the left column) can be referenced to delete rules. </p>
<p>As in this next example, which deletes rule <code>4</code> from the firewall. </p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw delete 4</span><br></pre></td></tr></table></figure>
<p>Be aware that if you have IPv6 enabled - which is the case on many distributions now by default after installation - there is always an equivalent rule added for IPv6; whenever you add a rule. So you need to delete that corresponding rule also when using this method. In my example it would have been rule <code>8</code> which you can see in the output(s).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ 8] 443 (v6)                   ALLOW IN    Anywhere (v6)</span><br></pre></td></tr></table></figure>
<p>If for some reason you want to redo the entire rule-set of the firewall. You can <code>reset</code> the whole of your current configuration with one command. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw reset</span><br></pre></td></tr></table></figure>
<p>Be careful using this of course. </p>
<hr>
<h1 id="7-–-Enabling-and-Disabling-Logging"><a href="#7-–-Enabling-and-Disabling-Logging" class="headerlink" title="7 – Enabling and Disabling Logging"></a>7 – Enabling and Disabling Logging</h1><p>If you want to use logging for the firewall you must enable it to do so. </p>
<p>To enable logging use:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw logging on</span><br></pre></td></tr></table></figure>
<p>The location of the log file may differ but in general here’s the place to start looking.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ls /var/<span class="built_in">log</span>/ufw</span><br></pre></td></tr></table></figure>
<p>For information on how to interpret log entries in UFW, read through this section <a href="https://help.ubuntu.com/community/UFW#Interpreting_Log_Entries" target="_blank" rel="external">here</a>. </p>
<p>To disable logging if needed you can use:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw logging off</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="8-–-Miscellaneous"><a href="#8-–-Miscellaneous" class="headerlink" title="8 – Miscellaneous"></a>8 – Miscellaneous</h1><p>Rule comments were introduced as of February 2016 but you will require at least version <code>0.35</code> of UFW to be able to use them. </p>
<p>To use IPv6 with UFW you need to ensure you have it enabled in the configuration file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/default/ufw</span><br></pre></td></tr></table></figure>
<p>Change the the value of <code>IPV6</code> to equal <code>yes</code> in this file if it is set to “no”. </p>
<figure class="highlight bash"><figcaption><span>/etc/default/ufw excerpt</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IPV6=yes</span><br></pre></td></tr></table></figure>
<p>Save and leave the file. </p>
<p>Reloading the firewall here might be a wise step if you already had it running before doing this (the command for reloading is given in an earlier step). After this the IPv6 rules alongside the regular IPv4 rules should be active and added to the firewall. </p>
<p>Lastly here’s several aliases you might want to incorporate into your <code>.bashrc</code> or <code>.alias</code> file to make things slightly quicker. </p>
<figure class="highlight bash"><figcaption><span>~/.alias</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ufw</span></span><br><span class="line"><span class="built_in">alias</span> ufw=<span class="string">'sudo ufw'</span></span><br><span class="line"><span class="built_in">alias</span> ufwstatver=<span class="string">'sudo ufw status verbose'</span></span><br><span class="line"><span class="built_in">alias</span> ufwstatnum=<span class="string">'sudo ufw status numbered'</span></span><br></pre></td></tr></table></figure>
<hr>
<p>This post in its entirety covers most of the information required when it comes to getting to know UFW. Some of the external links also provide a vast amount of information should it be needed. </p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-with-ufw-on-ubuntu-16-04" target="_blank" rel="external">Digital Ocean - How To Set Up a Firewall with UFW on Ubuntu 16.04</a> – There are several of these articles on DO and this is one I found the most useful for this post. </li>
<li><a href="https://wiki.ubuntu.com/UncomplicatedFirewall" target="_blank" rel="external">Ubuntu Wiki - UncomplicatedFirewall</a> – This page contains all the feature release and their versions. Alongside links to many different server guides.  </li>
<li><a href="https://launchpad.net/ufw" target="_blank" rel="external">Launchpad - UFW</a> – The project is hosted here with all development details included. </li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Firewall/" class="post__tag__link">Firewall</a></li><li class="post__tag__item"><a href="/tags/Networking/" class="post__tag__link">Networking</a></li><li class="post__tag__item"><a href="/tags/IP/" class="post__tag__link">IP</a></li></ul><a href="/2017/02/14/installing-using-ufw/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2016-06-26T23:00:00.000Z" class="post__time">June 27, 2016</time><h1 class="post__title"><a href="/2016/06/27/ansible-inventory-concepts/">Ansible - Inventory Concepts (2)</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/9HBs9cy.png" alt="Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>After outlining the initial installation and setup process in <a href="http://www.tricksofthetrades.net/2016/02/10/ansible-installing-running/">Ansible - Installing and Running (1)</a> I’m continuing in this post with a more precise look at how to handle the main hosts file. Specifically how to lay it out and add host variables or group variables to the mix. Dynamic inventory assets and development/production inventory layouts are not covered here and only alluded to or linked to. </p>
<p>Lastly splitting up the variable types and their definitions into their own YAML files is briefly introduced in the final step, and works best for more complex network hierarchies. </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Hosts-Inventory-File"><a href="#1-–-Hosts-Inventory-File" class="headerlink" title="1 –  Hosts Inventory File"></a>1 –  Hosts Inventory File</h1><p>As shown in “Ansible - Installing and Running (1)” Ansible operates by working simultaneously with multiple hosts in your infrastructure. It’s preferred way of doing this is to allocate hosts into different groups inside of the inventory file - <code>/etc/ansible/hosts</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ls /etc/ansible/</span><br><span class="line"></span><br><span class="line">ansible.cfg  hosts  hosts.orig  roles</span><br></pre></td></tr></table></figure>
<p>This file is completely configurable and can be expanded or broken up into multiple inventory files.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/ansible/hosts</span><br></pre></td></tr></table></figure>
<p>There’s a special form of inventory in Ansible known as <em>dynamic inventory</em> that refers to inventory files or asserts that get pulled down from the cloud, or other server side sources. This is not covered in this post however. </p>
<hr>
<h1 id="2-–-Hosts-and-Groups"><a href="#2-–-Hosts-and-Groups" class="headerlink" title="2 – Hosts and Groups"></a>2 – Hosts and Groups</h1><p>As seen in the first post, the INI style formatting for an Ansible hosts file looks similar to this:</p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[webservers]</span></span><br><span class="line"><span class="string">webremote.one.ip.address</span></span><br><span class="line"><span class="string">webremote.two.ip.address</span></span><br><span class="line"><span class="string">webremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[dbservers]</span></span><br><span class="line"><span class="string">dbremote.one.ip.address</span></span><br><span class="line"><span class="string">dbremote.two.ip.address</span></span><br><span class="line"><span class="string">dbremote.three.ip.address</span></span><br></pre></td></tr></table></figure>
<p>Square brackets <code>[ ]</code> contain a group name which is used to decide what systems you are controlling at what times and for what purpose. This makes it possible to apply actions to specific nodes/hosts as and when necessary. </p>
<p>Also systems (nodes/hosts) can be attributed under more than one group if needed, so in the snippet above one of the example nodes could be both a web server <strong>and</strong> a database server, added to both group entries in the file.</p>
<p>The hostnames can also be domain names instead of raw IP addresses if preferred, and when adding a large numbers of hosts if the domain names follow a similar numerical pattern, you can use ranges of numbers instead of adding them all individually. </p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[webservers]</span></span><br><span class="line"><span class="string">www[01:50].example.com</span></span><br></pre></td></tr></table></figure>
<p>Lastly hosts that run on non-standard SSH ports i.e. not <code>22</code> must have the their custom SSH port numbers inserted after the hostname separated by a colon.</p>
<p>For example:</p>
<p><code>webremote.one.ip.address:3675</code></p>
<p>Or instead defined through host/group variables (see next step). </p>
<hr>
<h1 id="3-–-Host-and-Group-Variables"><a href="#3-–-Host-and-Group-Variables" class="headerlink" title="3 – Host and Group Variables"></a>3 – Host and Group Variables</h1><p>Variables in the inventory file(s) are set on a host basis or group basis. There are many of these inbuilt variables on offer to the user when constructing the file. </p>
<p>Here is an example of two host variables, that explicitly tell Ansible to use SSH as the connection type, with a set username:</p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[webservers]</span></span><br><span class="line"><span class="string">webremote.one.ip.address</span> <span class="string">ansible_connection=ssh</span> <span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">webremote.two.ip.address</span> <span class="string">ansible_connection=ssh</span> <span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">webremote.three.ip.address</span> <span class="string">ansible_connection=ssh</span> <span class="string">ansible_user=username</span> </span><br><span class="line"></span><br><span class="line"><span class="string">[dbservers]</span></span><br><span class="line"><span class="string">dbremote.one.ip.address</span> <span class="string">ansible_connection=ssh</span> <span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">dbremote.two.ip.address</span> <span class="string">ansible_connection=ssh</span> <span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">dbremote.three.ip.address</span> <span class="string">ansible_connection=ssh</span> <span class="string">ansible_user=username</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> <code>username</code> would be replaced by the actual Ansible user on these hosts in the above.</p>
</blockquote>
<p>In the first post on Ansible I laid out these host variables and the file formatting differently, by using:</p>
<ul>
<li>An “empty” name for the hosts - <code>server-name-1</code></li>
<li>A host variable that then gives this name an IP address to refer to - <code>ansible_host=remote.one.ip.address</code></li>
<li>Another host variable with the specific username like in the previous example - <code>ansible_user=username</code></li>
<li>Then a final host variable that holds the custom SSH port to use when connecting to this host - <code>ansible_port=3980</code></li>
</ul>
<p>Here is what the layout looked like for this file:</p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[servers]</span></span><br><span class="line"><span class="string">server-name-1</span> <span class="string">ansible_host=remote.one.ip.address</span> <span class="string">ansible_user=username</span> <span class="string">ansible_port=3980</span> </span><br><span class="line"><span class="string">server-name-2</span> <span class="string">ansible_host=remote.one.ip.address</span> <span class="string">ansible_user=username</span> <span class="string">ansible_port=3980</span> </span><br><span class="line"><span class="string">server-name-3</span> <span class="string">ansible_host=remote.one.ip.address</span> <span class="string">ansible_user=username</span> <span class="string">ansible_port=3980</span></span><br></pre></td></tr></table></figure>
<p>Group variables allow extra options and settings like in the above to be applied to an entire group at once. Instead of having to set the same variables for each host when the value of the variables is the same. </p>
<p>These are defined by creating a new set of square brackets <code>[ ]</code> that contain the group name you wish to apply the variables to, followed by a <em>tag</em> that consists of a <code>:</code> and the term <code>vars</code> .</p>
<p>When put together using a group named “webservers” this makes - <code>[webservers:vars]</code> </p>
<p>The variables you want to apply to the group are then listed on separate lines - an example of all of this is shown in the below code snippet:</p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[webservers]</span></span><br><span class="line"><span class="string">webremote.one.ip.address</span></span><br><span class="line"><span class="string">webremote.two.ip.address</span></span><br><span class="line"><span class="string">webremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[webservers:vars]</span></span><br><span class="line"><span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">ansible_port=3980</span> </span><br><span class="line"><span class="string">ntp_server=ntp.example.com</span></span><br><span class="line"><span class="string">proxy=proxy.example.com</span></span><br><span class="line"></span><br><span class="line"><span class="string">[dbservers]</span></span><br><span class="line"><span class="string">dbremote.one.ip.address</span></span><br><span class="line"><span class="string">dbremote.two.ip.address</span></span><br><span class="line"><span class="string">dbremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[dbservers:vars]</span></span><br><span class="line"><span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">ansible_port=3980</span> </span><br><span class="line"><span class="string">ntp_server=ntp.example.com</span></span><br><span class="line"><span class="string">proxy=proxy.example.com</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="4-–-Groups-of-Groups"><a href="#4-–-Groups-of-Groups" class="headerlink" title="4 – Groups of Groups"></a>4 – Groups of Groups</h1><p>There’s a further way of making “groups out of groups” by using the <code>:children</code> tag. These can have group variables applied to them too by using the same method in the last step. To do this extra grouping, a new group name is created then suffixed with the <code>:children</code> tag which will contain the original groups defined.</p>
<p>Such as here:</p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[webservers-one]</span></span><br><span class="line"><span class="string">webremote.one.ip.address</span></span><br><span class="line"><span class="string">webremote.two.ip.address</span></span><br><span class="line"><span class="string">webremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[dbservers-one]</span></span><br><span class="line"><span class="string">dbremote.one.ip.address</span></span><br><span class="line"><span class="string">dbremote.two.ip.address</span></span><br><span class="line"><span class="string">dbremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[cluster-one:children]</span></span><br><span class="line"><span class="string">webservers-one</span></span><br><span class="line"><span class="string">dbservers-two</span></span><br></pre></td></tr></table></figure>
<p>To add group variables to this new group of a group, the new name is added to yet another group with the standard <code>:vars</code> tag.</p>
<p>Like at the bottom of this code snippet:</p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[webservers-one]</span></span><br><span class="line"><span class="string">webremote.one.ip.address</span></span><br><span class="line"><span class="string">webremote.two.ip.address</span></span><br><span class="line"><span class="string">webremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[dbservers-one]</span></span><br><span class="line"><span class="string">dbremote.one.ip.address</span></span><br><span class="line"><span class="string">dbremote.two.ip.address</span></span><br><span class="line"><span class="string">dbremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[cluster-one:children]</span></span><br><span class="line"><span class="string">webservers-one</span></span><br><span class="line"><span class="string">dbservers-two</span></span><br><span class="line"></span><br><span class="line"><span class="string">[cluster-one:vars]</span></span><br><span class="line"><span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">ansible_port=3980</span> </span><br><span class="line"><span class="string">ntp_server=ntp.example.com</span></span><br><span class="line"><span class="string">proxy=proxy.example.com</span></span><br></pre></td></tr></table></figure>
<p>The concept of grouping groups into more groups can theoretically go on indefinitely. Another level of grouping is added below to demonstrate:</p>
<figure class="highlight yaml"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[webservers-one]</span></span><br><span class="line"><span class="string">webremote.one.ip.address</span></span><br><span class="line"><span class="string">webremote.two.ip.address</span></span><br><span class="line"><span class="string">webremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[dbservers-one]</span></span><br><span class="line"><span class="string">dbremote.one.ip.address</span></span><br><span class="line"><span class="string">dbremote.two.ip.address</span></span><br><span class="line"><span class="string">dbremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[cluster-one:children]</span></span><br><span class="line"><span class="string">webservers-one</span></span><br><span class="line"><span class="string">dbservers-two</span></span><br><span class="line"></span><br><span class="line"><span class="string">[cluster-one:vars]</span></span><br><span class="line"><span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">ansible_port=3980</span> </span><br><span class="line"><span class="string">ntp_server=ntp.example.com</span></span><br><span class="line"><span class="string">proxy=proxy.example.com</span></span><br><span class="line"><span class="string">[webservers-two]</span></span><br><span class="line"></span><br><span class="line"><span class="string">webremote.one.ip.address</span></span><br><span class="line"><span class="string">webremote.two.ip.address</span></span><br><span class="line"><span class="string">webremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[dbservers-two]</span></span><br><span class="line"><span class="string">dbremote.one.ip.address</span></span><br><span class="line"><span class="string">dbremote.two.ip.address</span></span><br><span class="line"><span class="string">dbremote.three.ip.address</span></span><br><span class="line"></span><br><span class="line"><span class="string">[cluster-two:children]</span></span><br><span class="line"><span class="string">webservers-two</span></span><br><span class="line"><span class="string">dbservers-two</span></span><br><span class="line"></span><br><span class="line"><span class="string">[cluster-two:vars]</span></span><br><span class="line"><span class="string">ansible_user=username</span> </span><br><span class="line"><span class="string">ansible_port=3980</span> </span><br><span class="line"><span class="string">ntp_server=ntp.example.com</span></span><br><span class="line"><span class="string">proxy=proxy.example.com</span></span><br><span class="line"></span><br><span class="line"><span class="string">[all-clusters:children]</span></span><br><span class="line"><span class="string">cluster-one</span></span><br><span class="line"><span class="string">cluster-two</span></span><br></pre></td></tr></table></figure>
<p>More realistically this could be seen in terms of grouping local data-centre hosts into regions and then into a country wide group. </p>
<hr>
<h1 id="5-–-Multiple-Inventory-Files"><a href="#5-–-Multiple-Inventory-Files" class="headerlink" title="5 – Multiple Inventory Files"></a>5 – Multiple Inventory Files</h1><p>The singular <code>/etc/ansible/hosts</code> file is fine for smaller more contained network setups, but the preferred practice in Ansible is not to store variables in the main <code>hosts</code> inventory file. At least when dealing with larger more complex layouts of hosts, or bigger networks. </p>
<p>Host and group variables ideally when handling large scale setups should be stored in individual files. Files that are relative to the main inventory file.</p>
<p>As an example any group variables defined in the below file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/ansible/group_vars/webservers.yml</span><br></pre></td></tr></table></figure>
<p>Will apply to any hosts located in the <code>webservers</code> group. These variable files are written in YAML.</p>
<p>Similarly any host variables defined in:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/ansible/host_vars/server-name-1.yml</span><br></pre></td></tr></table></figure>
<p>Are applied to the host named <code>server-name-1</code> from the original <code>hosts</code> file. </p>
<p>Further segmentation and organisation of the host/inventory files is followed but not covered in this post, see <a href="http://rosstuck.com/multistage-environments-with-ansible/" target="_blank" rel="external">Multistage Environments with Ansible</a> for more information on how this is done.</p>
<hr>
<p>A future third post on Ansible will describe the <em>modules</em> in place that can be run as part of a playbook, or as ad-hoc based commands. </p>
<p><a href="http://www.tricksofthetrades.net/trades/">Links to subsequent Ansible posts can be found on the Trades page.</a></p>
<p><strong>More Information</strong></p>
<ul>
<li><a href="http://docs.ansible.com/ansible/intro_inventory.html" target="_blank" rel="external">Official Ansible Documentation - Inventory</a> – The concepts on this page are what I based most of this blosg post on. </li>
<li><a href="http://docs.ansible.com/ansible/playbooks_best_practices.html" target="_blank" rel="external">Official Ansible Documentation - Best Practices: Content Organisation</a> – Not as relevant but </li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Python/" class="post__tag__link">Python</a></li></ul><a href="/2016/06/27/ansible-inventory-concepts/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2016-06-12T23:00:00.000Z" class="post__time">June 13, 2016</time><h1 class="post__title"><a href="/2016/06/13/debian8-vps-checklist/">Debian 8 (Jessie) VPS Basic Checklist</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/JXNdLSN.png" alt="VPS Image"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>Here are some base guidelines I follow when setting up a new VPS manually without configuration management. These steps if anything make the system more secure overall and provide a good starting point from which you can setup the services/software’s required for the purpose of the VPS. </p>
<p>All of these steps in this post are from the context of a <em>droplet</em> (VPS) hosted by <a href="https://m.do.co/c/e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> using the Debian 8.5 x64 kernel images they use as of the above date. </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Setup-VPS-User-Account"><a href="#1-–-Setup-VPS-User-Account" class="headerlink" title="1 – Setup VPS User Account"></a>1 – Setup VPS User Account</h1><p>Initial root access for this section is assumed. Adding a registered SSH public key to the droplet creation on Digital Ocean gives pass-wordless root access to the VPS. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh root@your.vps.ip.address</span><br></pre></td></tr></table></figure>
<p>Install the <code>sudo</code> package manually as this is not included with Digital Ocean’s Debian 8 image.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get install sudo</span><br></pre></td></tr></table></figure>
<p>Add your new Linux user to the system. Whenever you see <code>scarlz</code> here in commands it should be replaced with your own preferred username, and substituted in from throughout. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ adduser scarlz</span><br></pre></td></tr></table></figure>
<p>Add the newly created user to the <code>sudo</code> elevation privileges group.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ adduser scarlz sudo</span><br></pre></td></tr></table></figure>
<p>You can also add the user to the <code>adm</code> group which grants read access to system log files if you think this would be useful. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ adduser scarlz adm</span><br></pre></td></tr></table></figure>
<p>Exit the root SSH session. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="2-–-Copy-Client-Public-SSH-Key"><a href="#2-–-Copy-Client-Public-SSH-Key" class="headerlink" title="2 – Copy Client Public SSH Key"></a>2 – Copy Client Public SSH Key</h1><p>Install your public key to the new user added in the previous step. </p>
<p>Do this by running the <code>ssh-copy-id</code> command, supplying it with the the username and IP address of the VPS. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-copy-id scarlz@your.vps.ip.address</span><br></pre></td></tr></table></figure>
<p>The public key (after authentication) will be added to the remote user’s <code>~/.ssh/authorized_keys</code> file. </p>
<p>As long as the client has the private key tied to the public key just registered, it can be used to log into the VPS. </p>
<hr>
<h1 id="3-–-Update-and-Install-System-Packages"><a href="#3-–-Update-and-Install-System-Packages" class="headerlink" title="3 – Update and Install System Packages"></a>3 – Update and Install System Packages</h1><p>SSH back into the VPS as the new user you created previously, which should work without requiring authentication details thanks to the previous step. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh scarlz@your.vps.ip.address</span><br></pre></td></tr></table></figure>
<p>Run this command to ensure the system’s packages are up to date. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update &amp;&amp; sudo apt-get upgrade</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="4-–-Default-SSH-Port-and-Root-Access"><a href="#4-–-Default-SSH-Port-and-Root-Access" class="headerlink" title="4 – Default SSH Port and Root Access"></a>4 – Default SSH Port and Root Access</h1><p>This step removes the assumption any port scanning makes on what port number the SSH service is running on. The default is <code>22</code> so these processes will check for that first and foremost. Changing this number to an ephemeral port can help to reduce the number of attempted malicious login attempts that are made. However there are several finer points as to why you might not want to do this, so decide if this seems worthwhile or not before doing it (see the next link). </p>
<blockquote>
<p><strong>Note:</strong> <a href="http://security.stackexchange.com/questions/32308/should-i-change-the-default-ssh-port-on-linux-servers" target="_blank" rel="external">Should I change the default SSH port on linux servers?</a></p>
</blockquote>
<p>All I  would say is don’t get into the habit of doing this for other service’s port numbers. If you choose not to do this then Fail2ban (which we install later) will be enough in its place. </p>
<p>Disabling password authentication for the root user account and relying on the registered SSH key can also put a stop to attempted root logins from unwanted hosts. </p>
<p>Change the VPS’s default SSH port &amp; disable root login via passwords in the system wide SSH config file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure>
<p>Change the <code>Port 22</code> entry to any number between <code>1025</code> and <code>65536</code> respectively, if you have decided you want to do this.  </p>
<p>For example:</p>
<figure class="highlight bash"><figcaption><span>/etc/ssh/sshd_config</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Port 3267</span><br></pre></td></tr></table></figure>
<p>Change the <code>PermitRootLogin yes</code> entry to <code>PermitRootLogin without-password</code> instead,</p>
<p>This as mentioned before means only users with public SSH keys registered in the root authorised keys file can log in as root itself. </p>
<figure class="highlight bash"><figcaption><span>/etc/ssh/sshd_config</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PermitRootLogin without-password</span><br></pre></td></tr></table></figure>
<p>Restart SSH so the changes take effect.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service ssh restart</span><br></pre></td></tr></table></figure>
<p>When accessing the VPS via SSH in the future, you must now append the correct port number to the command e.g.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh scarlz@your.vps.ip.address -p 3267</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="5-–-Automatic-Security-Upgrades"><a href="#5-–-Automatic-Security-Upgrades" class="headerlink" title="5 – Automatic Security Upgrades"></a>5 – Automatic Security Upgrades</h1><p>Using a package named <code>unattended-upgrades</code> it’s possible to have updates done by the package manager automatically at set intervals. It is advised to only enable security updating and not the normal package upgrading as this could potentially cause problems with conflicts or unwanted changes. </p>
<p>Install the package to begin with.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install unattended-upgrades</span><br></pre></td></tr></table></figure>
<p>Open/create the <code>10periodic</code> configuration file for this package using your preferred text editor.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/apt/apt.conf.d/10periodic</span><br></pre></td></tr></table></figure>
<p>Add in the lines found in the below code snippet:</p>
<figure class="highlight bash"><figcaption><span>/etc/apt/apt.conf.d/10periodic</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">APT::Periodic::Update-Package-Lists <span class="string">"1"</span>;</span><br><span class="line">APT::Periodic::Download-Upgradeable-Packages <span class="string">"1"</span>;</span><br><span class="line">APT::Periodic::AutocleanInterval <span class="string">"7"</span>;</span><br><span class="line">APT::Periodic::Unattended-Upgrade <span class="string">"1"</span>;</span><br></pre></td></tr></table></figure>
<p>Save your additions and exit the file. </p>
<p>Now open up another configuration file named <code>50unattended-upgrades</code> for changes.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/apt/apt.conf.d/50unattended-upgrades</span><br></pre></td></tr></table></figure>
<p>Enable security updates only by adding the line - <code>&quot;origin=Debian,codename=${distro_codename},label=Debian-Security&quot;;</code> to the correct location, as shown in the next code snippet on line 17:</p>
<figure class="highlight bash"><figcaption><span>/etc/apt/apt.conf.d/50unattended-upgrades</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Unattended-Upgrade::Origins-Pattern &#123;</span><br><span class="line">        // Codename based matching:</span><br><span class="line">        // This will follow the migration of a release through different</span><br><span class="line">        // archives (e.g. from testing to stable and later oldstable).</span><br><span class="line">//      <span class="string">"o=Debian,n=jessie"</span>;</span><br><span class="line">//      <span class="string">"o=Debian,n=jessie-updates"</span>;</span><br><span class="line">//      <span class="string">"o=Debian,n=jessie-proposed-updates"</span>;</span><br><span class="line">//      <span class="string">"o=Debian,n=jessie,l=Debian-Security"</span>;</span><br><span class="line"></span><br><span class="line">        // Archive or Suite based matching:</span><br><span class="line">        // Note that this will silently match a different release after</span><br><span class="line">        // migration to the specified archive (e.g. testing becomes the</span><br><span class="line">        // new stable).</span><br><span class="line">//      <span class="string">"o=Debian,a=stable"</span>;</span><br><span class="line">//      <span class="string">"o=Debian,a=stable-updates"</span>;</span><br><span class="line">//      <span class="string">"o=Debian,a=proposed-updates"</span>;</span><br><span class="line">        <span class="string">"origin=Debian,codename=<span class="variable">$&#123;distro_codename&#125;</span>,label=Debian-Security"</span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Further down in the file add an email address thatcan receive the update reports and uncomment the line itself: </p>
<figure class="highlight bash"><figcaption><span>/etc/apt/apt.conf.d/50unattended-upgrades</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Send email to this address <span class="keyword">for</span> problems or packages upgrades</span><br><span class="line">// If empty or <span class="built_in">unset</span> <span class="keyword">then</span> no email is sent, make sure that you</span><br><span class="line">// have a working mail setup on your system. A package that provides</span><br><span class="line">// <span class="string">'mailx'</span> must be installed. E.g. <span class="string">"user@example.com"</span></span><br><span class="line">Unattended-Upgrade::Mail <span class="string">"user@email-domain.com"</span>;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="6-–-Setup-Dotfiles-Optional"><a href="#6-–-Setup-Dotfiles-Optional" class="headerlink" title="6 – Setup Dotfiles (Optional)"></a>6 – Setup Dotfiles (Optional)</h1><p>Most administrators or developers will have their own customised <em>dotfiles</em> they use to personalise the server and make tasks easier, or introduce extra functionality to the system. Here is where I would setup my own using Git and GitHub.   </p>
<p>It is unlikely that you’ll want to carry out the commands in this step as these instructions are for my own dotfiles, so only really relevant to me. </p>
<p><strong>Replace this step with installing and setting up your own equivalent dotfiles!</strong></p>
<blockquote>
<p><a href="https://github.com/5car1z/dotfiles" target="_blank" rel="external">https://github.com/5car1z/dotfiles</a></p>
</blockquote>
<p>Install Git via the system package manager. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install git</span><br></pre></td></tr></table></figure>
<p>Clone your dotfiles repository onto the system.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/5car1z/dotfiles.git </span><br><span class="line">$ <span class="built_in">cd</span> ~/dotfiles</span><br></pre></td></tr></table></figure>
<p>Run the two install scripts that add more packages (all the good stuff) and create the necessary symlinks using GNU Stow. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./install-debian-ubuntu-dotfile-dependencies.sh</span><br><span class="line">$ ./stow-dotfiles.sh</span><br></pre></td></tr></table></figure>
<p>If there’s any submodule problems update them to their latest remote versions with:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ update_submodules</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="7-–-Install-Software-Packages"><a href="#7-–-Install-Software-Packages" class="headerlink" title="7 – Install Software Packages"></a>7 – Install Software Packages</h1><p>Any outstanding or super essential packages that haven’t been brought in by the “dotfiles” step should be considered before moving on. What these are will be known only to you though as everybody’s preferences and needs are different. </p>
<p>Here are several examples however. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install git vim curl cowsay fortune-mod jq vim tmux ranger</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="8-–-Install-and-Run-UFW"><a href="#8-–-Install-and-Run-UFW" class="headerlink" title="8 – Install and Run UFW"></a>8 – Install and Run UFW</h1><p>UFW stands for “Uncomplicated Firewall” and is more concise easier to understand alternative to older firewall implementations like <a href="http://www.tricksofthetrades.net/2015/05/18/iptables-ipv4/">iptables</a>.  </p>
<p>Install on Debian 8 like any other package simply using:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install ufw</span><br></pre></td></tr></table></figure>
<p>Like with other firewalls of this elk it’s common practice to put in place a blanket set of ingress/egress rules then add the exceptions to services and ports on top afterwards. </p>
<p>Make the default overall action for any incoming traffic to be blocked and denied. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw default deny incoming</span><br></pre></td></tr></table></figure>
<p>Then make the default overall action for outgoing traffic to be permissible and allowed. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw default allow outgoing</span><br></pre></td></tr></table></figure>
<p>From here, any services you wish to allow that are received by the VPS can be added as an exception. See a separate post that covers the key areas of UFW in itself for information on how to do this. </p>
<blockquote>
<p><a href="http://www.tricksofthetrades.net/2017/02/14/installing-using-ufw/">Full UFW Guide</a></p>
</blockquote>
<p>To continue here, open the SSH port number you chose earlier on by replacing the number <code>3267</code> with your own number, in the following command.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow 3267/tcp</span><br></pre></td></tr></table></figure>
<p>Lastly after all the extra rules you need, enable the firewall so the configuration becomes active. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw <span class="built_in">enable</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="9-–-Install-and-Run-Fail2ban"><a href="#9-–-Install-and-Run-Fail2ban" class="headerlink" title="9 – Install and Run Fail2ban"></a>9 – Install and Run Fail2ban</h1><p>This application permanently stops any excessive failed attempts (brute forcing) at connecting to the VPS - it achieves this by banning the offending source IP. This is configurable over various services on the system and not just SSH. </p>
<p>Install it as done before with the system package manager. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install fail2ban sendmail</span><br></pre></td></tr></table></figure>
<p>Sendmail can also be used by Fail2ban when sending out notification messages for bans that have occurred, so this is useful to install alongside it. Unless you want to configure it to use a different mail service. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo sed <span class="string">'s/^banaction = .*/banaction = ufw/'</span> /etc/fail2ban/jail.conf &gt; /etc/fail2ban/jail.local</span><br></pre></td></tr></table></figure>
<p>Start the service and ensure it’s running by ussing the command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service fail2ban start</span><br></pre></td></tr></table></figure>
<p>A more detailed rundown of the configuration involved with Fail2ban is covered in a separate post to this one. </p>
<blockquote>
<p><a href="">Full Fail2ban Guide - To Be Added</a></p>
</blockquote>
<hr>
<p>This is a pretty straightforward post, all things considered. Remember that a persons needs for configuring a VPS will be tailored to their own requirements, criteria, and preferences. So these steps are good general outline but mainly the ones I personally follow - other people’s will be different, according to their needs. </p>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-debian-8" target="_blank" rel="external">Digital Ocean - Initial Server Setup with Debian 8</a> – Partial inspiration for this post. </li>
<li><a href="https://www.reddit.com/r/netsec/comments/4o7wpo/my_first_10_minutes_on_a_server/" target="_blank" rel="external">Reddit Thread - My First 10 Minutes On a Server</a> – Reddit thread that links to an article on best security practives to follow when setting up a VPS/server. </li>
<li><a href="https://wiki.debian.org/UnattendedUpgrades" target="_blank" rel="external">Debian Wiki - Unattended Upgrades</a> – Helpful explanation and information on how to use the configuration files. </li>
<li><a href="https://www.digitalocean.com/community/questions/what-is-your-server-security-check-list" target="_blank" rel="external">Digital Ocean - What is your server security check list?</a> – November 29, 2016 Question Thread.</li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Debian/" class="post__tag__link">Debian</a></li><li class="post__tag__item"><a href="/tags/Jessie/" class="post__tag__link">Jessie</a></li><li class="post__tag__item"><a href="/tags/VPS/" class="post__tag__link">VPS</a></li></ul><a href="/2016/06/13/debian8-vps-checklist/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2018 Scarlz</div><menu class="page-menu u-fr"><li class="page-menu__item"><a title="Previous" href="/topics/Programming/" class="page-menu__link icon-arrow-left"></a></li><li class="page-menu__item"><a title="Next" href="/topics/Programming/page/3/" class="page-menu__link icon-arrow-right"></a></li></menu></footer><script>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src="//"+l+".disqus.com/"+k+".js",i.parentNode.insertBefore(j,i)})
(document,"script","totts","count");
</script></body></html>