<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="Linux System Administration"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="atom.xml" title="Tricks of the Trades" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Programming - Tricks of the Trades</title><link rel="stylesheet" href="/css/main.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">Tricks of the Trades</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/trades" class="head-nav__link">Trades</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="/work" class="head-nav__link">Work</a></li><li class="head-nav__item"><a href="/about" class="head-nav__link">About</a></li><li class="head-nav__item"><a href="/contact" class="head-nav__link">Contact</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2018-02-03T00:00:00.000Z" class="post__time">February 3, 2018</time><h1 class="post__title"><a href="/2018/02/03/spectre-meltdown-ansible/">Deploying Meltdown and Spectre Fixes with Ansible on Linux Hosts</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/TEnht2h.jpg" alt="Spectre &amp; Meltdown Logos"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>As it stands the current “fixes” for <a href="https://meltdownattack.com/" target="_blank" rel="external">Meltdown and Spectre</a> mainly involve updating and upgrading hosts to include their patched kernel upgrades. When it comes to applying the updates to multiple Linux servers, one approach is to use the playbook/plays in this “lockdown” repo from Ansible. </p>
<blockquote>
<p><a href="https://github.com/ansible/ansible-lockdown/blob/master/meltdown-spectre-linux.yml" target="_blank" rel="external">https://github.com/ansible/ansible-lockdown/blob/master/meltdown-spectre-linux.yml</a></p>
</blockquote>
<p>This is how the YAML works to patch the aforementioned exploits. </p>
<a id="more"></a>
<hr>
<p>First off for the hosts directive, either the default <code>all</code> hosts is used or any hosts provided <code>-i</code> when running <code>ansible-playbook</code> take precedence. The tasks are to be carried out with <code>become:</code> and thereby super user privileges. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://meltdownattack.com</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">Patch</span> <span class="string">Linux</span> <span class="string">systems</span> <span class="string">against</span> <span class="string">Meltdown</span> <span class="string">and</span> <span class="string">Spectre</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">"<span class="template-variable">&#123;&#123; target_hosts | default('all') &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">  become:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>
<p>Variables are defined ready for use later on in the tasks section. </p>
<p><code>reboot_after_update:</code> is set to <code>no</code> but should be set to “yes” where possible by yourself. The reason for this is covered properly towards the end of these explanations. </p>
<p><code>packages:</code> contains the required kernel package versions for each respective Linux distro. Most of the Debian/Ubuntu entries are empty with the exception of Debian 9 (the latest stable version) which contains the specific kernel package.  </p>
<p>The empty values may be updated by the maintainers at some point, but you can add in the kernel packages yourself for the empty ones. I’ve done this in the next code snippet, from the information given at these two links:</p>
<blockquote>
<p><a href="https://www.debian.org/security/2018/dsa-4078" target="_blank" rel="external">https://www.debian.org/security/2018/dsa-4078</a><br><a href="https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/SpectreAndMeltdown" target="_blank" rel="external">https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/SpectreAndMeltdown</a></p>
</blockquote>
<p>These kernel packages are in essence the only Meltdown and or Spectre <em>“fixes”</em> currently available. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">vars:</span></span><br><span class="line"><span class="attr">  reboot_after_update:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">  packages:</span></span><br><span class="line">    <span class="comment"># https://access.redhat.com/security/vulnerabilities/speculativeexecution</span></span><br><span class="line"><span class="attr">    RedHat7:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kernel-3.10.0-693.11.6.el7</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">microcode_ctl-2.1-22.2.el7</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">perf-3.10.0-693.11.6.el7</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">python-perf-3.10.0-693.11.6.el7</span></span><br><span class="line"><span class="attr">    RedHat6:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kernel-2.6.32-696.18.7.el6</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">kernel-firmware-2.6.32-696.18.7.el6</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">perf-2.6.32-696.18.7.el6</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">python-perf-2.6.32-696.18.7.el6</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># https://www.debian.org/security/2018/dsa-4078</span></span><br><span class="line"><span class="attr">    Debian7:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-3.2.0-5-amd64</span></span><br><span class="line"><span class="attr">    Debian8:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-3.16.0-5-amd64</span></span><br><span class="line"><span class="attr">    Debian9:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-4.9.0-5-amd64</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/SpectreAndMeltdown</span></span><br><span class="line"><span class="attr">    Ubuntu14:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-3.13.0-141-generic</span></span><br><span class="line"><span class="attr">    Ubuntu16:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-4.4.0-112-generic</span> </span><br><span class="line"><span class="attr">    Ubuntu17:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">linux-image-4.13.0-31-generic</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Please remember that this is as things stand right now with the kernel patching in late January, so these version numbers are always subject to change as new fixes are released. </p>
</blockquote>
<p>There are two tasks in total. One for each type of package manager in use on the various distros. </p>
<p>When Yum is detected on the host by Ansible, the first task is executed and the distro packages defined previously are referenced for installation. This is done using the <code>ansible_os_family</code> and <code>ansible_distribution_major_version</code> system fact variables - the distro name and version number respectively.  </p>
<p>A handler is then called to reboot the host (explained later on).</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">RHEL</span> <span class="string">| Install kernel updates</span><br><span class="line"></span><span class="attr">    yum:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">"<span class="template-variable">&#123;&#123; packages[ansible_os_family ~ ansible_distribution_major_version] &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">      state:</span> <span class="string">present</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">ansible_pkg_mgr</span> <span class="string">==</span> <span class="string">'yum'</span></span><br><span class="line"><span class="attr">    notify:</span> <span class="string">reboot</span> <span class="string">system</span></span><br></pre></td></tr></table></figure>
<p>If Aptitude (<code>apt</code>) is detected on the host in place of Yum, the second task is run instead. Which uses a similar process. The distro type and version number are sourced from the start in order to install the correct packages (like in the other task), whilst the package index is updated via <code>update_cache:</code>.  </p>
<p>As before the host is then rebooted via the handler (more on that now, as promised). </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">DEBIAN</span> <span class="string">| Install kernel updates</span><br><span class="line"></span><span class="attr">  apt:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">"<span class="template-variable">&#123;&#123; item &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">    state:</span> <span class="string">present</span></span><br><span class="line"><span class="attr">    update_cache:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">    cache_valid_time:</span> <span class="number">3600</span></span><br><span class="line"><span class="attr">  with_items:</span> <span class="string">"<span class="template-variable">&#123;&#123; packages[ansible_distribution ~ ansible_distribution_major_version] &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">ansible_pkg_mgr</span> <span class="string">==</span> <span class="string">'apt'</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">reboot</span> <span class="string">system</span></span><br></pre></td></tr></table></figure>
<p>If the variable <code>reboot_after_update</code> from the start is set to <code>yes</code> or true. The host(s) will reboot at the end of each task run, as the handler is called. </p>
<p>This is here as it’s necessary to reboot the system to begin using the new kernel changes brought in for the Spectre/Meltdown exploits. So you should set <code>reboot_after_update</code> to “yes” at the start of the file, as long as it’s safe to do so in terms of node availability and uptime. </p>
<p>Lastly <code>async:</code> allows the shutdown command to run for a maximum of <code>15</code> seconds, but also <code>poll:</code> tells Ansible to check constantly for its completion. This is all so Ansible moves on and doesn’t idle from the node’s system shutdown.  </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">handlers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">reboot</span> <span class="string">system</span></span><br><span class="line"><span class="attr">    shell:</span> <span class="string">sleep</span> <span class="number">3</span><span class="string">;</span> <span class="string">reboot</span></span><br><span class="line"><span class="attr">    async:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">    poll:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">reboot_after_update</span></span><br></pre></td></tr></table></figure>
<p>It might be better to download the repository itself but if you want the <code>meltdown-spectre-linux.yml</code> file I showed here (with all the kernel package versions added in) use this Gist instead:</p>
<script src="https://gist.github.com/5car1z/ddbb17cb763d5aedf129732213febac4.js"></script>

<blockquote>
<p><strong>Warning:</strong> Be aware that the “reboot” variable is set to yes in this Gist. </p>
</blockquote>
<p>Run the file against your desired host groups or host patterns as normal, adding a <code>-K</code> sudo password or <code>-u</code> user switch if relevant e.g. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook <span class="_">-l</span> webservers meltdown-spectre-linux.yml -K</span><br></pre></td></tr></table></figure>
<p>Then watch Ansible check and update the kernel packages on each host. Oh and <code>uname -r</code> reveals the kernel package in use by your current node. </p>
<p>Thanks to <a href="https://www.ansible.com/blog/author/sam-doran" target="_blank" rel="external">Sam Doran</a> for the plays and the Ansible repository this is taken from. </p>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Meltdown/" class="post__tag__link">Meltdown</a></li><li class="post__tag__item"><a href="/tags/Spectre/" class="post__tag__link">Spectre</a></li></ul><a href="/2018/02/03/spectre-meltdown-ansible/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2018-01-11T00:00:00.000Z" class="post__time">January 11, 2018</time><h1 class="post__title"><a href="/2018/01/11/kernel-update-for-meltdown-spectre/">Kernal Updates for Meltdown and Spectre CPU Exploits</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/TEnht2h.jpg" alt="Meltdown and Spectre Logos"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>As updating the target hosts system packages to their latest versions includes the kernel updates, this is in general the easiest way to bring in any <a href="https://meltdownattack.com/" target="_blank" rel="external">Meltdown and Spectre</a> fixes. A reboot is required after the updates for kernel changes to take effect. </p>
<p>Without configuration management or any automation tools it’s pretty simple.</p>
<a id="more"></a>
<hr>
<p>On Debian and Ubuntu:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get dist-upgrade</span><br><span class="line">$ sudo reboot</span><br></pre></td></tr></table></figure>
<p>On RPM based distros like Redhat and CentOS this would be:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum update</span><br><span class="line">$ sudo reboot</span><br></pre></td></tr></table></figure>
<p>On Fedora it’s <code>dnf</code> instead:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo dnf update</span><br><span class="line">$ sudo reboot</span><br></pre></td></tr></table></figure>
<hr>
<p>Further updates, more information, and perhaps even a targeted approach to circumventing these exploits could be available in the future. So keep up to date with both of the two issues as best as possible.</p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-protect-your-server-against-the-meltdown-and-spectre-vulnerabilities" target="_blank" rel="external">DigitalOcean - How To Protect Your Server Against the Meltdown and Spectre Vulnerabilities</a></li>
<li><a href="https://www.cyberciti.biz/faq/patch-meltdown-cpu-vulnerability-cve-2017-5754-linux/" target="_blank" rel="external">Nixcraft: How to patch Meltdown CPU Vulnerability CVE-2017-5754 on Linux</a></li>
<li><a href="https://www.cyberciti.biz/faq/patch-spectre-vulnerability-cve-2017-5753-cve-2017-5715-linux/" target="_blank" rel="external">Nixcraft: How to patch Spectre Vulnerability CVE-2017-5753/CVE-2017-5715 on Linux</a></li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Security/" class="post__tag__link">Security</a></li><li class="post__tag__item"><a href="/tags/Meltdown/" class="post__tag__link">Meltdown</a></li><li class="post__tag__item"><a href="/tags/Spectre/" class="post__tag__link">Spectre</a></li></ul><a href="/2018/01/11/kernel-update-for-meltdown-spectre/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2017-10-01T23:00:00.000Z" class="post__time">October 2, 2017</time><h1 class="post__title"><a href="/2017/10/02/ansible-local-playbooks/">Ansible - Local Playbook Execution</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/9HBs9cy.png" alt="Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>There are a several ways to run Ansible on a local system that I could find whilst searching the net. In this I’m covering three of the ones that were the most popular or the most prevalent. The first two seem great for their different contexts, and the third is not as necessary but worth considering perhaps.  </p>
<p>Being able to do this can be very useful for setting up your own machines or workstations (dotfiles anyone?) at least in the event that you don’t want to use traditional scripting. Also when creating playbooks that involve interacting with developer API’s this is an important component - see the “more information” section at the end, for a link to an example of this. </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Local-Play-Directives"><a href="#1-–-Local-Play-Directives" class="headerlink" title="1 – Local Play Directives"></a>1 – Local Play Directives</h1><p>This is the easiest way I found and probably most suited for when writing one or two individual playbooks. </p>
<p>Simply put, using both <code>127.0.0.1</code> for the <code>hosts:</code> directive and setting <code>connection:</code> to <code>local</code>  in a playbook ensures any tasks carried out are executed on your local machine. </p>
<p>This is an example playbook that prints “localhost” during execution to show local playback, then updates and upgrades Apt system packages; so it’s intended for Debian and or Ubuntu. </p>
<figure class="highlight bash"><figcaption><span>playbook.yml </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"></span><br><span class="line">- name: run the playbook tasks on the localhost</span><br><span class="line">  hosts: 127.0.0.1</span><br><span class="line">  connection: <span class="built_in">local</span></span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">  - name: <span class="built_in">print</span> out the hostname of target</span><br><span class="line">    <span class="built_in">command</span>: hostname</span><br><span class="line">  </span><br><span class="line">  - name: ensure aptitude is installed</span><br><span class="line">    <span class="built_in">command</span>: apt-get -y install aptitude</span><br><span class="line">  </span><br><span class="line">  - name: update the apt package index i.e. apt-get update</span><br><span class="line">    apt: update_cache=yes</span><br><span class="line"></span><br><span class="line">  - name: upgrade system packages i.e. apt-get upgrade</span><br><span class="line">    apt: upgrade=yes</span><br></pre></td></tr></table></figure>
<p>Run it as usual like any standard playbook - inclusive of  <code>-K</code> as it’ll need <code>sudo</code> privileges to complete. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -K playbook.yml</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="2-–-Repository-Config-and-Hosts-File"><a href="#2-–-Repository-Config-and-Hosts-File" class="headerlink" title="2 – Repository Config and Hosts File"></a>2 – Repository Config and Hosts File</h1><p>This second method works best in the context of a version control repository, which features multiple local playbook files and is intended to be passed around from person to person or host to host. It works by forcing Ansible to use a custom config file and in turn local hosts file.  </p>
<p>Here are the step you’d need to carry out in order to set this up in a Git repository, after setting up the repo itself. There’s also no commands for checking in, writing, and pushing files to the remote.</p>
<p>In the Git repository, create the custom <code>ansible.cfg</code> file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim ansible.cfg</span><br></pre></td></tr></table></figure>
<p>Add these contents to the file as they’re shown:</p>
<figure class="highlight bash"><figcaption><span>ansible.cfg</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">hostfile = hosts</span><br></pre></td></tr></table></figure>
<p>Save and exit the new file. </p>
<p>Then create another file, this time the custom <code>hosts</code> one.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim hosts</span><br></pre></td></tr></table></figure>
<p>The contents here consist of a group named <code>[local]</code> and a host entry listed as <code>localhost</code>. The host variable for local host <code>ansible_connection=local</code> as expected forces a local connection whenever it is targeted in a playbook. </p>
<figure class="highlight bash"><figcaption><span>hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">local</span>]</span><br><span class="line">localhost ansible_connection=<span class="built_in">local</span></span><br></pre></td></tr></table></figure>
<p>Again on a Debian/Ubuntu host you could use an adapted version of the earlier playbook as a test example, to ensure everything is working as intended. The difference here is the <code>localhost</code> value for <code>hosts:</code> and no requirement to mention the <code>connection: local</code> directive. </p>
<figure class="highlight bash"><figcaption><span>playbook.yml </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"></span><br><span class="line">- name: run the playbook tasks on the localhost</span><br><span class="line">  hosts: localhost</span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">  - name: <span class="built_in">print</span> out the hostname of target</span><br><span class="line">    <span class="built_in">command</span>: hostname</span><br><span class="line">  </span><br><span class="line">  - name: ensure aptitude is installed</span><br><span class="line">    <span class="built_in">command</span>: apt-get -y install aptitude</span><br><span class="line">  </span><br><span class="line">  - name: update the apt package index i.e. apt-get update</span><br><span class="line">    apt: update_cache=yes</span><br><span class="line"></span><br><span class="line">  - name: upgrade system packages i.e. apt-get upgrade</span><br><span class="line">    apt: upgrade=yes</span><br></pre></td></tr></table></figure>
<p>You’ll need to provide your <code>sudo</code> password with this again, to run the playbook.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -K playbook.yml</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="3-–-Global-Inventory-Hosts-Group"><a href="#3-–-Global-Inventory-Hosts-Group" class="headerlink" title="3 – Global Inventory Hosts Group"></a>3 – Global Inventory Hosts Group</h1><p>One further alternative solution (in a non version control scenario where there’s no need for portability) is to instead add the <code>[local]</code> host group to your global <code>/etc/ansible/hosts</code> file. </p>
<p>These would be the commands:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/ansible/hosts</span><br></pre></td></tr></table></figure>
<p>Append this new host group to the file. </p>
<figure class="highlight bash"><figcaption><span>/etc/ansible/hosts</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">local</span>]</span><br><span class="line">localhost ansible_connection=<span class="built_in">local</span></span><br></pre></td></tr></table></figure>
<p>Write your opening lines of playbooks with the <code>hosts: all</code> definition. Here’s the example from before, adapted to this:</p>
<figure class="highlight bash"><figcaption><span>playbook.yml </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"></span><br><span class="line">- name: run the playbook tasks on the localhost</span><br><span class="line">  hosts: all</span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">  - name: <span class="built_in">print</span> out the hostname of target</span><br><span class="line">    <span class="built_in">command</span>: hostname</span><br><span class="line">  </span><br><span class="line">  - name: ensure aptitude is installed</span><br><span class="line">    <span class="built_in">command</span>: apt-get -y install aptitude</span><br><span class="line">  </span><br><span class="line">  - name: update the apt package index i.e. apt-get update</span><br><span class="line">    apt: update_cache=yes</span><br><span class="line"></span><br><span class="line">  - name: upgrade system packages i.e. apt-get upgrade</span><br><span class="line">    apt: upgrade=yes</span><br></pre></td></tr></table></figure>
<p>Then afterwards when you want to run a playbook locally, use the <code>-l</code> switch and provide the <code>local</code> group or  <code>localhost</code> as the target host. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook -K <span class="_">-l</span> localhost playbook.yml</span><br></pre></td></tr></table></figure>
<p>It’s still wise and maybe more convenient to keep local playbook execution isolated to one directory or Git repository however (using the method in the former step). I would probably not recommend this method over the other two, but whatever works best for your particular needs I guess. </p>
<p>Thanks for reading, and I hope this has helped you out with local playbook execution in some way or another.  </p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://docs.ansible.com/ansible/latest/playbooks_delegation.html#local-playbooks" target="_blank" rel="external">Ansible Official Documentation - Local Playbooks</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-use-the-digitalocean-api-v2-with-ansible-2-0-on-ubuntu-14-04" target="_blank" rel="external">How To Use the DigitalOcean API v2 with Ansible 2.0 on Ubuntu 14.04</a></li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Python/" class="post__tag__link">Python</a></li><li class="post__tag__item"><a href="/tags/Debian/" class="post__tag__link">Debian</a></li><li class="post__tag__item"><a href="/tags/Ubuntu/" class="post__tag__link">Ubuntu</a></li></ul><a href="/2017/10/02/ansible-local-playbooks/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2017-08-20T23:00:00.000Z" class="post__time">August 21, 2017</time><h1 class="post__title"><a href="/2017/08/21/ansible-playbook-server-provisioning/">Ansible - Playbook Server Provisioning (5)</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/9HBs9cy.png" alt="Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>One of the many purposes of Ansible is to easily, quickly, and efficiently <em>provision</em> new server infrastructure. The use of configuration management tools in server provisioning can be quite essential, as it provides a very flexible solution in regards to deploying and managing new hosts. This post goes through a very simple example playbook that uses Ansible roles to break up and organise the provisioning process. If you haven’t used Ansible to setup a server before this is a good place to start. The idea can then be expanded upon to add more individual components or specific ideas. </p>
<p>The Playbook is intended for Linux hosts running Debian 8 (Jessie) and is tested using a suitable <a href="https://www.vagrantup.com/" target="_blank" rel="external">Vagrant VM</a>. After the testing, towards the end of the post, the playbook is then deployed to several newly created Debian 8 droplets on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a>. </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Playbook-Repository"><a href="#1-–-Playbook-Repository" class="headerlink" title="1 – Playbook Repository"></a>1 – Playbook Repository</h1><p>The entirety of this post was tested on a Xubuntu 16.04 VM using the below version of Ansible and Python:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible 2.3.1.0</span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  configured module search path = Default w/o overrides</span><br><span class="line">  python version = 2.7.12 (default, Nov 19 2016, 06:48:10) [GCC 5.4.0 20160609]</span><br></pre></td></tr></table></figure>
<p>The layout of the files for this playbook look like this: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">├── playbook.yml</span><br><span class="line">├── README.md</span><br><span class="line">├── roles</span><br><span class="line">│   ├── base</span><br><span class="line">│   │   ├── files</span><br><span class="line">│   │   │   └── motd</span><br><span class="line">│   │   ├── handlers</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── tasks</span><br><span class="line">│   │       └── main.yml</span><br><span class="line">│   ├── ntp</span><br><span class="line">│   │   ├── defaults</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── handlers</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── templates</span><br><span class="line">│   │       └── timezone</span><br><span class="line">│   ├── ufw</span><br><span class="line">│   │   ├── defaults</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── tasks</span><br><span class="line">│   │       └── main.yml</span><br><span class="line">│   └── users</span><br><span class="line">│       ├── defaults</span><br><span class="line">│       │   └── main.yml</span><br><span class="line">│       └── tasks</span><br><span class="line">│           └── main.yml</span><br><span class="line">└── vagrant</span><br><span class="line">    ├── group_vars</span><br><span class="line">    │   └── vagrant.yml</span><br><span class="line">    ├── inventory.yml</span><br><span class="line">    ├── README.md</span><br><span class="line">    └── Vagrantfile</span><br><span class="line"></span><br><span class="line">18 directories, 17 files</span><br></pre></td></tr></table></figure>
<p>All stored here on GitHub within this repository:</p>
<blockquote>
<p><a href="https://github.com/5car1z/ansible-debian-provisioning" target="_blank" rel="external">https://github.com/5car1z/ansible-debian-provisioning</a></p>
</blockquote>
<hr>
<h1 id="2-–-Main-Playbook-File"><a href="#2-–-Main-Playbook-File" class="headerlink" title="2 – Main Playbook File"></a>2 – Main Playbook File</h1><p>At the root level of the <a href="https://github.com/5car1z/ansible-debian-provisioning" target="_blank" rel="external">ansible-debian-provisioning</a> repo is the main <code>playbook.yml</code> file, which calls and runs the subsequent roles and their tasks. </p>
<figure class="highlight yaml"><figcaption><span>playbook.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">provision</span> <span class="string">debian</span> <span class="number">8</span> <span class="string">(jessie)</span> <span class="string">droplets</span> </span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">base</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">users</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ufw</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ntp</span></span><br></pre></td></tr></table></figure>
<p>There are several variables defined here in this core playbook file. </p>
<ul>
<li><code>hosts</code> - set to target <code>all</code> the hosts in the Ansible inventory file <code>/etc/ansible/hosts</code>. </li>
<li><code>gather_facts</code> - when the playbook is run, it will gather tasks about the operating system first before executing tasks. </li>
<li><code>roles</code> - here are the four role names to be included when running the Ansible playbook (listed in order of execution).  </li>
</ul>
<p>From here on the plays (tasks) inside each of the roles directories are processed by Ansible - once the user runs the playbook. </p>
<hr>
<h1 id="3-–-Roles-Base"><a href="#3-–-Roles-Base" class="headerlink" title="3 – Roles: Base"></a>3 – Roles: Base</h1><p>The “base” role puts in place some sensible server defaults/groundwork, and holds three directories containing their relevant Ansible configuration files: </p>
<ul>
<li><code>roles/base/files/motd</code></li>
<li><code>roles/base/handlers/main.yml</code></li>
<li><code>roles/base/tasks/main.yml</code></li>
</ul>
<p>The “files” directory contains an ASCII style message of the day (MOTD) file, that once in place is shown to user’s upon connecting to the server. This can be changed freely to whatever message is suitable by altering the <code>motd</code> file contents.  </p>
<figure class="highlight bash"><figcaption><span>roles/base/files/motd</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">*****************************************************************</span><br><span class="line">*           This server is configured by Ansible.               *</span><br><span class="line">*                                                               *</span><br><span class="line">*   See https://github.com/5car1z/ansible-debian-provisioning   *</span><br><span class="line">*****************************************************************</span><br></pre></td></tr></table></figure>
<p>The play (or tasks) for this role to be carried out by Ansible on each target host, are found in the “tasks” directory’s configuration file. In here there are multiple tasks that together form the play. The description for each task explains its individual purpose. </p>
<figure class="highlight yaml"><figcaption><span>roles/base/tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">install</span> <span class="string">some</span> <span class="string">commonly</span> <span class="string">used</span> <span class="string">packages</span></span><br><span class="line"><span class="attr">  apt:</span> <span class="string">pkg=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  with_items:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">htop</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">tmux</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">vim</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">unattended-upgrades</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">cowsay</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">set</span> <span class="string">the</span> <span class="string">server</span> <span class="string">message</span> <span class="string">of</span> <span class="string">the</span> <span class="string">day</span> <span class="string">explaining</span> <span class="string">ansible</span> <span class="string">was</span> <span class="string">the</span> <span class="string">configuration</span> <span class="string">management</span> <span class="string">tool</span></span><br><span class="line"><span class="attr">  copy:</span> <span class="string">src=motd</span></span><br><span class="line">        <span class="string">dest=/etc/motd</span></span><br><span class="line">        <span class="string">mode=644</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">disable</span> <span class="string">ssh</span> <span class="string">root</span> <span class="string">logins</span> <span class="string">without</span> <span class="string">the</span> <span class="string">use</span> <span class="string">of</span> <span class="string">a</span> <span class="string">valid</span> <span class="string">ssh</span> <span class="string">key</span></span><br><span class="line"><span class="attr">  lineinfile:</span> <span class="string">dest=/etc/ssh/sshd_config</span> <span class="string">state=present</span> <span class="string">regexp='^PermitRootLogin</span> <span class="string">' line='</span><span class="string">PermitRootLogin</span> <span class="string">without-password'</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">sshd</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">disable</span> <span class="string">ssh</span> <span class="string">password</span> <span class="string">logins</span> <span class="string">for</span> <span class="string">regular</span> <span class="string">users</span></span><br><span class="line"><span class="attr">  lineinfile:</span> <span class="string">dest=/etc/ssh/sshd_config</span> <span class="string">state=present</span> <span class="string">regexp='^PasswordAuthentication</span> <span class="string">' line='</span><span class="string">PasswordAuthentication</span> <span class="literal">no</span><span class="string">'</span><br><span class="line">  notify: restart sshd</span><br><span class="line"></span><br><span class="line">- name: enable unattended security updates option</span><br><span class="line">  debconf: name=unattended-upgrades</span><br><span class="line">           question='</span><span class="string">unattended-upgrades/enable_auto_updates'</span></span><br><span class="line">           <span class="string">value='true'</span></span><br><span class="line">           <span class="string">vtype='boolean'</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">reconfigure</span> <span class="string">unattended-upgrades</span></span><br></pre></td></tr></table></figure>
<p>This is where the bulk of changes are actually made to the target hosts when running the playbook. Each change is described roughly in the <em>name</em>  directives. </p>
<p>In this base role, several packages are to be installed, the message of the day is changed, SSH key usage is enforced and made mandatory, whilst automatic security updates are enabled. </p>
<p>Notice in the last code snippet the triggering of the two handlers when required via the usage of <code>notify:</code>. </p>
<p>Here’s how the handlers work.</p>
<p>The “handler” directory’s configuration file lists two handlers. The first handler for this role ensures the SSH system daemon is restarted. The second handler runs the <code>dpkg-reconfigure</code> command for the <code>unattended-upgrades</code> package. </p>
<figure class="highlight yaml"><figcaption><span>roles/base/handlers/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">restart</span> <span class="string">sshd</span></span><br><span class="line"><span class="attr">  service:</span> <span class="string">name=ssh</span> <span class="string">state=restarted</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">reconfigure</span> <span class="string">unattended-upgrades</span></span><br><span class="line"><span class="attr">  command:</span> <span class="string">dpkg-reconfigure</span> <span class="bullet">-f</span> <span class="string">noninteractive</span> <span class="string">unattended-upgrades</span></span><br></pre></td></tr></table></figure>
<p>These handlers are both triggered when appended to tasks found elsewhere in this role’s playbook files - like we saw earlier. </p>
<hr>
<h1 id="4-–-Roles-Users"><a href="#4-–-Roles-Users" class="headerlink" title="4 – Roles: Users"></a>4 – Roles: Users</h1><p>The “users” role houses two Ansible directories.</p>
<ul>
<li><code>roles/users/defaults/main.yml</code></li>
<li><code>roles/users/tasks/main.yml</code></li>
</ul>
<p>The <code>main.yml</code> file in the defaults directory contains credentials for the Linux user accounts to be generated on the target host(s). The YAML used here begins as a list of dictionaries. Each user and their associated credentials make up one entry in this initial list of dictionaries. The keys in every dictionary here contain the literal user values. </p>
<p>If you’re unsure on the YAML syntax and its usage, see Ansible’s explanations on <a href="https://docs.ansible.com/ansible/YAMLSyntax.html" target="_blank" rel="external">YAML in Ansible</a>.</p>
<figure class="highlight yaml"><figcaption><span>roles/users/defaults/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span><span class="bullet">--</span> </span><br><span class="line"><span class="attr">provisioned_users:</span> </span><br><span class="line">   </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">user-one</span></span><br><span class="line"><span class="attr">    encrypted_password:</span> <span class="string">$1$@YMgS-5Y$2lH.vkVmawJ810djjkGp70</span></span><br><span class="line"><span class="attr">    public_keys:</span> </span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="attr">    sudo:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    adm:</span> <span class="literal">true</span></span><br><span class="line">   </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">user-two</span> </span><br><span class="line"><span class="attr">    encrypted_password:</span> <span class="string">$1$@YMgS-5Y$2lH.vkVmawJ810djjkGp70</span></span><br><span class="line"><span class="attr">    public_keys:</span> </span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="attr">    sudo:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    adm:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">user-three</span></span><br><span class="line"><span class="attr">    encrypted_password:</span> <span class="string">$1$@YMgS-5Y$2lH.vkVmawJ810djjkGp70</span></span><br><span class="line"><span class="attr">    public_keys:</span> </span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="attr">    sudo:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    adm:</span> <span class="literal">false</span></span><br><span class="line">   </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">user-four</span></span><br><span class="line"><span class="attr">    encrypted_password:</span> <span class="string">$1$@YMgS-5Y$2lH.vkVmawJ810djjkGp70</span></span><br><span class="line"><span class="attr">    public_keys:</span> </span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="attr">    sudo:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    adm:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> It’s important to remember that the provided key values in the previous code snippet are mainly placeholders and imagined examples. They need replacing with real values.</p>
</blockquote>
<p>The first key in the user dictionary is <code>name:</code> and defines the Linux account username.</p>
<p>The second is <code>encrypted_password:</code> which must be set to a <em>hashed</em> value and should not be plain-text. Later on in this section we’ll explain how to go about generating a hash for your own passwords. </p>
<p>The third is <code>public_keys:</code> which you’ll notice is plural. This is in case you want to add multiple SSH keys (from your localhost) to your remote new user account, to give multiple people/keys access when needed. Importantly here, a “nested” list is used to add these multiple entries when they’re required.</p>
<p>The next key <code>sudo:</code> is a Boolean and adds the user account to the <code>sudo</code> group when set to “true”.</p>
<p>The last key <code>adm:</code> is the same as the previous key. It’s also a Boolean and adds the user account to the <code>adm</code> or “admin` group when set to “true”.</p>
<p>Moving over to the second configuration file in the “tasks” directory, you can see the play/tasks that make use of the definitions in the previous file.</p>
<figure class="highlight yaml"><figcaption><span>roles/users/tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">add</span> <span class="string">provisioned</span> <span class="string">user</span> <span class="string">accounts</span> <span class="string">defined</span> <span class="string">in</span> <span class="string">defaults</span> <span class="string">config</span> </span><br><span class="line"><span class="attr">  user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item.name</span> <span class="string">&#125;&#125;</span> <span class="string">home=/home/&#123;&#123;</span> <span class="string">item.name</span> <span class="string">&#125;&#125;</span> <span class="string">shell=/bin/bash</span> <span class="string">state=present</span> <span class="string">password=&#123;&#123;</span> <span class="string">item.encrypted_password</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  with_items:</span> <span class="string">"<span class="template-variable">&#123;&#123; provisioned_users &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">add</span> <span class="string">public</span> <span class="string">keys</span> <span class="string">to</span> <span class="string">authorized</span> <span class="string">keys</span> <span class="string">files</span></span><br><span class="line"><span class="attr">  authorized_key:</span> <span class="string">user=&#123;&#123;</span> <span class="string">item[0].name</span> <span class="string">&#125;&#125;</span> <span class="string">key="&#123;&#123;</span> <span class="string">lookup('file',</span> <span class="string">item[1])</span> <span class="string">&#125;&#125;"</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  with_subelements:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"<span class="template-variable">&#123;&#123; provisioned_users &#125;&#125;</span>"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">public_keys</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">add</span> <span class="string">provisioned</span> <span class="string">users</span> <span class="string">to</span> <span class="string">sudo</span> <span class="string">group</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item.name</span> <span class="string">&#125;&#125;</span> <span class="string">groups=sudo</span> <span class="string">append=yes</span></span><br><span class="line"><span class="attr">  with_items:</span> <span class="string">"<span class="template-variable">&#123;&#123; provisioned_users &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">item.sudo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">add</span> <span class="string">provisioned</span> <span class="string">users</span> <span class="string">to</span> <span class="string">admin</span> <span class="string">group</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item.name</span> <span class="string">&#125;&#125;</span> <span class="string">groups=adm</span> <span class="string">append=yes</span></span><br><span class="line"><span class="attr">  with_items:</span> <span class="string">"<span class="template-variable">&#123;&#123; provisioned_users &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">item.adm</span></span><br></pre></td></tr></table></figure>
<p>The descriptions of the tasks explain how things work here. The modules used for this are the <a href="https://docs.ansible.com/ansible/latest/user_module.html" target="_blank" rel="external">user</a> and <a href="https://docs.ansible.com/ansible/latest/authorized_key_module.html" target="_blank" rel="external">authorized key</a> modules.  </p>
<hr>
<h3 id="Generating-Crypted-Passwords"><a href="#Generating-Crypted-Passwords" class="headerlink" title="Generating Crypted Passwords"></a>Generating Crypted Passwords</h3><p>When it comes to generating the hashes (crypted values) for your username key passwords, there are a several different methods on offer. </p>
<p>The first involves using <code>mkpasswd</code> a utility that is available on most Linux systems. If it’s not on your system look for it in your package manager’s index - which in Debian and Ubuntu comes bundled inside the <code>whois</code> package. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install whois</span><br></pre></td></tr></table></figure>
<p>Generating a hashed password is as simple as running:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkpasswd --method=sha-512</span><br></pre></td></tr></table></figure>
<p>A separate way of doing this is to use Python’s crypt module/library:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python -c <span class="string">'import crypt; print crypt.crypt("EnterPasswordHere", "SomeSalt")'</span></span><br></pre></td></tr></table></figure>
<p><code>Enter Password Here</code> is of course replaced by the plain-text password you want to use. Whilst <code>SomeSalt</code> needs to be replaced by a salt - a random string of characters. </p>
<p>You could use <code>pwgen</code> to generate salts, should you want to:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install pwgen</span><br><span class="line">$ pwgen</span><br></pre></td></tr></table></figure>
<p>A final alternative is via the <code>openssl</code> package.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl passwd -salt SomeSalt -1 EnterPasswordHere</span><br></pre></td></tr></table></figure>
<p>Pick one of the values from the output to use for your <code>encrypted_password:</code> keys. </p>
<hr>
<h1 id="5-–-Roles-UFW"><a href="#5-–-Roles-UFW" class="headerlink" title="5 – Roles: UFW"></a>5 – Roles: UFW</h1><p>The “UFW” role configures the firewall settings for servers. There are only two configuration files to be aware of. </p>
<ul>
<li><code>roles/ufw/defaults/main.yml</code></li>
<li><code>roles/ufw/tasks/main.yml</code></li>
</ul>
<p>The first config file in the “defaults” directory defines which custom firewall ports you wish to remain open and accessible to outside connections. They are defined in a list format that can be added to as necessary. </p>
<figure class="highlight yaml"><figcaption><span>roles/ufw/defaults/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">ufw_open_ports:</span> <span class="string">['80',</span> <span class="string">'43'</span><span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>Only two ports are set to open currently in this file - HTTP port <code>80</code> and HTTPS port <code>43</code>. </p>
<p>More tinkering with the firewall is carried out in the other config file, which resides in the “tasks” directory:</p>
<figure class="highlight yaml"><figcaption><span>roles/ufw/tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">install</span> <span class="string">ufw</span></span><br><span class="line"><span class="attr">  apt:</span> <span class="string">pkg=ufw</span> <span class="string">state=present</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">disable</span> <span class="string">and</span> <span class="string">reset</span> <span class="string">firewall</span></span><br><span class="line"><span class="attr">  ufw:</span> <span class="string">state=reset</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">open</span> <span class="string">firewall</span> <span class="string">for</span> <span class="string">ssh</span></span><br><span class="line"><span class="attr">  ufw:</span> <span class="string">rule=allow</span> <span class="string">name=OpenSSH</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">open</span> <span class="string">firewall</span> <span class="string">on</span> <span class="string">specific</span> <span class="string">ports</span></span><br><span class="line"><span class="attr">  ufw:</span> <span class="string">rule=allow</span> <span class="string">port=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  with_items:</span> <span class="string">"<span class="template-variable">&#123;&#123; ufw_open_ports &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">reload</span> <span class="string">and</span> <span class="string">enable</span> <span class="string">firewall</span></span><br><span class="line"><span class="attr">  ufw:</span> <span class="string">state=enabled</span> <span class="string">policy=deny</span></span><br></pre></td></tr></table></figure>
<p>As you can see above in the last code snippet, Ansible is instructed to install the UFW package, reset the firewall, open port <code>22</code> for SSH access, then reload and enable the firewall to make it active. Our previous ports defined in the other file are also opened.</p>
<p>It’s worth noting that all of this is done via the inbuilt <code>ufw:</code> Ansible module, and not at any point manually through the shell.</p>
<hr>
<h1 id="6-–-Roles-NTP"><a href="#6-–-Roles-NTP" class="headerlink" title="6 – Roles: NTP"></a>6 – Roles: NTP</h1><p>The NTP role handles timezone settings for target hosts and has four directories with configuration files inside of them:</p>
<ul>
<li><code>roles/ntp/defaults/main.yml</code></li>
<li><code>roles/ntp/handlers/main.yml</code></li>
<li><code>roles/ntp/tasks/main.yml</code></li>
<li><code>roles/ntp/templates/main.yml</code></li>
</ul>
<p>The “defaults” config file is where you set the timezone you wish to use for your server(s). Alter the <code>Europe/London</code> text to <a href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones" target="_blank" rel="external">your own choice</a> here.</p>
<figure class="highlight yaml"><figcaption><span>roles/ntp/defaults/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">timezone:</span> <span class="string">Europe/London</span></span><br><span class="line"><span class="attr">ntp_server:</span> <span class="number">0.</span><span class="string">debian.pool.ntp.org</span></span><br></pre></td></tr></table></figure>
<p>There is no requirement to change the <code>ntp_server:</code> definition and this can be left as it is written.</p>
<p>Two handlers are required (all set in the “handlers” file) to ensure the NTP config is running once setup/updated. They are triggered as normal in the other “tasks” section file. </p>
<figure class="highlight yaml"><figcaption><span>roles/ntp/handlers/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">reconfigure</span> <span class="string">tzdata</span></span><br><span class="line"><span class="attr">  command:</span> <span class="string">dpkg-reconfigure</span> <span class="bullet">-f</span> <span class="string">noninteractive</span> <span class="string">tzdata</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">restart</span> <span class="string">ntp</span></span><br><span class="line"><span class="attr">  service:</span> <span class="string">name=ntp</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>
<p>The NTP “tasks” carry out several actions. A template file containing the chosen timezone is copied into the remote hosts’s <code>/etc/timezone</code> directory, and given root user based permissions. The <code>tzdata</code> and <code>ntp</code> package is then downloaded and installed. The <code>ntp</code> service gets enabled as well as started using the <code>service:</code> module. Two lines in the <code>ntp.conf</code> are altered to match the OS type (Debian in this case), which has been set in the “defaults” <code>ntp_server:</code> directive. </p>
<figure class="highlight yaml"><figcaption><span>roles/ntp/tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">configure</span> <span class="string">timezone</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">timezone</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/timezone</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">reconfigure</span> <span class="string">tzdata</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">install</span> <span class="string">tzdata</span></span><br><span class="line"><span class="attr">  apt:</span> <span class="string">pkg=tzdata</span> <span class="string">state=installed</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">install</span> <span class="string">ntp</span></span><br><span class="line"><span class="attr">  apt:</span> <span class="string">pkg=ntp</span> <span class="string">state=installed</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">start</span> <span class="string">ntp</span></span><br><span class="line"><span class="attr">  service:</span> <span class="string">name=ntp</span> <span class="string">state=started</span> <span class="string">enabled=true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">set</span> <span class="string">ntp</span> <span class="string">server</span></span><br><span class="line"><span class="attr">  lineinfile:</span> <span class="string">dest=/etc/ntp.conf</span> <span class="string">state=present</span> <span class="string">regexp='^server</span> <span class="string">' line='</span><span class="string">server</span> <span class="string">&#123;&#123;</span> <span class="string">ntp_server</span> <span class="string">&#125;&#125;</span> <span class="string">iburst'</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">ntp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Note that there may be more than one 'server' line in this file (hence we</span></span><br><span class="line"><span class="comment"># cannot do this with just one regexp rule).</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">remove</span> <span class="string">all</span> <span class="string">other</span> <span class="string">ntp</span> <span class="string">servers</span></span><br><span class="line"><span class="attr">  lineinfile:</span> <span class="string">dest=/etc/ntp.conf</span> <span class="string">state=absent</span> <span class="string">regexp="^server\s+(?!&#123;&#123;</span> <span class="string">ntp_server</span> <span class="string">&#125;&#125;)"</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">ntp</span></span><br></pre></td></tr></table></figure>
<p>Like previously, note the use of the handlers to trigger the desired actions in this above NTP snippet. </p>
<p>Lastly in this section/role, you can see the very short one line template file. Which takes your timezone choice e.g. <code>timezone: Europe/London</code> from the defaults config file. </p>
<figure class="highlight yaml"><figcaption><span>roles/ntp/templates/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;</span> <span class="string">timezone</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>This is all the roles of the playbook covered, here’s one method of testing it before deploying and utilising it on real hosts. </p>
<hr>
<h1 id="7-–-Vagrant-Local-Testing"><a href="#7-–-Vagrant-Local-Testing" class="headerlink" title="7 – Vagrant Local Testing"></a>7 – Vagrant Local Testing</h1><p>You can run through the playbook in a test environment to ensure it works as intended, before applying it to real servers. A containerisation/virtualisation tool like Vagrant or Docker is great for this purpose. In my example testing I’m going with Vagrant, but Docker is probably a more modern choice and certainly worth pursing instead if preferred. Be aware that container’s are meant to be abstracted stripped down layers of a full OS image however, so may in fact not be better suited than a Vagrant VM.  </p>
<blockquote>
<p><a href="http://www.tricksofthetrades.net/2017/05/17/vagrant-started/">How to Install and Get Started with Vagrant in 2017</a></p>
</blockquote>
<p>If you haven’t already you’ll need to clone the GitHub repository to carry out the testing in this step:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/5car1z/ansible-debian-provisioning.git</span><br></pre></td></tr></table></figure>
<p>Once you have the repo cloned and Vagrant up and running on your local system, change into the <code>vagrant</code> directory to begin the testing. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> vagrant</span><br></pre></td></tr></table></figure>
<p>In this directory you’ll see several Vagrant files. The main file that does most of the work here is the <code>Vagrantfile</code>. </p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">├── README.md</span><br><span class="line">├── Vagrantfile</span><br><span class="line">├── group_vars</span><br><span class="line">│  └── vagrant.yml</span><br><span class="line">└── inventory.yml</span><br></pre></td></tr></table></figure>
<p>The only portion of the <code>Vagrantfile</code> file we’ll take a look at here is the “provision” code block, so open up the file with an editor and find it, or just read it here:</p>
<figure class="highlight bash"><figcaption><span>Vagrantfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Provision using our Ansible playbook.</span></span><br><span class="line">  config.vm.provision <span class="string">"ansible"</span> <span class="keyword">do</span> |ansible|</span><br><span class="line">    ansible.playbook = <span class="string">"../playbook.yml"</span></span><br><span class="line">    ansible.inventory_path = <span class="string">"inventory.yml"</span></span><br><span class="line">    ansible.host_key_checking = <span class="literal">false</span></span><br><span class="line">  end</span><br><span class="line">  </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>This piece of configuration sets up Ansible as the provisioning agent Vagrant should use when provisioning a Vagrant VM. It also identifies where the target playbook to make use of is stored, alongside which Ansible inventory file to use. <a href="https://www.ibm.com/support/knowledgecenter/en/SSLTBW_2.2.0/com.ibm.zos.v2r2.foto100/hostch.htm" target="_blank" rel="external">Host key checking</a> for SSH with Ansible is also disabled. All of this is in the context of the Vagrant test VM. </p>
<p>So the <em>provisioner</em> is the entity that works through some pre-set tasks using the VM instance provided by Vagrant. The most common provisioners are: Puppet, Chef and Ansible. Shell Scripting is also still a very prevalent option. </p>
<p>The rest of the <code>Vagrantfile</code> is important but not crucial to aware of, as it can be understood another time when learning how Vagrant itself works.</p>
<p>Exit this file and type in the next command to begin the testing process:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant up</span><br></pre></td></tr></table></figure>
<p>This downloads the <code>debian/jessie64</code> box (<a href="https://app.vagrantup.com/debian/boxes/jessie64" target="_blank" rel="external">seen here</a>) specified in the <code>Vagrantfile</code> and creates an instance of that box as a Vagrant virtual machine (to test the Ansible playbook on).  </p>
<blockquote>
<p><strong>Note: </strong> If your host is already a Linux VM (nested virtualisation) set your hypervisor network state to Bridged instead of NAT, to remove networking problems such as slow downloads, networking auth errors, proxy errors, etc inside of Vagrant boxes. </p>
</blockquote>
<p>As the Ansible provision settings are already in place within the <code>Vagrantfile</code>, there’s no need to tell Vagrant to use Ansible with the new VM for us. </p>
<p>So just watch as the output messages show the playbook execution progress, until the final display reads:</p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt; PLAY RECAP &gt;</span><br><span class="line"> ------------</span><br><span class="line">        \   ^__^</span><br><span class="line">         \  (oo)\_______</span><br><span class="line">            (__)\       )\/\</span><br><span class="line">                ||----w |</span><br><span class="line">                ||     ||</span><br><span class="line"></span><br><span class="line">default                    : ok=24   changed=16   unreachable=0    failed=0</span><br></pre></td></tr></table></figure>
<p>To further verify the changes have been made, or explore individual parts of the Vagrant test VM, SSH into it by typing:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant ssh</span><br></pre></td></tr></table></figure>
<p>Exit from the Vagrant VM as you would any other remote host e.g. <code>exit</code> or <code>CTRL</code> + <code>D</code></p>
<p>When you make changes to the playbook content and its actions in the future, to further test the changes you must re-run the playbook on the Vagrant VM. </p>
<p>To do this use this command: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant provision</span><br></pre></td></tr></table></figure>
<p>Manually running Ansible against Vagrant to achieve something like a a dry test run i.e.  <code>--check</code> or any other options you might want to incorporate, is possible too. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook --private-key=~/.vagrant.d/insecure_private_key -u vagrant -i inventory.yml --check ../playbook.yml</span><br></pre></td></tr></table></figure>
<p>To actually implement changes again, remove the <code>--check</code> flag or use the provision command as normal. </p>
<p>Finally here, let’s look at some housekeeping in terms of Vagrant usage.  </p>
<p>Update your Vagrant Debian box to the latest version from the maintainer with:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant box update debian/jessie64</span><br></pre></td></tr></table></figure>
<p>Destroy your test environment (Vagrant VM instance) using the next command, where <code>default</code> is the name of the environment.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant destroy ansible_server_provisioning</span><br></pre></td></tr></table></figure>
<p>ID’s for Vagrant virtual machines work instead of the environment name too. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant global-status</span><br></pre></td></tr></table></figure>
<p>Finally to remove your Vagrant Debian box download completely, and all of the different updated versions, run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant box remove debian/jessie64 --all</span><br></pre></td></tr></table></figure>
<p>Now onto the real thing!</p>
<hr>
<h1 id="8-–-Digital-Ocean-Droplet-s"><a href="#8-–-Digital-Ocean-Droplet-s" class="headerlink" title="8 – Digital Ocean Droplet(s)"></a>8 – Digital Ocean Droplet(s)</h1><p><a href="https://cloud.digitalocean.com/droplets/new?i=cda637&amp;size=512mb&amp;region=lon1&amp;distro=debian&amp;distroImage=debian-8-x64" target="_blank" rel="external">Create several new Debian droplets using the Digital Ocean control panel</a> - copying your Ansible SSH key across to the new droplets during creation.</p>
<blockquote>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-configure-ssh-key-based-authentication-on-a-linux-server" target="_blank" rel="external">How To Configure SSH Key-Based Authentication on a Linux Server</a></p>
</blockquote>
<p>Add the multiple new droplet IP addresses to your Ansible inventory file (default in <code>/etc/ansible/hosts</code>). </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/ansible/hosts</span><br></pre></td></tr></table></figure>
<p>Here’s a bare minimum example of the contents, for if you created three droplets in total. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[testing]</span><br><span class="line">ansible-test-1 ansible_host=your.droplet.ip.address </span><br><span class="line">ansible-test-2 ansible_host=your.droplet.ip.address </span><br><span class="line">ansible-test-3 ansible_host=your.droplet.ip.address</span><br></pre></td></tr></table></figure>
<p>Create this directory, and begin writing to a new file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir /etc/ansible/group_vars/</span><br><span class="line">$ sudo vim /etc/ansible/group_vars/testing</span><br></pre></td></tr></table></figure>
<p>Setup a group variable for the <code>testing</code> group, so they use the <code>root</code> user with Ansible’s SSH operations. </p>
<figure class="highlight bash"><figcaption><span>/etc/ansible/group_vars/testing</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">ansible_user=root</span><br></pre></td></tr></table></figure>
<p>In the root level of the repository, run our provisioning Ansible playbook at your <code>testing</code> group’s live Digital Ocean droplets.  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook <span class="_">-l</span> testing playbook.yml</span><br></pre></td></tr></table></figure>
<p>Watch the output once again to confirm the playbook’s success. </p>
<hr>
<p>That’s about it. You could check your droplet manually and take a look at what’s actually changed if you really like, but the earlier output from running the Ansible playbook is of course your verification, on what’s been carried out. </p>
<p><a href="http://www.tricksofthetrades.net/trades/">Links to subsequent Ansible posts can be found on the Trades page.</a></p>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://docs.ansible.com/ansible/latest/faq.html#how-do-i-generate-crypted-passwords-for-the-user-module" target="_blank" rel="external">How do I generate crypted passwords for the user module?</a></li>
<li><a href="https://stackoverflow.com/questions/19292899/creating-a-new-user-and-password-with-ansible" target="_blank" rel="external">Stack Overflow - Creating a new user and password with Ansible</a></li>
<li><a href="https://github.com/ansible/ansible-examples/blob/master/language_features/user_commands.yml" target="_blank" rel="external">GitHub Repository - ansible-examples/language_features/user_commands.yml</a></li>
<li><a href="https://ejosh.co/de/2015/05/ansible-for-server-provisioning/" target="_blank" rel="external">Ansible for Server Provisioning - Docker Involvement</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-use-ansible-roles-to-abstract-your-infrastructure-environment" target="_blank" rel="external">Digital Ocean - How to Use Ansible Roles to Abstract your Infrastructure Environment</a></li>
<li><a href="https://git.lumc.nl/humgen/server-provisioning/tree/debian-jessie" target="_blank" rel="external">GitLab Server - Human Genetics/Server Provisioning Repo (Old Version)</a></li>
<li><a href="https://git.lumc.nl/humgen-devops/ansible-role-base-server/tree/master" target="_blank" rel="external">GitLab Server - Human Genetics Devops / ansible-role-base-server (New Version)</a></li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Python/" class="post__tag__link">Python</a></li><li class="post__tag__item"><a href="/tags/Jessie/" class="post__tag__link">Jessie</a></li></ul><a href="/2017/08/21/ansible-playbook-server-provisioning/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2017-05-16T23:00:00.000Z" class="post__time">May 17, 2017</time><h1 class="post__title"><a href="/2017/05/17/vagrant-started/">How to Install and Get Started with Vagrant in 2017</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/mw4s7ic.png" alt="Vagrant Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>Despite its age and familiarity to most nowadays I couldn’t find a straight forward post on how to install and get started using Vagrant. So here’s my notes on doing so in blog post format. Be aware that this is well trodden ground and the Vagrant documentation on their website has a similar set of steps and content. The official site, if not this will get you where you need to be when it comes to getting started with Vagrant. </p>
<blockquote>
<p><a href="https://www.vagrantup.com/intro/getting-started/index.html" target="_blank" rel="external">Official Vagrant Website - Getting Started</a></p>
</blockquote>
<a id="more"></a>
<hr>
<h1 id="1-–-Install-VirtualBox"><a href="#1-–-Install-VirtualBox" class="headerlink" title="1 – Install VirtualBox"></a>1 – Install VirtualBox</h1><p>Our provider choice will be VirtualBox. The <em>provider</em> describes the software in charge of creating then managing the virtual machines comissioned by Vagrant. The two major providers are VirtualBox and VMware, VirtualBox is free and open source, whereas VMware is not. </p>
<p><a href="https://www.virtualbox.org/wiki/Linux_Downloads" target="_blank" rel="external">Find the correct installation procedure for your flavour of Linux here.</a></p>
<p>On Ubuntu you would add this line to the bottom of your <code>sources.list</code> file:</p>
<p><code>deb http://download.virtualbox.org/virtualbox/debian xenial contrib</code></p>
<p>Replacing <code>xenial</code> for your own distributions release codename. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/apt/sources.list</span><br></pre></td></tr></table></figure>
<p>You can find this codename if you don’t already know it by running this command; back on the prompt. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsb_release <span class="_">-a</span></span><br></pre></td></tr></table></figure>
<p>For Debian 8 (“Jessie”) and Ubuntu 16.04 (“Xenial”) or later distributions. Download and add the repositories PGP key. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-key add -</span><br></pre></td></tr></table></figure>
<p>Update the apt-get package database and install the <code>virtualbox</code> packages. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install virtualbox</span><br></pre></td></tr></table></figure>
<p>VirtualBox is now installed and ready to use. </p>
<hr>
<h1 id="2-–-Install-Vagrant"><a href="#2-–-Install-Vagrant" class="headerlink" title="2 – Install Vagrant"></a>2 – Install Vagrant</h1><p><a href="https://www.vagrantup.com/downloads.html" target="_blank" rel="external">Find the correct binary for your version of Linux, then download it with the URL and Wget.</a></p>
<p>Here’s the <code>wget</code> command and correct URL for downloading the latest version of Vagrant on Debian (at the time of writing this) - yours may differ. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://releases.hashicorp.com/vagrant/1.9.4/vagrant_1.9.4_x86_64.deb ~</span><br></pre></td></tr></table></figure>
<p>To then install the binary as a package on the system, use:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo dpkg -i vagrant_1.9.4_x86_64.deb</span><br></pre></td></tr></table></figure>
<p>You can remove the Vagrant <code>.deb</code> build file from your user’s home directory now, after it’s been installed. </p>
<hr>
<h2 id="3-–-Download-and-Use-a-Vagrant-Box"><a href="#3-–-Download-and-Use-a-Vagrant-Box" class="headerlink" title="3 – Download and Use a Vagrant Box"></a>3 – Download and Use a Vagrant Box</h2><p>Make a temporary test directory, and change into it, before continuing. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir ~/vagrant-test &amp;&amp; <span class="built_in">cd</span> vagrant-test</span><br></pre></td></tr></table></figure>
<p>To test the install, you can download and run a basic Vagrant box as a VM by running the next set of commands.</p>
<p>So we’re clear, here’s a good definition of a what a Vagrant “box” actually is: </p>
<blockquote>
<p>“A package containing a representation of a virtual machine running a specific operating system. To be more simple, it is a base image of any Operating System or Kernel. It may be for a specific Provider.”</p>
</blockquote>
<p>The box is the image, and from this image a virtual machine (VM) is created on the localhost. </p>
<p>The basic Vagrant configuration for this VM will be based in one file, the <code>Vagrantfile</code>. </p>
<p>This file is placed in the <code>~/vagrant-test</code> directory via:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant init ubuntu/xenial64</span><br></pre></td></tr></table></figure>
<p>There are a wide variety of different box types (various OS images) listed on <a href="https://atlas.hashicorp.com/boxes/search" target="_blank" rel="external">Hashi corp’s  Atlas index.</a></p>
<p>After issuing the next command Vagrant will start to download the box and attempt to create and run a VM through VirtualBox.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant up</span><br></pre></td></tr></table></figure>
<p>Here’s an example of what the progress output looks like for this:</p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">==&gt; default: Box <span class="string">'ubuntu/xenial64'</span> could not be found. Attempting to find and install...</span><br><span class="line">    default: Box Provider: virtualbox</span><br><span class="line">    default: Box Version: &gt;= 0</span><br><span class="line">==&gt; default: Loading metadata <span class="keyword">for</span> box <span class="string">'ubuntu/xenial64'</span></span><br><span class="line">    default: URL: https://atlas.hashicorp.com/ubuntu/xenial64</span><br><span class="line">==&gt; default: Adding box <span class="string">'ubuntu/xenial64'</span> (v2017.05.01) <span class="keyword">for</span> provider: virtualbox</span><br><span class="line">    default: Downloading: https://vagrantcloud.com/ogarcia/boxes/archlinux-x32/versions/2017.05.01/providers/virtualbox.box</span><br><span class="line">==&gt; default: Successfully added box <span class="string">'ubuntu/xenial64'</span> (v2017.05.01) <span class="keyword">for</span> <span class="string">'virtualbox'</span>!</span><br><span class="line">==&gt; default: Importing base box <span class="string">'ubuntu/xenial64'</span>...</span><br><span class="line">==&gt; default: Matching MAC address <span class="keyword">for</span> NAT networking...</span><br><span class="line">==&gt; default: Checking <span class="keyword">if</span> box <span class="string">'ubuntu/xenial64'</span> is up to date...</span><br><span class="line">==&gt; default: Setting the name of the VM: vagrant-testing_default_1494195673719_66642</span><br><span class="line">==&gt; default: Clearing any previously <span class="built_in">set</span> network interfaces...</span><br><span class="line">==&gt; default: Preparing network interfaces based on configuration...</span><br><span class="line">    default: Adapter 1: nat</span><br><span class="line">==&gt; default: Forwarding ports...</span><br><span class="line">    default: 22 (guest) =&gt; 2222 (host) (adapter 1)</span><br><span class="line">==&gt; default: Booting VM...</span><br><span class="line">==&gt; default: Waiting <span class="keyword">for</span> machine to boot. This may take a few minutes...</span><br><span class="line">    default: SSH address: 127.0.0.1:2222</span><br><span class="line">    default: SSH username: vagrant</span><br><span class="line">    default: SSH auth method: private key</span><br><span class="line">    default: </span><br><span class="line">    default: Vagrant insecure key detected. Vagrant will automatically replace</span><br><span class="line">    default: this with a newly generated keypair <span class="keyword">for</span> better security.</span><br><span class="line">    default: </span><br><span class="line">    default: Inserting generated public key within guest...</span><br><span class="line">    default: Removing insecure key from the guest <span class="keyword">if</span> it<span class="string">'s present...</span><br><span class="line">    default: Key inserted! Disconnecting and reconnecting using new SSH key...</span><br><span class="line">==&gt; default: Machine booted and ready!</span><br><span class="line">==&gt; default: Checking for guest additions in VM...</span><br><span class="line">    default: The guest additions on this VM do not match the installed version of</span><br><span class="line">    default: VirtualBox! In most cases this is fine, but in rare cases it can</span><br><span class="line">    default: prevent things such as shared folders from working properly. If you see</span><br><span class="line">    default: shared folder errors, please make sure the guest additions within the</span><br><span class="line">    default: virtual machine match the version of VirtualBox you have installed on</span><br><span class="line">    default: your host and reload your VM.</span><br><span class="line">    default: </span><br><span class="line">    default: Guest Additions Version: 5.1.22 r115126</span><br><span class="line">    default: VirtualBox Version: 5.0</span><br><span class="line">==&gt; default: Mounting shared folders...</span><br><span class="line">    default: /vagrant =&gt; /home/scarlz/vagrant-testing</span></span><br></pre></td></tr></table></figure>
<p>You can get an error message here relating to CPU architecture if you use a box that isn’t intended for your host’s operating system.</p>
<p>For example, the first image here requires a 64-bit host operating system, and then the second is for a 32-bit version. The “host” here refers to the machine you installed Vagrant on.</p>
<ul>
<li><a href="https://atlas.hashicorp.com/ubuntu/boxes/xenial64" target="_blank" rel="external">https://atlas.hashicorp.com/ubuntu/boxes/xenial64</a></li>
<li><a href="https://atlas.hashicorp.com/ubuntu/boxes/trusty32" target="_blank" rel="external">https://atlas.hashicorp.com/ubuntu/boxes/trusty32</a></li>
</ul>
<p>In my example we used the first box, a 64-bit system. </p>
<p>Also if you are running Vagrant itself in a virtual machine (using a hypervisor). Then you’ll need to ensure your hypervisor has “VT-x/AMD-V enabled”.</p>
<p>To enable this you’ll have to do something along the lines of:</p>
<ol>
<li>Power off the host virtual machine.</li>
<li>Edit the individual virtual machine’s settings.</li>
<li>Go to the CPU/processors section.</li>
<li>Enable “VT-x/AMD-V” /  “Virtualise Intel VR-x/EPT and AMD-V/RVI”</li>
<li>Then power on the virtual machine again.</li>
<li>Re-run <code>vagrant up</code> in your Vagrant testing directory.</li>
</ol>
<p>Here is what the setting looks like when using VMware Workstation as your hypervisor.</p>
<p><img src="https://i.gyazo.com/2f12d720498b753e09eb79f6f31117c9.png" alt="Vmware CPU Section Image"></p>
<hr>
<h1 id="4-–-Connect-to-a-Running-VM"><a href="#4-–-Connect-to-a-Running-VM" class="headerlink" title="4 – Connect to a Running VM"></a>4 – Connect to a Running VM</h1><p>Once a box is installed and configured to run in a VM (like in step 2), you connect to the VM through an SSH tunnel created by Vagrant. </p>
<p>To connect to the newly running VM with Vagrant use:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant ssh</span><br></pre></td></tr></table></figure>
<p>The prompt now shows you are connected to your new VM!</p>
<figure class="highlight bash"><figcaption><span>prompt example</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-xenial:~$</span><br></pre></td></tr></table></figure>
<p>Type <code>exit</code> or use <code>CTRL + D</code> to leave the VM’s command line and return to your host. </p>
<hr>
<h1 id="5-–-Vagrant-Sub-commands"><a href="#5-–-Vagrant-Sub-commands" class="headerlink" title="5 – Vagrant Sub-commands"></a>5 – Vagrant Sub-commands</h1><p>These are the commands you’ll find yourself using when working with Vagrant. They use subsets of subcommands - which may seem confusing at first glance. The first is <code>box</code> and has several susbets. Not all however have them.</p>
<h2 id="box"><a href="#box" class="headerlink" title="box"></a><a href="https://www.vagrantup.com/docs/cli/box.html" target="_blank" rel="external">box</a></h2><p>List all the boxes you currently have installed on the host. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant box list</span><br></pre></td></tr></table></figure>
<p>Remove an already existing box from Vagrant. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant box remove ubuntu/xenial64</span><br></pre></td></tr></table></figure>
<p>Check updates for all box images on your system. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant box update</span><br></pre></td></tr></table></figure>
<p>Many of these commands can have the box named appended to them. In order to single them out. </p>
<h2 id="destroy"><a href="#destroy" class="headerlink" title="destroy"></a><a href="https://www.vagrantup.com/docs/cli/destroy.html" target="_blank" rel="external">destroy</a></h2><p>The Vagrant documentation sums this command up pretty well:</p>
<blockquote>
<p>“This command stops the running machine Vagrant is managing and destroys all resources that were created during the machine creation process. After running this command, your computer should be left at a clean state, as if you never created the guest machine in the first place.”</p>
</blockquote>
<p>Use it to destroy your created virual machines e.g.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant destroy ubuntu/xenial64</span><br></pre></td></tr></table></figure>
<h2 id="halt"><a href="#halt" class="headerlink" title="halt"></a><a href="https://www.vagrantup.com/docs/cli/halt.html" target="_blank" rel="external">halt</a></h2><p>This command shuts down the running virtual machine Vagrant is currently managing; you can add a machine name/ID to target specific VM’s</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant halt</span><br></pre></td></tr></table></figure>
<h2 id="reload"><a href="#reload" class="headerlink" title="reload"></a><a href="https://www.vagrantup.com/docs/cli/reload.html" target="_blank" rel="external">reload</a></h2><p>This is the same as a <code>vagrant halt</code> but restarts the VM after halting - like with <code>vagrant up</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant reload</span><br></pre></td></tr></table></figure>
<h2 id="port"><a href="#port" class="headerlink" title="port"></a><a href="https://www.vagrantup.com/docs/cli/port.html" target="_blank" rel="external">port</a></h2><p>This allows you to list all the Vagrant guest ports that are mapped to the host ports. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant port</span><br></pre></td></tr></table></figure>
<h2 id="ssh-config"><a href="#ssh-config" class="headerlink" title="ssh_config"></a><a href="https://www.vagrantup.com/docs/cli/ssh_config.html" target="_blank" rel="external">ssh_config</a></h2><p>Useful for displaying the output of the Vagrant host side SSH configuration file. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant ssh-config</span><br></pre></td></tr></table></figure>
<p>Returns:</p>
<figure class="highlight bash"><figcaption><span>Example Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Host default</span><br><span class="line">  HostName 127.0.0.1</span><br><span class="line">  User ubuntu</span><br><span class="line">  Port 2222</span><br><span class="line">  UserKnownHostsFile /dev/null</span><br><span class="line">  StrictHostKeyChecking no</span><br><span class="line">  PasswordAuthentication no</span><br><span class="line">  IdentityFile /home/scarlz/vagrant-ubuntu-test/.vagrant/machines/default/virtualbox/private_key</span><br><span class="line">  IdentitiesOnly yes</span><br><span class="line">  LogLevel FATAL</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="6-–-Miscellaneous"><a href="#6-–-Miscellaneous" class="headerlink" title="6 – Miscellaneous"></a>6 – Miscellaneous</h2><p>Should there ever be any SSH connection issues to a VM. The connection log can be seen by appending <code>--debug</code> to the command. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant ssh --debug</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> This <code>--debug</code> flag can be added onto most Vagrant commands to see the internal operations being carried out. </p>
</blockquote>
<p>Checking the status of the current Vagrant virtual machine is possible by entering:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant status</span><br></pre></td></tr></table></figure>
<p>A global version also exists.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant global-status</span><br></pre></td></tr></table></figure>
<p>Adding the <code>--prune</code> flag updates the cache for this - thereby removing any old, dead entries from the output. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant global-status --prune</span><br></pre></td></tr></table></figure>
<p>Looking back to the <code>Vagrantfile</code> configuration. We can see that there are different options on offer to configure the resultant VM(s). </p>
<p>One to highlight is the VM name that is assigned to both the provider (VirtualBox) and internal Vagrant machine “name”. </p>
<p>This is the code to explicitly define it in both instances, if you ever want to:</p>
<figure class="highlight bash"><figcaption><span>Vagrantfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Vagrant.configure(VAGRANTFILE_API_VERSION) <span class="keyword">do</span> |config|</span><br><span class="line"></span><br><span class="line"> config.vm.define <span class="string">"ubuntu_test_vm"</span> <span class="keyword">do</span> |vmname|</span><br><span class="line"> end</span><br><span class="line">  </span><br><span class="line"> config.vm.provider :virtualbox <span class="keyword">do</span> |vb|</span><br><span class="line">     vb.name = <span class="string">"ubuntu_test_vm"</span></span><br><span class="line"> end</span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>Line 3 determines the <code>&quot;name&quot;</code> listed when issuing: <code>vagrant global-status</code></p>
<p>Whilst line 5/6 ensures VirtualBox names and displays the VM properly in its GUI. </p>
<p><img src="https://i.imgur.com/CrSEOo4.png" alt="VirtualBox Ubuntu VM Image"></p>
<p><a href="https://www.vagrantup.com/docs/vagrantfile/" target="_blank" rel="external">How the Vagrantfile works in terms of configuration is described in detail here.</a></p>
<hr>
<h2 id="7-–-Autocompletion"><a href="#7-–-Autocompletion" class="headerlink" title="7 – Autocompletion"></a>7 – Autocompletion</h2><p>A nice addition to Vagrant is shell auto completion (Bash shell) for when typing in the above commands.  An up to date (at the time of writing this) repo which provides this is located here: </p>
<blockquote>
<p><a href="https://github.com/brbsix/vagrant-bash-completion" target="_blank" rel="external">https://github.com/brbsix/vagrant-bash-completion</a></p>
</blockquote>
<p>This is a fork of <a href="https://github.com/kura/vagrant-bash-completion" target="_blank" rel="external">Kura’s old repo</a>; thanks go to him for maintaining this up until now. Here’s the provided “easiest” method of downloading this functionality to your Linux/Unix host system. </p>
<p><code>wget</code> the script file in the above repo. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget -q https://raw.github.com/brbsix/vagrant-bash-completion/master/vagrant-bash-completion/etc/bash_completion.d/vagrant</span><br></pre></td></tr></table></figure>
<p>Add the newly downloaded file to the system Bash completion directory - whilst modifying the file’s permissions. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo install -m 0644 vagrant /etc/bash_completion.d/</span><br></pre></td></tr></table></figure>
<p>Now either close and re-open your terminal, or <code>source</code> in the new <code>/etc/bash_completion.d/vagrant</code> bash completion file. To get the new auto-completion working. </p>
<hr>
<h1 id="8-–-Further-Reading"><a href="#8-–-Further-Reading" class="headerlink" title="8 – Further Reading"></a>8 – Further Reading</h1><p>Erika Heidi has recently revisited and updated her great in-depth book dedicated to Vagrant. For a full run down of Vagrant and how to add configuration management tools into the mix. I’d highly recommend this book. </p>
<p><img src="https://i.imgur.com/0kT5WIB.png" alt="Cookbook - Frontcover"></p>
<blockquote>
<p><a href="https://leanpub.com/vagrantcookbook" target="_blank" rel="external">https://leanpub.com/vagrantcookbook</a></p>
</blockquote>
<p>There’s an accompanying blog post from February 2017 that she’s put together on recent Vagrant usage and trends. It’s quite short and worth reading if you’re interested.</p>
<blockquote>
<p><a href="http://www.erikaheidi.com/blog/vagrant-usage-research-2017/" target="_blank" rel="external">http://www.erikaheidi.com/blog/vagrant-usage-research-2017/</a></p>
</blockquote>
<p>The infographic (which I’ll leave here) is the main takeaway from the post:</p>
<p><img src="http://www.erikaheidi.com/files/2017-02/vagrant-research-2017.png" alt="The State of Vagrant Infographic"></p>
<hr>
<p>Vagrant is a slightly ageing software in the sense that many prefer more recent tools like Docker. It does however still have its uses and is quite well adopted these days, so it’s more than worth understanding at least the basics.</p>
<p>Enjoy your time with Vagrant.  </p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://stackoverflow.com/questions/17175696/running-vagrant-inside-vmware-vm" target="_blank" rel="external">Stack Overflow - Running Vagrant Inside VMWare VM</a> – As mentioned in step 2. </li>
<li><a href="https://stackoverflow.com/questions/22922891/vagrant-ssh-authentication-failure" target="_blank" rel="external">Stack Overflow - Vagrant ssh authentication failure</a> – An issue that seems to occur with the official Vagrant Ubuntu images. </li>
<li><a href="https://stackoverflow.com/questions/17845637/how-to-change-vagrant-default-machine-name" target="_blank" rel="external">Stack Overflow - How to change Vagrant ‘default’ machine name?</a> – Complex but comprehensive thread for this. </li>
<li><a href="https://stackoverflow.com/questions/24440142/removing-list-of-vms-in-vagrant-cache" target="_blank" rel="external">Stack Overflow - Removing list of vms in vagrant cache</a> – For when the status output is not accurate/updating. </li>
<li><a href="https://github.com/mitchellh/vagrant/issues/5186" target="_blank" rel="external">“Warning: Authentication failure. Retrying…”</a> – A very detailed long-term GitHub thread detailing the aforementioned issue. </li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ubuntu/" class="post__tag__link">Ubuntu</a></li><li class="post__tag__item"><a href="/tags/Virtualisation/" class="post__tag__link">Virtualisation</a></li><li class="post__tag__item"><a href="/tags/Vagrant/" class="post__tag__link">Vagrant</a></li></ul><a href="/2017/05/17/vagrant-started/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2018 Scarlz</div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"></span></li><li class="page-menu__item"><a title="Next" href="/trades/Programming/page/2/" class="page-menu__link icon-arrow-right"></a></li></menu></footer><script>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src="//"+l+".disqus.com/"+k+".js",i.parentNode.insertBefore(j,i)})
(document,"script","totts","count");
</script></body></html>