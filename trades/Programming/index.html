<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" content="ToTT"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="alternative" href="atom.xml" title="Tricks of the Trades" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>Programming - Tricks of the Trades</title><link rel="stylesheet" href="/css/main.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--></head><body><header class="head"><h1 class="head-title u-fl"><a href="/">Tricks of the Trades</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a href="/" class="head-nav__link">Home</a></li><li class="head-nav__item"><a href="/archives" class="head-nav__link">Archives</a></li><li class="head-nav__item"><a href="/trades" class="head-nav__link">Trades</a></li><li class="head-nav__item"><a href="/work" class="head-nav__link">Work</a></li><li class="head-nav__item"><a href="/about" class="head-nav__link">About</a></li><li class="head-nav__item"><a href="/contact" class="head-nav__link">Contact</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time datetime="2017-08-20T23:00:00.000Z" class="post__time">August 21, 2017</time><h1 class="post__title"><a href="/2017/08/21/ansible-playbook-server-provisioning/">Ansible - Playbook Server Provisioning (5)</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/9HBs9cy.png" alt="Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>One of the many purposes of Ansible is to easily, quickly, and efficiently <em>provision</em> new server infrastructure. The use of configuration management tools in server provisioning can be quite essential, as it provides a very flexible solution in regards to deploying and managing new hosts. This post goes through a very simple example playbook that uses Ansible roles to break up and organise the provisioning process. If you haven’t used Ansible to setup a server before this is a good place to start. The idea can then be expanded upon to add more individual components or specific ideas. </p>
<p>The Playbook is intended for Linux hosts running Debian 8 (Jessie) and is tested using a suitable <a href="https://www.vagrantup.com/" target="_blank" rel="external">Vagrant VM</a>. After the testing, towards the end of the post, the playbook is then deployed to several newly created Debian 8 droplets on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a>. </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Playbook-Repository"><a href="#1-–-Playbook-Repository" class="headerlink" title="1 – Playbook Repository"></a>1 – Playbook Repository</h1><p>The entirety of this post was tested on a Xubuntu 16.04 VM using the below version of Ansible and Python:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible 2.3.1.0</span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  configured module search path = Default w/o overrides</span><br><span class="line">  python version = 2.7.12 (default, Nov 19 2016, 06:48:10) [GCC 5.4.0 20160609]</span><br></pre></td></tr></table></figure>
<p>The layout of the files for this playbook look like this: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">├── playbook.yml</span><br><span class="line">├── README.md</span><br><span class="line">├── roles</span><br><span class="line">│   ├── base</span><br><span class="line">│   │   ├── files</span><br><span class="line">│   │   │   └── motd</span><br><span class="line">│   │   ├── handlers</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── tasks</span><br><span class="line">│   │       └── main.yml</span><br><span class="line">│   ├── ntp</span><br><span class="line">│   │   ├── defaults</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── handlers</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── templates</span><br><span class="line">│   │       └── timezone</span><br><span class="line">│   ├── ufw</span><br><span class="line">│   │   ├── defaults</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── tasks</span><br><span class="line">│   │       └── main.yml</span><br><span class="line">│   └── users</span><br><span class="line">│       ├── defaults</span><br><span class="line">│       │   └── main.yml</span><br><span class="line">│       └── tasks</span><br><span class="line">│           └── main.yml</span><br><span class="line">└── vagrant</span><br><span class="line">    ├── group_vars</span><br><span class="line">    │   └── vagrant.yml</span><br><span class="line">    ├── inventory.yml</span><br><span class="line">    ├── README.md</span><br><span class="line">    └── Vagrantfile</span><br><span class="line"></span><br><span class="line">18 directories, 17 files</span><br></pre></td></tr></table></figure>
<p>All stored here on GitHub within this repository:</p>
<blockquote>
<p><a href="https://github.com/5car1z/ansible-debian-provisioning" target="_blank" rel="external">https://github.com/5car1z/ansible-debian-provisioning</a></p>
</blockquote>
<hr>
<h1 id="2-–-Main-Playbook-File"><a href="#2-–-Main-Playbook-File" class="headerlink" title="2 – Main Playbook File"></a>2 – Main Playbook File</h1><p>At the root level of the <a href="https://github.com/5car1z/ansible-debian-provisioning" target="_blank" rel="external">ansible-debian-provisioning</a> repo is the main <code>playbook.yml</code> file, which calls and runs the subsequent roles and their tasks. </p>
<figure class="highlight yaml"><figcaption><span>playbook.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">provision</span> <span class="string">debian</span> <span class="number">8</span> <span class="string">(jessie)</span> <span class="string">droplets</span> </span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">base</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">users</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ufw</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ntp</span></span><br></pre></td></tr></table></figure>
<p>There are several variables defined here in this core playbook file. </p>
<ul>
<li><code>hosts</code> - set to target <code>all</code> the hosts in the Ansible inventory file <code>/etc/ansible/hosts</code>. </li>
<li><code>gather_facts</code> - when the playbook is run, it will gather tasks about the operating system first before executing tasks. </li>
<li><code>roles</code> - here are the four role names to be included when running the Ansible playbook (listed in order of execution).  </li>
</ul>
<p>From here on the plays (tasks) inside each of the roles directories are processed by Ansible - once the user runs the playbook. </p>
<hr>
<h1 id="3-–-Roles-Base"><a href="#3-–-Roles-Base" class="headerlink" title="3 – Roles: Base"></a>3 – Roles: Base</h1><p>The “base” role puts in place some sensible server defaults/groundwork, and holds three directories containing their relevant Ansible configuration files: </p>
<ul>
<li><code>roles/base/files/motd</code></li>
<li><code>roles/base/handlers/main.yml</code></li>
<li><code>roles/base/tasks/main.yml</code></li>
</ul>
<p>The “files” directory contains an ASCII style message of the day (MOTD) file, that once in place is shown to user’s upon connecting to the server. This can be changed freely to whatever message is suitable by altering the <code>motd</code> file contents.  </p>
<figure class="highlight bash"><figcaption><span>roles/base/files/motd</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">*****************************************************************</span><br><span class="line">*           This server is configured by Ansible.               *</span><br><span class="line">*                                                               *</span><br><span class="line">*   See https://github.com/5car1z/ansible-debian-provisioning   *</span><br><span class="line">*****************************************************************</span><br></pre></td></tr></table></figure>
<p>The play (or tasks) for this role to be carried out by Ansible on each target host, are found in the “tasks” directory’s configuration file. In here there are multiple tasks that together form the play. The description for each task explains its individual purpose. </p>
<figure class="highlight yaml"><figcaption><span>roles/base/tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">install</span> <span class="string">some</span> <span class="string">commonly</span> <span class="string">used</span> <span class="string">packages</span></span><br><span class="line"><span class="attr">  apt:</span> <span class="string">pkg=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  with_items:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">fail2ban</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">git</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">htop</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">tmux</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">vim</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">unattended-upgrades</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">cowsay</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">set</span> <span class="string">the</span> <span class="string">server</span> <span class="string">message</span> <span class="string">of</span> <span class="string">the</span> <span class="string">day</span> <span class="string">explaining</span> <span class="string">ansible</span> <span class="string">was</span> <span class="string">the</span> <span class="string">configuration</span> <span class="string">management</span> <span class="string">tool</span></span><br><span class="line"><span class="attr">  copy:</span> <span class="string">src=motd</span></span><br><span class="line">        <span class="string">dest=/etc/motd</span></span><br><span class="line">        <span class="string">mode=644</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">disable</span> <span class="string">ssh</span> <span class="string">root</span> <span class="string">logins</span> <span class="string">without</span> <span class="string">the</span> <span class="string">use</span> <span class="string">of</span> <span class="string">a</span> <span class="string">valid</span> <span class="string">ssh</span> <span class="string">key</span></span><br><span class="line"><span class="attr">  lineinfile:</span> <span class="string">dest=/etc/ssh/sshd_config</span> <span class="string">state=present</span> <span class="string">regexp='^PermitRootLogin</span> <span class="string">' line='</span><span class="string">PermitRootLogin</span> <span class="string">without-password'</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">sshd</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">disable</span> <span class="string">ssh</span> <span class="string">password</span> <span class="string">logins</span> <span class="string">for</span> <span class="string">regular</span> <span class="string">users</span></span><br><span class="line"><span class="attr">  lineinfile:</span> <span class="string">dest=/etc/ssh/sshd_config</span> <span class="string">state=present</span> <span class="string">regexp='^PasswordAuthentication</span> <span class="string">' line='</span><span class="string">PasswordAuthentication</span> <span class="literal">no</span><span class="string">'</span><br><span class="line">  notify: restart sshd</span><br><span class="line"></span><br><span class="line">- name: enable unattended security updates option</span><br><span class="line">  debconf: name=unattended-upgrades</span><br><span class="line">           question='</span><span class="string">unattended-upgrades/enable_auto_updates'</span></span><br><span class="line">           <span class="string">value='true'</span></span><br><span class="line">           <span class="string">vtype='boolean'</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">reconfigure</span> <span class="string">unattended-upgrades</span></span><br></pre></td></tr></table></figure>
<p>This is where the bulk of changes are actually made to the target hosts when running the playbook. Each change is described roughly in the <em>name</em>  directives. </p>
<p>In this base role, several packages are to be installed, the message of the day is changed, SSH key usage is enforced and made mandatory, whilst automatic security updates are enabled. </p>
<p>Notice in the last code snippet the triggering of the two handlers when required via the usage of <code>notify:</code>. </p>
<p>Here’s how the handlers work.</p>
<p>The “handler” directory’s configuration file lists two handlers. The first handler for this role ensures the SSH system daemon is restarted. The second handler runs the <code>dpkg-reconfigure</code> command for the <code>unattended-upgrades</code> package. </p>
<figure class="highlight yaml"><figcaption><span>roles/base/handlers/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">restart</span> <span class="string">sshd</span></span><br><span class="line"><span class="attr">  service:</span> <span class="string">name=ssh</span> <span class="string">state=restarted</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">reconfigure</span> <span class="string">unattended-upgrades</span></span><br><span class="line"><span class="attr">  command:</span> <span class="string">dpkg-reconfigure</span> <span class="bullet">-f</span> <span class="string">noninteractive</span> <span class="string">unattended-upgrades</span></span><br></pre></td></tr></table></figure>
<p>These handlers are both triggered when appended to tasks found elsewhere in this role’s playbook files - like we saw earlier. </p>
<hr>
<h1 id="4-–-Roles-Users"><a href="#4-–-Roles-Users" class="headerlink" title="4 – Roles: Users"></a>4 – Roles: Users</h1><p>The “users” role houses two Ansible directories.</p>
<ul>
<li><code>roles/users/defaults/main.yml</code></li>
<li><code>roles/users/tasks/main.yml</code></li>
</ul>
<p>The <code>main.yml</code> file in the defaults directory contains credentials for the Linux user accounts to be generated on the target host(s). The YAML used here begins as a list of dictionaries. Each user and their associated credentials make up one entry in this initial list of dictionaries. The keys in every dictionary here contain the literal user values. </p>
<p>If you’re unsure on the YAML syntax and its usage, see Ansible’s explanations on <a href="https://docs.ansible.com/ansible/YAMLSyntax.html" target="_blank" rel="external">YAML in Ansible</a>.</p>
<figure class="highlight yaml"><figcaption><span>roles/users/defaults/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span><span class="bullet">--</span> </span><br><span class="line"><span class="attr">provisioned_users:</span> </span><br><span class="line">   </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">user-one</span></span><br><span class="line"><span class="attr">    encrypted_password:</span> <span class="string">$1$@YMgS-5Y$2lH.vkVmawJ810djjkGp70</span></span><br><span class="line"><span class="attr">    public_keys:</span> </span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="attr">    sudo:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    adm:</span> <span class="literal">true</span></span><br><span class="line">   </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">user-two</span> </span><br><span class="line"><span class="attr">    encrypted_password:</span> <span class="string">$1$@YMgS-5Y$2lH.vkVmawJ810djjkGp70</span></span><br><span class="line"><span class="attr">    public_keys:</span> </span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="attr">    sudo:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    adm:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">user-three</span></span><br><span class="line"><span class="attr">    encrypted_password:</span> <span class="string">$1$@YMgS-5Y$2lH.vkVmawJ810djjkGp70</span></span><br><span class="line"><span class="attr">    public_keys:</span> </span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="attr">    sudo:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    adm:</span> <span class="literal">false</span></span><br><span class="line">   </span><br><span class="line"><span class="attr">  - name:</span> <span class="string">user-four</span></span><br><span class="line"><span class="attr">    encrypted_password:</span> <span class="string">$1$@YMgS-5Y$2lH.vkVmawJ810djjkGp70</span></span><br><span class="line"><span class="attr">    public_keys:</span> </span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/home/$USER/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="attr">    sudo:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    adm:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> It’s important to remember that the provided key values in the previous code snippet are mainly placeholders and imagined examples. They need replacing with real values.</p>
</blockquote>
<p>The first key in the user dictionary is <code>name:</code> and defines the Linux account username.</p>
<p>The second is <code>encrypted_password:</code> which must be set to a <em>hashed</em> value and should not be plain-text. Later on in this section we’ll explain how to go about generating a hash for your own passwords. </p>
<p>The third is <code>public_keys:</code> which you’ll notice is plural. This is in case you want to add multiple SSH keys (from your localhost) to your remote new user account, to give multiple people/keys access when needed. Importantly here, a “nested” list is used to add these multiple entries when they’re required.</p>
<p>The next key <code>sudo:</code> is a Boolean and adds the user account to the <code>sudo</code> group when set to “true”.</p>
<p>The last key <code>adm:</code> is the same as the previous key. It’s also a Boolean and adds the user account to the <code>adm</code> or “admin` group when set to “true”.</p>
<p>Moving over to the second configuration file in the “tasks” directory, you can see the play/tasks that make use of the definitions in the previous file.</p>
<figure class="highlight yaml"><figcaption><span>roles/users/tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">add</span> <span class="string">provisioned</span> <span class="string">user</span> <span class="string">accounts</span> <span class="string">defined</span> <span class="string">in</span> <span class="string">defaults</span> <span class="string">config</span> </span><br><span class="line"><span class="attr">  user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item.name</span> <span class="string">&#125;&#125;</span> <span class="string">home=/home/&#123;&#123;</span> <span class="string">item.name</span> <span class="string">&#125;&#125;</span> <span class="string">shell=/bin/bash</span> <span class="string">state=present</span> <span class="string">password=&#123;&#123;</span> <span class="string">item.encrypted_password</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  with_items:</span> <span class="string">"<span class="template-variable">&#123;&#123; provisioned_users &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">add</span> <span class="string">public</span> <span class="string">keys</span> <span class="string">to</span> <span class="string">authorized</span> <span class="string">keys</span> <span class="string">files</span></span><br><span class="line"><span class="attr">  authorized_key:</span> <span class="string">user=&#123;&#123;</span> <span class="string">item[0].name</span> <span class="string">&#125;&#125;</span> <span class="string">key="&#123;&#123;</span> <span class="string">lookup('file',</span> <span class="string">item[1])</span> <span class="string">&#125;&#125;"</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  with_subelements:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"<span class="template-variable">&#123;&#123; provisioned_users &#125;&#125;</span>"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">public_keys</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">add</span> <span class="string">provisioned</span> <span class="string">users</span> <span class="string">to</span> <span class="string">sudo</span> <span class="string">group</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item.name</span> <span class="string">&#125;&#125;</span> <span class="string">groups=sudo</span> <span class="string">append=yes</span></span><br><span class="line"><span class="attr">  with_items:</span> <span class="string">"<span class="template-variable">&#123;&#123; provisioned_users &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">item.sudo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">add</span> <span class="string">provisioned</span> <span class="string">users</span> <span class="string">to</span> <span class="string">admin</span> <span class="string">group</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item.name</span> <span class="string">&#125;&#125;</span> <span class="string">groups=adm</span> <span class="string">append=yes</span></span><br><span class="line"><span class="attr">  with_items:</span> <span class="string">"<span class="template-variable">&#123;&#123; provisioned_users &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">  when:</span> <span class="string">item.adm</span></span><br></pre></td></tr></table></figure>
<p>The descriptions of the tasks explain how things work here. The modules used for this are the <a href="https://docs.ansible.com/ansible/latest/user_module.html" target="_blank" rel="external">user</a> and <a href="https://docs.ansible.com/ansible/latest/authorized_key_module.html" target="_blank" rel="external">authorized key</a> modules.  </p>
<hr>
<h3 id="Generating-Crypted-Passwords"><a href="#Generating-Crypted-Passwords" class="headerlink" title="Generating Crypted Passwords"></a>Generating Crypted Passwords</h3><p>When it comes to generating the hashes (crypted values) for your username key passwords, there are a several different methods on offer. </p>
<p>The first involves using <code>mkpasswd</code> a utility that is available on most Linux systems. If it’s not on your system look for it in your package manager’s index - which in Debian and Ubuntu comes bundled inside the <code>whois</code> package. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install whois</span><br></pre></td></tr></table></figure>
<p>Generating a hashed password is as simple as running:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkpasswd --method=sha-512</span><br></pre></td></tr></table></figure>
<p>A separate way of doing this is to use Python’s crypt module/library:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python -c <span class="string">'import crypt; print crypt.crypt("Enter Password Here", "$1$eixaeMai$")'</span></span><br></pre></td></tr></table></figure>
<p><code>Enter Password Here</code> is of course replaced by the plain-text password you want to use. Whilst <code>SomeSalt</code> needs to be replaced by a salt; a random string of characters. </p>
<p>You could use <code>pwgen</code> to generate salts, should you want to:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install pwgen</span><br><span class="line">$ pwgen</span><br></pre></td></tr></table></figure>
<p>Pick one of the values from the output to use for your <code>encrypted_password:</code> keys. </p>
<hr>
<h1 id="5-–-Roles-UFW"><a href="#5-–-Roles-UFW" class="headerlink" title="5 – Roles: UFW"></a>5 – Roles: UFW</h1><p>The “UFW” role configures the firewall settings for servers. There are only two configuration files to be aware of. </p>
<ul>
<li><code>roles/ufw/defaults/main.yml</code></li>
<li><code>roles/ufw/tasks/main.yml</code></li>
</ul>
<p>The first config file in the “defaults” directory defines which custom firewall ports you wish to remain open and accessible to outside connections. They are defined in a list format that can be added to as necessary. </p>
<figure class="highlight yaml"><figcaption><span>roles/ufw/defaults/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">ufw_open_ports:</span> <span class="string">['80',</span> <span class="string">'43'</span><span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>Only two ports are set to open currently in this file - HTTP port <code>80</code> and HTTPS port <code>43</code>. </p>
<p>More tinkering with the firewall is carried out in the other config file, which resides in the “tasks” directory:</p>
<figure class="highlight yaml"><figcaption><span>roles/ufw/tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">install</span> <span class="string">ufw</span></span><br><span class="line"><span class="attr">  apt:</span> <span class="string">pkg=ufw</span> <span class="string">state=present</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">disable</span> <span class="string">and</span> <span class="string">reset</span> <span class="string">firewall</span></span><br><span class="line"><span class="attr">  ufw:</span> <span class="string">state=reset</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">open</span> <span class="string">firewall</span> <span class="string">for</span> <span class="string">ssh</span></span><br><span class="line"><span class="attr">  ufw:</span> <span class="string">rule=allow</span> <span class="string">name=OpenSSH</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">open</span> <span class="string">firewall</span> <span class="string">on</span> <span class="string">specific</span> <span class="string">ports</span></span><br><span class="line"><span class="attr">  ufw:</span> <span class="string">rule=allow</span> <span class="string">port=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  with_items:</span> <span class="string">"<span class="template-variable">&#123;&#123; ufw_open_ports &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">reload</span> <span class="string">and</span> <span class="string">enable</span> <span class="string">firewall</span></span><br><span class="line"><span class="attr">  ufw:</span> <span class="string">state=enabled</span> <span class="string">policy=deny</span></span><br></pre></td></tr></table></figure>
<p>As you can see above in the last code snippet, Ansible is instructed to install the UFW package, reset the firewall, open port <code>22</code> for SSH access, then reload and enable the firewall to make it active. Our previous ports defined in the other file are also opened.</p>
<p>It’s worth noting that all of this is done via the inbuilt <code>ufw:</code> Ansible module, and not at any point manually through the shell.</p>
<hr>
<h1 id="6-–-Roles-NTP"><a href="#6-–-Roles-NTP" class="headerlink" title="6 – Roles: NTP"></a>6 – Roles: NTP</h1><p>The NTP role handles timezone settings for target hosts and has four directories with configuration files inside of them:</p>
<ul>
<li><code>roles/ntp/defaults/main.yml</code></li>
<li><code>roles/ntp/handlers/main.yml</code></li>
<li><code>roles/ntp/tasks/main.yml</code></li>
<li><code>roles/ntp/templates/main.yml</code></li>
</ul>
<p>The “defaults” config file is where you set the timezone you wish to use for your server(s). Alter the <code>Europe/London</code> text to <a href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones" target="_blank" rel="external">your own choice</a> here.</p>
<figure class="highlight yaml"><figcaption><span>roles/ntp/defaults/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">timezone:</span> <span class="string">Europe/London</span></span><br><span class="line"><span class="attr">ntp_server:</span> <span class="number">0.</span><span class="string">debian.pool.ntp.org</span></span><br></pre></td></tr></table></figure>
<p>There is no requirement to change the <code>ntp_server:</code> definition and this can be left as it is written.</p>
<p>Two handlers are required (all set in the “handlers” file) to ensure the NTP config is running once setup/updated. They are triggered as normal in the other “tasks” section file. </p>
<figure class="highlight yaml"><figcaption><span>roles/ntp/handlers/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">reconfigure</span> <span class="string">tzdata</span></span><br><span class="line"><span class="attr">  command:</span> <span class="string">dpkg-reconfigure</span> <span class="bullet">-f</span> <span class="string">noninteractive</span> <span class="string">tzdata</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">restart</span> <span class="string">ntp</span></span><br><span class="line"><span class="attr">  service:</span> <span class="string">name=ntp</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>
<p>The NTP “tasks” carry out several actions. A template file containing the chosen timezone is copied into the remote hosts’s <code>/etc/timezone</code> directory, and given root user based permissions. The <code>tzdata</code> and <code>ntp</code> package is then downloaded and installed. The <code>ntp</code> service gets enabled as well as started using the <code>service:</code> module. Two lines in the <code>ntp.conf</code> are altered to match the OS type (Debian in this case), which has been set in the “defaults” <code>ntp_server:</code> directive. </p>
<figure class="highlight yaml"><figcaption><span>roles/ntp/tasks/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">configure</span> <span class="string">timezone</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    src:</span> <span class="string">timezone</span></span><br><span class="line"><span class="attr">    dest:</span> <span class="string">/etc/timezone</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">reconfigure</span> <span class="string">tzdata</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">install</span> <span class="string">tzdata</span></span><br><span class="line"><span class="attr">  apt:</span> <span class="string">pkg=tzdata</span> <span class="string">state=installed</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">install</span> <span class="string">ntp</span></span><br><span class="line"><span class="attr">  apt:</span> <span class="string">pkg=ntp</span> <span class="string">state=installed</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">start</span> <span class="string">ntp</span></span><br><span class="line"><span class="attr">  service:</span> <span class="string">name=ntp</span> <span class="string">state=started</span> <span class="string">enabled=true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- name:</span> <span class="string">set</span> <span class="string">ntp</span> <span class="string">server</span></span><br><span class="line"><span class="attr">  lineinfile:</span> <span class="string">dest=/etc/ntp.conf</span> <span class="string">state=present</span> <span class="string">regexp='^server</span> <span class="string">' line='</span><span class="string">server</span> <span class="string">&#123;&#123;</span> <span class="string">ntp_server</span> <span class="string">&#125;&#125;</span> <span class="string">iburst'</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">ntp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Note that there may be more than one 'server' line in this file (hence we</span></span><br><span class="line"><span class="comment"># cannot do this with just one regexp rule).</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">remove</span> <span class="string">all</span> <span class="string">other</span> <span class="string">ntp</span> <span class="string">servers</span></span><br><span class="line"><span class="attr">  lineinfile:</span> <span class="string">dest=/etc/ntp.conf</span> <span class="string">state=absent</span> <span class="string">regexp="^server\s+(?!&#123;&#123;</span> <span class="string">ntp_server</span> <span class="string">&#125;&#125;)"</span></span><br><span class="line"><span class="attr">  notify:</span> <span class="string">restart</span> <span class="string">ntp</span></span><br></pre></td></tr></table></figure>
<p>Like previously, note the use of the handlers to trigger the desired actions in this above NTP snippet. </p>
<p>Lastly in this section/role, you can see the very short one line template file. Which takes your timezone choice e.g. <code>timezone: Europe/London</code> from the defaults config file. </p>
<figure class="highlight yaml"><figcaption><span>roles/ntp/templates/main.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#123;&#123;</span> <span class="string">timezone</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>This is all the roles of the playbook covered, here’s one method of testing it before deploying and utilising it on real hosts. </p>
<hr>
<h1 id="7-–-Vagrant-Local-Testing"><a href="#7-–-Vagrant-Local-Testing" class="headerlink" title="7 – Vagrant Local Testing"></a>7 – Vagrant Local Testing</h1><p>You can run through the playbook in a test environment to ensure it works as intended, before applying it to real servers. A containerisation/virtualisation tool like Vagrant or Docker is great for this purpose. In my example testing I’m going with Vagrant, but Docker is probably a more modern choice and certainly worth pursing instead if preferred. Be aware that container’s are meant to be abstracted stripped down layers of a full OS image however, so may in fact not be better suited than a Vagrant VM.  </p>
<blockquote>
<p><a href="[http://www.tricksofthetrades.net/2017/05/17/vagrant-started/">How to Install and Get Started with Vagrant in 2017</a></p>
</blockquote>
<p>If you haven’t already you’ll need to clone the GitHub repository to carry out the testing in this step:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/5car1z/ansible-debian-provisioning.git</span><br></pre></td></tr></table></figure>
<p>Once you have the repo cloned and Vagrant up and running on your local system, change into the <code>vagrant</code> directory to begin the testing. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> vagrant</span><br></pre></td></tr></table></figure>
<p>In this directory you’ll see several Vagrant files. The main file that does most of the work here is the <code>Vagrantfile</code>. </p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">├── README.md</span><br><span class="line">├── Vagrantfile</span><br><span class="line">├── group_vars</span><br><span class="line">│  └── vagrant.yml</span><br><span class="line">└── inventory.yml</span><br></pre></td></tr></table></figure>
<p>The only portion of the <code>Vagrantfile</code> file we’ll take a look at here is the “provision” code block, so open up the file with an editor and find it, or just read it here:</p>
<figure class="highlight bash"><figcaption><span>Vagrantfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Provision using our Ansible playbook.</span></span><br><span class="line">  config.vm.provision <span class="string">"ansible"</span> <span class="keyword">do</span> |ansible|</span><br><span class="line">    ansible.playbook = <span class="string">"../playbook.yml"</span></span><br><span class="line">    ansible.inventory_path = <span class="string">"inventory.yml"</span></span><br><span class="line">    ansible.host_key_checking = <span class="literal">false</span></span><br><span class="line">  end</span><br><span class="line">  </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>This piece of configuration sets up Ansible as the provisioning agent Vagrant should use when provisioning a Vagrant VM. It also identifies where the target playbook to make use of is stored, alongside which Ansible inventory file to use.  <a href="https://www.ibm.com/support/knowledgecenter/en/SSLTBW_2.2.0/com.ibm.zos.v2r2.foto100/hostch.htm" target="_blank" rel="external">Host key checking</a> for SSH with Ansible is also disabled. All of this is in the context of the Vagrant test VM. </p>
<p>The rest of the file is important but not crucial to aware of, as it can be understood another time when learning how Vagrant itself works.</p>
<p>Exit this file and type in the next command to begin the testing process:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant up</span><br></pre></td></tr></table></figure>
<p>This downloads the <code>debian/jessie64</code> box (<a href="https://app.vagrantup.com/debian/boxes/jessie64" target="_blank" rel="external">seen here</a>) specified in the <code>Vagrantfile</code> and creates an instance of that box as a Vagrant virtual machine (to test the Ansible playbook on).  </p>
<blockquote>
<p><strong>Note: </strong> If your host is already a Linux VM (nested virtualisation) set your hypervisor network state to Bridged instead of NAT, to remove networking problems such as slow downloads, networking auth errors, proxy errors, etc inside of Vagrant boxes. </p>
</blockquote>
<p>As the Ansible provision settings are already in place within the <code>Vagrantfile</code>, there’s no need to tell Vagrant to use Ansible with the new VM for us. </p>
<p>So just watch as the output messages show the playbook execution progress, until the final display reads:</p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt; PLAY RECAP &gt;</span><br><span class="line"> ------------</span><br><span class="line">        \   ^__^</span><br><span class="line">         \  (oo)\_______</span><br><span class="line">            (__)\       )\/\</span><br><span class="line">                ||----w |</span><br><span class="line">                ||     ||</span><br><span class="line"></span><br><span class="line">default                    : ok=24   changed=16   unreachable=0    failed=0</span><br></pre></td></tr></table></figure>
<p>To further verify the changes have been made, or explore individual parts of the Vagrant test VM, SSH into it by typing:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant ssh</span><br></pre></td></tr></table></figure>
<p>Exit from the Vagrant VM as you would any other remote host e.g. <code>exit</code> or <code>CTRL</code> + <code>D</code></p>
<p>When you make changes to the playbook content and its actions in the future, to further test the changes you must re-run the playbook on the Vagrant VM. </p>
<p>To do this use this command: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant provision</span><br></pre></td></tr></table></figure>
<p>Manually running Ansible against Vagrant to achieve something like a a dry test run i.e.  <code>--check</code> or any other options you might want to incorporate, is possible too. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook --private-key=~/.vagrant.d/insecure_private_key -u vagrant -i inventory.yml --check ../playbook.yml</span><br></pre></td></tr></table></figure>
<p>To actually implement changes again, remove the <code>--check</code> flag or use the provision command as normal. </p>
<p>Finally here, let’s look at some housekeeping in terms of Vagrant usage.  </p>
<p>Update your Vagrant Debian box to the latest version from the maintainer with:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant box update debian/jessie64</span><br></pre></td></tr></table></figure>
<p>Destroy your test environment (Vagrant VM instance) using the next command, where <code>default</code> is the name of the environment.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant destroy ansible_server_provisioning</span><br></pre></td></tr></table></figure>
<p>ID’s for Vagrant virtual machines work instead of the environment name too. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant global-status</span><br></pre></td></tr></table></figure>
<p>Finally to remove your Vagrant Debian box download completely, and all of the different updated versions, run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant box remove debian/jessie64 --all</span><br></pre></td></tr></table></figure>
<p>Now onto the real thing!</p>
<hr>
<h1 id="8-–-Digital-Ocean-Droplet-s"><a href="#8-–-Digital-Ocean-Droplet-s" class="headerlink" title="8 – Digital Ocean Droplet(s)"></a>8 – Digital Ocean Droplet(s)</h1><p><a href="https://cloud.digitalocean.com/droplets/new?i=cda637&amp;size=512mb&amp;region=lon1&amp;distro=debian&amp;distroImage=debian-8-x64" target="_blank" rel="external">Create several new Debian droplets using the Digital Ocean control panel</a> - copying your Ansible SSH key across to the new droplets during creation.</p>
<blockquote>
<p><a href="https://www.digitalocean.com/community/tutorials/how-to-configure-ssh-key-based-authentication-on-a-linux-server" target="_blank" rel="external">How To Configure SSH Key-Based Authentication on a Linux Server</a></p>
</blockquote>
<p>Add the multiple new droplet IP addresses to your Ansible inventory file (default in <code>/etc/ansible/hosts</code>). </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/ansible/hosts</span><br></pre></td></tr></table></figure>
<p>Here’s a bare minimum example of the contents, for if you created three droplets in total. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[testing]</span><br><span class="line">ansible-test-1 ansible_host=your.droplet.ip.address </span><br><span class="line">ansible-test-2 ansible_host=your.droplet.ip.address </span><br><span class="line">ansible-test-3 ansible_host=your.droplet.ip.address</span><br></pre></td></tr></table></figure>
<p>Create this directory, and begin writing to a new file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir /etc/ansible/group_vars/</span><br><span class="line">$ sudo vim /etc/ansible/group_vars/testing</span><br></pre></td></tr></table></figure>
<p>Setup a group variable for the <code>testing</code> group, so they use the <code>root</code> user with Ansible’s SSH operations. </p>
<figure class="highlight bash"><figcaption><span>/etc/ansible/group_vars/testing</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">ansible_user=root</span><br></pre></td></tr></table></figure>
<p>In the root level of the repository, run our provisioning Ansible playbook at your <code>testing</code> group’s live Digital Ocean droplets.  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook <span class="_">-l</span> testing playbook.yml</span><br></pre></td></tr></table></figure>
<p>Watch the output once again to confirm the playbook’s success. </p>
<hr>
<p>That’s about it. You could check your droplet manually and take a look at what’s actually changed if you really like, but the earlier output from running the Ansible playbook is of course your verification, on what’s been carried out. </p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://docs.ansible.com/ansible/latest/faq.html#how-do-i-generate-crypted-passwords-for-the-user-module" target="_blank" rel="external">How do I generate crypted passwords for the user module?</a></li>
<li><a href="https://stackoverflow.com/questions/19292899/creating-a-new-user-and-password-with-ansible" target="_blank" rel="external">Stack Overflow - Creating a new user and password with Ansible</a></li>
<li><a href="https://github.com/ansible/ansible-examples/blob/master/language_features/user_commands.yml" target="_blank" rel="external">GitHub Repository - ansible-examples/language_features/user_commands.yml</a></li>
<li><a href="https://ejosh.co/de/2015/05/ansible-for-server-provisioning/" target="_blank" rel="external">Ansible for Server Provisioning - Docker Involvement</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-use-ansible-roles-to-abstract-your-infrastructure-environment" target="_blank" rel="external">Digital Ocean - How to Use Ansible Roles to Abstract your Infrastructure Environment</a></li>
<li><a href="https://git.lumc.nl/humgen/server-provisioning/tree/debian-jessie" target="_blank" rel="external">GitLab Server - Human Genetics/Server Provisioning Repo (Old Version)</a></li>
<li><a href="https://git.lumc.nl/humgen-devops/ansible-role-base-server/tree/master" target="_blank" rel="external">GitLab Server - Human Genetics Devops / ansible-role-base-server (New Version)</a></li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Python/" class="post__tag__link">Python</a></li><li class="post__tag__item"><a href="/tags/Jessie/" class="post__tag__link">Jessie</a></li></ul><a href="/2017/08/21/ansible-playbook-server-provisioning/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2017-05-16T23:00:00.000Z" class="post__time">May 17, 2017</time><h1 class="post__title"><a href="/2017/05/17/vagrant-started/">How to Install and Get Started with Vagrant in 2017</a></h1></header><div class="post__main echo"><p><img src="https://i.imgur.com/mw4s7ic.png" alt="Vagrant Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>Despite its age and familiarity to most nowadays I couldn’t find a straight forward post on how to install and get started using Vagrant. So here’s my notes on doing so in blog post format. Be aware that this is well trodden ground and the Vagrant documentation on their website has a similar set of steps and content. The official site, if not this will get you where you need to be when it comes to getting started with Vagrant. </p>
<blockquote>
<p><a href="https://www.vagrantup.com/intro/getting-started/index.html" target="_blank" rel="external">Official Vagrant Website - Getting Started</a></p>
</blockquote>
<a id="more"></a>
<hr>
<h1 id="1-–-Install-VirtualBox"><a href="#1-–-Install-VirtualBox" class="headerlink" title="1 – Install VirtualBox"></a>1 – Install VirtualBox</h1><p><a href="https://www.virtualbox.org/wiki/Linux_Downloads" target="_blank" rel="external">Find the correct installation procedure for your flavour of Linux here.</a></p>
<p>On Ubuntu you would add this line to the bottom of your <code>sources.list</code> file:</p>
<p><code>deb http://download.virtualbox.org/virtualbox/debian xenial contrib</code></p>
<p>Replacing <code>xenial</code> for your own distributions release codename. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/apt/sources.list</span><br></pre></td></tr></table></figure>
<p>You can find this codename if you don’t already know it by running this command; back on the prompt. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsb_release <span class="_">-a</span></span><br></pre></td></tr></table></figure>
<p>For Debian 8 (“Jessie”) and Ubuntu 16.04 (“Xenial”) or later distributions. Download and add the repositories PGP key. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-key add -</span><br></pre></td></tr></table></figure>
<p>Update the apt-get package database and install the <code>virtualbox</code> packages. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install virtualbox</span><br></pre></td></tr></table></figure>
<p>Virtualbox is now installed and ready to use. </p>
<hr>
<h1 id="2-–-Install-Vagrant"><a href="#2-–-Install-Vagrant" class="headerlink" title="2 – Install Vagrant"></a>2 – Install Vagrant</h1><p><a href="https://www.vagrantup.com/downloads.html" target="_blank" rel="external">Find the correct binary for your version of Linux, then download it with the URL and Wget.</a></p>
<p>Here’s the <code>wget</code> command and correct URL for downloading the latest version of Vagrant on Debian (at the time of writing this) - yours may differ. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://releases.hashicorp.com/vagrant/1.9.4/vagrant_1.9.4_x86_64.deb ~</span><br></pre></td></tr></table></figure>
<p>To then install the binary as a package on the system, use:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo dpkg -i vagrant_1.9.4_x86_64.deb</span><br></pre></td></tr></table></figure>
<p>You can remove the Vagrant <code>.deb</code> build file from your user’s home directory now, after it’s been installed. </p>
<p>Make a temporary test directory, and change into it, before continuing. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir ~/vagrant-test &amp;&amp; <span class="built_in">cd</span> vagrant-test</span><br></pre></td></tr></table></figure>
<p>To test the install, you can download and run a basic Vagrant box as a VM by running the next set of commands.</p>
<p>So we’re clear, here’s a good definition of a what a Vagrant “box” actually is: </p>
<blockquote>
<p>“A package containing a representation of a virtual machine running a specific operating system. To be more simple, it is a base image of any Operating System or Kernel. It may be for a specific Provider.”</p>
</blockquote>
<p>The box is the image, and from this image a virtual machine (VM) is created on the localhost. </p>
<p>The basic Vagrant configuration for this VM will be based in one file, the <code>Vagrantfile</code>. </p>
<p>This file is placed in the <code>~/vagrant-test</code> directory via:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant init ubuntu/xenial64</span><br></pre></td></tr></table></figure>
<p>There are a wide variety of different box types (various OS images) listed on <a href="https://atlas.hashicorp.com/boxes/search" target="_blank" rel="external">Hashi corp’s  Atlas index.</a></p>
<p>After issuing the next command Vagrant will start to download the box and attempt to create and run a VM through virtualbox.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant up</span><br></pre></td></tr></table></figure>
<p>Here’s an example of what the progress output looks like for this:</p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">==&gt; default: Box <span class="string">'ubuntu/xenial64'</span> could not be found. Attempting to find and install...</span><br><span class="line">    default: Box Provider: virtualbox</span><br><span class="line">    default: Box Version: &gt;= 0</span><br><span class="line">==&gt; default: Loading metadata <span class="keyword">for</span> box <span class="string">'ubuntu/xenial64'</span></span><br><span class="line">    default: URL: https://atlas.hashicorp.com/ubuntu/xenial64</span><br><span class="line">==&gt; default: Adding box <span class="string">'ubuntu/xenial64'</span> (v2017.05.01) <span class="keyword">for</span> provider: virtualbox</span><br><span class="line">    default: Downloading: https://vagrantcloud.com/ogarcia/boxes/archlinux-x32/versions/2017.05.01/providers/virtualbox.box</span><br><span class="line">==&gt; default: Successfully added box <span class="string">'ubuntu/xenial64'</span> (v2017.05.01) <span class="keyword">for</span> <span class="string">'virtualbox'</span>!</span><br><span class="line">==&gt; default: Importing base box <span class="string">'ubuntu/xenial64'</span>...</span><br><span class="line">==&gt; default: Matching MAC address <span class="keyword">for</span> NAT networking...</span><br><span class="line">==&gt; default: Checking <span class="keyword">if</span> box <span class="string">'ubuntu/xenial64'</span> is up to date...</span><br><span class="line">==&gt; default: Setting the name of the VM: vagrant-testing_default_1494195673719_66642</span><br><span class="line">==&gt; default: Clearing any previously <span class="built_in">set</span> network interfaces...</span><br><span class="line">==&gt; default: Preparing network interfaces based on configuration...</span><br><span class="line">    default: Adapter 1: nat</span><br><span class="line">==&gt; default: Forwarding ports...</span><br><span class="line">    default: 22 (guest) =&gt; 2222 (host) (adapter 1)</span><br><span class="line">==&gt; default: Booting VM...</span><br><span class="line">==&gt; default: Waiting <span class="keyword">for</span> machine to boot. This may take a few minutes...</span><br><span class="line">    default: SSH address: 127.0.0.1:2222</span><br><span class="line">    default: SSH username: vagrant</span><br><span class="line">    default: SSH auth method: private key</span><br><span class="line">    default: </span><br><span class="line">    default: Vagrant insecure key detected. Vagrant will automatically replace</span><br><span class="line">    default: this with a newly generated keypair <span class="keyword">for</span> better security.</span><br><span class="line">    default: </span><br><span class="line">    default: Inserting generated public key within guest...</span><br><span class="line">    default: Removing insecure key from the guest <span class="keyword">if</span> it<span class="string">'s present...</span><br><span class="line">    default: Key inserted! Disconnecting and reconnecting using new SSH key...</span><br><span class="line">==&gt; default: Machine booted and ready!</span><br><span class="line">==&gt; default: Checking for guest additions in VM...</span><br><span class="line">    default: The guest additions on this VM do not match the installed version of</span><br><span class="line">    default: VirtualBox! In most cases this is fine, but in rare cases it can</span><br><span class="line">    default: prevent things such as shared folders from working properly. If you see</span><br><span class="line">    default: shared folder errors, please make sure the guest additions within the</span><br><span class="line">    default: virtual machine match the version of VirtualBox you have installed on</span><br><span class="line">    default: your host and reload your VM.</span><br><span class="line">    default: </span><br><span class="line">    default: Guest Additions Version: 5.1.22 r115126</span><br><span class="line">    default: VirtualBox Version: 5.0</span><br><span class="line">==&gt; default: Mounting shared folders...</span><br><span class="line">    default: /vagrant =&gt; /home/scarlz/vagrant-testing</span></span><br></pre></td></tr></table></figure>
<p>You can get an error message here relating to CPU architecture if you use a box that isn’t intended for your host’s operating system.</p>
<p>For example, the first image here requires a 64-bit host operating system, and then the second is for a 32-bit version. The “host” here refers to the machine you installed Vagrant on.</p>
<ul>
<li><a href="https://atlas.hashicorp.com/ubuntu/boxes/xenial64" target="_blank" rel="external">https://atlas.hashicorp.com/ubuntu/boxes/xenial64</a></li>
<li><a href="https://atlas.hashicorp.com/ubuntu/boxes/trusty32" target="_blank" rel="external">https://atlas.hashicorp.com/ubuntu/boxes/trusty32</a></li>
</ul>
<p>In my example we used the first box, a 64-bit system. </p>
<p>Also if you are running Vagrant itself in a virtual machine (using a hypervisor). Then you’ll need to ensure your hypervisor has “VT-x/AMD-V enabled”.</p>
<p>To enable this you’ll have to do something along the lines of:</p>
<ol>
<li>Power off the host virtual machine.</li>
<li>Edit the individual virtual machine’s settings.</li>
<li>Go to the CPU/processors section.</li>
<li>Enable “VT-x/AMD-V” /  “Virtualise Intel VR-x/EPT and AMD-V/RVI”</li>
<li>Then power on the virtual machine again.</li>
<li>Re-run <code>vagrant up</code> in your Vagrant testing directory.</li>
</ol>
<p>Here is what the setting looks like when using VMware Workstation as your hypervisor.</p>
<p><img src="https://i.gyazo.com/2f12d720498b753e09eb79f6f31117c9.png" alt="Vmware CPU Section Image"></p>
<hr>
<h1 id="3-–-Connect-to-a-Running-VM"><a href="#3-–-Connect-to-a-Running-VM" class="headerlink" title="3 – Connect to a Running VM"></a>3 – Connect to a Running VM</h1><p>Once a box is installed and configured to run in a VM (like in step 2), you connect to the VM through an SSH tunnel created by Vagrant. </p>
<p>To connect to the newly running VM with Vagrant use:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant ssh</span><br></pre></td></tr></table></figure>
<p>The prompt now shows you are connected to your new VM!</p>
<figure class="highlight bash"><figcaption><span>prompt example</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ubuntu-xenial:~$</span><br></pre></td></tr></table></figure>
<p>Type <code>exit</code> or use <code>CTRL + D</code> to leave the VM’s command line and return to your host. </p>
<hr>
<h1 id="4-–-Vagrant-Sub-commands"><a href="#4-–-Vagrant-Sub-commands" class="headerlink" title="4 – Vagrant Sub-commands"></a>4 – Vagrant Sub-commands</h1><p>These are the commands you’ll find yourself using when working with Vagrant. They use subsets of subcommands - which may seem confusing at first glance. The first is <code>box</code> and has several susbets. Not all however have them.</p>
<h2 id="box"><a href="#box" class="headerlink" title="box"></a><a href="https://www.vagrantup.com/docs/cli/box.html" target="_blank" rel="external">box</a></h2><p>List all the boxes you currently have installed on the host. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant box list</span><br></pre></td></tr></table></figure>
<p>Remove an already existing box from Vagrant. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant box remove ubuntu/xenial64</span><br></pre></td></tr></table></figure>
<p>Check updates for all box images on your system. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant box update</span><br></pre></td></tr></table></figure>
<p>Many of these commands can have the box named appended to them. In order to single them out. </p>
<h2 id="destroy"><a href="#destroy" class="headerlink" title="destroy"></a><a href="https://www.vagrantup.com/docs/cli/destroy.html" target="_blank" rel="external">destroy</a></h2><p>The Vagrant documentation sums this command up pretty well:</p>
<blockquote>
<p>“This command stops the running machine Vagrant is managing and destroys all resources that were created during the machine creation process. After running this command, your computer should be left at a clean state, as if you never created the guest machine in the first place.”</p>
</blockquote>
<p>Use it to destroy your created virual machines e.g.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant destroy ubuntu/xenial64</span><br></pre></td></tr></table></figure>
<h2 id="halt"><a href="#halt" class="headerlink" title="halt"></a><a href="https://www.vagrantup.com/docs/cli/halt.html" target="_blank" rel="external">halt</a></h2><p>This command shuts down the running virtual machine Vagrant is currently managing; you can add a machine name/ID to target specific VM’s</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant halt</span><br></pre></td></tr></table></figure>
<h2 id="reload"><a href="#reload" class="headerlink" title="reload"></a><a href="https://www.vagrantup.com/docs/cli/reload.html" target="_blank" rel="external">reload</a></h2><p>This is the same as a <code>vagrant halt</code> but restarts the VM after halting - like with <code>vagrant up</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant reload</span><br></pre></td></tr></table></figure>
<h2 id="port"><a href="#port" class="headerlink" title="port"></a><a href="https://www.vagrantup.com/docs/cli/port.html" target="_blank" rel="external">port</a></h2><p>This allows you to list all the Vagrant guest ports that are mapped to the host ports. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant port</span><br></pre></td></tr></table></figure>
<h2 id="ssh-config"><a href="#ssh-config" class="headerlink" title="ssh_config"></a><a href="https://www.vagrantup.com/docs/cli/ssh_config.html" target="_blank" rel="external">ssh_config</a></h2><p>Useful for displaying the output of the Vagrant host side SSH configuration file. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant ssh-config</span><br></pre></td></tr></table></figure>
<p>Returns:</p>
<figure class="highlight bash"><figcaption><span>Example Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Host default</span><br><span class="line">  HostName 127.0.0.1</span><br><span class="line">  User ubuntu</span><br><span class="line">  Port 2222</span><br><span class="line">  UserKnownHostsFile /dev/null</span><br><span class="line">  StrictHostKeyChecking no</span><br><span class="line">  PasswordAuthentication no</span><br><span class="line">  IdentityFile /home/scarlz/vagrant-ubuntu-test/.vagrant/machines/default/virtualbox/private_key</span><br><span class="line">  IdentitiesOnly yes</span><br><span class="line">  LogLevel FATAL</span><br></pre></td></tr></table></figure>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><p>Should there ever be any SSH connection issues to a VM. The connection log can be seen by appending <code>--debug</code> to the command. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant ssh --debug</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> This <code>--debug</code> flag can be added onto most Vagrant commands to see the internal operations being carried out. </p>
</blockquote>
<p>Checking the status of the current Vagrant virtual machine is possible by entering:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vagrant status</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="6-–-Autocompletion"><a href="#6-–-Autocompletion" class="headerlink" title="6 – Autocompletion"></a>6 – Autocompletion</h1><p>A nice addition to Vagrant is shell auto completion (Bash shell) for when typing in the above commands.  An up to date (at the time of writing this) repo which provides this is located here: </p>
<blockquote>
<p><a href="https://github.com/brbsix/vagrant-bash-completion" target="_blank" rel="external">https://github.com/brbsix/vagrant-bash-completion</a></p>
</blockquote>
<p>This is a fork of <a href="https://github.com/kura/vagrant-bash-completion" target="_blank" rel="external">Kura’s old repo</a>; thanks go to him for maintaining this up until now. Here’s the provided “easiest” method of downloading this functionality to your Linux/Unix host system. </p>
<p><code>wget</code> the script file in the above repo. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget -q https://raw.github.com/brbsix/vagrant-bash-completion/master/vagrant-bash-completion/etc/bash_completion.d/vagrant</span><br></pre></td></tr></table></figure>
<p>Add the newly downloaded file to the system Bash completion directory - whilst modifying the file’s permissions. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo install -m 0644 vagrant /etc/bash_completion.d/</span><br></pre></td></tr></table></figure>
<p>Now either close and re-open your terminal, or <code>source</code> in the new <code>/etc/bash_completion.d/vagrant</code> bash completion file. To get the new auto-completion working. </p>
<hr>
<h1 id="8-–-Further-Reading"><a href="#8-–-Further-Reading" class="headerlink" title="8 – Further Reading"></a>8 – Further Reading</h1><p>Erika Heidi has recently revisited and updated her great in-depth book dedicated to Vagrant. For a full run down of Vagrant and how to add configuration management tools into the mix. I’d highly recommend this book. </p>
<p><img src="https://i.imgur.com/0kT5WIB.png" alt="Cookbook - Frontcover"></p>
<blockquote>
<p><a href="https://leanpub.com/vagrantcookbook" target="_blank" rel="external">https://leanpub.com/vagrantcookbook</a></p>
</blockquote>
<p>There’s an accompanying blog post from February 2017 that she’s put together on recent Vagrant usage and trends. It’s quite short and worth reading if you’re interested.</p>
<blockquote>
<p><a href="http://www.erikaheidi.com/blog/vagrant-usage-research-2017/" target="_blank" rel="external">http://www.erikaheidi.com/blog/vagrant-usage-research-2017/</a></p>
</blockquote>
<p>The infographic (which I’ll leave here) is the main takeaway from the post:</p>
<p><img src="http://www.erikaheidi.com/files/2017-02/vagrant-research-2017.png" alt="The State of Vagrant Infographic"></p>
<hr>
<p>Vagrant is a slightly ageing software in the sense that many prefer more recent tools like Docker. It does however still have its uses and is quite well adopted these days, so it’s more than worth understanding at least the basics.</p>
<p>Enjoy your time with Vagrant.  </p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://stackoverflow.com/questions/17175696/running-vagrant-inside-vmware-vm" target="_blank" rel="external">Stack Overflow - Running Vagrant Inside VMWare VM</a> – As mentioned in step 2. </li>
<li><a href="https://stackoverflow.com/questions/22922891/vagrant-ssh-authentication-failure" target="_blank" rel="external">Stack Overflow - Vagrant ssh authentication failure</a> – An issue that seems to occur with the official Vagrant Ubuntu images. </li>
<li><a href="https://github.com/mitchellh/vagrant/issues/5186" target="_blank" rel="external">“Warning: Authentication failure. Retrying…”</a> – A very detailed long-term GitHub thread detailing the aforementioned issue. </li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Virtualisation/" class="post__tag__link">Virtualisation</a></li><li class="post__tag__item"><a href="/tags/Vagrant/" class="post__tag__link">Vagrant</a></li><li class="post__tag__item"><a href="/tags/Ubuntu/" class="post__tag__link">Ubuntu</a></li></ul><a href="/2017/05/17/vagrant-started/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2017-04-09T23:00:00.000Z" class="post__time">April 10, 2017</time><h1 class="post__title"><a href="/2017/04/10/ansible-playbooks/">Ansible - Playbook Concepts (4)</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/9HBs9cy.png" alt="Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>Playbooks are written in YAML like the configuration files and are the basis for Ansible’s configuration management and en-masse multi-machine deployment. </p>
<p>These are very powerful not only for declaring server configurations but also to orchestrate steps of any manual ordered process, even when the different steps must bounce back and forth between sets of machines in any order, as playbooks can launch tasks synchronously or asynchronously as required.</p>
<p>While it’s suitable to use the <code>/usr/bin/ansible</code> program for ad-hoc commands and tasks. Playbooks are better kept in source control and used to push out larger configurations, or assure the configurations of your remote systems are still in check. </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Playbook-Examples"><a href="#1-–-Playbook-Examples" class="headerlink" title="1 – Playbook Examples"></a>1 – Playbook Examples</h1><p>Here are some initial examples of Ansible playbooks. A playbook by definition is composed of one or more <em>plays</em> in a list.</p>
<p>The goal of each play is to map a group of hosts to some well defined role, through actions within the play Ansible calls tasks. Put simply though, a task is nothing more than a call to a preset Ansible <a href="http://www.tricksofthetrades.net/2017/03/20/ansible-adhoc-modules/">module</a>. </p>
<p>By composing a playbook of multiple ‘plays’, it is possible to orchestrate multi-machine deployments. Running certain steps on all machines in the “webservers” group, then certain steps on the “databases” server group, and then more commands back on the “webservers” group, etc. </p>
<p>The first snippet and playbook sets up Apache web server on hosts in the <code>webservers</code> group. Notice the variables declared, remote user in use, and handlers towards the end. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    http_port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    max_clients:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=httpd</span> <span class="string">state=latest</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">write</span> <span class="string">the</span> <span class="string">apache</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=/srv/httpd.j2</span> <span class="string">dest=/etc/httpd.conf</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span> <span class="string">(and</span> <span class="string">enable</span> <span class="string">it</span> <span class="string">at</span> <span class="string">boot)</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>
<p>This second example uses tasks that have really long parameters, and modules that take many parameters. When this is the case you can break tasks items over multiple lines to improve the playbook readability and structure. Breaking up tasks is achieved by using YAML dictionaries to supply the modules with their <em>key=value</em> arguments.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    http_port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    max_clients:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line"><span class="attr">    yum:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">      state:</span> <span class="string">latest</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">write</span> <span class="string">the</span> <span class="string">apache</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    template:</span></span><br><span class="line"><span class="attr">      src:</span> <span class="string">/srv/httpd.j2</span></span><br><span class="line"><span class="attr">      dest:</span> <span class="string">/etc/httpd.conf</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    service:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">      state:</span> <span class="string">started</span></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">      service:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">        state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>
<p>This final example contains not just one but two plays. The first targets the <code>webservers</code> host group and the second targets the <code>databases</code> host group. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=httpd</span> <span class="string">state=latest</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">write</span> <span class="string">the</span> <span class="string">apache</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=/srv/httpd.j2</span> <span class="string">dest=/etc/httpd.conf</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">databases</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">postgresql</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">name=postgresql</span> <span class="string">state=latest</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">that</span> <span class="string">postgresql</span> <span class="string">is</span> <span class="string">started</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=postgresql</span> <span class="string">state=started</span></span><br></pre></td></tr></table></figure>
<p>See the <a href="https://github.com/ansible/ansible-examples" target="_blank" rel="external">ansible/ansible-examples</a> GitHub repository for some fully fledged and properly structured Playbook configuration examples. </p>
<hr>
<h1 id="2-–-Playbook-Hosts-and-Users"><a href="#2-–-Playbook-Hosts-and-Users" class="headerlink" title="2 – Playbook Hosts and Users"></a>2 – Playbook Hosts and Users</h1><p>For each “play” in a playbook, you get to choose the servers/hosts in your infrastructure you want to target, and which remote Linux user to complete the steps in the play as (remember the steps are called tasks).</p>
<p>The <code>hosts</code> line at the start of a play is a list of one or more groups, or if needed a <a href="http://docs.ansible.com/ansible/intro_patterns.html" target="_blank" rel="external">host pattern</a>. The <code>remote_user</code> holds the name of the target Linux/Unix user account.</p>
<p>For example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure>
<p>Remote users can also be set per task instead of just for the entire play. Such as in this example where the task <code>test connection</code> uses a different user to the overall play. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">test</span> <span class="string">connection</span></span><br><span class="line"><span class="attr">      ping:</span></span><br><span class="line"><span class="attr">      remote_user:</span> <span class="string">scarlz</span></span><br></pre></td></tr></table></figure>
<p>The <code>become</code> and <code>become_method</code> items allow a change of privileges from within the SSH user’s session. This is useful for using shell programs like <code>sudo</code> for tasks that need <a href="http://docs.ansible.com/ansible/become.html" target="_blank" rel="external">higher privileges</a>.</p>
<p>Like here: </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">scarlz</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span></span><br><span class="line"><span class="attr">      become:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">      become_method:</span> <span class="string">sudo</span></span><br></pre></td></tr></table></figure>
<p>In these cases you must provide the necessary password using <code>--ask-become-pass</code> when running the playbook itself with <code>ansible-playbook</code> from the command line - covered later on. </p>
<p>Using <code>become_user</code> similarly allows a change of user from within the play’s SSH user shell session. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">scarlz</span></span><br><span class="line"><span class="attr">  become:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  become_user:</span> <span class="string">postgres</span></span><br></pre></td></tr></table></figure>
<p>Let’s look more at the tasks themselves and what they can do. </p>
<hr>
<h1 id="3-–-Playbook-Tasks"><a href="#3-–-Playbook-Tasks" class="headerlink" title="3 – Playbook Tasks"></a>3 – Playbook Tasks</h1><p>As seen each play contains its own list of tasks. Tasks are executed in order, one at a time, against all machines matched by the host group or pattern. So keep in mind that all hosts are going to receive and process the same task directives issued. </p>
<p>Also when running a playbook, any hosts that end up with failed tasks are taken out of the rotation for the entire playbook run. If things fail, simply correct the playbook file (or host connectivity issue) and rerun it.</p>
<p>As seen in the first section of this post, the goal of each task is to execute a module, with set variables passed to that module if needed. </p>
<p>Here is an omitted example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    http_port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    max_clients:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">make</span> <span class="string">sure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span></span><br></pre></td></tr></table></figure>
<p>Importantly though module use should also be “idempotent”. That is to say, when running a module multiple times in a sequence, it should have the same end result as if you had run it only once. One way to achieve this state of idem-potency in playbooks is to have a module check whether its desired final state has already been achieved, and if that state has been achieved, to instead exit without performing any actions. </p>
<p>So if all the modules a playbook uses are idempotent, then the playbook itself is likely to be idempotent too (overall), so re-running the playbook multiple times should be safe and not create any issues.</p>
<blockquote>
<p><strong>Note:</strong> The <code>command</code> and <code>shell</code> modules will typically rerun the same command issued again, which is fine if the command is something that does not change the outcome of its initial execution, when run multiple times. There is also a “creates” flag available here which can be used to make these two modules idempotent. </p>
</blockquote>
<p>Furthermore every task should have a <code>name</code>, which is included in the output from running the playbook, and serves as more of a description than a moniker. Due to this It is useful to provide good descriptions for each task step. </p>
<blockquote>
<p><strong>Note:</strong> If a <code>name</code> is not provided, the string fed to ‘action’ will be used for output.</p>
</blockquote>
<p>As with most modules, the <code>service</code> module takes arguments in the key=value format.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">make</span> <span class="string">sure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span></span><br></pre></td></tr></table></figure>
<p>The <code>command</code> and <code>shell</code> modules are the only modules that take a list of arguments and don’t use the key=value form as normal. </p>
<p>This makes them work in the same way as you would expect them to on the command line e.g. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">disable</span> <span class="string">selinux</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">/sbin/setenforce</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>The <code>command</code> and <code>shell</code> module care about return codes, so if you have a command where the successful exit code is not zero, you can alter it to this:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line"><span class="attr">    shell:</span> <span class="string">/usr/bin/somecommand</span> <span class="string">||</span> <span class="string">/bin/true</span></span><br></pre></td></tr></table></figure>
<p>If the action line of the module is getting too long, you can break it on a space character and indent any continued lines to improve readability. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">Copy</span> <span class="string">ansible</span> <span class="string">inventory</span> <span class="string">file</span> <span class="string">to</span> <span class="string">client</span></span><br><span class="line"><span class="attr">    copy:</span> <span class="string">src=/etc/ansible/hosts</span> <span class="string">dest=/etc/ansible/hosts</span></span><br><span class="line">            <span class="string">owner=root</span> <span class="string">group=root</span> <span class="string">mode=0644</span></span><br></pre></td></tr></table></figure>
<p>Variables declared can be explicitly used in task action lines, not just in <em>templates</em> (templates not covered yet). </p>
<p>The variable is called using the word <code>vhost</code> inside of the curly braces, in the example below:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    vhost:</span> <span class="string">blog-site.conf</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">create</span> <span class="string">a</span> <span class="string">virtual</span> <span class="string">host</span> <span class="string">file</span> <span class="string">for</span> <span class="string">&#123;&#123;</span> <span class="string">vhost</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=somefile.j2</span> <span class="string">dest=/etc/httpd/conf.d/&#123;&#123;</span> <span class="string">vhost</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>To carry on the concept and practice introduced here of idem-potency in Ansible. The next section talks about <em>handlers</em>.</p>
<hr>
<h1 id="4-–-Playbook-Handlers"><a href="#4-–-Playbook-Handlers" class="headerlink" title="4 – Playbook Handlers"></a>4 – Playbook Handlers</h1><p>Modules should be idempotent as described in the last section, so they can relay back whether they have made a change on the remote system or not. Playbooks have the ability to recognise these changes and also have a basic event system that can be used to respond to change. </p>
<p><code>notify</code> actions are triggered at the end of each block of tasks in a play, and will only be triggered once. Even if notified and triggered by multiple different tasks. For instance, multiple resources may indicate that Apache needs to be restarted because they have changed a config file, but Apache will only be restarted once to avoid multiple unnecessary restarts.</p>
<p>Here’s an example of restarting two services in a task when the contents of a file change, but only if the file changes. The items listed in the notify section of the task are called handlers.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">template</span> <span class="string">configuration</span> <span class="string">file</span></span><br><span class="line"><span class="attr">  template:</span> <span class="string">src=template.j2</span> <span class="string">dest=/etc/foo.conf</span></span><br><span class="line"><span class="attr">  notify:</span></span><br><span class="line"><span class="bullet">     -</span> <span class="string">restart</span> <span class="string">memcached</span></span><br><span class="line"><span class="bullet">     -</span> <span class="string">restart</span> <span class="string">apache</span></span><br></pre></td></tr></table></figure>
<p>Handlers are lists of tasks (not really any different from regular tasks) that are referenced by a globally unique name, and are notified by notifiers. If a handler is never referenced/notified it will not run. As inferred earlier, regardless of how many tasks notify a handler, it will run only once, and after all of the tasks complete in a particular play.</p>
<p>Here’s an example of a <code>handlers</code> section with some defined tasks:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">memcached</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=memcached</span> <span class="string">state=restarted</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=apache</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="5-–-Running-Playbooks"><a href="#5-–-Running-Playbooks" class="headerlink" title="5 – Running Playbooks"></a>5 – Running Playbooks</h1><p>Now that you’ve learned much of the groundwork for playbook syntax, we should look at how to run a completed playbook. </p>
<p>To run a playbook use the <code>anisble-playbook</code> command followed by the path to the playbook file. In this scenario it’s in the current working directory and named <code>playbook.yml</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-playbook playbook.yml <span class="_">-f</span> 10</span><br></pre></td></tr></table></figure>
<p>The <code>-f 10</code> specifies the usage of 10 simultaneous Ansible processes at once. </p>
<p>When executing a playbook there will always be a summary of the nodes/hosts that were targeted and how they fared with the instructions. General failures and fatal unreachable attempts by the playbook execution are kept separate in the “counts”.</p>
<p>The <code>--verbose</code> flag tagged onto the <code>ansible-playbook</code> command results in a more detailed account of the results of a playbook run. Furthermore the <code>--list-hosts</code> flag shows which hosts are to be affected by a playbook before you run it. </p>
<p>It’s possible to invert the architecture of Ansible, forcing nodes/hosts check in to a central location instead of pushing configuration out externally, by using the <code>ansible-pull</code> script. </p>
<p>Run the help option to see details on this if interested.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible-pull --help</span><br></pre></td></tr></table></figure>
<p>As an aside, some say that Ansible playbook output is vastly upgraded if the <code>cowsay</code> package is installed on your system. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Debian / Ubuntu</span></span><br><span class="line">$ sudo apt-get install cowsay </span><br><span class="line"><span class="comment"># Arch Linux</span></span><br><span class="line">$ sudo pacman -S cowsay</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="7-–-Ansible-Templating"><a href="#7-–-Ansible-Templating" class="headerlink" title="7 – Ansible Templating"></a>7 – Ansible Templating</h1><p>Templates in Ansible are constructed using the Jinja2 Python templating language, and reside in their own files. They are capable of referencing variables from outside sources, such as from within the playbook using the template and the outer Ansible file inventory e.g. a <code>main.yml</code> file within an upper <code>/vars</code> directory.</p>
<p>Templates are typically useful for setting up configuration files, to make them and other files more versatile or reusable among playbooks. They can have any file name but the <code>.tpl</code> or <code>.j2</code> extensions are common. </p>
<p>Below is a template example for setting up an Apache virtual host. It uses a variable for setting up the document root on each Ansible host:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;VirtualHost *:80&gt;</span></span><br><span class="line">    <span class="attribute">ServerAdmin</span> webmaster@localhost</span><br><span class="line">    <span class="attribute"><span class="nomarkup">DocumentRoot</span></span> &#123;&#123; doc_root &#125;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">&lt;Directory &#123;&#123; doc_root &#125;&#125;&gt;</span></span><br><span class="line">        <span class="attribute">AllowOverride</span> <span class="literal">All</span></span><br><span class="line">        <span class="attribute">Require</span> <span class="literal">all</span> granted</span><br><span class="line">    <span class="section">&lt;/Directory&gt;</span></span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br></pre></td></tr></table></figure>
<p>The inbuilt module <code>template:</code> is used to apply a template file in a task. For example, if you named a template file <code>vhost.tpl</code> and you placed it inside the same directory as your playbook, this is how you would make use of the template to replace the default Apache virtual host, on your Ansible hosts:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">Alter</span> <span class="string">the</span> <span class="string">default</span> <span class="string">Apache</span> <span class="string">virtual</span> <span class="string">host</span></span><br><span class="line"><span class="attr">  template:</span> <span class="string">src=vhost.tpl</span> <span class="string">dest=/etc/apache2/sites-available/000-default.conf</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="8-–-Roles-in-Playbooks"><a href="#8-–-Roles-in-Playbooks" class="headerlink" title="8 – Roles in Playbooks"></a>8 – Roles in Playbooks</h1><p>Roles work best for more complex playbooks that have many multiple but related tasks. Each role contains only the relevant data and information needed to carry out said tasks. As there are usually multiple stages to a task or set of tasks, playbooks can get very lengthy and congested with all their operations. So confining tasks to roles helps alleviate this problem. </p>
<p>As an example, a playbook that installs Nginx, likely involves adding the stable package repository, then installing the package itself, as well as setting up all the configuration for the web server. The final configuration step no doubt requires extra data such as variables, files, dynamic templates, and more. These are bet kept in their own role’s area.</p>
<p>The file-system for a role looks like the below, where <code>rolename</code> is the root directory, and the options are the subsequent directory areas for each piece of information. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">rolename</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">files</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">handlers</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">meta</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">templates</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">tasks</span></span><br><span class="line"><span class="bullet"> -</span> <span class="string">vars</span></span><br></pre></td></tr></table></figure>
<p>Within each of the individual directory areas above, Ansible will search for a <code>main.yml</code> file automatically. Any every piece of configuration for the role in question is contained within these locations. </p>
<hr>
<p>After understanding how each of these different concepts work together to create a playbook. You can go on to make your own from scratch, from other examples, or by converting your older setup scripts. </p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="http://docs.ansible.com/ansible/playbooks_intro.html" target="_blank" rel="external">Official Ansible Documentation - Intro to Playbooks</a> – Most of the base content for this post was garnered from here.</li>
<li><a href="https://www.digitalocean.com/community/tutorials/configuration-management-101-writing-ansible-playbooks" target="_blank" rel="external">Digital Ocean - Configuration Management 101: Writing Ansible Playbooks</a> – Some of the basic playbook examples and ideas are taken from this.</li>
<li><a href="https://serversforhackers.com/an-ansible-tutorial" target="_blank" rel="external">Servers for Hackers - An Ansible Tutorial</a> – Shows a great real world example for creating an Nginx playbook; among other things.</li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Python/" class="post__tag__link">Python</a></li></ul><a href="/2017/04/10/ansible-playbooks/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2017-03-20T00:00:00.000Z" class="post__time">March 20, 2017</time><h1 class="post__title"><a href="/2017/03/20/ansible-adhoc-modules/">Ansible - Ad Hoc Commands and Modules (3)</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/9HBs9cy.png" alt="Ansible Logo"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>Several ad hoc commands were shown in the previous post but no real detail was given as to what they can fully offer. These <em>ad hoc</em> commands are often cited as being a good starter point for learning what’s possible with Ansible; without having to dive straight into writing a playbook. Most of them incorporate the use of a <em>module</em> into their structure, so this post introduces modules too. Both from the point of view of an ad hoc command, and within the context of a task. Towards the end, the “special” Ansible module types are shown. </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Ad-Hoc-Commands"><a href="#1-–-Ad-Hoc-Commands" class="headerlink" title="1 – Ad Hoc Commands"></a>1 – Ad Hoc Commands</h1><p>Sometimes you may not need nor want to write a fully fledged playbook for simple operations. Either way the concepts here for these commands port directly over to the playbook language for when you do begin writing them later on. These due to their impromptu nature and use,. </p>
<p>In their simplest form these commands are shell commands performed in parallel to each host by Ansible. </p>
<p>Here <code>coreservers</code> is the group name that contains several hosts and the ad hoc command <code>-a</code> we are running on them is <code>/sbin/reboot</code> using <code>10</code> Ansible forks. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers <span class="_">-a</span> <span class="string">"/sbin/reboot"</span> <span class="_">-f</span> 10 <span class="_">-s</span> -K</span><br></pre></td></tr></table></figure>
<p>The <code>-f 10</code> in the above specifies the usage of 10 simultaneous processes to use (10 hosts at a time). You can also set this as an assumed default in the configuration file to avoid setting it here. The default is set to 5, which is lacking and conservative, so feel free to increase this value to a more optimal number. </p>
<p>Ansible defaults to running from your current user account (or from any hosts variables). To change this pass in the <code>-u</code> option. Where <code>scarlz</code> is the username you want to run the command as. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers <span class="_">-a</span> <span class="string">"/usr/bin/foo"</span> -u scarlz</span><br></pre></td></tr></table></figure>
<p>When not calling raw programs on the node through Ansible, modules are the main choice for carrying out operations. </p>
<p>In general the <code>-m</code> option denotes a named module. Here is an example of the <code>shell</code> module that is used to issue precise commands on the Ansible node. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -u scarlz -m shell <span class="_">-a</span> <span class="string">'echo $TERM'</span></span><br></pre></td></tr></table></figure>
<p>There are a whole back-catalogue of these inbuilt modules for you to make use of. </p>
<hr>
<h1 id="2-–-Modules"><a href="#2-–-Modules" class="headerlink" title="2 – Modules"></a>2 – Modules</h1><p>Modules contain the actions or functionality we want to implement and run. Some commonly used modules are apt/yum, copy, ec2, file, service, template, and user. Like shown in the previous section, modules can be used in ad-hoc commands as well as “tasks”.  </p>
<h2 id="Copy"><a href="#Copy" class="headerlink" title="Copy"></a>Copy</h2><p>This command transfers a “hosts” file directly to all servers in the “coreservers” group, using SCP and the <code>copy</code> module:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -m copy <span class="_">-a</span> <span class="string">"src=/etc/hosts dest=/tmp/hosts"</span> <span class="_">-s</span> -K</span><br></pre></td></tr></table></figure>
<h2 id="File"><a href="#File" class="headerlink" title="File"></a>File</h2><p>The <code>file</code> module provides the ability to change system ownership and permissions on remote files. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -m file <span class="_">-a</span> <span class="string">"dest=/var/www/index.html mode=755 owner=scarlz group=www"</span> <span class="_">-s</span> -K</span><br></pre></td></tr></table></figure>
<p>To create directories with <code>file</code>, like when using the <code>mkdir -p</code> command in Linux, add the “directory” <code>state-directory</code> option.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -m file <span class="_">-a</span> <span class="string">"dest=/var/www/new-vhost-dir mode=755 owner=scarlz group=www state=directory"</span> <span class="_">-s</span> -K</span><br></pre></td></tr></table></figure>
<p>Delete directories recursively, and delete files through <code>file</code> with the <code>state=absent</code> option.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -m file <span class="_">-a</span> <span class="string">"dest=/path/to/delete state=absent"</span></span><br></pre></td></tr></table></figure>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>This module is referred to when you need to interact with the OS system services. Inclusive of  BSD init, OpenRC, SysV, Solaris SMF, systemd, and upstart.</p>
<p>As an example of how this could work, this starts Nginx via systemd:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -m service <span class="_">-a</span> <span class="string">"name=nginx.service state=started"</span> <span class="_">-s</span> -K</span><br></pre></td></tr></table></figure>
<p>Changing the state option changes the result - this is to restart:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -m service <span class="_">-a</span> <span class="string">"name=nginx.service state=restarted"</span> <span class="_">-s</span> -K</span><br></pre></td></tr></table></figure>
<p>The value of “state” must be one of either: running, started, stopped, restarted, or reloaded.</p>
<h2 id="Users-and-Groups"><a href="#Users-and-Groups" class="headerlink" title="Users and Groups"></a>Users and Groups</h2><p>A module named the “user” module serves as an interface to creating, removing, and manipulating system user accounts. </p>
<p>Altering a user’s password only requires the username, in this next example this is <code>scarlz</code>, then the new password for the user which is substituted in to the <code>&lt;user-password&gt;</code> field.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -m user <span class="_">-a</span> <span class="string">"name=scarlz password=&lt;user-password&gt;"</span></span><br></pre></td></tr></table></figure>
<p>Removing the user account completely, once again needs the username (<code>scarlz</code> in my case) as well as the value <code>absent</code> for the <code>state</code> option. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ansible coreservers -m user <span class="_">-a</span> <span class="string">"name=scarlz state=absent"</span> <span class="_">-s</span> -K</span><br></pre></td></tr></table></figure>
<h2 id="Module-Index"><a href="#Module-Index" class="headerlink" title="Module Index"></a>Module Index</h2><p><a href="http://docs.ansible.com/ansible/modules_by_category.html" target="_blank" rel="external">Here’s a page from the official Ansible documentation</a> that acts as a catalogue for all the registered inbuilt modules available. There are many many modules, to cater for all specific needs. </p>
<hr>
<h1 id="3-–-Modules-in-Tasks"><a href="#3-–-Modules-in-Tasks" class="headerlink" title="3 – Modules in Tasks"></a>3 – Modules in Tasks</h1><p>Here are some examples of using the modules in a task (like you’d find in an Ansible playbook). </p>
<p>The file module (most shown before) creates a new directory to be used for caching purposes. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: add cache directory</span><br><span class="line">  file: path=/opt/cache state=directory</span><br></pre></td></tr></table></figure>
<p>The <code>apt</code> module handles packages for Ubuntu/Debian OS. The state option here designates that the install of Nginx should be implemented via apt-get, but the state value could also be replaced with <code>latest</code> (to update the package) or <code>absent</code> (to remove the package) instead. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: install nginx</span><br><span class="line">  yum name =nginx state=present</span><br></pre></td></tr></table></figure>
<p>This one’s pretty straight forward, and is the “task” equivalent of the ad hoc command from earlier. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: start nginx</span><br><span class="line">  service: name=nginx enabled=yes state=started</span><br></pre></td></tr></table></figure>
<p>One thing to notice here is with the <code>name:</code>  field. Tasks can be defined as anything you want here but should be descriptive. Tasks are simple and declarative, they aim to pass the correct arguments to the module calls, to achieve what is needed. </p>
<hr>
<h1 id="4-–-Special-Modules"><a href="#4-–-Special-Modules" class="headerlink" title="4 – Special Modules"></a>4 – Special Modules</h1><p>There are several modules that fall into their own category, that exist to provide special core use cases. The code examples here are in the form of a task you’d find within a playbook. </p>
<ul>
<li><code>command</code> module – Used for executing simple commands on remote nodes. (first example shown in step one). </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: Run the <span class="built_in">command</span> <span class="keyword">if</span> the specified file does not exist.</span><br><span class="line">  <span class="built_in">command</span>: /usr/bin/make_database.sh arg1 arg2 creates=/path/to/database</span><br></pre></td></tr></table></figure>
<ul>
<li><code>shell</code> module – Similar to the command module but allows the use of redirection, variables, and further operators. The <code>shell</code> module was also used in the first step. </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: Execute the <span class="built_in">command</span> <span class="keyword">in</span> remote shell; stdout goes to the specified file on the remote.</span><br><span class="line">  shell: somescript.sh &gt;&gt; somelog.txt</span><br></pre></td></tr></table></figure>
<ul>
<li><code>script</code> – Let’s you run a local script on a remote node - <strong>after transferring it.</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- script: /some/<span class="built_in">local</span>/script.sh --some-arguments 1234</span><br></pre></td></tr></table></figure>
<ul>
<li><code>raw</code> – Executes a low-down and dirty SSH command. Mainly used for installing Python versions onto hosts that do not already have it. </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: Bootstrap a legacy python 2.4 host</span><br><span class="line">  raw: yum -y install python-simplejson</span><br></pre></td></tr></table></figure>
<p>The examples uses Yum package manager, so is in the context of an enterprise Linux OS. </p>
<hr>
<p>With a basic understanding of how modules work within both ad hoc commands and tasks. It’s easy to now see how the bulk of an Ansible playbooks actions are laid out. </p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="http://docs.ansible.com/ansible/intro_adhoc.html" target="_blank" rel="external">Official Ansible Documentation - Introduction To Ad-Hoc Commands</a> – Has the bulk of the information contained in this post. </li>
<li><a href="https://serversforhackers.com/an-ansible-tutorial" target="_blank" rel="external">“Servers for Hackers” - An Ansible Tutorial</a> – Some context for some of the commands and the use of the options. </li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
<p><a href="https://serversforhackers.com/an-ansible-tutorial" target="_blank" rel="external">https://serversforhackers.com/an-ansible-tutorial</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Ansible/" class="post__tag__link">Ansible</a></li><li class="post__tag__item"><a href="/tags/CM/" class="post__tag__link">CM</a></li><li class="post__tag__item"><a href="/tags/Python/" class="post__tag__link">Python</a></li></ul><a href="/2017/03/20/ansible-adhoc-modules/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article><article class="post"><header class="post__head"><time datetime="2017-02-14T00:00:00.000Z" class="post__time">February 14, 2017</time><h1 class="post__title"><a href="/2017/02/14/installing-using-ufw/">Installing and Using UFW (Uncomplicated Firewall)</a></h1></header><div class="post__main echo"><p><img src="http://i.imgur.com/000yMhS.png" alt="Firewall Image"></p>
<h1 id="Preamble"><a href="#Preamble" class="headerlink" title="Preamble"></a>Preamble</h1><p>UFW is a popular and convenient firewall configuration tool originating from Ubuntu distributions. It’s a more accessible way of using the <code>iptables</code> program. Which with some of its complexities can be more cumbersome or confusing for newcomers to learn. In reality UFW works as a wrapper for iptables, so is not a firewall in its own right but the iptables firewall in a simpler form. It serves both IPv4 and IPv6 host-based traffic.</p>
<p>In this post are commands containing options/arguments that contain two words and look like this: <code>comment ssh</code>. These extra parts add a comment to the firewall rules generated. If you are using a version of UFW priot to <code>0.35</code> you may have to remove these two extra pieces to avoid errors. Please bear this in mind when you come to using these types of commands later on should you receive errors.  </p>
<a id="more"></a>
<hr>
<h1 id="1-–-Install-UFW"><a href="#1-–-Install-UFW" class="headerlink" title="1 – Install UFW"></a>1 – Install UFW</h1><p>Using your systems package manager is a straight forward and easy way of obtaining UFW. Here are two examples for Arch Linux and Debian/Ubuntu. </p>
<h2 id="Arch-Linux"><a href="#Arch-Linux" class="headerlink" title="Arch Linux"></a>Arch Linux</h2><p>On Arch with Pacman it’s simply:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pacman -S ufw</span><br></pre></td></tr></table></figure>
<p>Then enable it on boot through systemd using:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl <span class="built_in">enable</span> ufw</span><br><span class="line">$ sudo systemctl start ufw</span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="https://wiki.archlinux.org/index.php/Uncomplicated_Firewall" target="_blank" rel="external">Arch Wiki - Uncomplicated Firewall</a></p>
</blockquote>
<h2 id="Debian-Ubuntu"><a href="#Debian-Ubuntu" class="headerlink" title="Debian / Ubuntu"></a>Debian / Ubuntu</h2><p>UFW comes as part of most Ubuntu based distributions so you might already have it on your system, but to download the package on either Debian or Ubuntu use:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install ufw</span><br></pre></td></tr></table></figure>
<p>To check the status of the program and confirm installation.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw status verbose</span><br></pre></td></tr></table></figure>
<p>The output returned if installed successfully should be:</p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Status: inactive</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="2-–-Enable-Default-Rules"><a href="#2-–-Enable-Default-Rules" class="headerlink" title="2 – Enable Default Rules"></a>2 – Enable Default Rules</h1><p>As with several other firewall solutions, the standard practice is to block every possible incoming connection and allow any possible outgoing connections. Then open/block individual services and ports where necessary afterwards. </p>
<p>So deny all incoming connections. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw default deny incoming</span><br></pre></td></tr></table></figure>
<p>And allow all outgoing connections. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw default allow outgoing</span><br></pre></td></tr></table></figure>
<p>Remember that the firewall itself is still not active yet. All we have done so far is add these two overall base rules.  </p>
<hr>
<h1 id="3-–-Adding-Rules"><a href="#3-–-Adding-Rules" class="headerlink" title="3 – Adding Rules"></a>3 – Adding Rules</h1><p>There are two primary styles available for adding rules - standard rule inputs and alias style inputs. </p>
<p>Here’s how to enable SSH connections to the server, using one of the built-in alias style inputs UFW provides.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow ssh comment ssh</span><br></pre></td></tr></table></figure>
<p>This opens the default SSH TCP port - port number <code>22</code>.  Without this port open, SSH connections to your server would be blocked. Potentially making it inaccessible remotely.  </p>
<p>Here’s the same rule again that opens the default SSH port, but using the standard rule input syntax.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow 22/tcp comment ssh</span><br></pre></td></tr></table></figure>
<p>Anyone who does not use the default port number <code>22</code> for SSH and has altered it manually on their server, must use this standard rule syntax, and change the number in the command <code>22</code> to their chosen custom SSH port number. </p>
<p>Usually there is no need to restart UFW for newly added/removed rules to take effect. The effect of an action is applied immediately. </p>
<h2 id="Further-Methods"><a href="#Further-Methods" class="headerlink" title="Further Methods"></a>Further Methods</h2><p>Specific IP addresses may be utilised in rules too. The next example (as suggested by the syntax) allows all traffic incoming access from the provided address. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow from 192.168.255.255</span><br></pre></td></tr></table></figure>
<p>Port ranges are opened using a colon <code>:</code> and the number ranges you wish to use. The port type is given as <code>/tcp</code> or <code>/udp</code> appearing in the same manner as before. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow 3452:3478/tcp</span><br><span class="line">$ sudo ufw allow 3452:3478/udp</span><br></pre></td></tr></table></figure>
<p>Although the default rules we applied in step two automatically block every network connection, you can still block individual items with the firewall if you wish. Such as with a different blanket rule setup. </p>
<p>The <code>deny</code> command is what blocks specific port numbers, IP addresses, or port ranges when passed. </p>
<p>This would block the default SSH port if in some scenario it was required. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw deny ssh comment ssh</span><br></pre></td></tr></table></figure>
<p>To deny FTP traffic using the standard rule input syntax you can use:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw deny 21/tcp comment ssh</span><br></pre></td></tr></table></figure>
<p>Blocking a target IP address(s) is the same as allowing but again uses the <code>deny</code> option instead. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw deny from 192.168.254.254</span><br></pre></td></tr></table></figure>
<p>Lastly blocking entire ranges with <code>deny</code> is just as possible:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw deny 3278:3282/tcp</span><br><span class="line">$ sudo ufw deny 3278:3282/udp</span><br></pre></td></tr></table></figure>
<p>Blocking/denying entire subnets is also possible by using the IP address and mask (CIDR notation).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw deny 15.15.15.0/26</span><br></pre></td></tr></table></figure>
<p>Lastly here, blocking via the host machines network interface/hardware is possible e.g. <code>eth0</code> or whatever it is registered as. No examples for this will be shown here however. Simply note that it is possible. </p>
<hr>
<h1 id="4-–-Commonly-Applied-Rules"><a href="#4-–-Commonly-Applied-Rules" class="headerlink" title="4 – Commonly Applied Rules"></a>4 – Commonly Applied Rules</h1><p>Continuing on with the primary styles available for adding rules, the standard rule inputs and alias style inputs. Here are some common rules you might want to add to the firewall either now, or at some point in the future. </p>
<p>These two allow traffic on port <code>80</code> - the standard web server port. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow http comment http</span><br><span class="line">$ sudo ufw allow 80/tcp comment http</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Remember only one of the commands is required from these code blocks. Either the alias version (first line) or the standard input version (second line).</p>
</blockquote>
<p>The same goes for the port assigned to encrypted traffic on web servers, port <code>443</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow https comment https</span><br><span class="line">$ sudo ufw allow 443/tcp comment https</span><br></pre></td></tr></table></figure>
<p>Always use <code>sftp</code> instead of <code>ftp</code> when transferring files on the command line. The choice of commands to allow traffic on the default <code>sftp</code> port is:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow sftp comment sftp</span><br><span class="line">$ sudo ufw allow 115/tcp comment sftp</span><br></pre></td></tr></table></figure>
<p>When working with LDAP (Lightweight Directory Access Protocol) the alias command is best suited as it saves you having to open up both the TCP <strong>and</strong> UDP ports with two commands, so open up port <code>389</code> on both using:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow ldap comment ldap</span><br></pre></td></tr></table></figure>
<p>For SMTP traffic there’s:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow smtp comment smtp</span><br><span class="line">$ sudo ufw allow 25 comment smtp</span><br></pre></td></tr></table></figure>
<p>And for IMAP you’d enter:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow imap comment imap</span><br><span class="line">$ sudo ufw allow 143 comment imap</span><br></pre></td></tr></table></figure>
<p>Since UFW reads from the <code>/etc/services</code> file you can add any of the service names listed in there.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo less /etc/services</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Ping or ICMP reply should be enabled already by UFW. Meaning the server can be pinged even when the firewall is active. See <a href="http://askubuntu.com/a/10314" target="_blank" rel="external">http://askubuntu.com/a/10314</a></p>
</blockquote>
<p>Check this <a href="https://www.digitalocean.com/community/tutorials/ufw-essentials-common-firewall-rules-and-commands" target="_blank" rel="external">Digital Ocean article</a> for even more specific rules to add to your servers UFW config. </p>
<hr>
<h1 id="5-–-Enabling-and-Disabling-UFW"><a href="#5-–-Enabling-and-Disabling-UFW" class="headerlink" title="5 – Enabling and Disabling UFW"></a>5 – Enabling and Disabling UFW</h1><p>Once the rules are all added and ready for use, the final step is to activate the firewall. </p>
<p>This is easily done by issuing the command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw <span class="built_in">enable</span></span><br></pre></td></tr></table></figure>
<p>After entering the <code>sudo</code> password and confirming any prompts, you receive the message:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Firewall is active and enabled on system startup</span><br></pre></td></tr></table></figure>
<p>From here onward the rules are applied and working as entered. </p>
<p>To see the entire rules and status of the firewall now it’s running enter the command from the start again.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw status verbose</span><br></pre></td></tr></table></figure>
<p>Should you ever need to reload the firewall, use the <code>reload</code> option. Although this will probably be a rare occasion as remember rules are applied instantly upon entering.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw reload</span><br></pre></td></tr></table></figure>
<p>More commonly the entire firewall can be <code>disabled</code> with one command.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw <span class="built_in">disable</span></span><br></pre></td></tr></table></figure>
<p>Your rules and configuration is not list when the firewall is disabled, only inactive until you <code>enable</code> them again. To delete and remove rules see the next section. </p>
<hr>
<h1 id="6-–-Deleting-Rules"><a href="#6-–-Deleting-Rules" class="headerlink" title="6 – Deleting Rules"></a>6 – Deleting Rules</h1><p>Removing rules using the syntax you’re now likely familiar with. All you need to do is use the <code>delete</code> option as part of your command structure. </p>
<p>For example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw delete allow ssh</span><br><span class="line">$ sudo ufw delete allow 22/tcp</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note:</strong> Once again remember only one of the commands is required from the above code block. Either the alias version (first line) or the standard input version (second line).</p>
</blockquote>
<p>A smart way to remove rules uses the <code>numbered</code> output command.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw status numbered</span><br></pre></td></tr></table></figure>
<p>Here’s some example output:</p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Status: active</span><br><span class="line"></span><br><span class="line">     To                         Action      From</span><br><span class="line">     --                         ------      ----</span><br><span class="line">[ 1] 22                         ALLOW IN    Anywhere                  </span><br><span class="line">[ 2] 21/tcp                     ALLOW IN    Anywhere                  </span><br><span class="line">[ 3] 80                         ALLOW IN    Anywhere                  </span><br><span class="line">[ 4] 443                        ALLOW IN    Anywhere                  </span><br><span class="line">[ 5] 22 (v6)                    ALLOW IN    Anywhere (v6)             </span><br><span class="line">[ 6] 21/tcp (v6)                ALLOW IN    Anywhere (v6)             </span><br><span class="line">[ 7] 80 (v6)                    ALLOW IN    Anywhere (v6)             </span><br><span class="line">[ 8] 443 (v6)                   ALLOW IN    Anywhere (v6)</span><br></pre></td></tr></table></figure>
<p>The number featured in the resultant output (on the left column) can be referenced to delete rules. </p>
<p>As in this next example, which deletes rule <code>4</code> from the firewall. </p>
<figure class="highlight bash"><figcaption><span>Output</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw delete 4</span><br></pre></td></tr></table></figure>
<p>Be aware that if you have IPv6 enabled - which is the case on many distributions now by default after installation - there is always an equivalent rule added for IPv6; whenever you add a rule. So you need to delete that corresponding rule also when using this method. In my example it would have been rule <code>8</code> which you can see in the output(s).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ 8] 443 (v6)                   ALLOW IN    Anywhere (v6)</span><br></pre></td></tr></table></figure>
<p>If for some reason you want to redo the entire rule-set of the firewall. You can <code>reset</code> the whole of your current configuration with one command. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw reset</span><br></pre></td></tr></table></figure>
<p>Be careful using this of course. </p>
<hr>
<h1 id="7-–-Enabling-and-Disabling-Logging"><a href="#7-–-Enabling-and-Disabling-Logging" class="headerlink" title="7 – Enabling and Disabling Logging"></a>7 – Enabling and Disabling Logging</h1><p>If you want to use logging for the firewall you must enable it to do so. </p>
<p>To enable logging use:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw logging on</span><br></pre></td></tr></table></figure>
<p>The location of the log file may differ but in general here’s the place to start looking.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ls /var/<span class="built_in">log</span>/ufw</span><br></pre></td></tr></table></figure>
<p>For information on how to interpret log entries in UFW, read through this section <a href="https://help.ubuntu.com/community/UFW#Interpreting_Log_Entries" target="_blank" rel="external">here</a>. </p>
<p>To disable logging if needed you can use:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw logging off</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="8-–-Miscellaneous"><a href="#8-–-Miscellaneous" class="headerlink" title="8 – Miscellaneous"></a>8 – Miscellaneous</h1><p>Rule comments were introduced as of February 2016 but you will require at least version <code>0.35</code> of UFW to be able to use them. </p>
<p>To use IPv6 with UFW you need to ensure you have it enabled in the configuration file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/default/ufw</span><br></pre></td></tr></table></figure>
<p>Change the the value of <code>IPV6</code> to equal <code>yes</code> in this file if it is set to “no”. </p>
<figure class="highlight bash"><figcaption><span>/etc/default/ufw excerpt</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IPV6=yes</span><br></pre></td></tr></table></figure>
<p>Save and leave the file. </p>
<p>Reloading the firewall here might be a wise step if you already had it running before doing this (the command for reloading is given in an earlier step). After this the IPv6 rules alongside the regular IPv4 rules should be active and added to the firewall. </p>
<p>Lastly here’s several aliases you might want to incorporate into your <code>.bashrc</code> or <code>.alias</code> file to make things slightly quicker. </p>
<figure class="highlight bash"><figcaption><span>~/.alias</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ufw</span></span><br><span class="line"><span class="built_in">alias</span> ufw=<span class="string">'sudo ufw'</span></span><br><span class="line"><span class="built_in">alias</span> ufwstatver=<span class="string">'sudo ufw status verbose'</span></span><br><span class="line"><span class="built_in">alias</span> ufwstatnum=<span class="string">'sudo ufw status numbered'</span></span><br></pre></td></tr></table></figure>
<hr>
<p>This post in its entirety covers most of the information required when it comes to getting to know UFW. Some of the external links also provide a vast amount of information should it be needed. </p>
<hr>
<p><strong>More Information</strong></p>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-firewall-with-ufw-on-ubuntu-16-04" target="_blank" rel="external">Digital Ocean - How To Set Up a Firewall with UFW on Ubuntu 16.04</a> – There are several of these articles on DO and this is one I found the most useful for this post. </li>
<li><a href="https://wiki.ubuntu.com/UncomplicatedFirewall" target="_blank" rel="external">Ubuntu Wiki - UncomplicatedFirewall</a> – This page contains all the feature release and their versions. Alongside links to many different server guides.  </li>
<li><a href="https://launchpad.net/ufw" target="_blank" rel="external">Launchpad - UFW</a> – The project is hosted here with all development details included. </li>
</ul>
<blockquote>
<p>Easily deploy an SSD cloud server on <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">Digital Ocean</a> in 55 seconds. Sign up using my link and receive $10.00 in free credit: <a href="https://www.digitalocean.com/?refcode=e91058dbfc7b" target="_blank" rel="external">https://www.digitalocean.com/?refcode=e91058dbfc7b</a></p>
</blockquote>
<p>– Scarlz: <a href="https://twitter.com/5car1z" target="_blank" rel="external">@5car1z</a></p>
</div><footer class="post__foot u-cf"><ul class="post__tag u-fl"><li class="post__tag__item"><a href="/tags/Firewall/" class="post__tag__link">Firewall</a></li><li class="post__tag__item"><a href="/tags/Networking/" class="post__tag__link">Networking</a></li><li class="post__tag__item"><a href="/tags/IP/" class="post__tag__link">IP</a></li></ul><a href="/2017/02/14/installing-using-ufw/#disqus_thread" class="post__foot-link u-fr">COMMENTS</a></footer></article></main><footer class="foot"><div class="foot-copy u-fl">&copy; 2017 Scarlz</div><menu class="page-menu u-fr"><li class="page-menu__item"><span title="Previous" class="page-menu__link icon-arrow-left page-menu__link--disabled"></span></li><li class="page-menu__item"><a title="Next" href="/trades/Programming/page/2/" class="page-menu__link icon-arrow-right"></a></li></menu></footer><script>(function(h,g,l,k,j,i){j=h.createElement(g),i=h.getElementsByTagName(g)[0],
j.src="//"+l+".disqus.com/"+k+".js",i.parentNode.insertBefore(j,i)})
(document,"script","totts","count");
</script></body></html>